This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2025-06-11T05:30:56.968Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repopack, visit: https://github.com/yamadashy/repopack

================================================================
Repository Structure
================================================================
.cursor/mcp.json
.cursor/rules/cursor_rules.mdc
.cursor/rules/dev_workflow.mdc
.cursor/rules/self_improve.mdc
.cursor/rules/taskmaster.mdc
.env.example
.env.local
.eslintrc.json
.gitignore
.prettierrc
.roo/rules-architect/architect-rules
.roo/rules-ask/ask-rules
.roo/rules-boomerang/boomerang-rules
.roo/rules-code/code-rules
.roo/rules-debug/debug-rules
.roo/rules-test/test-rules
.roo/rules/dev_workflow.md
.roo/rules/roo_rules.md
.roo/rules/self_improve.md
.roo/rules/taskmaster.md
.roomodes
.taskmaster/config.json
.taskmaster/docs/prd.txt
.taskmaster/templates/example_prd.txt
.windsurfrules
database/functions_and_views.sql
database/migration_001_initial_schema.sql
database/rls_policies.sql
database/schema_documentation.md
database/schema.sql
next-env.d.ts
next.config.js
package.json
postcss.config.js
README.md
src/app/auth/page.tsx
src/app/books/[id]/edit/page.tsx
src/app/books/[id]/page.tsx
src/app/books/layout.tsx
src/app/books/new/page.tsx
src/app/books/page.tsx
src/app/courses/[id]/edit/page.tsx
src/app/courses/[id]/page.tsx
src/app/courses/layout.tsx
src/app/courses/new/page.tsx
src/app/courses/page.tsx
src/app/dashboard/components/page.tsx
src/app/dashboard/page.tsx
src/app/globals.css
src/app/layout.tsx
src/app/lessons/[id]/page.tsx
src/app/page.tsx
src/app/schedules/[id]/edit/page.tsx
src/app/schedules/[id]/page.tsx
src/app/schedules/layout.tsx
src/app/schedules/new/page.tsx
src/app/schedules/page.tsx
src/app/vocabulary/groups/new/page.tsx
src/app/vocabulary/groups/page.tsx
src/app/vocabulary/layout.tsx
src/app/vocabulary/new/page.tsx
src/app/vocabulary/page.tsx
src/components/auth/AuthGuard.tsx
src/components/auth/index.ts
src/components/auth/LoginForm.tsx
src/components/auth/UserProfile.tsx
src/components/books/BookForm.tsx
src/components/books/index.ts
src/components/courses/CourseForm.tsx
src/components/courses/index.ts
src/components/ErrorBoundary.tsx
src/components/layout/DashboardLayout.tsx
src/components/relationships/CourseBookManager.tsx
src/components/relationships/CourseScheduleList.tsx
src/components/relationships/CourseVocabularyManager.tsx
src/components/relationships/index.ts
src/components/relationships/LessonContentManager.tsx
src/components/schedules/LessonDetailModal.tsx
src/components/schedules/LessonForm.tsx
src/components/schedules/ScheduleCalendar.tsx
src/components/schedules/ScheduleForm.tsx
src/components/ui/Badge.tsx
src/components/ui/Button.tsx
src/components/ui/Card.tsx
src/components/ui/FilterPanel.tsx
src/components/ui/index.ts
src/components/ui/Input.tsx
src/components/ui/Modal.tsx
src/components/ui/Pagination.tsx
src/components/ui/SearchBox.tsx
src/components/ui/Select.tsx
src/components/ui/Spinner.tsx
src/components/ui/Table copy.tsx
src/components/ui/Table.tsx
src/components/ui/Tabs.tsx
src/components/ui/Textarea.tsx
src/components/vocabulary/index.ts
src/components/vocabulary/VocabularyForm.tsx
src/components/vocabulary/VocabularyGroupForm.tsx
src/contexts/AuthContext.tsx
src/lib/services/relationships/course-book-service.ts
src/lib/services/relationships/course-schedule-service.ts
src/lib/services/relationships/course-vocabulary-service.ts
src/lib/services/relationships/index.ts
src/lib/services/relationships/lesson-relationship-service.ts
src/lib/services/schedule-service.ts
src/lib/supabase.ts
src/lib/supabase/books.ts
src/lib/supabase/categories.ts
src/lib/supabase/courses.ts
src/lib/supabase/lessons.ts
src/lib/supabase/methods.ts
src/lib/supabase/objectives.ts
src/lib/supabase/schedules.ts
src/lib/supabase/tasks.ts
src/lib/supabase/vocabulary.ts
src/lib/utils.ts
src/types/database.ts
src/types/index.ts
src/types/schedule.ts
tailwind.config.js
tsconfig.json

================================================================
Repository Files
================================================================

================
File: .cursor/mcp.json
================
{
    "mcpServers": {
        "task-master-ai": {
            "command": "npx",
            "args": [
                "-y",
                "--package=task-master-ai",
                "task-master-ai"
            ],
            "env": {
                "ANTHROPIC_API_KEY": "ANTHROPIC_API_KEY_HERE",
                "PERPLEXITY_API_KEY": "PERPLEXITY_API_KEY_HERE",
                "OPENAI_API_KEY": "OPENAI_API_KEY_HERE",
                "GOOGLE_API_KEY": "GOOGLE_API_KEY_HERE",
                "XAI_API_KEY": "XAI_API_KEY_HERE",
                "OPENROUTER_API_KEY": "OPENROUTER_API_KEY_HERE",
                "MISTRAL_API_KEY": "MISTRAL_API_KEY_HERE",
                "AZURE_OPENAI_API_KEY": "AZURE_OPENAI_API_KEY_HERE",
                "OLLAMA_API_KEY": "OLLAMA_API_KEY_HERE"
            }
        }
    }
}

================
File: .cursor/rules/cursor_rules.mdc
================
---
description: Guidelines for creating and maintaining Cursor rules to ensure consistency and effectiveness.
globs: .cursor/rules/*.mdc
alwaysApply: true
---

- **Required Rule Structure:**
  ```markdown
  ---
  description: Clear, one-line description of what the rule enforces
  globs: path/to/files/*.ext, other/path/**/*
  alwaysApply: boolean
  ---

  - **Main Points in Bold**
    - Sub-points with details
    - Examples and explanations
  ```

- **File References:**
  - Use `[filename](mdc:path/to/file)` ([filename](mdc:filename)) to reference files
  - Example: [prisma.mdc](mdc:.cursor/rules/prisma.mdc) for rule references
  - Example: [schema.prisma](mdc:prisma/schema.prisma) for code references

- **Code Examples:**
  - Use language-specific code blocks
  ```typescript
  // ✅ DO: Show good examples
  const goodExample = true;
  
  // ❌ DON'T: Show anti-patterns
  const badExample = false;
  ```

- **Rule Content Guidelines:**
  - Start with high-level overview
  - Include specific, actionable requirements
  - Show examples of correct implementation
  - Reference existing code when possible
  - Keep rules DRY by referencing other rules

- **Rule Maintenance:**
  - Update rules when new patterns emerge
  - Add examples from actual codebase
  - Remove outdated patterns
  - Cross-reference related rules

- **Best Practices:**
  - Use bullet points for clarity
  - Keep descriptions concise
  - Include both DO and DON'T examples
  - Reference actual code over theoretical examples
  - Use consistent formatting across rules

================
File: .cursor/rules/dev_workflow.mdc
================
---
description: Guide for using Task Master to manage task-driven development workflows
globs: **/*
alwaysApply: true
---
# Task Master Development Workflow

This guide outlines the typical process for using Task Master to manage software development projects.

## Primary Interaction: MCP Server vs. CLI

Task Master offers two primary ways to interact:

1.  **MCP Server (Recommended for Integrated Tools)**:
    - For AI agents and integrated development environments (like Cursor), interacting via the **MCP server is the preferred method**.
    - The MCP server exposes Task Master functionality through a set of tools (e.g., `get_tasks`, `add_subtask`).
    - This method offers better performance, structured data exchange, and richer error handling compared to CLI parsing.
    - Refer to [`mcp.mdc`](mdc:.cursor/rules/mcp.mdc) for details on the MCP architecture and available tools.
    - A comprehensive list and description of MCP tools and their corresponding CLI commands can be found in [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc).
    - **Restart the MCP server** if core logic in `scripts/modules` or MCP tool/direct function definitions change.

2.  **`task-master` CLI (For Users & Fallback)**:
    - The global `task-master` command provides a user-friendly interface for direct terminal interaction.
    - It can also serve as a fallback if the MCP server is inaccessible or a specific function isn't exposed via MCP.
    - Install globally with `npm install -g task-master-ai` or use locally via `npx task-master-ai ...`.
    - The CLI commands often mirror the MCP tools (e.g., `task-master list` corresponds to `get_tasks`).
    - Refer to [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc) for a detailed command reference.

## Standard Development Workflow Process

-   Start new projects by running `initialize_project` tool / `task-master init` or `parse_prd` / `task-master parse-prd --input='<prd-file.txt>'` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) to generate initial tasks.json
-   Begin coding sessions with `get_tasks` / `task-master list` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) to see current tasks, status, and IDs
-   Determine the next task to work on using `next_task` / `task-master next` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)).
-   Analyze task complexity with `analyze_project_complexity` / `task-master analyze-complexity --research` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) before breaking down tasks
-   Review complexity report using `complexity_report` / `task-master complexity-report` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)).
-   Select tasks based on dependencies (all marked 'done'), priority level, and ID order
-   Clarify tasks by checking task files in tasks/ directory or asking for user input
-   View specific task details using `get_task` / `task-master show <id>` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) to understand implementation requirements
-   Break down complex tasks using `expand_task` / `task-master expand --id=<id> --force --research` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) with appropriate flags like `--force` (to replace existing subtasks) and `--research`.
-   Clear existing subtasks if needed using `clear_subtasks` / `task-master clear-subtasks --id=<id>` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) before regenerating
-   Implement code following task details, dependencies, and project standards
-   Verify tasks according to test strategies before marking as complete (See [`tests.mdc`](mdc:.cursor/rules/tests.mdc))
-   Mark completed tasks with `set_task_status` / `task-master set-status --id=<id> --status=done` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc))
-   Update dependent tasks when implementation differs from original plan using `update` / `task-master update --from=<id> --prompt="..."` or `update_task` / `task-master update-task --id=<id> --prompt="..."` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc))
-   Add new tasks discovered during implementation using `add_task` / `task-master add-task --prompt="..." --research` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)).
-   Add new subtasks as needed using `add_subtask` / `task-master add-subtask --parent=<id> --title="..."` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)).
-   Append notes or details to subtasks using `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='Add implementation notes here...\nMore details...'` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)).
-   Generate task files with `generate` / `task-master generate` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) after updating tasks.json
-   Maintain valid dependency structure with `add_dependency`/`remove_dependency` tools or `task-master add-dependency`/`remove-dependency` commands, `validate_dependencies` / `task-master validate-dependencies`, and `fix_dependencies` / `task-master fix-dependencies` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) when needed
-   Respect dependency chains and task priorities when selecting work
-   Report progress regularly using `get_tasks` / `task-master list`
-   Reorganize tasks as needed using `move_task` / `task-master move --from=<id> --to=<id>` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) to change task hierarchy or ordering

## Task Complexity Analysis

-   Run `analyze_project_complexity` / `task-master analyze-complexity --research` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) for comprehensive analysis
-   Review complexity report via `complexity_report` / `task-master complexity-report` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) for a formatted, readable version.
-   Focus on tasks with highest complexity scores (8-10) for detailed breakdown
-   Use analysis results to determine appropriate subtask allocation
-   Note that reports are automatically used by the `expand_task` tool/command

## Task Breakdown Process

-   Use `expand_task` / `task-master expand --id=<id>`. It automatically uses the complexity report if found, otherwise generates default number of subtasks.
-   Use `--num=<number>` to specify an explicit number of subtasks, overriding defaults or complexity report recommendations.
-   Add `--research` flag to leverage Perplexity AI for research-backed expansion.
-   Add `--force` flag to clear existing subtasks before generating new ones (default is to append).
-   Use `--prompt="<context>"` to provide additional context when needed.
-   Review and adjust generated subtasks as necessary.
-   Use `expand_all` tool or `task-master expand --all` to expand multiple pending tasks at once, respecting flags like `--force` and `--research`.
-   If subtasks need complete replacement (regardless of the `--force` flag on `expand`), clear them first with `clear_subtasks` / `task-master clear-subtasks --id=<id>`.

## Implementation Drift Handling

-   When implementation differs significantly from planned approach
-   When future tasks need modification due to current implementation choices
-   When new dependencies or requirements emerge
-   Use `update` / `task-master update --from=<futureTaskId> --prompt='<explanation>\nUpdate context...' --research` to update multiple future tasks.
-   Use `update_task` / `task-master update-task --id=<taskId> --prompt='<explanation>\nUpdate context...' --research` to update a single specific task.

## Task Status Management

-   Use 'pending' for tasks ready to be worked on
-   Use 'done' for completed and verified tasks
-   Use 'deferred' for postponed tasks
-   Add custom status values as needed for project-specific workflows

## Task Structure Fields

- **id**: Unique identifier for the task (Example: `1`, `1.1`)
- **title**: Brief, descriptive title (Example: `"Initialize Repo"`)
- **description**: Concise summary of what the task involves (Example: `"Create a new repository, set up initial structure."`)
- **status**: Current state of the task (Example: `"pending"`, `"done"`, `"deferred"`)
- **dependencies**: IDs of prerequisite tasks (Example: `[1, 2.1]`)
    - Dependencies are displayed with status indicators (✅ for completed, ⏱️ for pending)
    - This helps quickly identify which prerequisite tasks are blocking work
- **priority**: Importance level (Example: `"high"`, `"medium"`, `"low"`)
- **details**: In-depth implementation instructions (Example: `"Use GitHub client ID/secret, handle callback, set session token."`) 
- **testStrategy**: Verification approach (Example: `"Deploy and call endpoint to confirm 'Hello World' response."`) 
- **subtasks**: List of smaller, more specific tasks (Example: `[{"id": 1, "title": "Configure OAuth", ...}]`) 
- Refer to task structure details (previously linked to `tasks.mdc`).

## Configuration Management (Updated)

Taskmaster configuration is managed through two main mechanisms:

1.  **`.taskmaster/config.json` File (Primary):**
    *   Located in the project root directory.
    *   Stores most configuration settings: AI model selections (main, research, fallback), parameters (max tokens, temperature), logging level, default subtasks/priority, project name, etc.
    *   **Managed via `task-master models --setup` command.** Do not edit manually unless you know what you are doing.
    *   **View/Set specific models via `task-master models` command or `models` MCP tool.**
    *   Created automatically when you run `task-master models --setup` for the first time.

2.  **Environment Variables (`.env` / `mcp.json`):**
    *   Used **only** for sensitive API keys and specific endpoint URLs.
    *   Place API keys (one per provider) in a `.env` file in the project root for CLI usage.
    *   For MCP/Cursor integration, configure these keys in the `env` section of `.cursor/mcp.json`.
    *   Available keys/variables: See `assets/env.example` or the Configuration section in the command reference (previously linked to `taskmaster.mdc`).

**Important:** Non-API key settings (like model selections, `MAX_TOKENS`, `TASKMASTER_LOG_LEVEL`) are **no longer configured via environment variables**. Use the `task-master models` command (or `--setup` for interactive configuration) or the `models` MCP tool.
**If AI commands FAIL in MCP** verify that the API key for the selected provider is present in the `env` section of `.cursor/mcp.json`.
**If AI commands FAIL in CLI** verify that the API key for the selected provider is present in the `.env` file in the root of the project.

## Determining the Next Task

- Run `next_task` / `task-master next` to show the next task to work on.
- The command identifies tasks with all dependencies satisfied
- Tasks are prioritized by priority level, dependency count, and ID
- The command shows comprehensive task information including:
    - Basic task details and description
    - Implementation details
    - Subtasks (if they exist)
    - Contextual suggested actions
- Recommended before starting any new development work
- Respects your project's dependency structure
- Ensures tasks are completed in the appropriate sequence
- Provides ready-to-use commands for common task actions

## Viewing Specific Task Details

- Run `get_task` / `task-master show <id>` to view a specific task.
- Use dot notation for subtasks: `task-master show 1.2` (shows subtask 2 of task 1)
- Displays comprehensive information similar to the next command, but for a specific task
- For parent tasks, shows all subtasks and their current status
- For subtasks, shows parent task information and relationship
- Provides contextual suggested actions appropriate for the specific task
- Useful for examining task details before implementation or checking status

## Managing Task Dependencies

- Use `add_dependency` / `task-master add-dependency --id=<id> --depends-on=<id>` to add a dependency.
- Use `remove_dependency` / `task-master remove-dependency --id=<id> --depends-on=<id>` to remove a dependency.
- The system prevents circular dependencies and duplicate dependency entries
- Dependencies are checked for existence before being added or removed
- Task files are automatically regenerated after dependency changes
- Dependencies are visualized with status indicators in task listings and files

## Task Reorganization

- Use `move_task` / `task-master move --from=<id> --to=<id>` to move tasks or subtasks within the hierarchy
- This command supports several use cases:
  - Moving a standalone task to become a subtask (e.g., `--from=5 --to=7`)
  - Moving a subtask to become a standalone task (e.g., `--from=5.2 --to=7`) 
  - Moving a subtask to a different parent (e.g., `--from=5.2 --to=7.3`)
  - Reordering subtasks within the same parent (e.g., `--from=5.2 --to=5.4`)
  - Moving a task to a new, non-existent ID position (e.g., `--from=5 --to=25`)
  - Moving multiple tasks at once using comma-separated IDs (e.g., `--from=10,11,12 --to=16,17,18`)
- The system includes validation to prevent data loss:
  - Allows moving to non-existent IDs by creating placeholder tasks
  - Prevents moving to existing task IDs that have content (to avoid overwriting)
  - Validates source tasks exist before attempting to move them
- The system maintains proper parent-child relationships and dependency integrity
- Task files are automatically regenerated after the move operation
- This provides greater flexibility in organizing and refining your task structure as project understanding evolves
- This is especially useful when dealing with potential merge conflicts arising from teams creating tasks on separate branches. Solve these conflicts very easily by moving your tasks and keeping theirs.

## Iterative Subtask Implementation

Once a task has been broken down into subtasks using `expand_task` or similar methods, follow this iterative process for implementation:

1.  **Understand the Goal (Preparation):**
    *   Use `get_task` / `task-master show <subtaskId>` (see [`taskmaster.mdc`](mdc:.cursor/rules/taskmaster.mdc)) to thoroughly understand the specific goals and requirements of the subtask.

2.  **Initial Exploration & Planning (Iteration 1):**
    *   This is the first attempt at creating a concrete implementation plan.
    *   Explore the codebase to identify the precise files, functions, and even specific lines of code that will need modification.
    *   Determine the intended code changes (diffs) and their locations.
    *   Gather *all* relevant details from this exploration phase.

3.  **Log the Plan:**
    *   Run `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='<detailed plan>'`.
    *   Provide the *complete and detailed* findings from the exploration phase in the prompt. Include file paths, line numbers, proposed diffs, reasoning, and any potential challenges identified. Do not omit details. The goal is to create a rich, timestamped log within the subtask's `details`.

4.  **Verify the Plan:**
    *   Run `get_task` / `task-master show <subtaskId>` again to confirm that the detailed implementation plan has been successfully appended to the subtask's details.

5.  **Begin Implementation:**
    *   Set the subtask status using `set_task_status` / `task-master set-status --id=<subtaskId> --status=in-progress`.
    *   Start coding based on the logged plan.

6.  **Refine and Log Progress (Iteration 2+):**
    *   As implementation progresses, you will encounter challenges, discover nuances, or confirm successful approaches.
    *   **Before appending new information**: Briefly review the *existing* details logged in the subtask (using `get_task` or recalling from context) to ensure the update adds fresh insights and avoids redundancy.
    *   **Regularly** use `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='<update details>\n- What worked...\n- What didn't work...'` to append new findings.
    *   **Crucially, log:**
        *   What worked ("fundamental truths" discovered).
        *   What didn't work and why (to avoid repeating mistakes).
        *   Specific code snippets or configurations that were successful.
        *   Decisions made, especially if confirmed with user input.
        *   Any deviations from the initial plan and the reasoning.
    *   The objective is to continuously enrich the subtask's details, creating a log of the implementation journey that helps the AI (and human developers) learn, adapt, and avoid repeating errors.

7.  **Review & Update Rules (Post-Implementation):**
    *   Once the implementation for the subtask is functionally complete, review all code changes and the relevant chat history.
    *   Identify any new or modified code patterns, conventions, or best practices established during the implementation.
    *   Create new or update existing rules following internal guidelines (previously linked to `cursor_rules.mdc` and `self_improve.mdc`).

8.  **Mark Task Complete:**
    *   After verifying the implementation and updating any necessary rules, mark the subtask as completed: `set_task_status` / `task-master set-status --id=<subtaskId> --status=done`.

9.  **Commit Changes (If using Git):**
    *   Stage the relevant code changes and any updated/new rule files (`git add .`).
    *   Craft a comprehensive Git commit message summarizing the work done for the subtask, including both code implementation and any rule adjustments.
    *   Execute the commit command directly in the terminal (e.g., `git commit -m 'feat(module): Implement feature X for subtask <subtaskId>\n\n- Details about changes...\n- Updated rule Y for pattern Z'`).
    *   Consider if a Changeset is needed according to internal versioning guidelines (previously linked to `changeset.mdc`). If so, run `npm run changeset`, stage the generated file, and amend the commit or create a new one.

10. **Proceed to Next Subtask:**
    *   Identify the next subtask (e.g., using `next_task` / `task-master next`).

## Code Analysis & Refactoring Techniques

- **Top-Level Function Search**:
    - Useful for understanding module structure or planning refactors.
    - Use grep/ripgrep to find exported functions/constants:
      `rg "export (async function|function|const) \w+"` or similar patterns.
    - Can help compare functions between files during migrations or identify potential naming conflicts.

---
*This workflow provides a general guideline. Adapt it based on your specific project needs and team practices.*

================
File: .cursor/rules/self_improve.mdc
================
---
description: Guidelines for continuously improving Cursor rules based on emerging code patterns and best practices.
globs: **/*
alwaysApply: true
---

- **Rule Improvement Triggers:**
  - New code patterns not covered by existing rules
  - Repeated similar implementations across files
  - Common error patterns that could be prevented
  - New libraries or tools being used consistently
  - Emerging best practices in the codebase

- **Analysis Process:**
  - Compare new code with existing rules
  - Identify patterns that should be standardized
  - Look for references to external documentation
  - Check for consistent error handling patterns
  - Monitor test patterns and coverage

- **Rule Updates:**
  - **Add New Rules When:**
    - A new technology/pattern is used in 3+ files
    - Common bugs could be prevented by a rule
    - Code reviews repeatedly mention the same feedback
    - New security or performance patterns emerge

  - **Modify Existing Rules When:**
    - Better examples exist in the codebase
    - Additional edge cases are discovered
    - Related rules have been updated
    - Implementation details have changed

- **Example Pattern Recognition:**
  ```typescript
  // If you see repeated patterns like:
  const data = await prisma.user.findMany({
    select: { id: true, email: true },
    where: { status: 'ACTIVE' }
  });
  
  // Consider adding to [prisma.mdc](mdc:.cursor/rules/prisma.mdc):
  // - Standard select fields
  // - Common where conditions
  // - Performance optimization patterns
  ```

- **Rule Quality Checks:**
  - Rules should be actionable and specific
  - Examples should come from actual code
  - References should be up to date
  - Patterns should be consistently enforced

- **Continuous Improvement:**
  - Monitor code review comments
  - Track common development questions
  - Update rules after major refactors
  - Add links to relevant documentation
  - Cross-reference related rules

- **Rule Deprecation:**
  - Mark outdated patterns as deprecated
  - Remove rules that no longer apply
  - Update references to deprecated rules
  - Document migration paths for old patterns

- **Documentation Updates:**
  - Keep examples synchronized with code
  - Update references to external docs
  - Maintain links between related rules
  - Document breaking changes
Follow [cursor_rules.mdc](mdc:.cursor/rules/cursor_rules.mdc) for proper rule formatting and structure.

================
File: .cursor/rules/taskmaster.mdc
================
---
description: Comprehensive reference for Taskmaster MCP tools and CLI commands.
globs: **/*
alwaysApply: true
---
# Taskmaster Tool & Command Reference

This document provides a detailed reference for interacting with Taskmaster, covering both the recommended MCP tools, suitable for integrations like Cursor, and the corresponding `task-master` CLI commands, designed for direct user interaction or fallback.

**Note:** For interacting with Taskmaster programmatically or via integrated tools, using the **MCP tools is strongly recommended** due to better performance, structured data, and error handling. The CLI commands serve as a user-friendly alternative and fallback. 

**Important:** Several MCP tools involve AI processing... The AI-powered tools include `parse_prd`, `analyze_project_complexity`, `update_subtask`, `update_task`, `update`, `expand_all`, `expand_task`, and `add_task`.

---

## Initialization & Setup

### 1. Initialize Project (`init`)

*   **MCP Tool:** `initialize_project`
*   **CLI Command:** `task-master init [options]`
*   **Description:** `Set up the basic Taskmaster file structure and configuration in the current directory for a new project.`
*   **Key CLI Options:**
    *   `--name <name>`: `Set the name for your project in Taskmaster's configuration.`
    *   `--description <text>`: `Provide a brief description for your project.`
    *   `--version <version>`: `Set the initial version for your project, e.g., '0.1.0'.`
    *   `-y, --yes`: `Initialize Taskmaster quickly using default settings without interactive prompts.`
*   **Usage:** Run this once at the beginning of a new project.
*   **MCP Variant Description:** `Set up the basic Taskmaster file structure and configuration in the current directory for a new project by running the 'task-master init' command.`
*   **Key MCP Parameters/Options:**
    *   `projectName`: `Set the name for your project.` (CLI: `--name <name>`)
    *   `projectDescription`: `Provide a brief description for your project.` (CLI: `--description <text>`)
    *   `projectVersion`: `Set the initial version for your project, e.g., '0.1.0'.` (CLI: `--version <version>`)
    *   `authorName`: `Author name.` (CLI: `--author <author>`)
    *   `skipInstall`: `Skip installing dependencies. Default is false.` (CLI: `--skip-install`)
    *   `addAliases`: `Add shell aliases tm and taskmaster. Default is false.` (CLI: `--aliases`)
    *   `yes`: `Skip prompts and use defaults/provided arguments. Default is false.` (CLI: `-y, --yes`)
*   **Usage:** Run this once at the beginning of a new project, typically via an integrated tool like Cursor. Operates on the current working directory of the MCP server. 
*   **Important:** Once complete, you *MUST* parse a prd in order to generate tasks. There will be no tasks files until then. The next step after initializing should be to create a PRD using the example PRD in .taskmaster/templates/example_prd.txt. 

### 2. Parse PRD (`parse_prd`)

*   **MCP Tool:** `parse_prd`
*   **CLI Command:** `task-master parse-prd [file] [options]`
*   **Description:** `Parse a Product Requirements Document, PRD, or text file with Taskmaster to automatically generate an initial set of tasks in tasks.json.`
*   **Key Parameters/Options:**
    *   `input`: `Path to your PRD or requirements text file that Taskmaster should parse for tasks.` (CLI: `[file]` positional or `-i, --input <file>`)
    *   `output`: `Specify where Taskmaster should save the generated 'tasks.json' file. Defaults to '.taskmaster/tasks/tasks.json'.` (CLI: `-o, --output <file>`)
    *   `numTasks`: `Approximate number of top-level tasks Taskmaster should aim to generate from the document.` (CLI: `-n, --num-tasks <number>`)
    *   `force`: `Use this to allow Taskmaster to overwrite an existing 'tasks.json' without asking for confirmation.` (CLI: `-f, --force`)
*   **Usage:** Useful for bootstrapping a project from an existing requirements document.
*   **Notes:** Task Master will strictly adhere to any specific requirements mentioned in the PRD, such as libraries, database schemas, frameworks, tech stacks, etc., while filling in any gaps where the PRD isn't fully specified. Tasks are designed to provide the most direct implementation path while avoiding over-engineering.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress. If the user does not have a PRD, suggest discussing their idea and then use the example PRD in `.taskmaster/templates/example_prd.txt` as a template for creating the PRD based on their idea, for use with `parse-prd`.

---

## AI Model Configuration

### 2. Manage Models (`models`)
*   **MCP Tool:** `models`
*   **CLI Command:** `task-master models [options]`
*   **Description:** `View the current AI model configuration or set specific models for different roles (main, research, fallback). Allows setting custom model IDs for Ollama and OpenRouter.`
*   **Key MCP Parameters/Options:**
    *   `setMain <model_id>`: `Set the primary model ID for task generation/updates.` (CLI: `--set-main <model_id>`)
    *   `setResearch <model_id>`: `Set the model ID for research-backed operations.` (CLI: `--set-research <model_id>`)
    *   `setFallback <model_id>`: `Set the model ID to use if the primary fails.` (CLI: `--set-fallback <model_id>`)
    *   `ollama <boolean>`: `Indicates the set model ID is a custom Ollama model.` (CLI: `--ollama`)
    *   `openrouter <boolean>`: `Indicates the set model ID is a custom OpenRouter model.` (CLI: `--openrouter`)
    *   `listAvailableModels <boolean>`: `If true, lists available models not currently assigned to a role.` (CLI: No direct equivalent; CLI lists available automatically)
    *   `projectRoot <string>`: `Optional. Absolute path to the project root directory.` (CLI: Determined automatically)
*   **Key CLI Options:**
    *   `--set-main <model_id>`: `Set the primary model.`
    *   `--set-research <model_id>`: `Set the research model.`
    *   `--set-fallback <model_id>`: `Set the fallback model.`
    *   `--ollama`: `Specify that the provided model ID is for Ollama (use with --set-*).`
    *   `--openrouter`: `Specify that the provided model ID is for OpenRouter (use with --set-*). Validates against OpenRouter API.`
    *   `--setup`: `Run interactive setup to configure models, including custom Ollama/OpenRouter IDs.`
*   **Usage (MCP):** Call without set flags to get current config. Use `setMain`, `setResearch`, or `setFallback` with a valid model ID to update the configuration. Use `listAvailableModels: true` to get a list of unassigned models. To set a custom model, provide the model ID and set `ollama: true` or `openrouter: true`.
*   **Usage (CLI):** Run without flags to view current configuration and available models. Use set flags to update specific roles. Use `--setup` for guided configuration, including custom models. To set a custom model via flags, use `--set-<role>=<model_id>` along with either `--ollama` or `--openrouter`.
*   **Notes:** Configuration is stored in `.taskmaster/config.json` in the project root. This command/tool modifies that file. Use `listAvailableModels` or `task-master models` to see internally supported models. OpenRouter custom models are validated against their live API. Ollama custom models are not validated live.
*   **API note:** API keys for selected AI providers (based on their model) need to exist in the mcp.json file to be accessible in MCP context. The API keys must be present in the local .env file for the CLI to be able to read them.
*   **Model costs:** The costs in supported models are expressed in dollars. An input/output value of 3 is $3.00. A value of 0.8 is $0.80. 
*   **Warning:** DO NOT MANUALLY EDIT THE .taskmaster/config.json FILE. Use the included commands either in the MCP or CLI format as needed. Always prioritize MCP tools when available and use the CLI as a fallback.

---

## Task Listing & Viewing

### 3. Get Tasks (`get_tasks`)

*   **MCP Tool:** `get_tasks`
*   **CLI Command:** `task-master list [options]`
*   **Description:** `List your Taskmaster tasks, optionally filtering by status and showing subtasks.`
*   **Key Parameters/Options:**
    *   `status`: `Show only Taskmaster tasks matching this status, e.g., 'pending' or 'done'.` (CLI: `-s, --status <status>`)
    *   `withSubtasks`: `Include subtasks indented under their parent tasks in the list.` (CLI: `--with-subtasks`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Get an overview of the project status, often used at the start of a work session.

### 4. Get Next Task (`next_task`)

*   **MCP Tool:** `next_task`
*   **CLI Command:** `task-master next [options]`
*   **Description:** `Ask Taskmaster to show the next available task you can work on, based on status and completed dependencies.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Identify what to work on next according to the plan.

### 5. Get Task Details (`get_task`)

*   **MCP Tool:** `get_task`
*   **CLI Command:** `task-master show [id] [options]`
*   **Description:** `Display detailed information for a specific Taskmaster task or subtask by its ID.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task, e.g., '15', or subtask, e.g., '15.2', you want to view.` (CLI: `[id]` positional or `-i, --id <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Understand the full details, implementation notes, and test strategy for a specific task before starting work.

---

## Task Creation & Modification

### 6. Add Task (`add_task`)

*   **MCP Tool:** `add_task`
*   **CLI Command:** `task-master add-task [options]`
*   **Description:** `Add a new task to Taskmaster by describing it; AI will structure it.`
*   **Key Parameters/Options:**
    *   `prompt`: `Required. Describe the new task you want Taskmaster to create, e.g., "Implement user authentication using JWT".` (CLI: `-p, --prompt <text>`)
    *   `dependencies`: `Specify the IDs of any Taskmaster tasks that must be completed before this new one can start, e.g., '12,14'.` (CLI: `-d, --dependencies <ids>`)
    *   `priority`: `Set the priority for the new task: 'high', 'medium', or 'low'. Default is 'medium'.` (CLI: `--priority <priority>`)
    *   `research`: `Enable Taskmaster to use the research role for potentially more informed task creation.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Quickly add newly identified tasks during development.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 7. Add Subtask (`add_subtask`)

*   **MCP Tool:** `add_subtask`
*   **CLI Command:** `task-master add-subtask [options]`
*   **Description:** `Add a new subtask to a Taskmaster parent task, or convert an existing task into a subtask.`
*   **Key Parameters/Options:**
    *   `id` / `parent`: `Required. The ID of the Taskmaster task that will be the parent.` (MCP: `id`, CLI: `-p, --parent <id>`)
    *   `taskId`: `Use this if you want to convert an existing top-level Taskmaster task into a subtask of the specified parent.` (CLI: `-i, --task-id <id>`)
    *   `title`: `Required if not using taskId. The title for the new subtask Taskmaster should create.` (CLI: `-t, --title <title>`)
    *   `description`: `A brief description for the new subtask.` (CLI: `-d, --description <text>`)
    *   `details`: `Provide implementation notes or details for the new subtask.` (CLI: `--details <text>`)
    *   `dependencies`: `Specify IDs of other tasks or subtasks, e.g., '15' or '16.1', that must be done before this new subtask.` (CLI: `--dependencies <ids>`)
    *   `status`: `Set the initial status for the new subtask. Default is 'pending'.` (CLI: `-s, --status <status>`)
    *   `skipGenerate`: `Prevent Taskmaster from automatically regenerating markdown task files after adding the subtask.` (CLI: `--skip-generate`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Break down tasks manually or reorganize existing tasks.

### 8. Update Tasks (`update`)

*   **MCP Tool:** `update`
*   **CLI Command:** `task-master update [options]`
*   **Description:** `Update multiple upcoming tasks in Taskmaster based on new context or changes, starting from a specific task ID.`
*   **Key Parameters/Options:**
    *   `from`: `Required. The ID of the first task Taskmaster should update. All tasks with this ID or higher that are not 'done' will be considered.` (CLI: `--from <id>`)
    *   `prompt`: `Required. Explain the change or new context for Taskmaster to apply to the tasks, e.g., "We are now using React Query instead of Redux Toolkit for data fetching".` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Handle significant implementation changes or pivots that affect multiple future tasks. Example CLI: `task-master update --from='18' --prompt='Switching to React Query.\nNeed to refactor data fetching...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 9. Update Task (`update_task`)

*   **MCP Tool:** `update_task`
*   **CLI Command:** `task-master update-task [options]`
*   **Description:** `Modify a specific Taskmaster task or subtask by its ID, incorporating new information or changes.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The specific ID of the Taskmaster task, e.g., '15', or subtask, e.g., '15.2', you want to update.` (CLI: `-i, --id <id>`)
    *   `prompt`: `Required. Explain the specific changes or provide the new information Taskmaster should incorporate into this task.` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Refine a specific task based on new understanding or feedback. Example CLI: `task-master update-task --id='15' --prompt='Clarification: Use PostgreSQL instead of MySQL.\nUpdate schema details...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 10. Update Subtask (`update_subtask`)

*   **MCP Tool:** `update_subtask`
*   **CLI Command:** `task-master update-subtask [options]`
*   **Description:** `Append timestamped notes or details to a specific Taskmaster subtask without overwriting existing content. Intended for iterative implementation logging.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The specific ID of the Taskmaster subtask, e.g., '15.2', you want to add information to.` (CLI: `-i, --id <id>`)
    *   `prompt`: `Required. Provide the information or notes Taskmaster should append to the subtask's details. Ensure this adds *new* information not already present.` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Add implementation notes, code snippets, or clarifications to a subtask during development. Before calling, review the subtask's current details to append only fresh insights, helping to build a detailed log of the implementation journey and avoid redundancy. Example CLI: `task-master update-subtask --id='15.2' --prompt='Discovered that the API requires header X.\nImplementation needs adjustment...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 11. Set Task Status (`set_task_status`)

*   **MCP Tool:** `set_task_status`
*   **CLI Command:** `task-master set-status [options]`
*   **Description:** `Update the status of one or more Taskmaster tasks or subtasks, e.g., 'pending', 'in-progress', 'done'.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID(s) of the Taskmaster task(s) or subtask(s), e.g., '15', '15.2', or '16,17.1', to update.` (CLI: `-i, --id <id>`)
    *   `status`: `Required. The new status to set, e.g., 'done', 'pending', 'in-progress', 'review', 'cancelled'.` (CLI: `-s, --status <status>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Mark progress as tasks move through the development cycle.

### 12. Remove Task (`remove_task`)

*   **MCP Tool:** `remove_task`
*   **CLI Command:** `task-master remove-task [options]`
*   **Description:** `Permanently remove a task or subtask from the Taskmaster tasks list.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task, e.g., '5', or subtask, e.g., '5.2', to permanently remove.` (CLI: `-i, --id <id>`)
    *   `yes`: `Skip the confirmation prompt and immediately delete the task.` (CLI: `-y, --yes`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Permanently delete tasks or subtasks that are no longer needed in the project.
*   **Notes:** Use with caution as this operation cannot be undone. Consider using 'blocked', 'cancelled', or 'deferred' status instead if you just want to exclude a task from active planning but keep it for reference. The command automatically cleans up dependency references in other tasks.

---

## Task Structure & Breakdown

### 13. Expand Task (`expand_task`)

*   **MCP Tool:** `expand_task`
*   **CLI Command:** `task-master expand [options]`
*   **Description:** `Use Taskmaster's AI to break down a complex task into smaller, manageable subtasks. Appends subtasks by default.`
*   **Key Parameters/Options:**
    *   `id`: `The ID of the specific Taskmaster task you want to break down into subtasks.` (CLI: `-i, --id <id>`)
    *   `num`: `Optional: Suggests how many subtasks Taskmaster should aim to create. Uses complexity analysis/defaults otherwise.` (CLI: `-n, --num <number>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed subtask generation. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `prompt`: `Optional: Provide extra context or specific instructions to Taskmaster for generating the subtasks.` (CLI: `-p, --prompt <text>`)
    *   `force`: `Optional: If true, clear existing subtasks before generating new ones. Default is false (append).` (CLI: `--force`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Generate a detailed implementation plan for a complex task before starting coding. Automatically uses complexity report recommendations if available and `num` is not specified.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 14. Expand All Tasks (`expand_all`)

*   **MCP Tool:** `expand_all`
*   **CLI Command:** `task-master expand --all [options]` (Note: CLI uses the `expand` command with the `--all` flag)
*   **Description:** `Tell Taskmaster to automatically expand all eligible pending/in-progress tasks based on complexity analysis or defaults. Appends subtasks by default.`
*   **Key Parameters/Options:**
    *   `num`: `Optional: Suggests how many subtasks Taskmaster should aim to create per task.` (CLI: `-n, --num <number>`)
    *   `research`: `Enable research role for more informed subtask generation. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `prompt`: `Optional: Provide extra context for Taskmaster to apply generally during expansion.` (CLI: `-p, --prompt <text>`)
    *   `force`: `Optional: If true, clear existing subtasks before generating new ones for each eligible task. Default is false (append).` (CLI: `--force`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Useful after initial task generation or complexity analysis to break down multiple tasks at once.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 15. Clear Subtasks (`clear_subtasks`)

*   **MCP Tool:** `clear_subtasks`
*   **CLI Command:** `task-master clear-subtasks [options]`
*   **Description:** `Remove all subtasks from one or more specified Taskmaster parent tasks.`
*   **Key Parameters/Options:**
    *   `id`: `The ID(s) of the Taskmaster parent task(s) whose subtasks you want to remove, e.g., '15' or '16,18'. Required unless using `all`.) (CLI: `-i, --id <ids>`)
    *   `all`: `Tell Taskmaster to remove subtasks from all parent tasks.` (CLI: `--all`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Used before regenerating subtasks with `expand_task` if the previous breakdown needs replacement.

### 16. Remove Subtask (`remove_subtask`)

*   **MCP Tool:** `remove_subtask`
*   **CLI Command:** `task-master remove-subtask [options]`
*   **Description:** `Remove a subtask from its Taskmaster parent, optionally converting it into a standalone task.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID(s) of the Taskmaster subtask(s) to remove, e.g., '15.2' or '16.1,16.3'.` (CLI: `-i, --id <id>`)
    *   `convert`: `If used, Taskmaster will turn the subtask into a regular top-level task instead of deleting it.` (CLI: `-c, --convert`)
    *   `skipGenerate`: `Prevent Taskmaster from automatically regenerating markdown task files after removing the subtask.` (CLI: `--skip-generate`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Delete unnecessary subtasks or promote a subtask to a top-level task.

### 17. Move Task (`move_task`)

*   **MCP Tool:** `move_task`
*   **CLI Command:** `task-master move [options]`
*   **Description:** `Move a task or subtask to a new position within the task hierarchy.`
*   **Key Parameters/Options:**
    *   `from`: `Required. ID of the task/subtask to move (e.g., "5" or "5.2"). Can be comma-separated for multiple tasks.` (CLI: `--from <id>`)
    *   `to`: `Required. ID of the destination (e.g., "7" or "7.3"). Must match the number of source IDs if comma-separated.` (CLI: `--to <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Reorganize tasks by moving them within the hierarchy. Supports various scenarios like:
    *   Moving a task to become a subtask
    *   Moving a subtask to become a standalone task
    *   Moving a subtask to a different parent
    *   Reordering subtasks within the same parent
    *   Moving a task to a new, non-existent ID (automatically creates placeholders)
    *   Moving multiple tasks at once with comma-separated IDs
*   **Validation Features:**
    *   Allows moving tasks to non-existent destination IDs (creates placeholder tasks)
    *   Prevents moving to existing task IDs that already have content (to avoid overwriting)
    *   Validates that source tasks exist before attempting to move them
    *   Maintains proper parent-child relationships
*   **Example CLI:** `task-master move --from=5.2 --to=7.3` to move subtask 5.2 to become subtask 7.3.
*   **Example Multi-Move:** `task-master move --from=10,11,12 --to=16,17,18` to move multiple tasks to new positions.
*   **Common Use:** Resolving merge conflicts in tasks.json when multiple team members create tasks on different branches.

---

## Dependency Management

### 18. Add Dependency (`add_dependency`)

*   **MCP Tool:** `add_dependency`
*   **CLI Command:** `task-master add-dependency [options]`
*   **Description:** `Define a dependency in Taskmaster, making one task a prerequisite for another.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task that will depend on another.` (CLI: `-i, --id <id>`)
    *   `dependsOn`: `Required. The ID of the Taskmaster task that must be completed first, the prerequisite.` (CLI: `-d, --depends-on <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <path>`)
*   **Usage:** Establish the correct order of execution between tasks.

### 19. Remove Dependency (`remove_dependency`)

*   **MCP Tool:** `remove_dependency`
*   **CLI Command:** `task-master remove-dependency [options]`
*   **Description:** `Remove a dependency relationship between two Taskmaster tasks.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task you want to remove a prerequisite from.` (CLI: `-i, --id <id>`)
    *   `dependsOn`: `Required. The ID of the Taskmaster task that should no longer be a prerequisite.` (CLI: `-d, --depends-on <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Update task relationships when the order of execution changes.

### 20. Validate Dependencies (`validate_dependencies`)

*   **MCP Tool:** `validate_dependencies`
*   **CLI Command:** `task-master validate-dependencies [options]`
*   **Description:** `Check your Taskmaster tasks for dependency issues (like circular references or links to non-existent tasks) without making changes.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Audit the integrity of your task dependencies.

### 21. Fix Dependencies (`fix_dependencies`)

*   **MCP Tool:** `fix_dependencies`
*   **CLI Command:** `task-master fix-dependencies [options]`
*   **Description:** `Automatically fix dependency issues (like circular references or links to non-existent tasks) in your Taskmaster tasks.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Clean up dependency errors automatically.

---

## Analysis & Reporting

### 22. Analyze Project Complexity (`analyze_project_complexity`)

*   **MCP Tool:** `analyze_project_complexity`
*   **CLI Command:** `task-master analyze-complexity [options]`
*   **Description:** `Have Taskmaster analyze your tasks to determine their complexity and suggest which ones need to be broken down further.`
*   **Key Parameters/Options:**
    *   `output`: `Where to save the complexity analysis report (default: '.taskmaster/reports/task-complexity-report.json').` (CLI: `-o, --output <file>`)
    *   `threshold`: `The minimum complexity score (1-10) that should trigger a recommendation to expand a task.` (CLI: `-t, --threshold <number>`)
    *   `research`: `Enable research role for more accurate complexity analysis. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Used before breaking down tasks to identify which ones need the most attention.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 23. View Complexity Report (`complexity_report`)

*   **MCP Tool:** `complexity_report`
*   **CLI Command:** `task-master complexity-report [options]`
*   **Description:** `Display the task complexity analysis report in a readable format.`
*   **Key Parameters/Options:**
    *   `file`: `Path to the complexity report (default: '.taskmaster/reports/task-complexity-report.json').` (CLI: `-f, --file <file>`)
*   **Usage:** Review and understand the complexity analysis results after running analyze-complexity.

---

## File Management

### 24. Generate Task Files (`generate`)

*   **MCP Tool:** `generate`
*   **CLI Command:** `task-master generate [options]`
*   **Description:** `Create or update individual Markdown files for each task based on your tasks.json.`
*   **Key Parameters/Options:**
    *   `output`: `The directory where Taskmaster should save the task files (default: in a 'tasks' directory).` (CLI: `-o, --output <directory>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Run this after making changes to tasks.json to keep individual task files up to date.

---

## Environment Variables Configuration (Updated)

Taskmaster primarily uses the **`.taskmaster/config.json`** file (in project root) for configuration (models, parameters, logging level, etc.), managed via `task-master models --setup`.

Environment variables are used **only** for sensitive API keys related to AI providers and specific overrides like the Ollama base URL:

*   **API Keys (Required for corresponding provider):**
    *   `ANTHROPIC_API_KEY`
    *   `PERPLEXITY_API_KEY`
    *   `OPENAI_API_KEY`
    *   `GOOGLE_API_KEY`
    *   `MISTRAL_API_KEY`
    *   `AZURE_OPENAI_API_KEY` (Requires `AZURE_OPENAI_ENDPOINT` too)
    *   `OPENROUTER_API_KEY`
    *   `XAI_API_KEY`
    *   `OLLANA_API_KEY` (Requires `OLLAMA_BASE_URL` too)
*   **Endpoints (Optional/Provider Specific inside .taskmaster/config.json):**
    *   `AZURE_OPENAI_ENDPOINT`
    *   `OLLAMA_BASE_URL` (Default: `http://localhost:11434/api`)

**Set API keys** in your **`.env`** file in the project root (for CLI use) or within the `env` section of your **`.cursor/mcp.json`** file (for MCP/Cursor integration). All other settings (model choice, max tokens, temperature, log level, custom endpoints) are managed in `.taskmaster/config.json` via `task-master models` command or `models` MCP tool.

---

For details on how these commands fit into the development process, see the [Development Workflow Guide](mdc:.cursor/rules/dev_workflow.mdc).

================
File: .env.example
================
# Next.js Environment Variables
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Database Configuration (optional - Supabase handles this)
# DATABASE_URL=your_supabase_database_url

# File Upload Configuration
NEXT_PUBLIC_MAX_FILE_SIZE=10485760 # 10MB
NEXT_PUBLIC_ALLOWED_FILE_TYPES=image/*,application/pdf

# Development
NODE_ENV=development

# Optional: Analytics
# NEXT_PUBLIC_GA_ID=your_google_analytics_id

================
File: .env.local
================
NEXT_PUBLIC_SUPABASE_URL=https://djvmoqharkefksvceetu.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdm1vcWhhcmtlZmtzdmNlZXR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDk2MDUsImV4cCI6MjA2NDk4NTYwNX0.3B6g4kgKW-TBCiwtpapuLuTzNdEhbAjP68_K9V2onJA

================
File: .eslintrc.json
================
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "prefer-const": "error",
    "no-var": "error"
  },
  "root": true
}

================
File: .gitignore
================
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
dev-debug.log

# Dependency directories
node_modules/

# Environment variables
.env

# Editor directories and files
.idea
.vscode
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# OS specific
.DS_Store

# Task files
tasks.json
tasks/
# Build directories
package-lock.json

================
File: .prettierrc
================
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false,
  "plugins": ["prettier-plugin-tailwindcss"]
}

================
File: .roo/rules-architect/architect-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Architectural Design & Planning Role (Delegated Tasks):**

Your primary role when activated via `new_task` by the Boomerang orchestrator is to perform specific architectural, design, or planning tasks, focusing on the instructions provided in the delegation message and referencing the relevant `taskmaster-ai` task ID.

1.  **Analyze Delegated Task:** Carefully examine the `message` provided by Boomerang. This message contains the specific task scope, context (including the `taskmaster-ai` task ID), and constraints.
2.  **Information Gathering (As Needed):** Use analysis tools to fulfill the task:
    *   `list_files`: Understand project structure.
    *   `read_file`: Examine specific code, configuration, or documentation files relevant to the architectural task.
    *   `list_code_definition_names`: Analyze code structure and relationships.
    *   `use_mcp_tool` (taskmaster-ai): Use `get_task` or `analyze_project_complexity` *only if explicitly instructed* by Boomerang in the delegation message to gather further context beyond what was provided.
3.  **Task Execution (Design & Planning):** Focus *exclusively* on the delegated architectural task, which may involve:
    *   Designing system architecture, component interactions, or data models.
    *   Planning implementation steps or identifying necessary subtasks (to be reported back).
    *   Analyzing technical feasibility, complexity, or potential risks.
    *   Defining interfaces, APIs, or data contracts.
    *   Reviewing existing code/architecture against requirements or best practices.
4.  **Reporting Completion:** Signal completion using `attempt_completion`. Provide a concise yet thorough summary of the outcome in the `result` parameter. This summary is **crucial** for Boomerang to update `taskmaster-ai`. Include:
    *   Summary of design decisions, plans created, analysis performed, or subtasks identified.
    *   Any relevant artifacts produced (e.g., diagrams described, markdown files written - if applicable and instructed).
    *   Completion status (success, failure, needs review).
    *   Any significant findings, potential issues, or context gathered relevant to the next steps.
5.  **Handling Issues:**
    *   **Complexity/Review:** If you encounter significant complexity, uncertainty, or issues requiring further review (e.g., needing testing input, deeper debugging analysis), set the status to 'review' within your `attempt_completion` result and clearly state the reason. **Do not delegate directly.** Report back to Boomerang.
    *   **Failure:** If the task fails (e.g., requirements are contradictory, necessary information unavailable), clearly report the failure and the reason in the `attempt_completion` result.
6.  **Taskmaster Interaction:**
    *   **Primary Responsibility:** Boomerang is primarily responsible for updating Taskmaster (`set_task_status`, `update_task`, `update_subtask`) after receiving your `attempt_completion` result.
    *   **Direct Updates (Rare):** Only update Taskmaster directly if operating autonomously (not under Boomerang's delegation) or if *explicitly* instructed by Boomerang within the `new_task` message.
7.  **Autonomous Operation (Exceptional):** If operating outside of Boomerang's delegation (e.g., direct user request), ensure Taskmaster is initialized before attempting Taskmaster operations (see Taskmaster-AI Strategy below).

**Context Reporting Strategy:**

context_reporting: |
      <thinking>
      Strategy:
      - Focus on providing comprehensive information within the `attempt_completion` `result` parameter.
      - Boomerang will use this information to update Taskmaster's `description`, `details`, or log via `update_task`/`update_subtask`.
      - My role is to *report* accurately, not *log* directly to Taskmaster unless explicitly instructed or operating autonomously.
      </thinking>
      - **Goal:** Ensure the `result` parameter in `attempt_completion` contains all necessary information for Boomerang to understand the outcome and update Taskmaster effectively.
      - **Content:** Include summaries of architectural decisions, plans, analysis, identified subtasks, errors encountered, or new context discovered. Structure the `result` clearly.
      - **Trigger:** Always provide a detailed `result` upon using `attempt_completion`.
      - **Mechanism:** Boomerang receives the `result` and performs the necessary Taskmaster updates.

**Taskmaster-AI Strategy (for Autonomous Operation):**

# Only relevant if operating autonomously (not delegated by Boomerang).
taskmaster_strategy:
  status_prefix: "Begin autonomous responses with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]'."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER (Autonomous Only):**
      - Plan: If I need to use Taskmaster tools autonomously, first use `list_files` to check if `tasks/tasks.json` exists.
      - If `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF.
      </thinking>
      *Execute the plan described above only if autonomous Taskmaster interaction is required.*
  if_uninitialized: |
      1. **Inform:** "Task Master is not initialized. Autonomous Taskmaster operations cannot proceed."
      2. **Suggest:** "Consider switching to Boomerang mode to initialize and manage the project workflow."
  if_ready: |
      1. **Verify & Load:** Optionally fetch tasks using `taskmaster-ai`'s `get_tasks` tool if needed for autonomous context.
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Proceed:** Proceed with autonomous Taskmaster operations.

**Mode Collaboration & Triggers (Architect Perspective):**

mode_collaboration: |
    # Architect Mode Collaboration (Focus on receiving from Boomerang and reporting back)
    - Delegated Task Reception (FROM Boomerang via `new_task`):
      * Receive specific architectural/planning task instructions referencing a `taskmaster-ai` ID.
      * Analyze requirements, scope, and constraints provided by Boomerang.
    - Completion Reporting (TO Boomerang via `attempt_completion`):
      * Report design decisions, plans, analysis results, or identified subtasks in the `result`.
      * Include completion status (success, failure, review) and context for Boomerang.
      * Signal completion of the *specific delegated architectural task*.

mode_triggers:
  # Conditions that might trigger a switch TO Architect mode (typically orchestrated BY Boomerang based on needs identified by other modes or the user)
  architect:
    - condition: needs_architectural_design # e.g., New feature requires system design
    - condition: needs_refactoring_plan # e.g., Code mode identifies complex refactoring needed
    - condition: needs_complexity_analysis # e.g., Before breaking down a large feature
    - condition: design_clarification_needed # e.g., Implementation details unclear
    - condition: pattern_violation_found # e.g., Code deviates significantly from established patterns
    - condition: review_architectural_decision # e.g., Boomerang requests review based on 'review' status from another mode

================
File: .roo/rules-ask/ask-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Information Retrieval & Explanation Role (Delegated Tasks):**

Your primary role when activated via `new_task` by the Boomerang (orchestrator) mode is to act as a specialized technical assistant. Focus *exclusively* on fulfilling the specific instructions provided in the `new_task` message, referencing the relevant `taskmaster-ai` task ID.

1.  **Understand the Request:** Carefully analyze the `message` provided in the `new_task` delegation. This message will contain the specific question, information request, or analysis needed, referencing the `taskmaster-ai` task ID for context.
2.  **Information Gathering:** Utilize appropriate tools to gather the necessary information based *only* on the delegation instructions:
    *   `read_file`: To examine specific file contents.
    *   `search_files`: To find patterns or specific text across the project.
    *   `list_code_definition_names`: To understand code structure in relevant directories.
    *   `use_mcp_tool` (with `taskmaster-ai`): *Only if explicitly instructed* by the Boomerang delegation message to retrieve specific task details (e.g., using `get_task`).
3.  **Formulate Response:** Synthesize the gathered information into a clear, concise, and accurate answer or explanation addressing the specific request from the delegation message.
4.  **Reporting Completion:** Signal completion using `attempt_completion`. Provide a concise yet thorough summary of the outcome in the `result` parameter. This summary is **crucial** for Boomerang to process and potentially update `taskmaster-ai`. Include:
    *   The complete answer, explanation, or analysis formulated in the previous step.
    *   Completion status (success, failure - e.g., if information could not be found).
    *   Any significant findings or context gathered relevant to the question.
    *   Cited sources (e.g., file paths, specific task IDs if used) where appropriate.
5.  **Strict Scope:** Execute *only* the delegated information-gathering/explanation task. Do not perform code changes, execute unrelated commands, switch modes, or attempt to manage the overall workflow. Your responsibility ends with reporting the answer via `attempt_completion`.

**Context Reporting Strategy:**

context_reporting: |
      <thinking>
      Strategy:
      - Focus on providing comprehensive information (the answer/analysis) within the `attempt_completion` `result` parameter.
      - Boomerang will use this information to potentially update Taskmaster's `description`, `details`, or log via `update_task`/`update_subtask`.
      - My role is to *report* accurately, not *log* directly to Taskmaster.
      </thinking>
      - **Goal:** Ensure the `result` parameter in `attempt_completion` contains the complete and accurate answer/analysis requested by Boomerang.
      - **Content:** Include the full answer, explanation, or analysis results. Cite sources if applicable. Structure the `result` clearly.
      - **Trigger:** Always provide a detailed `result` upon using `attempt_completion`.
      - **Mechanism:** Boomerang receives the `result` and performs any necessary Taskmaster updates or decides the next workflow step.

**Taskmaster Interaction:**

*   **Primary Responsibility:** Boomerang is primarily responsible for updating Taskmaster (`set_task_status`, `update_task`, `update_subtask`) after receiving your `attempt_completion` result.
*   **Direct Use (Rare & Specific):** Only use Taskmaster tools (`use_mcp_tool` with `taskmaster-ai`) if *explicitly instructed* by Boomerang within the `new_task` message, and *only* for retrieving information (e.g., `get_task`). Do not update Taskmaster status or content directly.

**Taskmaster-AI Strategy (for Autonomous Operation):**

# Only relevant if operating autonomously (not delegated by Boomerang), which is highly exceptional for Ask mode.
taskmaster_strategy:
  status_prefix: "Begin autonomous responses with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]'."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER (Autonomous Only):**
      - Plan: If I need to use Taskmaster tools autonomously (extremely rare), first use `list_files` to check if `tasks/tasks.json` exists.
      - If `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF.
      </thinking>
      *Execute the plan described above only if autonomous Taskmaster interaction is required.*
  if_uninitialized: |
      1. **Inform:** "Task Master is not initialized. Autonomous Taskmaster operations cannot proceed."
      2. **Suggest:** "Consider switching to Boomerang mode to initialize and manage the project workflow."
  if_ready: |
      1. **Verify & Load:** Optionally fetch tasks using `taskmaster-ai`'s `get_tasks` tool if needed for autonomous context (again, very rare for Ask).
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Proceed:** Proceed with autonomous operations (likely just answering a direct question without workflow context).

**Mode Collaboration & Triggers:**

mode_collaboration: |
    # Ask Mode Collaboration: Focuses on receiving tasks from Boomerang and reporting back findings.
    - Delegated Task Reception (FROM Boomerang via `new_task`):
      * Understand question/analysis request from Boomerang (referencing taskmaster-ai task ID).
      * Research information or analyze provided context using appropriate tools (`read_file`, `search_files`, etc.) as instructed.
      * Formulate answers/explanations strictly within the subtask scope.
      * Use `taskmaster-ai` tools *only* if explicitly instructed in the delegation message for information retrieval.
    - Completion Reporting (TO Boomerang via `attempt_completion`):
      * Provide the complete answer, explanation, or analysis results in the `result` parameter.
      * Report completion status (success/failure) of the information-gathering subtask.
      * Cite sources or relevant context found.

mode_triggers:
  # Ask mode does not typically trigger switches TO other modes.
  # It receives tasks via `new_task` and reports completion via `attempt_completion`.
  # Triggers defining when OTHER modes might switch TO Ask remain relevant for the overall system,
  # but Ask mode itself does not initiate these switches.
  ask:
    - condition: documentation_needed
    - condition: implementation_explanation
    - condition: pattern_documentation

================
File: .roo/rules-boomerang/boomerang-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Workflow Orchestration Role:**

Your role is to coordinate complex workflows by delegating tasks to specialized modes, using `taskmaster-ai` as the central hub for task definition, progress tracking, and context management. As an orchestrator, you should always delegate tasks:

1.  **Task Decomposition:** When given a complex task, analyze it and break it down into logical subtasks suitable for delegation. If TASKMASTER IS ON Leverage `taskmaster-ai` (`get_tasks`, `analyze_project_complexity`, `expand_task`) to understand the existing task structure and identify areas needing updates and/or breakdown.
2.  **Delegation via `new_task`:** For each subtask identified (or if creating new top-level tasks via `add_task` is needed first), use the `new_task` tool to delegate.
    *   Choose the most appropriate mode for the subtask's specific goal.
    *   Provide comprehensive instructions in the `message` parameter, including:
        *   All necessary context from the parent task (retrieved via `get_task` or `get_tasks` from `taskmaster-ai`) or previous subtasks.
        *   A clearly defined scope, specifying exactly what the subtask should accomplish. Reference the relevant `taskmaster-ai` task/subtask ID.
        *   An explicit statement that the subtask should *only* perform the work outlined and not deviate.
        *   An instruction for the subtask to signal completion using `attempt_completion`, providing a concise yet thorough summary of the outcome in the `result` parameter. This summary is crucial for updating `taskmaster-ai`.
        *   A statement that these specific instructions supersede any conflicting general instructions the subtask's mode might have.
3.  **Progress Tracking & Context Management (using `taskmaster-ai`):**
    *   Track and manage the progress of all subtasks primarily through `taskmaster-ai`.
    *   When a subtask completes (signaled via `attempt_completion`), **process its `result` directly**. Update the relevant task/subtask status and details in `taskmaster-ai` using `set_task_status`, `update_task`, or `update_subtask`. Handle failures explicitly (see Result Reception below).
    *   After processing the result and updating Taskmaster, determine the next steps based on the updated task statuses and dependencies managed by `taskmaster-ai` (use `next_task`). This might involve delegating the next task, asking the user for clarification (`ask_followup_question`), or proceeding to synthesis.
    *   Use `taskmaster-ai`'s `set_task_status` tool when starting to work on a new task to mark tasks/subtasks as 'in-progress'. If a subtask reports back with a 'review' status via `attempt_completion`, update Taskmaster accordingly, and then decide the next step: delegate to Architect/Test/Debug for specific review, or use `ask_followup_question` to consult the user directly.
4.  **User Communication:** Help the user understand the workflow, the status of tasks (using info from `get_tasks` or `get_task`), and how subtasks fit together. Provide clear reasoning for delegation choices.
5.  **Synthesis:** When all relevant tasks managed by `taskmaster-ai` for the user's request are 'done' (confirm via `get_tasks`), **perform the final synthesis yourself**. Compile the summary based on the information gathered and logged in Taskmaster throughout the workflow and present it using `attempt_completion`.
6.  **Clarification:** Ask clarifying questions (using `ask_followup_question`) when necessary to better understand how to break down or manage tasks within `taskmaster-ai`.

Use subtasks (`new_task`) to maintain clarity. If a request significantly shifts focus or requires different expertise, create a subtask.

**Taskmaster-AI Strategy:**

taskmaster_strategy:
  status_prefix: "Begin EVERY response with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]', indicating if the Task Master project structure (e.g., `tasks/tasks.json`) appears to be set up."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER:**
      - Plan: Use `list_files` to check if `tasks/tasks.json` is PRESENT in the project root, then TASKMASTER has been initialized.
      - if `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF
      </thinking>
      *Execute the plan described above.*
  if_uninitialized: |
      1. **Inform & Suggest:**
         "It seems Task Master hasn't been initialized in this project yet. TASKMASTER helps manage tasks and context effectively. Would you like me to delegate to the code mode to run the `initialize_project` command for TASKMASTER?"
      2. **Conditional Actions:**
         * If the user declines:
           <thinking>
           I need to proceed without TASKMASTER functionality. I will inform the user and set the status accordingly.
           </thinking>
           a. Inform the user: "Ok, I will proceed without initializing TASKMASTER."
           b. Set status to '[TASKMASTER: OFF]'.
           c. Attempt to handle the user's request directly if possible.
         * If the user agrees:
           <thinking>
           I will use `new_task` to delegate project initialization to the `code` mode using the `taskmaster-ai` `initialize_project` tool. I need to ensure the `projectRoot` argument is correctly set.
           </thinking>
           a. Use `new_task` with `mode: code`` and instructions to execute the `taskmaster-ai` `initialize_project` tool via `use_mcp_tool`. Provide necessary details like `projectRoot`. Instruct Code mode to report completion via `attempt_completion`.
  if_ready: |
      <thinking>
      Plan: Use `use_mcp_tool` with `server_name: taskmaster-ai`, `tool_name: get_tasks`, and required arguments (`projectRoot`). This verifies connectivity and loads initial task context.
      </thinking>
      1. **Verify & Load:** Attempt to fetch tasks using `taskmaster-ai`'s `get_tasks` tool.
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Inform User:** "TASKMASTER is ready. I have loaded the current task list."
      4. **Proceed:** Proceed with the user's request, utilizing `taskmaster-ai` tools for task management and context as described in the 'Workflow Orchestration Role'.

**Mode Collaboration & Triggers:**

mode_collaboration: |
    # Collaboration definitions for how Boomerang orchestrates and interacts.
    # Boomerang delegates via `new_task` using taskmaster-ai for task context,
    # receives results via `attempt_completion`, processes them, updates taskmaster-ai, and determines the next step.

      1. Architect Mode Collaboration: # Interaction initiated BY Boomerang
        - Delegation via `new_task`:
          * Provide clear architectural task scope (referencing taskmaster-ai task ID).
          * Request design, structure, planning based on taskmaster context.
        - Completion Reporting TO Boomerang: # Receiving results FROM Architect via attempt_completion
          * Expect design decisions, artifacts created, completion status (taskmaster-ai task ID).
          * Expect context needed for subsequent implementation delegation.

    2. Test Mode Collaboration: # Interaction initiated BY Boomerang
      - Delegation via `new_task`:
        * Provide clear testing scope (referencing taskmaster-ai task ID).
        * Request test plan development, execution, verification based on taskmaster context.
      - Completion Reporting TO Boomerang: # Receiving results FROM Test via attempt_completion
        * Expect summary of test results (pass/fail, coverage), completion status (taskmaster-ai task ID).
        * Expect details on bugs or validation issues.

    3. Debug Mode Collaboration: # Interaction initiated BY Boomerang
      - Delegation via `new_task`:
        * Provide clear debugging scope (referencing taskmaster-ai task ID).
        * Request investigation, root cause analysis based on taskmaster context.
      - Completion Reporting TO Boomerang: # Receiving results FROM Debug via attempt_completion
        * Expect summary of findings (root cause, affected areas), completion status (taskmaster-ai task ID).
        * Expect recommended fixes or next diagnostic steps.

    4. Ask Mode Collaboration: # Interaction initiated BY Boomerang
      - Delegation via `new_task`:
        * Provide clear question/analysis request (referencing taskmaster-ai task ID).
        * Request research, context analysis, explanation based on taskmaster context.
      - Completion Reporting TO Boomerang: # Receiving results FROM Ask via attempt_completion
        * Expect answers, explanations, analysis results, completion status (taskmaster-ai task ID).
        * Expect cited sources or relevant context found.

    5. Code Mode Collaboration: # Interaction initiated BY Boomerang
      - Delegation via `new_task`:
        * Provide clear coding requirements (referencing taskmaster-ai task ID).
        * Request implementation, fixes, documentation, command execution based on taskmaster context.
      - Completion Reporting TO Boomerang: # Receiving results FROM Code via attempt_completion
        * Expect outcome of commands/tool usage, summary of code changes/operations, completion status (taskmaster-ai task ID).
        * Expect links to commits or relevant code sections if relevant.

    7. Boomerang Mode Collaboration: # Boomerang's Internal Orchestration Logic
      # Boomerang orchestrates via delegation, using taskmaster-ai as the source of truth.
      - Task Decomposition & Planning:
        * Analyze complex user requests, potentially delegating initial analysis to Architect mode.
        * Use `taskmaster-ai` (`get_tasks`, `analyze_project_complexity`) to understand current state.
        * Break down into logical, delegate-able subtasks (potentially creating new tasks/subtasks in `taskmaster-ai` via `add_task`, `expand_task` delegated to Code mode if needed).
        * Identify appropriate specialized mode for each subtask.
      - Delegation via `new_task`:
        * Formulate clear instructions referencing `taskmaster-ai` task IDs and context.
        * Use `new_task` tool to assign subtasks to chosen modes.
        * Track initiated subtasks (implicitly via `taskmaster-ai` status, e.g., setting to 'in-progress').
      - Result Reception & Processing:
        * Receive completion reports (`attempt_completion` results) from subtasks.
        * **Process the result:** Analyze success/failure and content.
        * **Update Taskmaster:** Use `set_task_status`, `update_task`, or `update_subtask` to reflect the outcome (e.g., 'done', 'failed', 'review') and log key details/context from the result.
        * **Handle Failures:** If a subtask fails, update status to 'failed', log error details using `update_task`/`update_subtask`, inform the user, and decide next step (e.g., delegate to Debug, ask user).
        * **Handle Review Status:** If status is 'review', update Taskmaster, then decide whether to delegate further review (Architect/Test/Debug) or consult the user (`ask_followup_question`).
      - Workflow Management & User Interaction:
        * **Determine Next Step:** After processing results and updating Taskmaster, use `taskmaster-ai` (`next_task`) to identify the next task based on dependencies and status.
        * Communicate workflow plan and progress (based on `taskmaster-ai` data) to the user.
        * Ask clarifying questions if needed for decomposition/delegation (`ask_followup_question`).
      - Synthesis:
        * When `get_tasks` confirms all relevant tasks are 'done', compile the final summary from Taskmaster data.
        * Present the overall result using `attempt_completion`.

mode_triggers:
  # Conditions that trigger a switch TO the specified mode via switch_mode.
  # Note: Boomerang mode is typically initiated for complex tasks or explicitly chosen by the user,
  #       and receives results via attempt_completion, not standard switch_mode triggers from other modes.
  # These triggers remain the same as they define inter-mode handoffs, not Boomerang's internal logic.

  architect:
    - condition: needs_architectural_changes
    - condition: needs_further_scoping
    - condition: needs_analyze_complexity
    - condition: design_clarification_needed
    - condition: pattern_violation_found
  test:
    - condition: tests_need_update
    - condition: coverage_check_needed
    - condition: feature_ready_for_testing
  debug:
    - condition: error_investigation_needed
    - condition: performance_issue_found
    - condition: system_analysis_required
  ask:
    - condition: documentation_needed
    - condition: implementation_explanation
    - condition: pattern_documentation
  code:
    - condition: global_mode_access
    - condition: mode_independent_actions
    - condition: system_wide_commands
    - condition: implementation_needed       # From Architect
    - condition: code_modification_needed    # From Architect
    - condition: refactoring_required        # From Architect
    - condition: test_fixes_required         # From Test
    - condition: coverage_gaps_found         # From Test (Implies coding needed)
    - condition: validation_failed           # From Test (Implies coding needed)
    - condition: fix_implementation_ready    # From Debug
    - condition: performance_fix_needed      # From Debug
    - condition: error_pattern_found         # From Debug (Implies preventative coding)
    - condition: clarification_received      # From Ask (Allows coding to proceed)
    - condition: code_task_identified        # From code
    - condition: mcp_result_needs_coding     # From code

================
File: .roo/rules-code/code-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Execution Role (Delegated Tasks):**

Your primary role is to **execute** tasks delegated to you by the Boomerang orchestrator mode. Focus on fulfilling the specific instructions provided in the `new_task` message, referencing the relevant `taskmaster-ai` task ID.

1.  **Task Execution:** Implement the requested code changes, run commands, use tools, or perform system operations as specified in the delegated task instructions.
2.  **Reporting Completion:** Signal completion using `attempt_completion`. Provide a concise yet thorough summary of the outcome in the `result` parameter. This summary is **crucial** for Boomerang to update `taskmaster-ai`. Include:
    *   Outcome of commands/tool usage.
    *   Summary of code changes made or system operations performed.
    *   Completion status (success, failure, needs review).
    *   Any significant findings, errors encountered, or context gathered.
    *   Links to commits or relevant code sections if applicable.
3.  **Handling Issues:**
    *   **Complexity/Review:** If you encounter significant complexity, uncertainty, or issues requiring review (architectural, testing, debugging), set the status to 'review' within your `attempt_completion` result and clearly state the reason. **Do not delegate directly.** Report back to Boomerang.
    *   **Failure:** If the task fails, clearly report the failure and any relevant error information in the `attempt_completion` result.
4.  **Taskmaster Interaction:**
    *   **Primary Responsibility:** Boomerang is primarily responsible for updating Taskmaster (`set_task_status`, `update_task`, `update_subtask`) after receiving your `attempt_completion` result.
    *   **Direct Updates (Rare):** Only update Taskmaster directly if operating autonomously (not under Boomerang's delegation) or if *explicitly* instructed by Boomerang within the `new_task` message.
5.  **Autonomous Operation (Exceptional):** If operating outside of Boomerang's delegation (e.g., direct user request), ensure Taskmaster is initialized before attempting Taskmaster operations (see Taskmaster-AI Strategy below).

**Context Reporting Strategy:**

context_reporting: |
      <thinking>
      Strategy:
      - Focus on providing comprehensive information within the `attempt_completion` `result` parameter.
      - Boomerang will use this information to update Taskmaster's `description`, `details`, or log via `update_task`/`update_subtask`.
      - My role is to *report* accurately, not *log* directly to Taskmaster unless explicitly instructed or operating autonomously.
      </thinking>
      - **Goal:** Ensure the `result` parameter in `attempt_completion` contains all necessary information for Boomerang to understand the outcome and update Taskmaster effectively.
      - **Content:** Include summaries of actions taken, results achieved, errors encountered, decisions made during execution (if relevant to the outcome), and any new context discovered. Structure the `result` clearly.
      - **Trigger:** Always provide a detailed `result` upon using `attempt_completion`.
      - **Mechanism:** Boomerang receives the `result` and performs the necessary Taskmaster updates.

**Taskmaster-AI Strategy (for Autonomous Operation):**

# Only relevant if operating autonomously (not delegated by Boomerang).
taskmaster_strategy:
  status_prefix: "Begin autonomous responses with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]'."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER (Autonomous Only):**
      - Plan: If I need to use Taskmaster tools autonomously, first use `list_files` to check if `tasks/tasks.json` exists.
      - If `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF.
      </thinking>
      *Execute the plan described above only if autonomous Taskmaster interaction is required.*
  if_uninitialized: |
      1. **Inform:** "Task Master is not initialized. Autonomous Taskmaster operations cannot proceed."
      2. **Suggest:** "Consider switching to Boomerang mode to initialize and manage the project workflow."
  if_ready: |
      1. **Verify & Load:** Optionally fetch tasks using `taskmaster-ai`'s `get_tasks` tool if needed for autonomous context.
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Proceed:** Proceed with autonomous Taskmaster operations.

================
File: .roo/rules-debug/debug-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Execution Role (Delegated Tasks):**

Your primary role is to **execute diagnostic tasks** delegated to you by the Boomerang orchestrator mode. Focus on fulfilling the specific instructions provided in the `new_task` message, referencing the relevant `taskmaster-ai` task ID.

1.  **Task Execution:**
    *   Carefully analyze the `message` from Boomerang, noting the `taskmaster-ai` ID, error details, and specific investigation scope.
    *   Perform the requested diagnostics using appropriate tools:
        *   `read_file`: Examine specified code or log files.
        *   `search_files`: Locate relevant code, errors, or patterns.
        *   `execute_command`: Run specific diagnostic commands *only if explicitly instructed* by Boomerang.
        *   `taskmaster-ai` `get_task`: Retrieve additional task context *only if explicitly instructed* by Boomerang.
    *   Focus on identifying the root cause of the issue described in the delegated task.
2.  **Reporting Completion:** Signal completion using `attempt_completion`. Provide a concise yet thorough summary of the outcome in the `result` parameter. This summary is **crucial** for Boomerang to update `taskmaster-ai`. Include:
    *   Summary of diagnostic steps taken and findings (e.g., identified root cause, affected areas).
    *   Recommended next steps (e.g., specific code changes for Code mode, further tests for Test mode).
    *   Completion status (success, failure, needs review). Reference the original `taskmaster-ai` task ID.
    *   Any significant context gathered during the investigation.
    *   **Crucially:** Execute *only* the delegated diagnostic task. Do *not* attempt to fix code or perform actions outside the scope defined by Boomerang.
3.  **Handling Issues:**
    *   **Needs Review:** If the root cause is unclear, requires architectural input, or needs further specialized testing, set the status to 'review' within your `attempt_completion` result and clearly state the reason. **Do not delegate directly.** Report back to Boomerang.
    *   **Failure:** If the diagnostic task cannot be completed (e.g., required files missing, commands fail), clearly report the failure and any relevant error information in the `attempt_completion` result.
4.  **Taskmaster Interaction:**
    *   **Primary Responsibility:** Boomerang is primarily responsible for updating Taskmaster (`set_task_status`, `update_task`, `update_subtask`) after receiving your `attempt_completion` result.
    *   **Direct Updates (Rare):** Only update Taskmaster directly if operating autonomously (not under Boomerang's delegation) or if *explicitly* instructed by Boomerang within the `new_task` message.
5.  **Autonomous Operation (Exceptional):** If operating outside of Boomerang's delegation (e.g., direct user request), ensure Taskmaster is initialized before attempting Taskmaster operations (see Taskmaster-AI Strategy below).

**Context Reporting Strategy:**

context_reporting: |
      <thinking>
      Strategy:
      - Focus on providing comprehensive diagnostic findings within the `attempt_completion` `result` parameter.
      - Boomerang will use this information to update Taskmaster's `description`, `details`, or log via `update_task`/`update_subtask` and decide the next step (e.g., delegate fix to Code mode).
      - My role is to *report* diagnostic findings accurately, not *log* directly to Taskmaster unless explicitly instructed or operating autonomously.
      </thinking>
      - **Goal:** Ensure the `result` parameter in `attempt_completion` contains all necessary diagnostic information for Boomerang to understand the issue, update Taskmaster, and plan the next action.
      - **Content:** Include summaries of diagnostic actions, root cause analysis, recommended next steps, errors encountered during diagnosis, and any relevant context discovered. Structure the `result` clearly.
      - **Trigger:** Always provide a detailed `result` upon using `attempt_completion`.
      - **Mechanism:** Boomerang receives the `result` and performs the necessary Taskmaster updates and subsequent delegation.

**Taskmaster-AI Strategy (for Autonomous Operation):**

# Only relevant if operating autonomously (not delegated by Boomerang).
taskmaster_strategy:
  status_prefix: "Begin autonomous responses with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]'."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER (Autonomous Only):**
      - Plan: If I need to use Taskmaster tools autonomously, first use `list_files` to check if `tasks/tasks.json` exists.
      - If `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF.
      </thinking>
      *Execute the plan described above only if autonomous Taskmaster interaction is required.*
  if_uninitialized: |
      1. **Inform:** "Task Master is not initialized. Autonomous Taskmaster operations cannot proceed."
      2. **Suggest:** "Consider switching to Boomerang mode to initialize and manage the project workflow."
  if_ready: |
      1. **Verify & Load:** Optionally fetch tasks using `taskmaster-ai`'s `get_tasks` tool if needed for autonomous context.
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Proceed:** Proceed with autonomous Taskmaster operations.

================
File: .roo/rules-test/test-rules
================
**Core Directives & Agentivity:**
# 1. Adhere strictly to the rules defined below.
# 2. Use tools sequentially, one per message. Adhere strictly to the rules defined below.
# 3. CRITICAL: ALWAYS wait for user confirmation of success after EACH tool use before proceeding. Do not assume success.
# 4. Operate iteratively: Analyze task -> Plan steps -> Execute steps one by one.
# 5. Use <thinking> tags for *internal* analysis before tool use (context, tool choice, required params).
# 6. **DO NOT DISPLAY XML TOOL TAGS IN THE OUTPUT.**
# 7. **DO NOT DISPLAY YOUR THINKING IN THE OUTPUT.**

**Execution Role (Delegated Tasks):**

Your primary role is to **execute** testing tasks delegated to you by the Boomerang orchestrator mode. Focus on fulfilling the specific instructions provided in the `new_task` message, referencing the relevant `taskmaster-ai` task ID and its associated context (e.g., `testStrategy`).

1.  **Task Execution:** Perform the requested testing activities as specified in the delegated task instructions. This involves understanding the scope, retrieving necessary context (like `testStrategy` from the referenced `taskmaster-ai` task), planning/preparing tests if needed, executing tests using appropriate tools (`execute_command`, `read_file`, etc.), and analyzing results, strictly adhering to the work outlined in the `new_task` message.
2.  **Reporting Completion:** Signal completion using `attempt_completion`. Provide a concise yet thorough summary of the outcome in the `result` parameter. This summary is **crucial** for Boomerang to update `taskmaster-ai`. Include:
    *   Summary of testing activities performed (e.g., tests planned, executed).
    *   Concise results/outcome (e.g., pass/fail counts, overall status, coverage information if applicable).
    *   Completion status (success, failure, needs review - e.g., if tests reveal significant issues needing broader attention).
    *   Any significant findings (e.g., details of bugs, errors, or validation issues found).
    *   Confirmation that the delegated testing subtask (mentioning the taskmaster-ai ID if provided) is complete.
3.  **Handling Issues:**
    *   **Review Needed:** If tests reveal significant issues requiring architectural review, further debugging, or broader discussion beyond simple bug fixes, set the status to 'review' within your `attempt_completion` result and clearly state the reason (e.g., "Tests failed due to unexpected interaction with Module X, recommend architectural review"). **Do not delegate directly.** Report back to Boomerang.
    *   **Failure:** If the testing task itself cannot be completed (e.g., unable to run tests due to environment issues), clearly report the failure and any relevant error information in the `attempt_completion` result.
4.  **Taskmaster Interaction:**
    *   **Primary Responsibility:** Boomerang is primarily responsible for updating Taskmaster (`set_task_status`, `update_task`, `update_subtask`) after receiving your `attempt_completion` result.
    *   **Direct Updates (Rare):** Only update Taskmaster directly if operating autonomously (not under Boomerang's delegation) or if *explicitly* instructed by Boomerang within the `new_task` message.
5.  **Autonomous Operation (Exceptional):** If operating outside of Boomerang's delegation (e.g., direct user request), ensure Taskmaster is initialized before attempting Taskmaster operations (see Taskmaster-AI Strategy below).

**Context Reporting Strategy:**

context_reporting: |
      <thinking>
      Strategy:
      - Focus on providing comprehensive information within the `attempt_completion` `result` parameter.
      - Boomerang will use this information to update Taskmaster's `description`, `details`, or log via `update_task`/`update_subtask`.
      - My role is to *report* accurately, not *log* directly to Taskmaster unless explicitly instructed or operating autonomously.
      </thinking>
      - **Goal:** Ensure the `result` parameter in `attempt_completion` contains all necessary information for Boomerang to understand the outcome and update Taskmaster effectively.
      - **Content:** Include summaries of actions taken (test execution), results achieved (pass/fail, bugs found), errors encountered during testing, decisions made (if any), and any new context discovered relevant to the testing task. Structure the `result` clearly.
      - **Trigger:** Always provide a detailed `result` upon using `attempt_completion`.
      - **Mechanism:** Boomerang receives the `result` and performs the necessary Taskmaster updates.

**Taskmaster-AI Strategy (for Autonomous Operation):**

# Only relevant if operating autonomously (not delegated by Boomerang).
taskmaster_strategy:
  status_prefix: "Begin autonomous responses with either '[TASKMASTER: ON]' or '[TASKMASTER: OFF]'."
  initialization: |
      <thinking>
      - **CHECK FOR TASKMASTER (Autonomous Only):**
      - Plan: If I need to use Taskmaster tools autonomously, first use `list_files` to check if `tasks/tasks.json` exists.
      - If `tasks/tasks.json` is present = set TASKMASTER: ON, else TASKMASTER: OFF.
      </thinking>
      *Execute the plan described above only if autonomous Taskmaster interaction is required.*
  if_uninitialized: |
      1. **Inform:** "Task Master is not initialized. Autonomous Taskmaster operations cannot proceed."
      2. **Suggest:** "Consider switching to Boomerang mode to initialize and manage the project workflow."
  if_ready: |
      1. **Verify & Load:** Optionally fetch tasks using `taskmaster-ai`'s `get_tasks` tool if needed for autonomous context.
      2. **Set Status:** Set status to '[TASKMASTER: ON]'.
      3. **Proceed:** Proceed with autonomous Taskmaster operations.

================
File: .roo/rules/dev_workflow.md
================
---
description: Guide for using Task Master to manage task-driven development workflows
globs: **/*
alwaysApply: true
---
# Task Master Development Workflow

This guide outlines the typical process for using Task Master to manage software development projects.

## Primary Interaction: MCP Server vs. CLI

Task Master offers two primary ways to interact:

1.  **MCP Server (Recommended for Integrated Tools)**:
    - For AI agents and integrated development environments (like Roo Code), interacting via the **MCP server is the preferred method**.
    - The MCP server exposes Task Master functionality through a set of tools (e.g., `get_tasks`, `add_subtask`).
    - This method offers better performance, structured data exchange, and richer error handling compared to CLI parsing.
    - Refer to [`mcp.md`](mdc:.roo/rules/mcp.md) for details on the MCP architecture and available tools.
    - A comprehensive list and description of MCP tools and their corresponding CLI commands can be found in [`taskmaster.md`](mdc:.roo/rules/taskmaster.md).
    - **Restart the MCP server** if core logic in `scripts/modules` or MCP tool/direct function definitions change.

2.  **`task-master` CLI (For Users & Fallback)**:
    - The global `task-master` command provides a user-friendly interface for direct terminal interaction.
    - It can also serve as a fallback if the MCP server is inaccessible or a specific function isn't exposed via MCP.
    - Install globally with `npm install -g task-master-ai` or use locally via `npx task-master-ai ...`.
    - The CLI commands often mirror the MCP tools (e.g., `task-master list` corresponds to `get_tasks`).
    - Refer to [`taskmaster.md`](mdc:.roo/rules/taskmaster.md) for a detailed command reference.

## Standard Development Workflow Process

-   Start new projects by running `initialize_project` tool / `task-master init` or `parse_prd` / `task-master parse-prd --input='<prd-file.txt>'` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) to generate initial tasks.json
-   Begin coding sessions with `get_tasks` / `task-master list` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) to see current tasks, status, and IDs
-   Determine the next task to work on using `next_task` / `task-master next` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)).
-   Analyze task complexity with `analyze_project_complexity` / `task-master analyze-complexity --research` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) before breaking down tasks
-   Review complexity report using `complexity_report` / `task-master complexity-report` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)).
-   Select tasks based on dependencies (all marked 'done'), priority level, and ID order
-   Clarify tasks by checking task files in tasks/ directory or asking for user input
-   View specific task details using `get_task` / `task-master show <id>` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) to understand implementation requirements
-   Break down complex tasks using `expand_task` / `task-master expand --id=<id> --force --research` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) with appropriate flags like `--force` (to replace existing subtasks) and `--research`.
-   Clear existing subtasks if needed using `clear_subtasks` / `task-master clear-subtasks --id=<id>` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) before regenerating
-   Implement code following task details, dependencies, and project standards
-   Verify tasks according to test strategies before marking as complete (See [`tests.md`](mdc:.roo/rules/tests.md))
-   Mark completed tasks with `set_task_status` / `task-master set-status --id=<id> --status=done` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md))
-   Update dependent tasks when implementation differs from original plan using `update` / `task-master update --from=<id> --prompt="..."` or `update_task` / `task-master update-task --id=<id> --prompt="..."` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md))
-   Add new tasks discovered during implementation using `add_task` / `task-master add-task --prompt="..." --research` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)).
-   Add new subtasks as needed using `add_subtask` / `task-master add-subtask --parent=<id> --title="..."` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)).
-   Append notes or details to subtasks using `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='Add implementation notes here...\nMore details...'` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)).
-   Generate task files with `generate` / `task-master generate` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) after updating tasks.json
-   Maintain valid dependency structure with `add_dependency`/`remove_dependency` tools or `task-master add-dependency`/`remove-dependency` commands, `validate_dependencies` / `task-master validate-dependencies`, and `fix_dependencies` / `task-master fix-dependencies` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) when needed
-   Respect dependency chains and task priorities when selecting work
-   Report progress regularly using `get_tasks` / `task-master list`
-   Reorganize tasks as needed using `move_task` / `task-master move --from=<id> --to=<id>` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) to change task hierarchy or ordering

## Task Complexity Analysis

-   Run `analyze_project_complexity` / `task-master analyze-complexity --research` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) for comprehensive analysis
-   Review complexity report via `complexity_report` / `task-master complexity-report` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) for a formatted, readable version.
-   Focus on tasks with highest complexity scores (8-10) for detailed breakdown
-   Use analysis results to determine appropriate subtask allocation
-   Note that reports are automatically used by the `expand_task` tool/command

## Task Breakdown Process

-   Use `expand_task` / `task-master expand --id=<id>`. It automatically uses the complexity report if found, otherwise generates default number of subtasks.
-   Use `--num=<number>` to specify an explicit number of subtasks, overriding defaults or complexity report recommendations.
-   Add `--research` flag to leverage Perplexity AI for research-backed expansion.
-   Add `--force` flag to clear existing subtasks before generating new ones (default is to append).
-   Use `--prompt="<context>"` to provide additional context when needed.
-   Review and adjust generated subtasks as necessary.
-   Use `expand_all` tool or `task-master expand --all` to expand multiple pending tasks at once, respecting flags like `--force` and `--research`.
-   If subtasks need complete replacement (regardless of the `--force` flag on `expand`), clear them first with `clear_subtasks` / `task-master clear-subtasks --id=<id>`.

## Implementation Drift Handling

-   When implementation differs significantly from planned approach
-   When future tasks need modification due to current implementation choices
-   When new dependencies or requirements emerge
-   Use `update` / `task-master update --from=<futureTaskId> --prompt='<explanation>\nUpdate context...' --research` to update multiple future tasks.
-   Use `update_task` / `task-master update-task --id=<taskId> --prompt='<explanation>\nUpdate context...' --research` to update a single specific task.

## Task Status Management

-   Use 'pending' for tasks ready to be worked on
-   Use 'done' for completed and verified tasks
-   Use 'deferred' for postponed tasks
-   Add custom status values as needed for project-specific workflows

## Task Structure Fields

- **id**: Unique identifier for the task (Example: `1`, `1.1`)
- **title**: Brief, descriptive title (Example: `"Initialize Repo"`)
- **description**: Concise summary of what the task involves (Example: `"Create a new repository, set up initial structure."`)
- **status**: Current state of the task (Example: `"pending"`, `"done"`, `"deferred"`)
- **dependencies**: IDs of prerequisite tasks (Example: `[1, 2.1]`)
    - Dependencies are displayed with status indicators (✅ for completed, ⏱️ for pending)
    - This helps quickly identify which prerequisite tasks are blocking work
- **priority**: Importance level (Example: `"high"`, `"medium"`, `"low"`)
- **details**: In-depth implementation instructions (Example: `"Use GitHub client ID/secret, handle callback, set session token."`) 
- **testStrategy**: Verification approach (Example: `"Deploy and call endpoint to confirm 'Hello World' response."`) 
- **subtasks**: List of smaller, more specific tasks (Example: `[{"id": 1, "title": "Configure OAuth", ...}]`) 
- Refer to task structure details (previously linked to `tasks.md`).

## Configuration Management (Updated)

Taskmaster configuration is managed through two main mechanisms:

1.  **`.taskmaster/config.json` File (Primary):**
    *   Located in the project root directory.
    *   Stores most configuration settings: AI model selections (main, research, fallback), parameters (max tokens, temperature), logging level, default subtasks/priority, project name, etc.
    *   **Managed via `task-master models --setup` command.** Do not edit manually unless you know what you are doing.
    *   **View/Set specific models via `task-master models` command or `models` MCP tool.**
    *   Created automatically when you run `task-master models --setup` for the first time.

2.  **Environment Variables (`.env` / `mcp.json`):**
    *   Used **only** for sensitive API keys and specific endpoint URLs.
    *   Place API keys (one per provider) in a `.env` file in the project root for CLI usage.
    *   For MCP/Roo Code integration, configure these keys in the `env` section of `.roo/mcp.json`.
    *   Available keys/variables: See `assets/env.example` or the Configuration section in the command reference (previously linked to `taskmaster.md`).

**Important:** Non-API key settings (like model selections, `MAX_TOKENS`, `TASKMASTER_LOG_LEVEL`) are **no longer configured via environment variables**. Use the `task-master models` command (or `--setup` for interactive configuration) or the `models` MCP tool.
**If AI commands FAIL in MCP** verify that the API key for the selected provider is present in the `env` section of `.roo/mcp.json`.
**If AI commands FAIL in CLI** verify that the API key for the selected provider is present in the `.env` file in the root of the project.

## Determining the Next Task

- Run `next_task` / `task-master next` to show the next task to work on.
- The command identifies tasks with all dependencies satisfied
- Tasks are prioritized by priority level, dependency count, and ID
- The command shows comprehensive task information including:
    - Basic task details and description
    - Implementation details
    - Subtasks (if they exist)
    - Contextual suggested actions
- Recommended before starting any new development work
- Respects your project's dependency structure
- Ensures tasks are completed in the appropriate sequence
- Provides ready-to-use commands for common task actions

## Viewing Specific Task Details

- Run `get_task` / `task-master show <id>` to view a specific task.
- Use dot notation for subtasks: `task-master show 1.2` (shows subtask 2 of task 1)
- Displays comprehensive information similar to the next command, but for a specific task
- For parent tasks, shows all subtasks and their current status
- For subtasks, shows parent task information and relationship
- Provides contextual suggested actions appropriate for the specific task
- Useful for examining task details before implementation or checking status

## Managing Task Dependencies

- Use `add_dependency` / `task-master add-dependency --id=<id> --depends-on=<id>` to add a dependency.
- Use `remove_dependency` / `task-master remove-dependency --id=<id> --depends-on=<id>` to remove a dependency.
- The system prevents circular dependencies and duplicate dependency entries
- Dependencies are checked for existence before being added or removed
- Task files are automatically regenerated after dependency changes
- Dependencies are visualized with status indicators in task listings and files

## Task Reorganization

- Use `move_task` / `task-master move --from=<id> --to=<id>` to move tasks or subtasks within the hierarchy
- This command supports several use cases:
  - Moving a standalone task to become a subtask (e.g., `--from=5 --to=7`)
  - Moving a subtask to become a standalone task (e.g., `--from=5.2 --to=7`) 
  - Moving a subtask to a different parent (e.g., `--from=5.2 --to=7.3`)
  - Reordering subtasks within the same parent (e.g., `--from=5.2 --to=5.4`)
  - Moving a task to a new, non-existent ID position (e.g., `--from=5 --to=25`)
  - Moving multiple tasks at once using comma-separated IDs (e.g., `--from=10,11,12 --to=16,17,18`)
- The system includes validation to prevent data loss:
  - Allows moving to non-existent IDs by creating placeholder tasks
  - Prevents moving to existing task IDs that have content (to avoid overwriting)
  - Validates source tasks exist before attempting to move them
- The system maintains proper parent-child relationships and dependency integrity
- Task files are automatically regenerated after the move operation
- This provides greater flexibility in organizing and refining your task structure as project understanding evolves
- This is especially useful when dealing with potential merge conflicts arising from teams creating tasks on separate branches. Solve these conflicts very easily by moving your tasks and keeping theirs.

## Iterative Subtask Implementation

Once a task has been broken down into subtasks using `expand_task` or similar methods, follow this iterative process for implementation:

1.  **Understand the Goal (Preparation):**
    *   Use `get_task` / `task-master show <subtaskId>` (see [`taskmaster.md`](mdc:.roo/rules/taskmaster.md)) to thoroughly understand the specific goals and requirements of the subtask.

2.  **Initial Exploration & Planning (Iteration 1):**
    *   This is the first attempt at creating a concrete implementation plan.
    *   Explore the codebase to identify the precise files, functions, and even specific lines of code that will need modification.
    *   Determine the intended code changes (diffs) and their locations.
    *   Gather *all* relevant details from this exploration phase.

3.  **Log the Plan:**
    *   Run `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='<detailed plan>'`.
    *   Provide the *complete and detailed* findings from the exploration phase in the prompt. Include file paths, line numbers, proposed diffs, reasoning, and any potential challenges identified. Do not omit details. The goal is to create a rich, timestamped log within the subtask's `details`.

4.  **Verify the Plan:**
    *   Run `get_task` / `task-master show <subtaskId>` again to confirm that the detailed implementation plan has been successfully appended to the subtask's details.

5.  **Begin Implementation:**
    *   Set the subtask status using `set_task_status` / `task-master set-status --id=<subtaskId> --status=in-progress`.
    *   Start coding based on the logged plan.

6.  **Refine and Log Progress (Iteration 2+):**
    *   As implementation progresses, you will encounter challenges, discover nuances, or confirm successful approaches.
    *   **Before appending new information**: Briefly review the *existing* details logged in the subtask (using `get_task` or recalling from context) to ensure the update adds fresh insights and avoids redundancy.
    *   **Regularly** use `update_subtask` / `task-master update-subtask --id=<subtaskId> --prompt='<update details>\n- What worked...\n- What didn't work...'` to append new findings.
    *   **Crucially, log:**
        *   What worked ("fundamental truths" discovered).
        *   What didn't work and why (to avoid repeating mistakes).
        *   Specific code snippets or configurations that were successful.
        *   Decisions made, especially if confirmed with user input.
        *   Any deviations from the initial plan and the reasoning.
    *   The objective is to continuously enrich the subtask's details, creating a log of the implementation journey that helps the AI (and human developers) learn, adapt, and avoid repeating errors.

7.  **Review & Update Rules (Post-Implementation):**
    *   Once the implementation for the subtask is functionally complete, review all code changes and the relevant chat history.
    *   Identify any new or modified code patterns, conventions, or best practices established during the implementation.
    *   Create new or update existing rules following internal guidelines (previously linked to `cursor_rules.md` and `self_improve.md`).

8.  **Mark Task Complete:**
    *   After verifying the implementation and updating any necessary rules, mark the subtask as completed: `set_task_status` / `task-master set-status --id=<subtaskId> --status=done`.

9.  **Commit Changes (If using Git):**
    *   Stage the relevant code changes and any updated/new rule files (`git add .`).
    *   Craft a comprehensive Git commit message summarizing the work done for the subtask, including both code implementation and any rule adjustments.
    *   Execute the commit command directly in the terminal (e.g., `git commit -m 'feat(module): Implement feature X for subtask <subtaskId>\n\n- Details about changes...\n- Updated rule Y for pattern Z'`).
    *   Consider if a Changeset is needed according to internal versioning guidelines (previously linked to `changeset.md`). If so, run `npm run changeset`, stage the generated file, and amend the commit or create a new one.

10. **Proceed to Next Subtask:**
    *   Identify the next subtask (e.g., using `next_task` / `task-master next`).

## Code Analysis & Refactoring Techniques

- **Top-Level Function Search**:
    - Useful for understanding module structure or planning refactors.
    - Use grep/ripgrep to find exported functions/constants:
      `rg "export (async function|function|const) \w+"` or similar patterns.
    - Can help compare functions between files during migrations or identify potential naming conflicts.

---
*This workflow provides a general guideline. Adapt it based on your specific project needs and team practices.*

================
File: .roo/rules/roo_rules.md
================
---
description: Guidelines for creating and maintaining Roo Code rules to ensure consistency and effectiveness.
globs: .roo/rules/*.md
alwaysApply: true
---

- **Required Rule Structure:**
  ```markdown
  ---
  description: Clear, one-line description of what the rule enforces
  globs: path/to/files/*.ext, other/path/**/*
  alwaysApply: boolean
  ---

  - **Main Points in Bold**
    - Sub-points with details
    - Examples and explanations
  ```

- **File References:**
  - Use `[filename](mdc:path/to/file)` ([filename](mdc:filename)) to reference files
  - Example: [prisma.md](mdc:.roo/rules/prisma.md) for rule references
  - Example: [schema.prisma](mdc:prisma/schema.prisma) for code references

- **Code Examples:**
  - Use language-specific code blocks
  ```typescript
  // ✅ DO: Show good examples
  const goodExample = true;
  
  // ❌ DON'T: Show anti-patterns
  const badExample = false;
  ```

- **Rule Content Guidelines:**
  - Start with high-level overview
  - Include specific, actionable requirements
  - Show examples of correct implementation
  - Reference existing code when possible
  - Keep rules DRY by referencing other rules

- **Rule Maintenance:**
  - Update rules when new patterns emerge
  - Add examples from actual codebase
  - Remove outdated patterns
  - Cross-reference related rules

- **Best Practices:**
  - Use bullet points for clarity
  - Keep descriptions concise
  - Include both DO and DON'T examples
  - Reference actual code over theoretical examples
  - Use consistent formatting across rules

================
File: .roo/rules/self_improve.md
================
---
description: Guidelines for continuously improving Roo Code rules based on emerging code patterns and best practices.
globs: **/*
alwaysApply: true
---

- **Rule Improvement Triggers:**
  - New code patterns not covered by existing rules
  - Repeated similar implementations across files
  - Common error patterns that could be prevented
  - New libraries or tools being used consistently
  - Emerging best practices in the codebase

- **Analysis Process:**
  - Compare new code with existing rules
  - Identify patterns that should be standardized
  - Look for references to external documentation
  - Check for consistent error handling patterns
  - Monitor test patterns and coverage

- **Rule Updates:**
  - **Add New Rules When:**
    - A new technology/pattern is used in 3+ files
    - Common bugs could be prevented by a rule
    - Code reviews repeatedly mention the same feedback
    - New security or performance patterns emerge

  - **Modify Existing Rules When:**
    - Better examples exist in the codebase
    - Additional edge cases are discovered
    - Related rules have been updated
    - Implementation details have changed

- **Example Pattern Recognition:**
  ```typescript
  // If you see repeated patterns like:
  const data = await prisma.user.findMany({
    select: { id: true, email: true },
    where: { status: 'ACTIVE' }
  });
  
  // Consider adding to [prisma.md](mdc:.roo/rules/prisma.md):
  // - Standard select fields
  // - Common where conditions
  // - Performance optimization patterns
  ```

- **Rule Quality Checks:**
  - Rules should be actionable and specific
  - Examples should come from actual code
  - References should be up to date
  - Patterns should be consistently enforced

- **Continuous Improvement:**
  - Monitor code review comments
  - Track common development questions
  - Update rules after major refactors
  - Add links to relevant documentation
  - Cross-reference related rules

- **Rule Deprecation:**
  - Mark outdated patterns as deprecated
  - Remove rules that no longer apply
  - Update references to deprecated rules
  - Document migration paths for old patterns

- **Documentation Updates:**
  - Keep examples synchronized with code
  - Update references to external docs
  - Maintain links between related rules
  - Document breaking changes
Follow [cursor_rules.md](mdc:.roo/rules/cursor_rules.md) for proper rule formatting and structure.

================
File: .roo/rules/taskmaster.md
================
---
description: Comprehensive reference for Taskmaster MCP tools and CLI commands.
globs: **/*
alwaysApply: true
---
# Taskmaster Tool & Command Reference

This document provides a detailed reference for interacting with Taskmaster, covering both the recommended MCP tools, suitable for integrations like Roo Code, and the corresponding `task-master` CLI commands, designed for direct user interaction or fallback.

**Note:** For interacting with Taskmaster programmatically or via integrated tools, using the **MCP tools is strongly recommended** due to better performance, structured data, and error handling. The CLI commands serve as a user-friendly alternative and fallback. 

**Important:** Several MCP tools involve AI processing... The AI-powered tools include `parse_prd`, `analyze_project_complexity`, `update_subtask`, `update_task`, `update`, `expand_all`, `expand_task`, and `add_task`.

---

## Initialization & Setup

### 1. Initialize Project (`init`)

*   **MCP Tool:** `initialize_project`
*   **CLI Command:** `task-master init [options]`
*   **Description:** `Set up the basic Taskmaster file structure and configuration in the current directory for a new project.`
*   **Key CLI Options:**
    *   `--name <name>`: `Set the name for your project in Taskmaster's configuration.`
    *   `--description <text>`: `Provide a brief description for your project.`
    *   `--version <version>`: `Set the initial version for your project, e.g., '0.1.0'.`
    *   `-y, --yes`: `Initialize Taskmaster quickly using default settings without interactive prompts.`
*   **Usage:** Run this once at the beginning of a new project.
*   **MCP Variant Description:** `Set up the basic Taskmaster file structure and configuration in the current directory for a new project by running the 'task-master init' command.`
*   **Key MCP Parameters/Options:**
    *   `projectName`: `Set the name for your project.` (CLI: `--name <name>`)
    *   `projectDescription`: `Provide a brief description for your project.` (CLI: `--description <text>`)
    *   `projectVersion`: `Set the initial version for your project, e.g., '0.1.0'.` (CLI: `--version <version>`)
    *   `authorName`: `Author name.` (CLI: `--author <author>`)
    *   `skipInstall`: `Skip installing dependencies. Default is false.` (CLI: `--skip-install`)
    *   `addAliases`: `Add shell aliases tm and taskmaster. Default is false.` (CLI: `--aliases`)
    *   `yes`: `Skip prompts and use defaults/provided arguments. Default is false.` (CLI: `-y, --yes`)
*   **Usage:** Run this once at the beginning of a new project, typically via an integrated tool like Roo Code. Operates on the current working directory of the MCP server. 
*   **Important:** Once complete, you *MUST* parse a prd in order to generate tasks. There will be no tasks files until then. The next step after initializing should be to create a PRD using the example PRD in .taskmaster/templates/example_prd.txt. 

### 2. Parse PRD (`parse_prd`)

*   **MCP Tool:** `parse_prd`
*   **CLI Command:** `task-master parse-prd [file] [options]`
*   **Description:** `Parse a Product Requirements Document, PRD, or text file with Taskmaster to automatically generate an initial set of tasks in tasks.json.`
*   **Key Parameters/Options:**
    *   `input`: `Path to your PRD or requirements text file that Taskmaster should parse for tasks.` (CLI: `[file]` positional or `-i, --input <file>`)
    *   `output`: `Specify where Taskmaster should save the generated 'tasks.json' file. Defaults to '.taskmaster/tasks/tasks.json'.` (CLI: `-o, --output <file>`)
    *   `numTasks`: `Approximate number of top-level tasks Taskmaster should aim to generate from the document.` (CLI: `-n, --num-tasks <number>`)
    *   `force`: `Use this to allow Taskmaster to overwrite an existing 'tasks.json' without asking for confirmation.` (CLI: `-f, --force`)
*   **Usage:** Useful for bootstrapping a project from an existing requirements document.
*   **Notes:** Task Master will strictly adhere to any specific requirements mentioned in the PRD, such as libraries, database schemas, frameworks, tech stacks, etc., while filling in any gaps where the PRD isn't fully specified. Tasks are designed to provide the most direct implementation path while avoiding over-engineering.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress. If the user does not have a PRD, suggest discussing their idea and then use the example PRD in `.taskmaster/templates/example_prd.txt` as a template for creating the PRD based on their idea, for use with `parse-prd`.

---

## AI Model Configuration

### 2. Manage Models (`models`)
*   **MCP Tool:** `models`
*   **CLI Command:** `task-master models [options]`
*   **Description:** `View the current AI model configuration or set specific models for different roles (main, research, fallback). Allows setting custom model IDs for Ollama and OpenRouter.`
*   **Key MCP Parameters/Options:**
    *   `setMain <model_id>`: `Set the primary model ID for task generation/updates.` (CLI: `--set-main <model_id>`)
    *   `setResearch <model_id>`: `Set the model ID for research-backed operations.` (CLI: `--set-research <model_id>`)
    *   `setFallback <model_id>`: `Set the model ID to use if the primary fails.` (CLI: `--set-fallback <model_id>`)
    *   `ollama <boolean>`: `Indicates the set model ID is a custom Ollama model.` (CLI: `--ollama`)
    *   `openrouter <boolean>`: `Indicates the set model ID is a custom OpenRouter model.` (CLI: `--openrouter`)
    *   `listAvailableModels <boolean>`: `If true, lists available models not currently assigned to a role.` (CLI: No direct equivalent; CLI lists available automatically)
    *   `projectRoot <string>`: `Optional. Absolute path to the project root directory.` (CLI: Determined automatically)
*   **Key CLI Options:**
    *   `--set-main <model_id>`: `Set the primary model.`
    *   `--set-research <model_id>`: `Set the research model.`
    *   `--set-fallback <model_id>`: `Set the fallback model.`
    *   `--ollama`: `Specify that the provided model ID is for Ollama (use with --set-*).`
    *   `--openrouter`: `Specify that the provided model ID is for OpenRouter (use with --set-*). Validates against OpenRouter API.`
    *   `--setup`: `Run interactive setup to configure models, including custom Ollama/OpenRouter IDs.`
*   **Usage (MCP):** Call without set flags to get current config. Use `setMain`, `setResearch`, or `setFallback` with a valid model ID to update the configuration. Use `listAvailableModels: true` to get a list of unassigned models. To set a custom model, provide the model ID and set `ollama: true` or `openrouter: true`.
*   **Usage (CLI):** Run without flags to view current configuration and available models. Use set flags to update specific roles. Use `--setup` for guided configuration, including custom models. To set a custom model via flags, use `--set-<role>=<model_id>` along with either `--ollama` or `--openrouter`.
*   **Notes:** Configuration is stored in `.taskmaster/config.json` in the project root. This command/tool modifies that file. Use `listAvailableModels` or `task-master models` to see internally supported models. OpenRouter custom models are validated against their live API. Ollama custom models are not validated live.
*   **API note:** API keys for selected AI providers (based on their model) need to exist in the mcp.json file to be accessible in MCP context. The API keys must be present in the local .env file for the CLI to be able to read them.
*   **Model costs:** The costs in supported models are expressed in dollars. An input/output value of 3 is $3.00. A value of 0.8 is $0.80. 
*   **Warning:** DO NOT MANUALLY EDIT THE .taskmaster/config.json FILE. Use the included commands either in the MCP or CLI format as needed. Always prioritize MCP tools when available and use the CLI as a fallback.

---

## Task Listing & Viewing

### 3. Get Tasks (`get_tasks`)

*   **MCP Tool:** `get_tasks`
*   **CLI Command:** `task-master list [options]`
*   **Description:** `List your Taskmaster tasks, optionally filtering by status and showing subtasks.`
*   **Key Parameters/Options:**
    *   `status`: `Show only Taskmaster tasks matching this status, e.g., 'pending' or 'done'.` (CLI: `-s, --status <status>`)
    *   `withSubtasks`: `Include subtasks indented under their parent tasks in the list.` (CLI: `--with-subtasks`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Get an overview of the project status, often used at the start of a work session.

### 4. Get Next Task (`next_task`)

*   **MCP Tool:** `next_task`
*   **CLI Command:** `task-master next [options]`
*   **Description:** `Ask Taskmaster to show the next available task you can work on, based on status and completed dependencies.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Identify what to work on next according to the plan.

### 5. Get Task Details (`get_task`)

*   **MCP Tool:** `get_task`
*   **CLI Command:** `task-master show [id] [options]`
*   **Description:** `Display detailed information for a specific Taskmaster task or subtask by its ID.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task, e.g., '15', or subtask, e.g., '15.2', you want to view.` (CLI: `[id]` positional or `-i, --id <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Understand the full details, implementation notes, and test strategy for a specific task before starting work.

---

## Task Creation & Modification

### 6. Add Task (`add_task`)

*   **MCP Tool:** `add_task`
*   **CLI Command:** `task-master add-task [options]`
*   **Description:** `Add a new task to Taskmaster by describing it; AI will structure it.`
*   **Key Parameters/Options:**
    *   `prompt`: `Required. Describe the new task you want Taskmaster to create, e.g., "Implement user authentication using JWT".` (CLI: `-p, --prompt <text>`)
    *   `dependencies`: `Specify the IDs of any Taskmaster tasks that must be completed before this new one can start, e.g., '12,14'.` (CLI: `-d, --dependencies <ids>`)
    *   `priority`: `Set the priority for the new task: 'high', 'medium', or 'low'. Default is 'medium'.` (CLI: `--priority <priority>`)
    *   `research`: `Enable Taskmaster to use the research role for potentially more informed task creation.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Quickly add newly identified tasks during development.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 7. Add Subtask (`add_subtask`)

*   **MCP Tool:** `add_subtask`
*   **CLI Command:** `task-master add-subtask [options]`
*   **Description:** `Add a new subtask to a Taskmaster parent task, or convert an existing task into a subtask.`
*   **Key Parameters/Options:**
    *   `id` / `parent`: `Required. The ID of the Taskmaster task that will be the parent.` (MCP: `id`, CLI: `-p, --parent <id>`)
    *   `taskId`: `Use this if you want to convert an existing top-level Taskmaster task into a subtask of the specified parent.` (CLI: `-i, --task-id <id>`)
    *   `title`: `Required if not using taskId. The title for the new subtask Taskmaster should create.` (CLI: `-t, --title <title>`)
    *   `description`: `A brief description for the new subtask.` (CLI: `-d, --description <text>`)
    *   `details`: `Provide implementation notes or details for the new subtask.` (CLI: `--details <text>`)
    *   `dependencies`: `Specify IDs of other tasks or subtasks, e.g., '15' or '16.1', that must be done before this new subtask.` (CLI: `--dependencies <ids>`)
    *   `status`: `Set the initial status for the new subtask. Default is 'pending'.` (CLI: `-s, --status <status>`)
    *   `skipGenerate`: `Prevent Taskmaster from automatically regenerating markdown task files after adding the subtask.` (CLI: `--skip-generate`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Break down tasks manually or reorganize existing tasks.

### 8. Update Tasks (`update`)

*   **MCP Tool:** `update`
*   **CLI Command:** `task-master update [options]`
*   **Description:** `Update multiple upcoming tasks in Taskmaster based on new context or changes, starting from a specific task ID.`
*   **Key Parameters/Options:**
    *   `from`: `Required. The ID of the first task Taskmaster should update. All tasks with this ID or higher that are not 'done' will be considered.` (CLI: `--from <id>`)
    *   `prompt`: `Required. Explain the change or new context for Taskmaster to apply to the tasks, e.g., "We are now using React Query instead of Redux Toolkit for data fetching".` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Handle significant implementation changes or pivots that affect multiple future tasks. Example CLI: `task-master update --from='18' --prompt='Switching to React Query.\nNeed to refactor data fetching...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 9. Update Task (`update_task`)

*   **MCP Tool:** `update_task`
*   **CLI Command:** `task-master update-task [options]`
*   **Description:** `Modify a specific Taskmaster task or subtask by its ID, incorporating new information or changes.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The specific ID of the Taskmaster task, e.g., '15', or subtask, e.g., '15.2', you want to update.` (CLI: `-i, --id <id>`)
    *   `prompt`: `Required. Explain the specific changes or provide the new information Taskmaster should incorporate into this task.` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Refine a specific task based on new understanding or feedback. Example CLI: `task-master update-task --id='15' --prompt='Clarification: Use PostgreSQL instead of MySQL.\nUpdate schema details...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 10. Update Subtask (`update_subtask`)

*   **MCP Tool:** `update_subtask`
*   **CLI Command:** `task-master update-subtask [options]`
*   **Description:** `Append timestamped notes or details to a specific Taskmaster subtask without overwriting existing content. Intended for iterative implementation logging.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The specific ID of the Taskmaster subtask, e.g., '15.2', you want to add information to.` (CLI: `-i, --id <id>`)
    *   `prompt`: `Required. Provide the information or notes Taskmaster should append to the subtask's details. Ensure this adds *new* information not already present.` (CLI: `-p, --prompt <text>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed updates. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Add implementation notes, code snippets, or clarifications to a subtask during development. Before calling, review the subtask's current details to append only fresh insights, helping to build a detailed log of the implementation journey and avoid redundancy. Example CLI: `task-master update-subtask --id='15.2' --prompt='Discovered that the API requires header X.\nImplementation needs adjustment...'`
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 11. Set Task Status (`set_task_status`)

*   **MCP Tool:** `set_task_status`
*   **CLI Command:** `task-master set-status [options]`
*   **Description:** `Update the status of one or more Taskmaster tasks or subtasks, e.g., 'pending', 'in-progress', 'done'.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID(s) of the Taskmaster task(s) or subtask(s), e.g., '15', '15.2', or '16,17.1', to update.` (CLI: `-i, --id <id>`)
    *   `status`: `Required. The new status to set, e.g., 'done', 'pending', 'in-progress', 'review', 'cancelled'.` (CLI: `-s, --status <status>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Mark progress as tasks move through the development cycle.

### 12. Remove Task (`remove_task`)

*   **MCP Tool:** `remove_task`
*   **CLI Command:** `task-master remove-task [options]`
*   **Description:** `Permanently remove a task or subtask from the Taskmaster tasks list.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task, e.g., '5', or subtask, e.g., '5.2', to permanently remove.` (CLI: `-i, --id <id>`)
    *   `yes`: `Skip the confirmation prompt and immediately delete the task.` (CLI: `-y, --yes`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Permanently delete tasks or subtasks that are no longer needed in the project.
*   **Notes:** Use with caution as this operation cannot be undone. Consider using 'blocked', 'cancelled', or 'deferred' status instead if you just want to exclude a task from active planning but keep it for reference. The command automatically cleans up dependency references in other tasks.

---

## Task Structure & Breakdown

### 13. Expand Task (`expand_task`)

*   **MCP Tool:** `expand_task`
*   **CLI Command:** `task-master expand [options]`
*   **Description:** `Use Taskmaster's AI to break down a complex task into smaller, manageable subtasks. Appends subtasks by default.`
*   **Key Parameters/Options:**
    *   `id`: `The ID of the specific Taskmaster task you want to break down into subtasks.` (CLI: `-i, --id <id>`)
    *   `num`: `Optional: Suggests how many subtasks Taskmaster should aim to create. Uses complexity analysis/defaults otherwise.` (CLI: `-n, --num <number>`)
    *   `research`: `Enable Taskmaster to use the research role for more informed subtask generation. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `prompt`: `Optional: Provide extra context or specific instructions to Taskmaster for generating the subtasks.` (CLI: `-p, --prompt <text>`)
    *   `force`: `Optional: If true, clear existing subtasks before generating new ones. Default is false (append).` (CLI: `--force`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Generate a detailed implementation plan for a complex task before starting coding. Automatically uses complexity report recommendations if available and `num` is not specified.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 14. Expand All Tasks (`expand_all`)

*   **MCP Tool:** `expand_all`
*   **CLI Command:** `task-master expand --all [options]` (Note: CLI uses the `expand` command with the `--all` flag)
*   **Description:** `Tell Taskmaster to automatically expand all eligible pending/in-progress tasks based on complexity analysis or defaults. Appends subtasks by default.`
*   **Key Parameters/Options:**
    *   `num`: `Optional: Suggests how many subtasks Taskmaster should aim to create per task.` (CLI: `-n, --num <number>`)
    *   `research`: `Enable research role for more informed subtask generation. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `prompt`: `Optional: Provide extra context for Taskmaster to apply generally during expansion.` (CLI: `-p, --prompt <text>`)
    *   `force`: `Optional: If true, clear existing subtasks before generating new ones for each eligible task. Default is false (append).` (CLI: `--force`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Useful after initial task generation or complexity analysis to break down multiple tasks at once.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 15. Clear Subtasks (`clear_subtasks`)

*   **MCP Tool:** `clear_subtasks`
*   **CLI Command:** `task-master clear-subtasks [options]`
*   **Description:** `Remove all subtasks from one or more specified Taskmaster parent tasks.`
*   **Key Parameters/Options:**
    *   `id`: `The ID(s) of the Taskmaster parent task(s) whose subtasks you want to remove, e.g., '15' or '16,18'. Required unless using `all`.) (CLI: `-i, --id <ids>`)
    *   `all`: `Tell Taskmaster to remove subtasks from all parent tasks.` (CLI: `--all`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Used before regenerating subtasks with `expand_task` if the previous breakdown needs replacement.

### 16. Remove Subtask (`remove_subtask`)

*   **MCP Tool:** `remove_subtask`
*   **CLI Command:** `task-master remove-subtask [options]`
*   **Description:** `Remove a subtask from its Taskmaster parent, optionally converting it into a standalone task.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID(s) of the Taskmaster subtask(s) to remove, e.g., '15.2' or '16.1,16.3'.` (CLI: `-i, --id <id>`)
    *   `convert`: `If used, Taskmaster will turn the subtask into a regular top-level task instead of deleting it.` (CLI: `-c, --convert`)
    *   `skipGenerate`: `Prevent Taskmaster from automatically regenerating markdown task files after removing the subtask.` (CLI: `--skip-generate`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Delete unnecessary subtasks or promote a subtask to a top-level task.

### 17. Move Task (`move_task`)

*   **MCP Tool:** `move_task`
*   **CLI Command:** `task-master move [options]`
*   **Description:** `Move a task or subtask to a new position within the task hierarchy.`
*   **Key Parameters/Options:**
    *   `from`: `Required. ID of the task/subtask to move (e.g., "5" or "5.2"). Can be comma-separated for multiple tasks.` (CLI: `--from <id>`)
    *   `to`: `Required. ID of the destination (e.g., "7" or "7.3"). Must match the number of source IDs if comma-separated.` (CLI: `--to <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Reorganize tasks by moving them within the hierarchy. Supports various scenarios like:
    *   Moving a task to become a subtask
    *   Moving a subtask to become a standalone task
    *   Moving a subtask to a different parent
    *   Reordering subtasks within the same parent
    *   Moving a task to a new, non-existent ID (automatically creates placeholders)
    *   Moving multiple tasks at once with comma-separated IDs
*   **Validation Features:**
    *   Allows moving tasks to non-existent destination IDs (creates placeholder tasks)
    *   Prevents moving to existing task IDs that already have content (to avoid overwriting)
    *   Validates that source tasks exist before attempting to move them
    *   Maintains proper parent-child relationships
*   **Example CLI:** `task-master move --from=5.2 --to=7.3` to move subtask 5.2 to become subtask 7.3.
*   **Example Multi-Move:** `task-master move --from=10,11,12 --to=16,17,18` to move multiple tasks to new positions.
*   **Common Use:** Resolving merge conflicts in tasks.json when multiple team members create tasks on different branches.

---

## Dependency Management

### 18. Add Dependency (`add_dependency`)

*   **MCP Tool:** `add_dependency`
*   **CLI Command:** `task-master add-dependency [options]`
*   **Description:** `Define a dependency in Taskmaster, making one task a prerequisite for another.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task that will depend on another.` (CLI: `-i, --id <id>`)
    *   `dependsOn`: `Required. The ID of the Taskmaster task that must be completed first, the prerequisite.` (CLI: `-d, --depends-on <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <path>`)
*   **Usage:** Establish the correct order of execution between tasks.

### 19. Remove Dependency (`remove_dependency`)

*   **MCP Tool:** `remove_dependency`
*   **CLI Command:** `task-master remove-dependency [options]`
*   **Description:** `Remove a dependency relationship between two Taskmaster tasks.`
*   **Key Parameters/Options:**
    *   `id`: `Required. The ID of the Taskmaster task you want to remove a prerequisite from.` (CLI: `-i, --id <id>`)
    *   `dependsOn`: `Required. The ID of the Taskmaster task that should no longer be a prerequisite.` (CLI: `-d, --depends-on <id>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Update task relationships when the order of execution changes.

### 20. Validate Dependencies (`validate_dependencies`)

*   **MCP Tool:** `validate_dependencies`
*   **CLI Command:** `task-master validate-dependencies [options]`
*   **Description:** `Check your Taskmaster tasks for dependency issues (like circular references or links to non-existent tasks) without making changes.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Audit the integrity of your task dependencies.

### 21. Fix Dependencies (`fix_dependencies`)

*   **MCP Tool:** `fix_dependencies`
*   **CLI Command:** `task-master fix-dependencies [options]`
*   **Description:** `Automatically fix dependency issues (like circular references or links to non-existent tasks) in your Taskmaster tasks.`
*   **Key Parameters/Options:**
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Clean up dependency errors automatically.

---

## Analysis & Reporting

### 22. Analyze Project Complexity (`analyze_project_complexity`)

*   **MCP Tool:** `analyze_project_complexity`
*   **CLI Command:** `task-master analyze-complexity [options]`
*   **Description:** `Have Taskmaster analyze your tasks to determine their complexity and suggest which ones need to be broken down further.`
*   **Key Parameters/Options:**
    *   `output`: `Where to save the complexity analysis report (default: '.taskmaster/reports/task-complexity-report.json').` (CLI: `-o, --output <file>`)
    *   `threshold`: `The minimum complexity score (1-10) that should trigger a recommendation to expand a task.` (CLI: `-t, --threshold <number>`)
    *   `research`: `Enable research role for more accurate complexity analysis. Requires appropriate API key.` (CLI: `-r, --research`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Used before breaking down tasks to identify which ones need the most attention.
*   **Important:** This MCP tool makes AI calls and can take up to a minute to complete. Please inform users to hang tight while the operation is in progress.

### 23. View Complexity Report (`complexity_report`)

*   **MCP Tool:** `complexity_report`
*   **CLI Command:** `task-master complexity-report [options]`
*   **Description:** `Display the task complexity analysis report in a readable format.`
*   **Key Parameters/Options:**
    *   `file`: `Path to the complexity report (default: '.taskmaster/reports/task-complexity-report.json').` (CLI: `-f, --file <file>`)
*   **Usage:** Review and understand the complexity analysis results after running analyze-complexity.

---

## File Management

### 24. Generate Task Files (`generate`)

*   **MCP Tool:** `generate`
*   **CLI Command:** `task-master generate [options]`
*   **Description:** `Create or update individual Markdown files for each task based on your tasks.json.`
*   **Key Parameters/Options:**
    *   `output`: `The directory where Taskmaster should save the task files (default: in a 'tasks' directory).` (CLI: `-o, --output <directory>`)
    *   `file`: `Path to your Taskmaster 'tasks.json' file. Default relies on auto-detection.` (CLI: `-f, --file <file>`)
*   **Usage:** Run this after making changes to tasks.json to keep individual task files up to date.

---

## Environment Variables Configuration (Updated)

Taskmaster primarily uses the **`.taskmaster/config.json`** file (in project root) for configuration (models, parameters, logging level, etc.), managed via `task-master models --setup`.

Environment variables are used **only** for sensitive API keys related to AI providers and specific overrides like the Ollama base URL:

*   **API Keys (Required for corresponding provider):**
    *   `ANTHROPIC_API_KEY`
    *   `PERPLEXITY_API_KEY`
    *   `OPENAI_API_KEY`
    *   `GOOGLE_API_KEY`
    *   `MISTRAL_API_KEY`
    *   `AZURE_OPENAI_API_KEY` (Requires `AZURE_OPENAI_ENDPOINT` too)
    *   `OPENROUTER_API_KEY`
    *   `XAI_API_KEY`
    *   `OLLANA_API_KEY` (Requires `OLLAMA_BASE_URL` too)
*   **Endpoints (Optional/Provider Specific inside .taskmaster/config.json):**
    *   `AZURE_OPENAI_ENDPOINT`
    *   `OLLAMA_BASE_URL` (Default: `http://localhost:11434/api`)

**Set API keys** in your **`.env`** file in the project root (for CLI use) or within the `env` section of your **`.roo/mcp.json`** file (for MCP/Roo Code integration). All other settings (model choice, max tokens, temperature, log level, custom endpoints) are managed in `.taskmaster/config.json` via `task-master models` command or `models` MCP tool.

---

For details on how these commands fit into the development process, see the [Development Workflow Guide](mdc:.roo/rules/dev_workflow.md).

================
File: .roomodes
================
{
  "customModes": [
    {
      "slug": "boomerang",
      "name": "Boomerang",
      "roleDefinition": "You are Roo, a strategic workflow orchestrator who coordinates complex tasks by delegating them to appropriate specialized modes. You have a comprehensive understanding of each mode's capabilities and limitations, also your own, and with the information given by the user and other modes in shared context you are enabled to effectively break down complex problems into discrete tasks that can be solved by different specialists using the `taskmaster-ai` system for task and context management.",
      "customInstructions": "Your role is to coordinate complex workflows by delegating tasks to specialized modes, using `taskmaster-ai` as the central hub for task definition, progress tracking, and context management. \nAs an orchestrator, you should:\nn1. When given a complex task, use contextual information (which gets updated frequently) to break it down into logical subtasks that can be delegated to appropriate specialized modes.\nn2. For each subtask, use the `new_task` tool to delegate. Choose the most appropriate mode for the subtask's specific goal and provide comprehensive instructions in the `message` parameter. \nThese instructions must include:\n*   All necessary context from the parent task or previous subtasks required to complete the work.\n*   A clearly defined scope, specifying exactly what the subtask should accomplish.\n*   An explicit statement that the subtask should *only* perform the work outlined in these instructions and not deviate.\n*   An instruction for the subtask to signal completion by using the `attempt_completion` tool, providing a thorough summary of the outcome in the `result` parameter, keeping in mind that this summary will be the source of truth used to further relay this information to other tasks and for you to keep track of what was completed on this project.\nn3. Track and manage the progress of all subtasks. When a subtask is completed, acknowledge its results and determine the next steps.\nn4. Help the user understand how the different subtasks fit together in the overall workflow. Provide clear reasoning about why you're delegating specific tasks to specific modes.\nn5. Ask clarifying questions when necessary to better understand how to break down complex tasks effectively. If it seems complex delegate to architect to accomplish that \nn6. Use subtasks to maintain clarity. If a request significantly shifts focus or requires a different expertise (mode), consider creating a subtask rather than overloading the current one.",
      "groups": [
        "read",
        "edit",
        "browser",
        "command",
        "mcp"
      ]
    },
    {
      "slug": "architect",
      "name": "Architect",
      "roleDefinition": "You are Roo, an expert technical leader operating in Architect mode. When activated via a delegated task, your focus is solely on analyzing requirements, designing system architecture, planning implementation steps, and performing technical analysis as specified in the task message. You utilize analysis tools as needed and report your findings and designs back using `attempt_completion`. You do not deviate from the delegated task scope.",
      "customInstructions": "1. Do some information gathering (for example using read_file or search_files) to get more context about the task.\n\n2. You should also ask the user clarifying questions to get a better understanding of the task.\n\n3. Once you've gained more context about the user's request, you should create a detailed plan for how to accomplish the task. Include Mermaid diagrams if they help make your plan clearer.\n\n4. Ask the user if they are pleased with this plan, or if they would like to make any changes. Think of this as a brainstorming session where you can discuss the task and plan the best way to accomplish it.\n\n5. Once the user confirms the plan, ask them if they'd like you to write it to a markdown file.\n\n6. Use the switch_mode tool to request that the user switch to another mode to implement the solution.",
      "groups": [
        "read",
        ["edit", { "fileRegex": "\\.md$", "description": "Markdown files only" }],
        "command",
        "mcp"
      ]
    },
    {
      "slug": "ask",
      "name": "Ask",
      "roleDefinition": "You are Roo, a knowledgeable technical assistant.\nWhen activated by another mode via a delegated task, your focus is to research, analyze, and provide clear, concise answers or explanations based *only* on the specific information requested in the delegation message. Use available tools for information gathering and report your findings back using `attempt_completion`.",
      "customInstructions": "You can analyze code, explain concepts, and access external resources. Make sure to answer the user's questions and don't rush to switch to implementing code. Include Mermaid diagrams if they help make your response clearer.",
      "groups": [
        "read",
        "browser",
        "mcp"
      ]
    },
    {
      "slug": "debug",
      "name": "Debug",
      "roleDefinition": "You are Roo, an expert software debugger specializing in systematic problem diagnosis and resolution. When activated by another mode, your task is to meticulously analyze the provided debugging request (potentially referencing Taskmaster tasks, logs, or metrics), use diagnostic tools as instructed to investigate the issue, identify the root cause, and report your findings and recommended next steps back via `attempt_completion`. You focus solely on diagnostics within the scope defined by the delegated task.",
      "customInstructions": "Reflect on 5-7 different possible sources of the problem, distill those down to 1-2 most likely sources, and then add logs to validate your assumptions. Explicitly ask the user to confirm the diagnosis before fixing the problem.",
      "groups": [
        "read",
        "edit",
        "command",
        "mcp"
      ]
    },
    {
      "slug": "test",
      "name": "Test",
      "roleDefinition": "You are Roo, an expert software tester. Your primary focus is executing testing tasks delegated to you by other modes.\nAnalyze the provided scope and context (often referencing a Taskmaster task ID and its `testStrategy`), develop test plans if needed, execute tests diligently, and report comprehensive results (pass/fail, bugs, coverage) back using `attempt_completion`. You operate strictly within the delegated task's boundaries.",
      "customInstructions": "Focus on the `testStrategy` defined in the Taskmaster task. Develop and execute test plans accordingly. Report results clearly, including pass/fail status, bug details, and coverage information.",
      "groups": [
        "read",
        "command",
        "mcp"
      ]
    }
  ]
}

================
File: .taskmaster/config.json
================
{
  "models": {
    "main": {
      "provider": "openai",
      "modelId": "gpt-4o-mini",
      "maxTokens": 120000,
      "temperature": 0.2
    },
    "research": {
      "provider": "perplexity",
      "modelId": "sonar-pro",
      "maxTokens": 8700,
      "temperature": 0.1
    },
    "fallback": {
      "provider": "anthropic",
      "modelId": "claude-3-5-sonnet-20240620",
      "maxTokens": 8192,
      "temperature": 0.1
    }
  },
  "global": {
    "logLevel": "info",
    "debug": false,
    "defaultSubtasks": 5,
    "defaultPriority": "medium",
    "projectName": "Taskmaster",
    "ollamaBaseURL": "http://localhost:11434/api",
    "bedrockBaseURL": "https://bedrock.us-east-1.amazonaws.com",
    "azureOpenaiBaseURL": "https://your-endpoint.openai.azure.com/",
    "userId": "1234567890"
  }
}

================
File: .taskmaster/docs/prd.txt
================
# Overview
模块化课程设计与管理平台 (Course Builder) 是一个高度灵活、可定制的在线课程构建工具。赋能教育者、培训师和内容创作者，让他们能够高效地设计、组合、管理和分享结构化、模块化的教学内容。

目标用户为系统管理员和课程组织者，专注于建立和管理教学内容，而非面向最终学习者。

# Core Features

## 1. Course Management
- 课程作为顶层容器，包含课程名称、分类、封面图、简介、目标学员、前置要求
- 灵活组合教材、教学计划、教学目标和教学方法构成完整课程
- 支持模板和CSV/Excel批量导入课程信息
- 卡片式布局展示，支持AJAX异步查询、搜索、筛选和分页

## 2. Book/Material Library
- 中心化教材库，包含书名、作者、分类、封面、描述、标签
- 支持批量导入书目信息
- 一本教材可关联多个词汇集
- 可复用于不同课程

## 3. Vocabulary Management
- 包含单词、词性、释义、等级(CEFR)等属性
- 支持批量导入(单词,词性,释义格式)
- 词汇集分组功能，一个词汇可属于多个词汇集
- 词汇集可关联多本教材

## 4. Schedule Design
- 教学计划包含总周数、每周课时数、单次课时长
- 提供预设模板(如"标准12周研讨课")
- 日历视图展示教学进度
- 每节课详细设计：学习目标、教学方法、任务作业、关联教材章节、关联词汇集
- 出勤记录功能

## 5. Objective Library
- 可复用的教学目标库
- 包含目标名称、描述、状态(规划中/进行中/已存档)
- 确保教学连贯性和一致性

## 6. Method Library
- 教学方法库(PBL、翻转课堂、小组讨论等)
- 包含方法名称和详细描述
- 供教师在设计课时活动时参考选用

## 7. Task/Activity Library
- 标准化任务库，包含测验、作业、阅读、写作等分类
- 任务名称、描述、分类属性
- 方便在教学计划中快速添加和复用

## 8. Platform Common Features
- 所有列表页采用卡片式布局
- AJAX异步查询，流畅的搜索筛选体验
- 批量修改功能
- 创建/编辑页面内即时创建新分类
- 所有核心对象可生成公开分享链接
- 供利益相关者查看分析数据

# User Experience
主要用户为系统管理员和课程组织者，需要：
- 直观的内容管理界面
- 高效的批量操作功能
- 灵活的模块化组合能力
- 清晰的数据展示和分析

用户工作流：
1. 建立教材库和词汇库
2. 创建教学目标和方法库
3. 设计教学计划模板
4. 组合各模块创建完整课程
5. 管理和分享课程内容

# Technical Architecture
- Frontend: Next.js, React, TypeScript, Tailwind CSS
- Backend/Database: Supabase (database, auth, storage, serverless functions)
- 简约页面风格设计
- 所有代码注释使用英文
- 数据设计遵循简单使用逻辑，避免过度复杂化

核心数据模型：
- Course (课程)
- Book (教材)
- Vocabulary & VocabularyGroup (词汇和词汇集)
- Schedule & Lesson (教学计划和课时)
- Objective (教学目标)
- Method (教学方法)
- Task (任务活动)
- Category (分类)

# Development Roadmap

## Phase 1: MVP Foundation
- 基础项目架构搭建(Next.js + Supabase)
- 用户认证系统
- 核心数据模型设计和数据库schema
- 基础UI组件库(卡片、表单、列表等)

## Phase 2: Core Content Management
- Course管理功能
- Book库管理功能
- Vocabulary管理功能
- 基础CRUD操作界面

## Phase 3: Advanced Features
- Schedule设计和日历视图
- Objective和Method库
- Task库管理
- 批量导入功能

## Phase 4: User Experience Enhancement
- 高级搜索和筛选
- 批量操作功能
- 公开分享链接
- 数据分析和报表

## Phase 5: Integration & Optimization
- 模块间关联功能完善
- 性能优化
- 用户体验细节优化
- 测试和部署

# Logical Dependency Chain
1. 项目基础架构 → 认证系统 → 数据库设计
2. 基础UI组件 → 核心CRUD功能
3. 独立模块(Course, Book, Vocabulary) → 关联功能
4. 高级功能(Schedule, 批量操作) → 用户体验优化
5. 集成测试 → 部署上线

快速到达可用前端的策略：
- 先实现Course管理的基础展示
- 快速构建卡片式列表界面
- 实现基本的增删改查功能
- 逐步添加高级特性

# Risks and Mitigations
- 技术风险：Supabase集成复杂度 → 从简单功能开始，逐步集成
- 数据设计风险：过度复杂化 → 遵循简单原则，避免过度设计
- 用户体验风险：功能过于复杂 → 分阶段发布，收集反馈
- 性能风险：大量数据加载 → 实现分页和异步加载

MVP关键要素：
- 能够创建和管理课程
- 基础的教材和词汇管理
- 简单直观的用户界面
- 稳定的数据存储

# Appendix
项目位置：D:\dev\cursor\course builder\
使用Supabase MCP功能进行数据库连接和管理
注重教学内容管理而非学习者交互
支持中英文内容但代码注释使用英文

================
File: .taskmaster/templates/example_prd.txt
================
<context>
# Overview  
[Provide a high-level overview of your product here. Explain what problem it solves, who it's for, and why it's valuable.]

# Core Features  
[List and describe the main features of your product. For each feature, include:
- What it does
- Why it's important
- How it works at a high level]

# User Experience  
[Describe the user journey and experience. Include:
- User personas
- Key user flows
- UI/UX considerations]
</context>
<PRD>
# Technical Architecture  
[Outline the technical implementation details:
- System components
- Data models
- APIs and integrations
- Infrastructure requirements]

# Development Roadmap  
[Break down the development process into phases:
- MVP requirements
- Future enhancements
- Do not think about timelines whatsoever -- all that matters is scope and detailing exactly what needs to be build in each phase so it can later be cut up into tasks]

# Logical Dependency Chain
[Define the logical order of development:
- Which features need to be built first (foundation)
- Getting as quickly as possible to something usable/visible front end that works
- Properly pacing and scoping each feature so it is atomic but can also be built upon and improved as development approaches]

# Risks and Mitigations  
[Identify potential risks and how they'll be addressed:
- Technical challenges
- Figuring out the MVP that we can build upon
- Resource constraints]

# Appendix  
[Include any additional information:
- Research findings
- Technical specifications]
</PRD>

================
File: .windsurfrules
================
Below you will find a variety of important rules spanning:
- the dev_workflow
- the .windsurfrules document self-improvement workflow
- the template to follow when modifying or adding new sections/rules to this document.

---
DEV_WORKFLOW
---
description: Guide for using meta-development script (scripts/dev.js) to manage task-driven development workflows
globs: **/*
filesToApplyRule: **/*
alwaysApply: true
---

- **Global CLI Commands**
  - Task Master now provides a global CLI through the `task-master` command
  - All functionality from `scripts/dev.js` is available through this interface
  - Install globally with `npm install -g claude-task-master` or use locally via `npx`
  - Use `task-master <command>` instead of `node scripts/dev.js <command>`
  - Examples:
    - `task-master list` instead of `node scripts/dev.js list`
    - `task-master next` instead of `node scripts/dev.js next`
    - `task-master expand --id=3` instead of `node scripts/dev.js expand --id=3`
  - All commands accept the same options as their script equivalents
  - The CLI provides additional commands like `task-master init` for project setup

- **Development Workflow Process**
  - Start new projects by running `task-master init` or `node scripts/dev.js parse-prd --input=<prd-file.txt>` to generate initial tasks.json
  - Begin coding sessions with `task-master list` to see current tasks, status, and IDs
  - Analyze task complexity with `task-master analyze-complexity --research` before breaking down tasks
  - Select tasks based on dependencies (all marked 'done'), priority level, and ID order
  - Clarify tasks by checking task files in tasks/ directory or asking for user input
  - View specific task details using `task-master show <id>` to understand implementation requirements
  - Break down complex tasks using `task-master expand --id=<id>` with appropriate flags
  - Clear existing subtasks if needed using `task-master clear-subtasks --id=<id>` before regenerating
  - Implement code following task details, dependencies, and project standards
  - Verify tasks according to test strategies before marking as complete
  - Mark completed tasks with `task-master set-status --id=<id> --status=done`
  - Update dependent tasks when implementation differs from original plan
  - Generate task files with `task-master generate` after updating tasks.json
  - Maintain valid dependency structure with `task-master fix-dependencies` when needed
  - Respect dependency chains and task priorities when selecting work
  - Report progress regularly using the list command

- **Task Complexity Analysis**
  - Run `node scripts/dev.js analyze-complexity --research` for comprehensive analysis
  - Review complexity report in scripts/task-complexity-report.json
  - Or use `node scripts/dev.js complexity-report` for a formatted, readable version of the report
  - Focus on tasks with highest complexity scores (8-10) for detailed breakdown
  - Use analysis results to determine appropriate subtask allocation
  - Note that reports are automatically used by the expand command

- **Task Breakdown Process**
  - For tasks with complexity analysis, use `node scripts/dev.js expand --id=<id>`
  - Otherwise use `node scripts/dev.js expand --id=<id> --subtasks=<number>`
  - Add `--research` flag to leverage Perplexity AI for research-backed expansion
  - Use `--prompt="<context>"` to provide additional context when needed
  - Review and adjust generated subtasks as necessary
  - Use `--all` flag to expand multiple pending tasks at once
  - If subtasks need regeneration, clear them first with `clear-subtasks` command

- **Implementation Drift Handling**
  - When implementation differs significantly from planned approach
  - When future tasks need modification due to current implementation choices
  - When new dependencies or requirements emerge
  - Call `node scripts/dev.js update --from=<futureTaskId> --prompt="<explanation>"` to update tasks.json

- **Task Status Management**
  - Use 'pending' for tasks ready to be worked on
  - Use 'done' for completed and verified tasks
  - Use 'deferred' for postponed tasks
  - Add custom status values as needed for project-specific workflows

- **Task File Format Reference**
  ```
  # Task ID: <id>
  # Title: <title>
  # Status: <status>
  # Dependencies: <comma-separated list of dependency IDs>
  # Priority: <priority>
  # Description: <brief description>
  # Details:
  <detailed implementation notes>
  
  # Test Strategy:
  <verification approach>
  ```

- **Command Reference: parse-prd**
  - Legacy Syntax: `node scripts/dev.js parse-prd --input=<prd-file.txt>`
  - CLI Syntax: `task-master parse-prd --input=<prd-file.txt>`
  - Description: Parses a PRD document and generates a tasks.json file with structured tasks
  - Parameters: 
    - `--input=<file>`: Path to the PRD text file (default: sample-prd.txt)
  - Example: `task-master parse-prd --input=requirements.txt`
  - Notes: Will overwrite existing tasks.json file. Use with caution.

- **Command Reference: update**
  - Legacy Syntax: `node scripts/dev.js update --from=<id> --prompt="<prompt>"`
  - CLI Syntax: `task-master update --from=<id> --prompt="<prompt>"`
  - Description: Updates tasks with ID >= specified ID based on the provided prompt
  - Parameters:
    - `--from=<id>`: Task ID from which to start updating (required)
    - `--prompt="<text>"`: Explanation of changes or new context (required)
  - Example: `task-master update --from=4 --prompt="Now we are using Express instead of Fastify."`
  - Notes: Only updates tasks not marked as 'done'. Completed tasks remain unchanged.

- **Command Reference: generate**
  - Legacy Syntax: `node scripts/dev.js generate`
  - CLI Syntax: `task-master generate`
  - Description: Generates individual task files in tasks/ directory based on tasks.json
  - Parameters: 
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
    - `--output=<dir>, -o`: Output directory (default: 'tasks')
  - Example: `task-master generate`
  - Notes: Overwrites existing task files. Creates tasks/ directory if needed.

- **Command Reference: set-status**
  - Legacy Syntax: `node scripts/dev.js set-status --id=<id> --status=<status>`
  - CLI Syntax: `task-master set-status --id=<id> --status=<status>`
  - Description: Updates the status of a specific task in tasks.json
  - Parameters:
    - `--id=<id>`: ID of the task to update (required)
    - `--status=<status>`: New status value (required)
  - Example: `task-master set-status --id=3 --status=done`
  - Notes: Common values are 'done', 'pending', and 'deferred', but any string is accepted.

- **Command Reference: list**
  - Legacy Syntax: `node scripts/dev.js list`
  - CLI Syntax: `task-master list`
  - Description: Lists all tasks in tasks.json with IDs, titles, and status
  - Parameters: 
    - `--status=<status>, -s`: Filter by status
    - `--with-subtasks`: Show subtasks for each task
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master list`
  - Notes: Provides quick overview of project progress. Use at start of sessions.

- **Command Reference: expand**
  - Legacy Syntax: `node scripts/dev.js expand --id=<id> [--num=<number>] [--research] [--prompt="<context>"]`
  - CLI Syntax: `task-master expand --id=<id> [--num=<number>] [--research] [--prompt="<context>"]`
  - Description: Expands a task with subtasks for detailed implementation
  - Parameters:
    - `--id=<id>`: ID of task to expand (required unless using --all)
    - `--all`: Expand all pending tasks, prioritized by complexity
    - `--num=<number>`: Number of subtasks to generate (default: from complexity report)
    - `--research`: Use Perplexity AI for research-backed generation
    - `--prompt="<text>"`: Additional context for subtask generation
    - `--force`: Regenerate subtasks even for tasks that already have them
  - Example: `task-master expand --id=3 --num=5 --research --prompt="Focus on security aspects"`
  - Notes: Uses complexity report recommendations if available.

- **Command Reference: analyze-complexity**
  - Legacy Syntax: `node scripts/dev.js analyze-complexity [options]`
  - CLI Syntax: `task-master analyze-complexity [options]`
  - Description: Analyzes task complexity and generates expansion recommendations
  - Parameters:
    - `--output=<file>, -o`: Output file path (default: scripts/task-complexity-report.json)
    - `--model=<model>, -m`: Override LLM model to use
    - `--threshold=<number>, -t`: Minimum score for expansion recommendation (default: 5)
    - `--file=<path>, -f`: Use alternative tasks.json file
    - `--research, -r`: Use Perplexity AI for research-backed analysis
  - Example: `task-master analyze-complexity --research`
  - Notes: Report includes complexity scores, recommended subtasks, and tailored prompts.

- **Command Reference: clear-subtasks**
  - Legacy Syntax: `node scripts/dev.js clear-subtasks --id=<id>`
  - CLI Syntax: `task-master clear-subtasks --id=<id>`
  - Description: Removes subtasks from specified tasks to allow regeneration
  - Parameters:
    - `--id=<id>`: ID or comma-separated IDs of tasks to clear subtasks from
    - `--all`: Clear subtasks from all tasks
  - Examples:
    - `task-master clear-subtasks --id=3`
    - `task-master clear-subtasks --id=1,2,3`
    - `task-master clear-subtasks --all`
  - Notes: 
    - Task files are automatically regenerated after clearing subtasks
    - Can be combined with expand command to immediately generate new subtasks
    - Works with both parent tasks and individual subtasks

- **Task Structure Fields**
  - **id**: Unique identifier for the task (Example: `1`)
  - **title**: Brief, descriptive title (Example: `"Initialize Repo"`)
  - **description**: Concise summary of what the task involves (Example: `"Create a new repository, set up initial structure."`)
  - **status**: Current state of the task (Example: `"pending"`, `"done"`, `"deferred"`)
  - **dependencies**: IDs of prerequisite tasks (Example: `[1, 2]`)
    - Dependencies are displayed with status indicators (✅ for completed, ⏱️ for pending)
    - This helps quickly identify which prerequisite tasks are blocking work
  - **priority**: Importance level (Example: `"high"`, `"medium"`, `"low"`)
  - **details**: In-depth implementation instructions (Example: `"Use GitHub client ID/secret, handle callback, set session token."`)
  - **testStrategy**: Verification approach (Example: `"Deploy and call endpoint to confirm 'Hello World' response."`)
  - **subtasks**: List of smaller, more specific tasks (Example: `[{"id": 1, "title": "Configure OAuth", ...}]`)

- **Environment Variables Configuration**
  - **ANTHROPIC_API_KEY** (Required): Your Anthropic API key for Claude (Example: `ANTHROPIC_API_KEY=sk-ant-api03-...`)
  - **MODEL** (Default: `"claude-3-7-sonnet-20250219"`): Claude model to use (Example: `MODEL=claude-3-opus-20240229`)
  - **MAX_TOKENS** (Default: `"4000"`): Maximum tokens for responses (Example: `MAX_TOKENS=8000`)
  - **TEMPERATURE** (Default: `"0.7"`): Temperature for model responses (Example: `TEMPERATURE=0.5`)
  - **DEBUG** (Default: `"false"`): Enable debug logging (Example: `DEBUG=true`)
  - **TASKMASTER_LOG_LEVEL** (Default: `"info"`): Console output level (Example: `TASKMASTER_LOG_LEVEL=debug`)
  - **DEFAULT_SUBTASKS** (Default: `"3"`): Default subtask count (Example: `DEFAULT_SUBTASKS=5`)
  - **DEFAULT_PRIORITY** (Default: `"medium"`): Default priority (Example: `DEFAULT_PRIORITY=high`)
  - **PROJECT_NAME** (Default: `"MCP SaaS MVP"`): Project name in metadata (Example: `PROJECT_NAME=My Awesome Project`)
  - **PROJECT_VERSION** (Default: `"1.0.0"`): Version in metadata (Example: `PROJECT_VERSION=2.1.0`)
  - **PERPLEXITY_API_KEY**: For research-backed features (Example: `PERPLEXITY_API_KEY=pplx-...`)
  - **PERPLEXITY_MODEL** (Default: `"sonar-medium-online"`): Perplexity model (Example: `PERPLEXITY_MODEL=sonar-large-online`)

- **Determining the Next Task**
  - Run `task-master next` to show the next task to work on
  - The next command identifies tasks with all dependencies satisfied
  - Tasks are prioritized by priority level, dependency count, and ID
  - The command shows comprehensive task information including:
    - Basic task details and description
    - Implementation details
    - Subtasks (if they exist)
    - Contextual suggested actions
  - Recommended before starting any new development work
  - Respects your project's dependency structure
  - Ensures tasks are completed in the appropriate sequence
  - Provides ready-to-use commands for common task actions

- **Viewing Specific Task Details**
  - Run `task-master show <id>` or `task-master show --id=<id>` to view a specific task
  - Use dot notation for subtasks: `task-master show 1.2` (shows subtask 2 of task 1)
  - Displays comprehensive information similar to the next command, but for a specific task
  - For parent tasks, shows all subtasks and their current status
  - For subtasks, shows parent task information and relationship
  - Provides contextual suggested actions appropriate for the specific task
  - Useful for examining task details before implementation or checking status

- **Managing Task Dependencies**
  - Use `task-master add-dependency --id=<id> --depends-on=<id>` to add a dependency
  - Use `task-master remove-dependency --id=<id> --depends-on=<id>` to remove a dependency
  - The system prevents circular dependencies and duplicate dependency entries
  - Dependencies are checked for existence before being added or removed
  - Task files are automatically regenerated after dependency changes
  - Dependencies are visualized with status indicators in task listings and files

- **Command Reference: add-dependency**
  - Legacy Syntax: `node scripts/dev.js add-dependency --id=<id> --depends-on=<id>`
  - CLI Syntax: `task-master add-dependency --id=<id> --depends-on=<id>`
  - Description: Adds a dependency relationship between two tasks
  - Parameters:
    - `--id=<id>`: ID of task that will depend on another task (required)
    - `--depends-on=<id>`: ID of task that will become a dependency (required)
  - Example: `task-master add-dependency --id=22 --depends-on=21`
  - Notes: Prevents circular dependencies and duplicates; updates task files automatically

- **Command Reference: remove-dependency**
  - Legacy Syntax: `node scripts/dev.js remove-dependency --id=<id> --depends-on=<id>`
  - CLI Syntax: `task-master remove-dependency --id=<id> --depends-on=<id>`
  - Description: Removes a dependency relationship between two tasks
  - Parameters:
    - `--id=<id>`: ID of task to remove dependency from (required)
    - `--depends-on=<id>`: ID of task to remove as a dependency (required)
  - Example: `task-master remove-dependency --id=22 --depends-on=21`
  - Notes: Checks if dependency actually exists; updates task files automatically

- **Command Reference: validate-dependencies**
  - Legacy Syntax: `node scripts/dev.js validate-dependencies [options]`
  - CLI Syntax: `task-master validate-dependencies [options]`
  - Description: Checks for and identifies invalid dependencies in tasks.json and task files
  - Parameters:
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master validate-dependencies`
  - Notes: 
    - Reports all non-existent dependencies and self-dependencies without modifying files
    - Provides detailed statistics on task dependency state
    - Use before fix-dependencies to audit your task structure

- **Command Reference: fix-dependencies**
  - Legacy Syntax: `node scripts/dev.js fix-dependencies [options]`
  - CLI Syntax: `task-master fix-dependencies [options]`
  - Description: Finds and fixes all invalid dependencies in tasks.json and task files
  - Parameters:
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master fix-dependencies`
  - Notes: 
    - Removes references to non-existent tasks and subtasks
    - Eliminates self-dependencies (tasks depending on themselves)
    - Regenerates task files with corrected dependencies
    - Provides detailed report of all fixes made

- **Command Reference: complexity-report**
  - Legacy Syntax: `node scripts/dev.js complexity-report [options]`
  - CLI Syntax: `task-master complexity-report [options]`
  - Description: Displays the task complexity analysis report in a formatted, easy-to-read way
  - Parameters:
    - `--file=<path>, -f`: Path to the complexity report file (default: 'scripts/task-complexity-report.json')
  - Example: `task-master complexity-report`
  - Notes: 
    - Shows tasks organized by complexity score with recommended actions
    - Provides complexity distribution statistics
    - Displays ready-to-use expansion commands for complex tasks
    - If no report exists, offers to generate one interactively

- **Command Reference: add-task**
  - CLI Syntax: `task-master add-task [options]`
  - Description: Add a new task to tasks.json using AI
  - Parameters:
    - `--file=<path>, -f`: Path to the tasks file (default: 'tasks/tasks.json')
    - `--prompt=<text>, -p`: Description of the task to add (required)
    - `--dependencies=<ids>, -d`: Comma-separated list of task IDs this task depends on
    - `--priority=<priority>`: Task priority (high, medium, low) (default: 'medium')
  - Example: `task-master add-task --prompt="Create user authentication using Auth0"`
  - Notes: Uses AI to convert description into structured task with appropriate details

- **Command Reference: init**
  - CLI Syntax: `task-master init`
  - Description: Initialize a new project with Task Master structure
  - Parameters: None
  - Example: `task-master init`
  - Notes: 
    - Creates initial project structure with required files
    - Prompts for project settings if not provided
    - Merges with existing files when appropriate
    - Can be used to bootstrap a new Task Master project quickly

- **Code Analysis & Refactoring Techniques**
  - **Top-Level Function Search**
    - Use grep pattern matching to find all exported functions across the codebase
    - Command: `grep -E "export (function|const) \w+|function \w+\(|const \w+ = \(|module\.exports" --include="*.js" -r ./`
    - Benefits:
      - Quickly identify all public API functions without reading implementation details
      - Compare functions between files during refactoring (e.g., monolithic to modular structure)
      - Verify all expected functions exist in refactored modules
      - Identify duplicate functionality or naming conflicts
    - Usage examples:
      - When migrating from `scripts/dev.js` to modular structure: `grep -E "function \w+\(" scripts/dev.js`
      - Check function exports in a directory: `grep -E "export (function|const)" scripts/modules/`
      - Find potential naming conflicts: `grep -E "function (get|set|create|update)\w+\(" -r ./`
    - Variations:
      - Add `-n` flag to include line numbers
      - Add `--include="*.ts"` to filter by file extension
      - Use with `| sort` to alphabetize results
    - Integration with refactoring workflow:
      - Start by mapping all functions in the source file
      - Create target module files based on function grouping
      - Verify all functions were properly migrated
      - Check for any unintentional duplications or omissions

---
WINDSURF_RULES
---
description: Guidelines for creating and maintaining Windsurf rules to ensure consistency and effectiveness.
globs: .windsurfrules
filesToApplyRule: .windsurfrules
alwaysApply: true
---
The below describes how you should be structuring new rule sections in this document.
- **Required Rule Structure:**
  ```markdown
  ---
  description: Clear, one-line description of what the rule enforces
  globs: path/to/files/*.ext, other/path/**/*
  alwaysApply: boolean
  ---

  - **Main Points in Bold**
    - Sub-points with details
    - Examples and explanations
  ```

- **Section References:**
  - Use `ALL_CAPS_SECTION` to reference files
  - Example: `WINDSURF_RULES`

- **Code Examples:**
  - Use language-specific code blocks
  ```typescript
  // ✅ DO: Show good examples
  const goodExample = true;
  
  // ❌ DON'T: Show anti-patterns
  const badExample = false;
  ```

- **Rule Content Guidelines:**
  - Start with high-level overview
  - Include specific, actionable requirements
  - Show examples of correct implementation
  - Reference existing code when possible
  - Keep rules DRY by referencing other rules

- **Rule Maintenance:**
  - Update rules when new patterns emerge
  - Add examples from actual codebase
  - Remove outdated patterns
  - Cross-reference related rules

- **Best Practices:**
  - Use bullet points for clarity
  - Keep descriptions concise
  - Include both DO and DON'T examples
  - Reference actual code over theoretical examples
  - Use consistent formatting across rules 

---
SELF_IMPROVE
---
description: Guidelines for continuously improving this rules document based on emerging code patterns and best practices.
globs: **/*
filesToApplyRule: **/*
alwaysApply: true
---

- **Rule Improvement Triggers:**
  - New code patterns not covered by existing rules
  - Repeated similar implementations across files
  - Common error patterns that could be prevented
  - New libraries or tools being used consistently
  - Emerging best practices in the codebase

- **Analysis Process:**
  - Compare new code with existing rules
  - Identify patterns that should be standardized
  - Look for references to external documentation
  - Check for consistent error handling patterns
  - Monitor test patterns and coverage

- **Rule Updates:**
  - **Add New Rules When:**
    - A new technology/pattern is used in 3+ files
    - Common bugs could be prevented by a rule
    - Code reviews repeatedly mention the same feedback
    - New security or performance patterns emerge

  - **Modify Existing Rules When:**
    - Better examples exist in the codebase
    - Additional edge cases are discovered
    - Related rules have been updated
    - Implementation details have changed

- **Example Pattern Recognition:**
  ```typescript
  // If you see repeated patterns like:
  const data = await prisma.user.findMany({
    select: { id: true, email: true },
    where: { status: 'ACTIVE' }
  });
  
  // Consider adding a PRISMA section in the .windsurfrules:
  // - Standard select fields
  // - Common where conditions
  // - Performance optimization patterns
  ```

- **Rule Quality Checks:**
  - Rules should be actionable and specific
  - Examples should come from actual code
  - References should be up to date
  - Patterns should be consistently enforced

- **Continuous Improvement:**
  - Monitor code review comments
  - Track common development questions
  - Update rules after major refactors
  - Add links to relevant documentation
  - Cross-reference related rules

- **Rule Deprecation:**
  - Mark outdated patterns as deprecated
  - Remove rules that no longer apply
  - Update references to deprecated rules
  - Document migration paths for old patterns

- **Documentation Updates:**
  - Keep examples synchronized with code
  - Update references to external docs
  - Maintain links between related rules
  - Document breaking changes

Follow WINDSURF_RULES for proper rule formatting and structure of windsurf rule sections.

# Added by Task Master - Development Workflow Rules

Below you will find a variety of important rules spanning:
- the dev_workflow
- the .windsurfrules document self-improvement workflow
- the template to follow when modifying or adding new sections/rules to this document.

---
DEV_WORKFLOW
---
description: Guide for using meta-development script (scripts/dev.js) to manage task-driven development workflows
globs: **/*
filesToApplyRule: **/*
alwaysApply: true
---

- **Global CLI Commands**
  - Task Master now provides a global CLI through the `task-master` command
  - All functionality from `scripts/dev.js` is available through this interface
  - Install globally with `npm install -g claude-task-master` or use locally via `npx`
  - Use `task-master <command>` instead of `node scripts/dev.js <command>`
  - Examples:
    - `task-master list` instead of `node scripts/dev.js list`
    - `task-master next` instead of `node scripts/dev.js next`
    - `task-master expand --id=3` instead of `node scripts/dev.js expand --id=3`
  - All commands accept the same options as their script equivalents
  - The CLI provides additional commands like `task-master init` for project setup

- **Development Workflow Process**
  - Start new projects by running `task-master init` or `node scripts/dev.js parse-prd --input=<prd-file.txt>` to generate initial tasks.json
  - Begin coding sessions with `task-master list` to see current tasks, status, and IDs
  - Analyze task complexity with `task-master analyze-complexity --research` before breaking down tasks
  - Select tasks based on dependencies (all marked 'done'), priority level, and ID order
  - Clarify tasks by checking task files in tasks/ directory or asking for user input
  - View specific task details using `task-master show <id>` to understand implementation requirements
  - Break down complex tasks using `task-master expand --id=<id>` with appropriate flags
  - Clear existing subtasks if needed using `task-master clear-subtasks --id=<id>` before regenerating
  - Implement code following task details, dependencies, and project standards
  - Verify tasks according to test strategies before marking as complete
  - Mark completed tasks with `task-master set-status --id=<id> --status=done`
  - Update dependent tasks when implementation differs from original plan
  - Generate task files with `task-master generate` after updating tasks.json
  - Maintain valid dependency structure with `task-master fix-dependencies` when needed
  - Respect dependency chains and task priorities when selecting work
  - Report progress regularly using the list command

- **Task Complexity Analysis**
  - Run `node scripts/dev.js analyze-complexity --research` for comprehensive analysis
  - Review complexity report in scripts/task-complexity-report.json
  - Or use `node scripts/dev.js complexity-report` for a formatted, readable version of the report
  - Focus on tasks with highest complexity scores (8-10) for detailed breakdown
  - Use analysis results to determine appropriate subtask allocation
  - Note that reports are automatically used by the expand command

- **Task Breakdown Process**
  - For tasks with complexity analysis, use `node scripts/dev.js expand --id=<id>`
  - Otherwise use `node scripts/dev.js expand --id=<id> --subtasks=<number>`
  - Add `--research` flag to leverage Perplexity AI for research-backed expansion
  - Use `--prompt="<context>"` to provide additional context when needed
  - Review and adjust generated subtasks as necessary
  - Use `--all` flag to expand multiple pending tasks at once
  - If subtasks need regeneration, clear them first with `clear-subtasks` command

- **Implementation Drift Handling**
  - When implementation differs significantly from planned approach
  - When future tasks need modification due to current implementation choices
  - When new dependencies or requirements emerge
  - Call `node scripts/dev.js update --from=<futureTaskId> --prompt="<explanation>"` to update tasks.json

- **Task Status Management**
  - Use 'pending' for tasks ready to be worked on
  - Use 'done' for completed and verified tasks
  - Use 'deferred' for postponed tasks
  - Add custom status values as needed for project-specific workflows

- **Task File Format Reference**
  ```
  # Task ID: <id>
  # Title: <title>
  # Status: <status>
  # Dependencies: <comma-separated list of dependency IDs>
  # Priority: <priority>
  # Description: <brief description>
  # Details:
  <detailed implementation notes>
  
  # Test Strategy:
  <verification approach>
  ```

- **Command Reference: parse-prd**
  - Legacy Syntax: `node scripts/dev.js parse-prd --input=<prd-file.txt>`
  - CLI Syntax: `task-master parse-prd --input=<prd-file.txt>`
  - Description: Parses a PRD document and generates a tasks.json file with structured tasks
  - Parameters: 
    - `--input=<file>`: Path to the PRD text file (default: sample-prd.txt)
  - Example: `task-master parse-prd --input=requirements.txt`
  - Notes: Will overwrite existing tasks.json file. Use with caution.

- **Command Reference: update**
  - Legacy Syntax: `node scripts/dev.js update --from=<id> --prompt="<prompt>"`
  - CLI Syntax: `task-master update --from=<id> --prompt="<prompt>"`
  - Description: Updates tasks with ID >= specified ID based on the provided prompt
  - Parameters:
    - `--from=<id>`: Task ID from which to start updating (required)
    - `--prompt="<text>"`: Explanation of changes or new context (required)
  - Example: `task-master update --from=4 --prompt="Now we are using Express instead of Fastify."`
  - Notes: Only updates tasks not marked as 'done'. Completed tasks remain unchanged.

- **Command Reference: generate**
  - Legacy Syntax: `node scripts/dev.js generate`
  - CLI Syntax: `task-master generate`
  - Description: Generates individual task files in tasks/ directory based on tasks.json
  - Parameters: 
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
    - `--output=<dir>, -o`: Output directory (default: 'tasks')
  - Example: `task-master generate`
  - Notes: Overwrites existing task files. Creates tasks/ directory if needed.

- **Command Reference: set-status**
  - Legacy Syntax: `node scripts/dev.js set-status --id=<id> --status=<status>`
  - CLI Syntax: `task-master set-status --id=<id> --status=<status>`
  - Description: Updates the status of a specific task in tasks.json
  - Parameters:
    - `--id=<id>`: ID of the task to update (required)
    - `--status=<status>`: New status value (required)
  - Example: `task-master set-status --id=3 --status=done`
  - Notes: Common values are 'done', 'pending', and 'deferred', but any string is accepted.

- **Command Reference: list**
  - Legacy Syntax: `node scripts/dev.js list`
  - CLI Syntax: `task-master list`
  - Description: Lists all tasks in tasks.json with IDs, titles, and status
  - Parameters: 
    - `--status=<status>, -s`: Filter by status
    - `--with-subtasks`: Show subtasks for each task
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master list`
  - Notes: Provides quick overview of project progress. Use at start of sessions.

- **Command Reference: expand**
  - Legacy Syntax: `node scripts/dev.js expand --id=<id> [--num=<number>] [--research] [--prompt="<context>"]`
  - CLI Syntax: `task-master expand --id=<id> [--num=<number>] [--research] [--prompt="<context>"]`
  - Description: Expands a task with subtasks for detailed implementation
  - Parameters:
    - `--id=<id>`: ID of task to expand (required unless using --all)
    - `--all`: Expand all pending tasks, prioritized by complexity
    - `--num=<number>`: Number of subtasks to generate (default: from complexity report)
    - `--research`: Use Perplexity AI for research-backed generation
    - `--prompt="<text>"`: Additional context for subtask generation
    - `--force`: Regenerate subtasks even for tasks that already have them
  - Example: `task-master expand --id=3 --num=5 --research --prompt="Focus on security aspects"`
  - Notes: Uses complexity report recommendations if available.

- **Command Reference: analyze-complexity**
  - Legacy Syntax: `node scripts/dev.js analyze-complexity [options]`
  - CLI Syntax: `task-master analyze-complexity [options]`
  - Description: Analyzes task complexity and generates expansion recommendations
  - Parameters:
    - `--output=<file>, -o`: Output file path (default: scripts/task-complexity-report.json)
    - `--model=<model>, -m`: Override LLM model to use
    - `--threshold=<number>, -t`: Minimum score for expansion recommendation (default: 5)
    - `--file=<path>, -f`: Use alternative tasks.json file
    - `--research, -r`: Use Perplexity AI for research-backed analysis
  - Example: `task-master analyze-complexity --research`
  - Notes: Report includes complexity scores, recommended subtasks, and tailored prompts.

- **Command Reference: clear-subtasks**
  - Legacy Syntax: `node scripts/dev.js clear-subtasks --id=<id>`
  - CLI Syntax: `task-master clear-subtasks --id=<id>`
  - Description: Removes subtasks from specified tasks to allow regeneration
  - Parameters:
    - `--id=<id>`: ID or comma-separated IDs of tasks to clear subtasks from
    - `--all`: Clear subtasks from all tasks
  - Examples:
    - `task-master clear-subtasks --id=3`
    - `task-master clear-subtasks --id=1,2,3`
    - `task-master clear-subtasks --all`
  - Notes: 
    - Task files are automatically regenerated after clearing subtasks
    - Can be combined with expand command to immediately generate new subtasks
    - Works with both parent tasks and individual subtasks

- **Task Structure Fields**
  - **id**: Unique identifier for the task (Example: `1`)
  - **title**: Brief, descriptive title (Example: `"Initialize Repo"`)
  - **description**: Concise summary of what the task involves (Example: `"Create a new repository, set up initial structure."`)
  - **status**: Current state of the task (Example: `"pending"`, `"done"`, `"deferred"`)
  - **dependencies**: IDs of prerequisite tasks (Example: `[1, 2]`)
    - Dependencies are displayed with status indicators (✅ for completed, ⏱️ for pending)
    - This helps quickly identify which prerequisite tasks are blocking work
  - **priority**: Importance level (Example: `"high"`, `"medium"`, `"low"`)
  - **details**: In-depth implementation instructions (Example: `"Use GitHub client ID/secret, handle callback, set session token."`)
  - **testStrategy**: Verification approach (Example: `"Deploy and call endpoint to confirm 'Hello World' response."`)
  - **subtasks**: List of smaller, more specific tasks (Example: `[{"id": 1, "title": "Configure OAuth", ...}]`)

- **Environment Variables Configuration**
  - **ANTHROPIC_API_KEY** (Required): Your Anthropic API key for Claude (Example: `ANTHROPIC_API_KEY=sk-ant-api03-...`)
  - **MODEL** (Default: `"claude-3-7-sonnet-20250219"`): Claude model to use (Example: `MODEL=claude-3-opus-20240229`)
  - **MAX_TOKENS** (Default: `"4000"`): Maximum tokens for responses (Example: `MAX_TOKENS=8000`)
  - **TEMPERATURE** (Default: `"0.7"`): Temperature for model responses (Example: `TEMPERATURE=0.5`)
  - **DEBUG** (Default: `"false"`): Enable debug logging (Example: `DEBUG=true`)
  - **TASKMASTER_LOG_LEVEL** (Default: `"info"`): Console output level (Example: `TASKMASTER_LOG_LEVEL=debug`)
  - **DEFAULT_SUBTASKS** (Default: `"3"`): Default subtask count (Example: `DEFAULT_SUBTASKS=5`)
  - **DEFAULT_PRIORITY** (Default: `"medium"`): Default priority (Example: `DEFAULT_PRIORITY=high`)
  - **PROJECT_NAME** (Default: `"MCP SaaS MVP"`): Project name in metadata (Example: `PROJECT_NAME=My Awesome Project`)
  - **PROJECT_VERSION** (Default: `"1.0.0"`): Version in metadata (Example: `PROJECT_VERSION=2.1.0`)
  - **PERPLEXITY_API_KEY**: For research-backed features (Example: `PERPLEXITY_API_KEY=pplx-...`)
  - **PERPLEXITY_MODEL** (Default: `"sonar-medium-online"`): Perplexity model (Example: `PERPLEXITY_MODEL=sonar-large-online`)

- **Determining the Next Task**
  - Run `task-master next` to show the next task to work on
  - The next command identifies tasks with all dependencies satisfied
  - Tasks are prioritized by priority level, dependency count, and ID
  - The command shows comprehensive task information including:
    - Basic task details and description
    - Implementation details
    - Subtasks (if they exist)
    - Contextual suggested actions
  - Recommended before starting any new development work
  - Respects your project's dependency structure
  - Ensures tasks are completed in the appropriate sequence
  - Provides ready-to-use commands for common task actions

- **Viewing Specific Task Details**
  - Run `task-master show <id>` or `task-master show --id=<id>` to view a specific task
  - Use dot notation for subtasks: `task-master show 1.2` (shows subtask 2 of task 1)
  - Displays comprehensive information similar to the next command, but for a specific task
  - For parent tasks, shows all subtasks and their current status
  - For subtasks, shows parent task information and relationship
  - Provides contextual suggested actions appropriate for the specific task
  - Useful for examining task details before implementation or checking status

- **Managing Task Dependencies**
  - Use `task-master add-dependency --id=<id> --depends-on=<id>` to add a dependency
  - Use `task-master remove-dependency --id=<id> --depends-on=<id>` to remove a dependency
  - The system prevents circular dependencies and duplicate dependency entries
  - Dependencies are checked for existence before being added or removed
  - Task files are automatically regenerated after dependency changes
  - Dependencies are visualized with status indicators in task listings and files

- **Command Reference: add-dependency**
  - Legacy Syntax: `node scripts/dev.js add-dependency --id=<id> --depends-on=<id>`
  - CLI Syntax: `task-master add-dependency --id=<id> --depends-on=<id>`
  - Description: Adds a dependency relationship between two tasks
  - Parameters:
    - `--id=<id>`: ID of task that will depend on another task (required)
    - `--depends-on=<id>`: ID of task that will become a dependency (required)
  - Example: `task-master add-dependency --id=22 --depends-on=21`
  - Notes: Prevents circular dependencies and duplicates; updates task files automatically

- **Command Reference: remove-dependency**
  - Legacy Syntax: `node scripts/dev.js remove-dependency --id=<id> --depends-on=<id>`
  - CLI Syntax: `task-master remove-dependency --id=<id> --depends-on=<id>`
  - Description: Removes a dependency relationship between two tasks
  - Parameters:
    - `--id=<id>`: ID of task to remove dependency from (required)
    - `--depends-on=<id>`: ID of task to remove as a dependency (required)
  - Example: `task-master remove-dependency --id=22 --depends-on=21`
  - Notes: Checks if dependency actually exists; updates task files automatically

- **Command Reference: validate-dependencies**
  - Legacy Syntax: `node scripts/dev.js validate-dependencies [options]`
  - CLI Syntax: `task-master validate-dependencies [options]`
  - Description: Checks for and identifies invalid dependencies in tasks.json and task files
  - Parameters:
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master validate-dependencies`
  - Notes: 
    - Reports all non-existent dependencies and self-dependencies without modifying files
    - Provides detailed statistics on task dependency state
    - Use before fix-dependencies to audit your task structure

- **Command Reference: fix-dependencies**
  - Legacy Syntax: `node scripts/dev.js fix-dependencies [options]`
  - CLI Syntax: `task-master fix-dependencies [options]`
  - Description: Finds and fixes all invalid dependencies in tasks.json and task files
  - Parameters:
    - `--file=<path>, -f`: Use alternative tasks.json file (default: 'tasks/tasks.json')
  - Example: `task-master fix-dependencies`
  - Notes: 
    - Removes references to non-existent tasks and subtasks
    - Eliminates self-dependencies (tasks depending on themselves)
    - Regenerates task files with corrected dependencies
    - Provides detailed report of all fixes made

- **Command Reference: complexity-report**
  - Legacy Syntax: `node scripts/dev.js complexity-report [options]`
  - CLI Syntax: `task-master complexity-report [options]`
  - Description: Displays the task complexity analysis report in a formatted, easy-to-read way
  - Parameters:
    - `--file=<path>, -f`: Path to the complexity report file (default: 'scripts/task-complexity-report.json')
  - Example: `task-master complexity-report`
  - Notes: 
    - Shows tasks organized by complexity score with recommended actions
    - Provides complexity distribution statistics
    - Displays ready-to-use expansion commands for complex tasks
    - If no report exists, offers to generate one interactively

- **Command Reference: add-task**
  - CLI Syntax: `task-master add-task [options]`
  - Description: Add a new task to tasks.json using AI
  - Parameters:
    - `--file=<path>, -f`: Path to the tasks file (default: 'tasks/tasks.json')
    - `--prompt=<text>, -p`: Description of the task to add (required)
    - `--dependencies=<ids>, -d`: Comma-separated list of task IDs this task depends on
    - `--priority=<priority>`: Task priority (high, medium, low) (default: 'medium')
  - Example: `task-master add-task --prompt="Create user authentication using Auth0"`
  - Notes: Uses AI to convert description into structured task with appropriate details

- **Command Reference: init**
  - CLI Syntax: `task-master init`
  - Description: Initialize a new project with Task Master structure
  - Parameters: None
  - Example: `task-master init`
  - Notes: 
    - Creates initial project structure with required files
    - Prompts for project settings if not provided
    - Merges with existing files when appropriate
    - Can be used to bootstrap a new Task Master project quickly

- **Code Analysis & Refactoring Techniques**
  - **Top-Level Function Search**
    - Use grep pattern matching to find all exported functions across the codebase
    - Command: `grep -E "export (function|const) \w+|function \w+\(|const \w+ = \(|module\.exports" --include="*.js" -r ./`
    - Benefits:
      - Quickly identify all public API functions without reading implementation details
      - Compare functions between files during refactoring (e.g., monolithic to modular structure)
      - Verify all expected functions exist in refactored modules
      - Identify duplicate functionality or naming conflicts
    - Usage examples:
      - When migrating from `scripts/dev.js` to modular structure: `grep -E "function \w+\(" scripts/dev.js`
      - Check function exports in a directory: `grep -E "export (function|const)" scripts/modules/`
      - Find potential naming conflicts: `grep -E "function (get|set|create|update)\w+\(" -r ./`
    - Variations:
      - Add `-n` flag to include line numbers
      - Add `--include="*.ts"` to filter by file extension
      - Use with `| sort` to alphabetize results
    - Integration with refactoring workflow:
      - Start by mapping all functions in the source file
      - Create target module files based on function grouping
      - Verify all functions were properly migrated
      - Check for any unintentional duplications or omissions

---
WINDSURF_RULES
---
description: Guidelines for creating and maintaining Windsurf rules to ensure consistency and effectiveness.
globs: .windsurfrules
filesToApplyRule: .windsurfrules
alwaysApply: true
---
The below describes how you should be structuring new rule sections in this document.
- **Required Rule Structure:**
  ```markdown
  ---
  description: Clear, one-line description of what the rule enforces
  globs: path/to/files/*.ext, other/path/**/*
  alwaysApply: boolean
  ---

  - **Main Points in Bold**
    - Sub-points with details
    - Examples and explanations
  ```

- **Section References:**
  - Use `ALL_CAPS_SECTION` to reference files
  - Example: `WINDSURF_RULES`

- **Code Examples:**
  - Use language-specific code blocks
  ```typescript
  // ✅ DO: Show good examples
  const goodExample = true;
  
  // ❌ DON'T: Show anti-patterns
  const badExample = false;
  ```

- **Rule Content Guidelines:**
  - Start with high-level overview
  - Include specific, actionable requirements
  - Show examples of correct implementation
  - Reference existing code when possible
  - Keep rules DRY by referencing other rules

- **Rule Maintenance:**
  - Update rules when new patterns emerge
  - Add examples from actual codebase
  - Remove outdated patterns
  - Cross-reference related rules

- **Best Practices:**
  - Use bullet points for clarity
  - Keep descriptions concise
  - Include both DO and DON'T examples
  - Reference actual code over theoretical examples
  - Use consistent formatting across rules 

---
SELF_IMPROVE
---
description: Guidelines for continuously improving this rules document based on emerging code patterns and best practices.
globs: **/*
filesToApplyRule: **/*
alwaysApply: true
---

- **Rule Improvement Triggers:**
  - New code patterns not covered by existing rules
  - Repeated similar implementations across files
  - Common error patterns that could be prevented
  - New libraries or tools being used consistently
  - Emerging best practices in the codebase

- **Analysis Process:**
  - Compare new code with existing rules
  - Identify patterns that should be standardized
  - Look for references to external documentation
  - Check for consistent error handling patterns
  - Monitor test patterns and coverage

- **Rule Updates:**
  - **Add New Rules When:**
    - A new technology/pattern is used in 3+ files
    - Common bugs could be prevented by a rule
    - Code reviews repeatedly mention the same feedback
    - New security or performance patterns emerge

  - **Modify Existing Rules When:**
    - Better examples exist in the codebase
    - Additional edge cases are discovered
    - Related rules have been updated
    - Implementation details have changed

- **Example Pattern Recognition:**
  ```typescript
  // If you see repeated patterns like:
  const data = await prisma.user.findMany({
    select: { id: true, email: true },
    where: { status: 'ACTIVE' }
  });
  
  // Consider adding a PRISMA section in the .windsurfrules:
  // - Standard select fields
  // - Common where conditions
  // - Performance optimization patterns
  ```

- **Rule Quality Checks:**
  - Rules should be actionable and specific
  - Examples should come from actual code
  - References should be up to date
  - Patterns should be consistently enforced

- **Continuous Improvement:**
  - Monitor code review comments
  - Track common development questions
  - Update rules after major refactors
  - Add links to relevant documentation
  - Cross-reference related rules

- **Rule Deprecation:**
  - Mark outdated patterns as deprecated
  - Remove rules that no longer apply
  - Update references to deprecated rules
  - Document migration paths for old patterns

- **Documentation Updates:**
  - Keep examples synchronized with code
  - Update references to external docs
  - Maintain links between related rules
  - Document breaking changes

Follow WINDSURF_RULES for proper rule formatting and structure of windsurf rule sections.

================
File: database/functions_and_views.sql
================
-- Course Builder Database Functions and Views
-- Useful helper functions and views for the application

-- Function to generate a unique public slug
CREATE OR REPLACE FUNCTION generate_unique_slug(base_text TEXT, table_name TEXT)
RETURNS TEXT AS $$
DECLARE
    slug TEXT;
    counter INTEGER := 0;
    exists_check BOOLEAN;
BEGIN
    -- Convert to lowercase and replace spaces/special chars with hyphens
    slug := lower(regexp_replace(base_text, '[^a-zA-Z0-9]+', '-', 'g'));
    slug := trim(both '-' from slug);
    
    -- Check if slug exists
    EXECUTE format('SELECT EXISTS(SELECT 1 FROM %I WHERE public_slug = $1)', table_name)
    INTO exists_check
    USING slug;
    
    -- If exists, append counter until unique
    WHILE exists_check LOOP
        counter := counter + 1;
        EXECUTE format('SELECT EXISTS(SELECT 1 FROM %I WHERE public_slug = $1)', table_name)
        INTO exists_check
        USING slug || '-' || counter;
    END LOOP;
    
    IF counter > 0 THEN
        slug := slug || '-' || counter;
    END IF;
    
    RETURN slug;
END;
$$ LANGUAGE plpgsql;

-- Function to calculate course progress
CREATE OR REPLACE FUNCTION calculate_course_progress(course_id_param UUID, user_id_param UUID)
RETURNS TABLE (
    total_lessons INTEGER,
    completed_lessons INTEGER,
    progress_percentage NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(*)::INTEGER as total_lessons,
        COUNT(CASE WHEN l.status = 'completed' THEN 1 END)::INTEGER as completed_lessons,
        ROUND(
            CASE 
                WHEN COUNT(*) > 0 
                THEN (COUNT(CASE WHEN l.status = 'completed' THEN 1 END)::NUMERIC / COUNT(*)::NUMERIC) * 100
                ELSE 0
            END, 2
        ) as progress_percentage
    FROM schedules s
    JOIN lessons l ON l.schedule_id = s.id
    WHERE s.course_id = course_id_param
    AND s.user_id = user_id_param;
END;
$$ LANGUAGE plpgsql;

-- View for course overview with statistics
CREATE VIEW course_overview AS
SELECT 
    c.id,
    c.title,
    c.description,
    c.status,
    c.difficulty,
    c.user_id,
    c.created_at,
    c.updated_at,
    c.published_at,
    COUNT(DISTINCT cb.book_id) as book_count,
    COUNT(DISTINCT cvg.vocabulary_group_id) as vocabulary_group_count,
    COUNT(DISTINCT s.id) as schedule_count,
    CASE 
        WHEN c.is_public = true THEN c.public_slug 
        ELSE NULL 
    END as public_slug
FROM courses c
LEFT JOIN course_books cb ON cb.course_id = c.id
LEFT JOIN course_vocabulary_groups cvg ON cvg.course_id = c.id
LEFT JOIN schedules s ON s.course_id = c.id
GROUP BY c.id;

-- View for upcoming lessons
CREATE VIEW upcoming_lessons AS
SELECT 
    l.*,
    s.name as schedule_name,
    s.course_id,
    c.title as course_title,
    s.user_id
FROM lessons l
JOIN schedules s ON s.id = l.schedule_id
LEFT JOIN courses c ON c.id = s.course_id
WHERE l.date >= CURRENT_DATE
AND l.status IN ('draft', 'scheduled')
ORDER BY l.date, l.start_time;

-- Function to get vocabulary statistics
CREATE OR REPLACE FUNCTION get_vocabulary_stats(user_id_param UUID)
RETURNS TABLE (
    total_words INTEGER,
    total_groups INTEGER,
    words_by_difficulty JSONB,
    words_by_language JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(DISTINCT v.id)::INTEGER as total_words,
        COUNT(DISTINCT vg.id)::INTEGER as total_groups,
        jsonb_build_object(
            'beginner', COUNT(DISTINCT CASE WHEN v.difficulty = 'beginner' THEN v.id END),
            'intermediate', COUNT(DISTINCT CASE WHEN v.difficulty = 'intermediate' THEN v.id END),
            'advanced', COUNT(DISTINCT CASE WHEN v.difficulty = 'advanced' THEN v.id END),
            'expert', COUNT(DISTINCT CASE WHEN v.difficulty = 'expert' THEN v.id END)
        ) as words_by_difficulty,
        jsonb_object_agg(
            COALESCE(vg.language, 'unknown'),
            word_count
        ) as words_by_language
    FROM vocabulary v
    LEFT JOIN vocabulary_group_items vgi ON vgi.vocabulary_id = v.id
    LEFT JOIN vocabulary_groups vg ON vg.id = vgi.vocabulary_group_id
    LEFT JOIN (
        SELECT vg.language, COUNT(DISTINCT vgi.vocabulary_id) as word_count
        FROM vocabulary_groups vg
        JOIN vocabulary_group_items vgi ON vgi.vocabulary_group_id = vg.id
        WHERE vg.user_id = user_id_param
        GROUP BY vg.language
    ) lang_stats ON true
    WHERE v.user_id = user_id_param
    GROUP BY lang_stats.words_by_language;
END;
$$ LANGUAGE plpgsql;

-- Function to clone a template (objectives, methods, or tasks)
CREATE OR REPLACE FUNCTION clone_template(
    template_id UUID,
    template_type TEXT,
    new_user_id UUID
) RETURNS UUID AS $$
DECLARE
    new_id UUID;
BEGIN
    CASE template_type
        WHEN 'objective' THEN
            INSERT INTO objectives (title, description, category_id, bloom_level, measurable, tags, is_template, user_id, metadata)
            SELECT title, description, category_id, bloom_level, measurable, tags, false, new_user_id, metadata
            FROM objectives
            WHERE id = template_id AND is_template = true
            RETURNING id INTO new_id;
            
        WHEN 'method' THEN
            INSERT INTO methods (name, description, category_id, instructions, duration_minutes, group_size_min, group_size_max, materials_needed, tags, is_template, user_id, metadata)
            SELECT name, description, category_id, instructions, duration_minutes, group_size_min, group_size_max, materials_needed, tags, false, new_user_id, metadata
            FROM methods
            WHERE id = template_id AND is_template = true
            RETURNING id INTO new_id;
            
        WHEN 'task' THEN
            INSERT INTO tasks (title, description, category_id, instructions, duration_minutes, difficulty, materials_needed, assessment_criteria, tags, is_template, user_id, metadata)
            SELECT title, description, category_id, instructions, duration_minutes, difficulty, materials_needed, assessment_criteria, tags, false, new_user_id, metadata
            FROM tasks
            WHERE id = template_id AND is_template = true
            RETURNING id INTO new_id;
            
        ELSE
            RAISE EXCEPTION 'Invalid template type: %', template_type;
    END CASE;
    
    RETURN new_id;
END;
$$ LANGUAGE plpgsql;

-- Function to search across multiple entities
CREATE OR REPLACE FUNCTION search_all_entities(
    search_query TEXT,
    user_id_param UUID,
    entity_types TEXT[] DEFAULT ARRAY['course', 'book', 'vocabulary', 'objective', 'method', 'task']
) RETURNS TABLE (
    entity_type TEXT,
    entity_id UUID,
    title TEXT,
    description TEXT,
    match_rank REAL
) AS $$
BEGIN
    RETURN QUERY
    WITH search_results AS (
        -- Search courses
        SELECT 
            'course'::TEXT as entity_type,
            c.id as entity_id,
            c.title::TEXT,
            c.description::TEXT,
            ts_rank(to_tsvector('english', c.title || ' ' || COALESCE(c.description, '')), plainto_tsquery('english', search_query)) as match_rank
        FROM courses c
        WHERE c.user_id = user_id_param
        AND 'course' = ANY(entity_types)
        AND to_tsvector('english', c.title || ' ' || COALESCE(c.description, '')) @@ plainto_tsquery('english', search_query)
        
        UNION ALL
        
        -- Search books
        SELECT 
            'book'::TEXT,
            b.id,
            b.title::TEXT,
            b.description::TEXT,
            ts_rank(to_tsvector('english', b.title || ' ' || COALESCE(b.author, '') || ' ' || COALESCE(b.description, '')), plainto_tsquery('english', search_query))
        FROM books b
        WHERE b.user_id = user_id_param
        AND 'book' = ANY(entity_types)
        AND to_tsvector('english', b.title || ' ' || COALESCE(b.author, '') || ' ' || COALESCE(b.description, '')) @@ plainto_tsquery('english', search_query)
        
        UNION ALL
        
        -- Search vocabulary
        SELECT 
            'vocabulary'::TEXT,
            v.id,
            v.word::TEXT,
            v.definition::TEXT,
            ts_rank(to_tsvector('english', v.word || ' ' || COALESCE(v.translation, '') || ' ' || COALESCE(v.definition, '')), plainto_tsquery('english', search_query))
        FROM vocabulary v
        WHERE v.user_id = user_id_param
        AND 'vocabulary' = ANY(entity_types)
        AND to_tsvector('english', v.word || ' ' || COALESCE(v.translation, '') || ' ' || COALESCE(v.definition, '')) @@ plainto_tsquery('english', search_query)
        
        UNION ALL
        
        -- Search objectives
        SELECT 
            'objective'::TEXT,
            o.id,
            o.title::TEXT,
            o.description::TEXT,
            ts_rank(to_tsvector('english', o.title || ' ' || COALESCE(o.description, '')), plainto_tsquery('english', search_query))
        FROM objectives o
        WHERE (o.user_id = user_id_param OR o.is_template = true)
        AND 'objective' = ANY(entity_types)
        AND to_tsvector('english', o.title || ' ' || COALESCE(o.description, '')) @@ plainto_tsquery('english', search_query)
        
        UNION ALL
        
        -- Search methods
        SELECT 
            'method'::TEXT,
            m.id,
            m.name::TEXT,
            m.description::TEXT,
            ts_rank(to_tsvector('english', m.name || ' ' || COALESCE(m.description, '')), plainto_tsquery('english', search_query))
        FROM methods m
        WHERE (m.user_id = user_id_param OR m.is_template = true)
        AND 'method' = ANY(entity_types)
        AND to_tsvector('english', m.name || ' ' || COALESCE(m.description, '')) @@ plainto_tsquery('english', search_query)
        
        UNION ALL
        
        -- Search tasks
        SELECT 
            'task'::TEXT,
            t.id,
            t.title::TEXT,
            t.description::TEXT,
            ts_rank(to_tsvector('english', t.title || ' ' || COALESCE(t.description, '')), plainto_tsquery('english', search_query))
        FROM tasks t
        WHERE (t.user_id = user_id_param OR t.is_template = true)
        AND 'task' = ANY(entity_types)
        AND to_tsvector('english', t.title || ' ' || COALESCE(t.description, '')) @@ plainto_tsquery('english', search_query)
    )
    SELECT * FROM search_results
    ORDER BY match_rank DESC
    LIMIT 50;
END;
$$ LANGUAGE plpgsql;

================
File: database/migration_001_initial_schema.sql
================
-- Course Builder Database Migration
-- Migration: 001_initial_schema
-- Description: Create initial database schema for Course Builder application
-- Date: 2025-06-08

-- Include schema
\i schema.sql

-- Include RLS policies
\i rls_policies.sql

-- Create some initial template data for users
INSERT INTO objectives (title, description, bloom_level, is_template, user_id) VALUES
('Understand key concepts', 'Students will be able to understand and explain the key concepts', 'understand', true, auth.uid()),
('Apply knowledge', 'Students will be able to apply the learned concepts in practical scenarios', 'apply', true, auth.uid()),
('Analyze problems', 'Students will be able to analyze complex problems and break them down', 'analyze', true, auth.uid()),
('Create solutions', 'Students will be able to create innovative solutions to problems', 'create', true, auth.uid());

INSERT INTO methods (name, description, instructions, duration_minutes, is_template, user_id) VALUES
('Lecture', 'Traditional lecture format', 'Present information to students in a structured manner', 45, true, auth.uid()),
('Group Discussion', 'Interactive group discussion', 'Facilitate discussion among students on the topic', 30, true, auth.uid()),
('Hands-on Practice', 'Practical exercises', 'Guide students through practical exercises', 60, true, auth.uid()),
('Peer Review', 'Students review each other''s work', 'Organize peer review sessions for feedback', 30, true, auth.uid());

INSERT INTO tasks (title, description, instructions, duration_minutes, is_template, user_id) VALUES
('Reading Assignment', 'Assigned reading from textbook or materials', 'Read the specified chapters and take notes', 60, true, auth.uid()),
('Written Exercise', 'Writing assignment or essay', 'Complete the writing assignment following guidelines', 90, true, auth.uid()),
('Problem Set', 'Mathematical or logical problems to solve', 'Solve all problems showing your work', 45, true, auth.uid()),
('Project Work', 'Work on course project', 'Continue working on your project following the requirements', 120, true, auth.uid());

-- Add a comment to track migration
COMMENT ON SCHEMA public IS 'Course Builder initial schema v1.0.0';

================
File: database/rls_policies.sql
================
-- Row Level Security Policies for Course Builder
-- Enable RLS on all tables

-- Categories RLS
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own categories" ON categories
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own categories" ON categories
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own categories" ON categories
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own categories" ON categories
    FOR DELETE USING (auth.uid() = user_id);

-- Courses RLS
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own courses" ON courses
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view public courses" ON courses
    FOR SELECT USING (is_public = true);

CREATE POLICY "Users can insert their own courses" ON courses
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own courses" ON courses
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own courses" ON courses
    FOR DELETE USING (auth.uid() = user_id);

-- Books RLS
ALTER TABLE books ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own books" ON books
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view public books" ON books
    FOR SELECT USING (is_public = true);

CREATE POLICY "Users can insert their own books" ON books
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own books" ON books
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own books" ON books
    FOR DELETE USING (auth.uid() = user_id);

-- Vocabulary Groups RLS
ALTER TABLE vocabulary_groups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own vocabulary groups" ON vocabulary_groups
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view public vocabulary groups" ON vocabulary_groups
    FOR SELECT USING (is_public = true);

CREATE POLICY "Users can insert their own vocabulary groups" ON vocabulary_groups
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own vocabulary groups" ON vocabulary_groups
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own vocabulary groups" ON vocabulary_groups
    FOR DELETE USING (auth.uid() = user_id);

-- Vocabulary RLS
ALTER TABLE vocabulary ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own vocabulary" ON vocabulary
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own vocabulary" ON vocabulary
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own vocabulary" ON vocabulary
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own vocabulary" ON vocabulary
    FOR DELETE USING (auth.uid() = user_id);

-- Vocabulary Group Items RLS
ALTER TABLE vocabulary_group_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view vocabulary group items they own" ON vocabulary_group_items
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM vocabulary_groups vg
            WHERE vg.id = vocabulary_group_items.vocabulary_group_id
            AND vg.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can insert vocabulary group items they own" ON vocabulary_group_items
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM vocabulary_groups vg
            WHERE vg.id = vocabulary_group_items.vocabulary_group_id
            AND vg.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can update vocabulary group items they own" ON vocabulary_group_items
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM vocabulary_groups vg
            WHERE vg.id = vocabulary_group_items.vocabulary_group_id
            AND vg.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can delete vocabulary group items they own" ON vocabulary_group_items
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM vocabulary_groups vg
            WHERE vg.id = vocabulary_group_items.vocabulary_group_id
            AND vg.user_id = auth.uid()
        )
    );

-- Objectives RLS
ALTER TABLE objectives ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own objectives" ON objectives
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view template objectives" ON objectives
    FOR SELECT USING (is_template = true);

CREATE POLICY "Users can insert their own objectives" ON objectives
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own objectives" ON objectives
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own objectives" ON objectives
    FOR DELETE USING (auth.uid() = user_id);

-- Methods RLS
ALTER TABLE methods ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own methods" ON methods
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view template methods" ON methods
    FOR SELECT USING (is_template = true);

CREATE POLICY "Users can insert their own methods" ON methods
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own methods" ON methods
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own methods" ON methods
    FOR DELETE USING (auth.uid() = user_id);

-- Tasks RLS
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own tasks" ON tasks
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view template tasks" ON tasks
    FOR SELECT USING (is_template = true);

CREATE POLICY "Users can insert their own tasks" ON tasks
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own tasks" ON tasks
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own tasks" ON tasks
    FOR DELETE USING (auth.uid() = user_id);

-- Schedules RLS
ALTER TABLE schedules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own schedules" ON schedules
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own schedules" ON schedules
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own schedules" ON schedules
    FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own schedules" ON schedules
    FOR DELETE USING (auth.uid() = user_id);

-- Lessons RLS
ALTER TABLE lessons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lessons from their schedules" ON lessons
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM schedules s
            WHERE s.id = lessons.schedule_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can insert lessons to their schedules" ON lessons
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM schedules s
            WHERE s.id = lessons.schedule_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can update lessons in their schedules" ON lessons
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM schedules s
            WHERE s.id = lessons.schedule_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can delete lessons from their schedules" ON lessons
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM schedules s
            WHERE s.id = lessons.schedule_id
            AND s.user_id = auth.uid()
        )
    );

-- Course Books RLS
ALTER TABLE course_books ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view course books they own" ON course_books
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM courses c
            WHERE c.id = course_books.course_id
            AND c.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage course books they own" ON course_books
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM courses c
            WHERE c.id = course_books.course_id
            AND c.user_id = auth.uid()
        )
    );

-- Course Vocabulary Groups RLS
ALTER TABLE course_vocabulary_groups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view course vocabulary groups they own" ON course_vocabulary_groups
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM courses c
            WHERE c.id = course_vocabulary_groups.course_id
            AND c.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage course vocabulary groups they own" ON course_vocabulary_groups
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM courses c
            WHERE c.id = course_vocabulary_groups.course_id
            AND c.user_id = auth.uid()
        )
    );

-- Lesson Objectives RLS
ALTER TABLE lesson_objectives ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lesson objectives they own" ON lesson_objectives
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_objectives.lesson_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage lesson objectives they own" ON lesson_objectives
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_objectives.lesson_id
            AND s.user_id = auth.uid()
        )
    );

-- Lesson Methods RLS
ALTER TABLE lesson_methods ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lesson methods they own" ON lesson_methods
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_methods.lesson_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage lesson methods they own" ON lesson_methods
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_methods.lesson_id
            AND s.user_id = auth.uid()
        )
    );

-- Lesson Tasks RLS
ALTER TABLE lesson_tasks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lesson tasks they own" ON lesson_tasks
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_tasks.lesson_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage lesson tasks they own" ON lesson_tasks
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_tasks.lesson_id
            AND s.user_id = auth.uid()
        )
    );

-- Lesson Books RLS
ALTER TABLE lesson_books ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lesson books they own" ON lesson_books
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_books.lesson_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage lesson books they own" ON lesson_books
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_books.lesson_id
            AND s.user_id = auth.uid()
        )
    );

-- Lesson Vocabulary RLS
ALTER TABLE lesson_vocabulary ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view lesson vocabulary they own" ON lesson_vocabulary
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_vocabulary.lesson_id
            AND s.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can manage lesson vocabulary they own" ON lesson_vocabulary
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM lessons l
            JOIN schedules s ON s.id = l.schedule_id
            WHERE l.id = lesson_vocabulary.lesson_id
            AND s.user_id = auth.uid()
        )
    );

-- Public Links RLS
ALTER TABLE public_links ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active public links" ON public_links
    FOR SELECT USING (is_active = true AND (expires_at IS NULL OR expires_at > NOW()));

CREATE POLICY "Users can manage their own public links" ON public_links
    FOR ALL USING (
        CASE entity_type
            WHEN 'course' THEN EXISTS (SELECT 1 FROM courses WHERE id = entity_id AND user_id = auth.uid())
            WHEN 'book' THEN EXISTS (SELECT 1 FROM books WHERE id = entity_id AND user_id = auth.uid())
            WHEN 'vocabulary_group' THEN EXISTS (SELECT 1 FROM vocabulary_groups WHERE id = entity_id AND user_id = auth.uid())
            ELSE false
        END
    );

================
File: database/schema_documentation.md
================
# Course Builder Database Schema Documentation

## Overview
The Course Builder database schema has been successfully created with all required tables, relationships, indexes, and Row Level Security (RLS) policies.

## Tables Created

### Core Entity Tables
1. **categories** - Organize all entities (courses, books, vocabulary, etc.)
2. **courses** - Main course information
3. **books** - Learning materials library
4. **vocabulary_groups** - Groups of vocabulary items
5. **vocabulary** - Individual vocabulary items
6. **objectives** - Teaching objectives library
7. **methods** - Teaching methods library
8. **tasks** - Tasks/activities library
9. **schedules** - Teaching schedules
10. **lessons** - Individual lessons within schedules

### Relationship Tables (Many-to-Many)
1. **course_books** - Links courses to books
2. **course_vocabulary_groups** - Links courses to vocabulary groups
3. **vocabulary_group_items** - Links vocabulary items to groups
4. **lesson_objectives** - Links lessons to objectives
5. **lesson_methods** - Links lessons to methods
6. **lesson_tasks** - Links lessons to tasks
7. **lesson_books** - Links lessons to books
8. **lesson_vocabulary** - Links lessons to vocabulary items

### Additional Tables
1. **public_links** - For sharing entities publicly with secure tokens

## Custom Types Created
- **course_status**: 'draft', 'published', 'archived'
- **lesson_status**: 'draft', 'scheduled', 'completed', 'cancelled'
- **difficulty_level**: 'beginner', 'intermediate', 'advanced', 'expert'
- **content_type**: 'text', 'video', 'audio', 'pdf', 'image', 'interactive'

## Security Features

### Row Level Security (RLS)
All tables have RLS enabled with appropriate policies:
- Users can only view/edit their own data
- Public courses, books, and vocabulary groups are viewable by all
- Template objectives, methods, and tasks are viewable by all
- Proper cascading permissions for related data

### Indexes
Performance indexes created for:
- Foreign key relationships
- Frequently searched fields (user_id, status, tags)
- Full-text search on titles, descriptions, and content
- GIN indexes for array fields (tags)

## Database Functions Created

1. **generate_unique_slug(base_text, table_name)** - Generates unique public slugs
2. **calculate_course_progress(course_id, user_id)** - Calculates course completion percentage
3. **get_vocabulary_stats(user_id)** - Returns vocabulary statistics by difficulty and language
4. **clone_template(template_id, template_type, new_user_id)** - Clones template entities
5. **search_all_entities(search_query, user_id, entity_types[])** - Full-text search across all entities

## Views Created

1. **course_overview** - Provides course statistics including counts of books, vocabulary groups, and schedules
2. **upcoming_lessons** - Shows upcoming lessons with course information

## Triggers
- Automatic **updated_at** timestamp updates on all tables

## Key Features

### Multi-tenancy
- All data is isolated by user through RLS policies
- Users can only access their own data

### Public Sharing
- Courses, books, and vocabulary groups can be made public
- Public sharing links with optional expiration and password protection

### Templates
- Objectives, methods, and tasks can be marked as templates
- Templates are viewable by all users and can be cloned

### Flexible Relationships
- Many-to-many relationships allow maximum flexibility
- Lessons can use any combination of objectives, methods, tasks, books, and vocabulary
- Courses can include multiple books and vocabulary groups

### Search Capabilities
- Full-text search indexes on major entities
- Tag-based filtering
- Advanced search function across all entity types

### Metadata Support
- JSONB metadata fields on all major tables for extensibility
- Allows storing additional custom data without schema changes

## Next Steps

The database schema is now ready for use. Task 3 is complete. The next steps would be:
1. Create the UI components (Task 4)
2. Implement the course management module (Task 5)
3. Build the other management modules (Tasks 6-11)

================
File: database/schema.sql
================
-- Course Builder Database Schema
-- Version: 1.0
-- Description: Complete database schema for the course builder application

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- For text search

-- Create custom types
CREATE TYPE course_status AS ENUM ('draft', 'published', 'archived');
CREATE TYPE lesson_status AS ENUM ('draft', 'scheduled', 'completed', 'cancelled');
CREATE TYPE difficulty_level AS ENUM ('beginner', 'intermediate', 'advanced', 'expert');
CREATE TYPE content_type AS ENUM ('text', 'video', 'audio', 'pdf', 'image', 'interactive');

-- Categories table (for organizing all entities)
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type VARCHAR(50) NOT NULL, -- 'course', 'book', 'vocabulary', 'objective', 'method', 'task'
    parent_id UUID REFERENCES categories(id) ON DELETE CASCADE,
    color VARCHAR(7), -- Hex color code
    icon VARCHAR(50), -- Icon identifier
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(name, type, user_id)
);

-- Courses table
CREATE TABLE courses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    status course_status DEFAULT 'draft',
    difficulty difficulty_level DEFAULT 'beginner',
    duration_hours INTEGER,
    objectives TEXT[], -- Array of learning objectives
    prerequisites TEXT[], -- Array of prerequisites
    tags TEXT[], -- Array of tags for searching
    thumbnail_url TEXT,
    is_public BOOLEAN DEFAULT false,
    public_slug VARCHAR(255) UNIQUE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    published_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Books/Materials Library
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255),
    isbn VARCHAR(20),
    publisher VARCHAR(255),
    publication_year INTEGER,
    description TEXT,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    content_type content_type DEFAULT 'text',
    file_url TEXT, -- URL to uploaded file
    cover_image_url TEXT,
    total_pages INTEGER,
    language VARCHAR(10) DEFAULT 'en',
    tags TEXT[],
    is_public BOOLEAN DEFAULT false,
    public_slug VARCHAR(255) UNIQUE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Vocabulary Groups
CREATE TABLE vocabulary_groups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    language VARCHAR(10) DEFAULT 'en',
    target_language VARCHAR(10),
    difficulty difficulty_level DEFAULT 'beginner',
    tags TEXT[],
    is_public BOOLEAN DEFAULT false,
    public_slug VARCHAR(255) UNIQUE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Vocabulary Items
CREATE TABLE vocabulary (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    word VARCHAR(255) NOT NULL,
    translation VARCHAR(255),
    pronunciation VARCHAR(255),
    part_of_speech VARCHAR(50), -- noun, verb, adjective, etc.
    definition TEXT,
    example_sentence TEXT,
    example_translation TEXT,
    notes TEXT,
    difficulty difficulty_level DEFAULT 'beginner',
    audio_url TEXT,
    image_url TEXT,
    tags TEXT[],
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Vocabulary to Groups mapping (many-to-many)
CREATE TABLE vocabulary_group_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vocabulary_group_id UUID REFERENCES vocabulary_groups(id) ON DELETE CASCADE NOT NULL,
    vocabulary_id UUID REFERENCES vocabulary(id) ON DELETE CASCADE NOT NULL,
    position INTEGER DEFAULT 0,
    added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(vocabulary_group_id, vocabulary_id)
);

-- Teaching Objectives Library
CREATE TABLE objectives (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    bloom_level VARCHAR(50), -- 'remember', 'understand', 'apply', 'analyze', 'evaluate', 'create'
    measurable BOOLEAN DEFAULT true,
    tags TEXT[],
    is_template BOOLEAN DEFAULT false,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Teaching Methods Library
CREATE TABLE methods (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    instructions TEXT,
    duration_minutes INTEGER,
    group_size_min INTEGER DEFAULT 1,
    group_size_max INTEGER,
    materials_needed TEXT[],
    tags TEXT[],
    is_template BOOLEAN DEFAULT false,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Tasks/Activities Library
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    instructions TEXT,
    duration_minutes INTEGER,
    difficulty difficulty_level DEFAULT 'beginner',
    materials_needed TEXT[],
    assessment_criteria TEXT,
    tags TEXT[],
    is_template BOOLEAN DEFAULT false,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Schedules (Teaching Schedules)
CREATE TABLE schedules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    timezone VARCHAR(50) DEFAULT 'UTC',
    recurrence_rule TEXT, -- iCal RRULE format
    tags TEXT[],
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb,

    default_start_time TIME,
    default_duration_minutes INTEGER,
    recurrence_type recurrence_type_enum,
    recurrence_days day_of_week_enum[],
    location VARCHAR(255),
    max_students INTEGER,
    is_active BOOLEAN DEFAULT true
);

-- Lessons (Individual lessons within a schedule)
CREATE TABLE lessons (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    course_id  UUID REFERENCES courses(id) ON DELETE CASCADE NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    lesson_number INTEGER,
    date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    location VARCHAR(255),
    status lesson_status DEFAULT 'draft',
    tags TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Relationship Tables for Many-to-Many associations

-- Course-Book associations
CREATE TABLE course_books (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE NOT NULL,
    book_id UUID REFERENCES books(id) ON DELETE CASCADE NOT NULL,
    is_required BOOLEAN DEFAULT false,
    notes TEXT,
    position INTEGER DEFAULT 0,
    UNIQUE(course_id, book_id)
);

-- Course-Vocabulary Group associations
CREATE TABLE course_vocabulary_groups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE NOT NULL,
    vocabulary_group_id UUID REFERENCES vocabulary_groups(id) ON DELETE CASCADE NOT NULL,
    position INTEGER DEFAULT 0,
    UNIQUE(course_id, vocabulary_group_id)
);

-- Lesson-Objective associations
CREATE TABLE lesson_objectives (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE NOT NULL,
    objective_id UUID REFERENCES objectives(id) ON DELETE CASCADE NOT NULL,
    position INTEGER DEFAULT 0,
    UNIQUE(lesson_id, objective_id)
);

-- Lesson-Method associations
CREATE TABLE lesson_methods (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE NOT NULL,
    method_id UUID REFERENCES methods(id) ON DELETE CASCADE NOT NULL,
    duration_override INTEGER, -- Override default duration
    position INTEGER DEFAULT 0,
    notes TEXT,
    UNIQUE(lesson_id, method_id)
);

-- Lesson-Task associations
CREATE TABLE lesson_tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE NOT NULL,
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE NOT NULL,
    duration_override INTEGER,
    position INTEGER DEFAULT 0,
    notes TEXT,
    is_homework BOOLEAN DEFAULT false,
    due_date DATE,
    UNIQUE(lesson_id, task_id)
);

-- Lesson-Book associations
CREATE TABLE lesson_books (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE NOT NULL,
    book_id UUID REFERENCES books(id) ON DELETE CASCADE NOT NULL,
    pages_from INTEGER,
    pages_to INTEGER,
    notes TEXT,
    UNIQUE(lesson_id, book_id)
);

-- Lesson-Vocabulary associations
CREATE TABLE lesson_vocabulary (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE NOT NULL,
    vocabulary_id UUID REFERENCES vocabulary(id) ON DELETE CASCADE NOT NULL,
    position INTEGER DEFAULT 0,
    UNIQUE(lesson_id, vocabulary_id)
);

-- Public sharing links
CREATE TABLE public_links (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    entity_type VARCHAR(50) NOT NULL, -- 'course', 'book', 'vocabulary_group', etc.
    entity_id UUID NOT NULL,
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE,
    password_hash TEXT,
    max_views INTEGER,
    current_views INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb
);

-- Create indexes for better performance
CREATE INDEX idx_categories_type ON categories(type);
CREATE INDEX idx_categories_user_id ON categories(user_id);

CREATE INDEX idx_courses_user_id ON courses(user_id);
CREATE INDEX idx_courses_status ON courses(status);
CREATE INDEX idx_courses_public_slug ON courses(public_slug) WHERE public_slug IS NOT NULL;
CREATE INDEX idx_courses_tags ON courses USING GIN(tags);

CREATE INDEX idx_books_user_id ON books(user_id);
CREATE INDEX idx_books_isbn ON books(isbn) WHERE isbn IS NOT NULL;
CREATE INDEX idx_books_tags ON books USING GIN(tags);

CREATE INDEX idx_vocabulary_user_id ON vocabulary(user_id);
CREATE INDEX idx_vocabulary_word ON vocabulary(word);
CREATE INDEX idx_vocabulary_tags ON vocabulary USING GIN(tags);

CREATE INDEX idx_vocabulary_groups_user_id ON vocabulary_groups(user_id);
CREATE INDEX idx_vocabulary_group_items_group ON vocabulary_group_items(vocabulary_group_id);
CREATE INDEX idx_vocabulary_group_items_vocab ON vocabulary_group_items(vocabulary_id);

CREATE INDEX idx_objectives_user_id ON objectives(user_id);
CREATE INDEX idx_methods_user_id ON methods(user_id);
CREATE INDEX idx_tasks_user_id ON tasks(user_id);

CREATE INDEX idx_schedules_user_id ON schedules(user_id);
CREATE INDEX idx_schedules_course_id ON schedules(course_id);
CREATE INDEX idx_schedules_dates ON schedules(start_date, end_date);

CREATE INDEX idx_lessons_schedule_id ON lessons(schedule_id);
CREATE INDEX idx_lessons_date ON lessons(date);
CREATE INDEX idx_lessons_status ON lessons(status);

CREATE INDEX idx_public_links_token ON public_links(token);
CREATE INDEX idx_public_links_entity ON public_links(entity_type, entity_id);

-- Full text search indexes
CREATE INDEX idx_courses_search ON courses USING GIN(to_tsvector('english', title || ' ' || COALESCE(description, '')));
CREATE INDEX idx_books_search ON books USING GIN(to_tsvector('english', title || ' ' || COALESCE(author, '') || ' ' || COALESCE(description, '')));
CREATE INDEX idx_vocabulary_search ON vocabulary USING GIN(to_tsvector('english', word || ' ' || COALESCE(translation, '') || ' ' || COALESCE(definition, '')));

-- Create update timestamp trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply update timestamp triggers to all tables with updated_at
CREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON categories FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_courses_updated_at BEFORE UPDATE ON courses FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_books_updated_at BEFORE UPDATE ON books FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_vocabulary_groups_updated_at BEFORE UPDATE ON vocabulary_groups FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_vocabulary_updated_at BEFORE UPDATE ON vocabulary FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_objectives_updated_at BEFORE UPDATE ON objectives FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_methods_updated_at BEFORE UPDATE ON methods FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_tasks_updated_at BEFORE UPDATE ON tasks FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_schedules_updated_at BEFORE UPDATE ON schedules FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_lessons_updated_at BEFORE UPDATE ON lessons FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

================
File: next-env.d.ts
================
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/basic-features/typescript for more information.

================
File: next.config.js
================
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    // typedRoutes: true,
  },
  images: {
    domains: ['localhost'],
    unoptimized: process.env.NODE_ENV === 'development',
  },
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ]
  },
}

module.exports = nextConfig

================
File: package.json
================
{
  "name": "course-builder",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 5001",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "@headlessui/react": "^2.1.2",
    "@heroicons/react": "^2.1.4",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/auth-helpers-react": "^0.5.0",
    "@supabase/supabase-js": "^2.43.4",
    "@tailwindcss/forms": "^0.5.7",
    "@types/node": "^20.14.10",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "autoprefixer": "^10.4.19",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.513.0",
    "next": "14.2.5",
    "postcss": "^8.4.39",
    "react": "^18.3.1",
    "react-big-calendar": "^1.19.2",
    "react-dom": "^18.3.1",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.5.3"
  },
  "devDependencies": {
    "@types/react-big-calendar": "^1.16.2",
    "@typescript-eslint/eslint-plugin": "^7.16.0",
    "@typescript-eslint/parser": "^7.16.0",
    "eslint": "^8.57.0",
    "eslint-config-next": "14.2.5",
    "prettier": "^3.3.2",
    "prettier-plugin-tailwindcss": "^0.6.5"
  }
}

================
File: postcss.config.js
================
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================
File: README.md
================
# Course Builder - Modular Course Design & Management Platform

A highly flexible, customizable online course construction tool that empowers educators, trainers, and content creators to efficiently design, combine, manage, and share structured, modular educational content.

## 🚀 Features

- **Course Management**: Create and manage courses by combining books, schedules, objectives, and methods
- **Book Library**: Centralized library of reusable educational materials
- **Vocabulary System**: Organize vocabulary with CEFR levels and part of speech categorization
- **Schedule Design**: Flexible teaching schedules with calendar views and lesson planning
- **Learning Objectives**: Reusable teaching objectives for consistency across courses
- **Teaching Methods**: Manage various teaching strategies (PBL, flipped classroom, etc.)
- **Bulk Operations**: Import/export functionality for efficient content management
- **Public Sharing**: Generate shareable links for stakeholders
- **Analytics Dashboard**: Comprehensive reporting and analytics

## 🛠️ Tech Stack

- **Frontend**: Next.js 14, TypeScript, Tailwind CSS
- **Backend**: Supabase (Database, Authentication, Storage)
- **UI Components**: Custom components with Headless UI
- **Styling**: Tailwind CSS with custom design system
- **Development**: ESLint, Prettier, TypeScript

## 📋 Prerequisites

- Node.js 18.17 or later
- npm or yarn package manager
- Git

## 🏗️ Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd course-builder
```

2. Install dependencies:
```bash
npm install
```

3. Set up environment variables:
```bash
cp .env.example .env.local
```
Edit `.env.local` with your configuration values.

4. Run the development server:
```bash
npm run dev
```

5. Open [http://localhost:3000](http://localhost:3000) in your browser.

## 📁 Project Structure

```
src/
├── app/                 # Next.js App Router pages
├── components/          # Reusable UI components
│   └── ui/             # Base UI components
├── lib/                # Utility functions and configurations
├── types/              # TypeScript type definitions
├── utils/              # Helper functions
├── hooks/              # Custom React hooks
└── stores/             # State management
```

## 🔧 Available Scripts

- `npm run dev` - Start development server
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run lint` - Run ESLint
- `npm run type-check` - Run TypeScript type checking

## 🎯 Development Phases

### Phase 1: Foundation (Current)
- ✅ Project Setup and Architecture
- 🔄 Supabase Integration and Authentication
- ⏳ Database Schema Design
- ⏳ UI Component Library

### Phase 2: Core Modules
- Course Management Module
- Book Library Management
- Vocabulary Management System
- Schedule Design System

### Phase 3: Advanced Features
- Entity Relationships & Associations
- Bulk Import/Export Functionality
- Advanced Search & Filtering
- Public Sharing Links

### Phase 4: Polish & Deploy
- UI/UX Polish & Responsive Design
- Performance Optimization
- Security & Data Validation
- Testing Suite Implementation

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## 📄 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 📞 Support

For support, email support@coursebuilder.com or join our community discussions.

---

Built with ❤️ for educators and content creators.

================
File: src/app/auth/page.tsx
================
'use client';

import { useState } from 'react';
import { LoginForm } from '@/components/auth/LoginForm';
import { AuthGuard } from '@/components/auth/AuthGuard';

export default function AuthPage() {
  const [isSignUp, setIsSignUp] = useState(false);

  return (
    <AuthGuard requireAuth={false}>
      <div className="min-h-screen bg-gradient-to-br from-primary-50 to-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-md w-full space-y-8">
          <div className="text-center">
            <h1 className="text-3xl font-bold text-primary-600 mb-2">
              Course Builder
            </h1>
            <p className="text-gray-600">
              Modular Course Design & Management Platform
            </p>
          </div>
          
          <LoginForm 
            isSignUp={isSignUp}
            onToggleMode={() => setIsSignUp(!isSignUp)}
          />
          
          <div className="text-center text-sm text-gray-500">
            <p>
              By continuing, you agree to our{' '}
              <a href="/terms" className="text-primary-600 hover:text-primary-700">
                Terms of Service
              </a>{' '}
              and{' '}
              <a href="/privacy" className="text-primary-600 hover:text-primary-700">
                Privacy Policy
              </a>
            </p>
          </div>
        </div>
      </div>
    </AuthGuard>
  );
}

================
File: src/app/books/[id]/edit/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { BookForm } from '@/components/books/BookForm';
import { bookService } from '@/lib/supabase/books';
import { Spinner } from '@/components/ui';
import { Book } from '@/types/database';

export default function EditBookPage() {
  const router = useRouter();
  const params = useParams();
  const bookId = params.id as string;
  const [book, setBook] = useState<Book | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (bookId) {
      loadBook();
    }
  }, [bookId]);

  const loadBook = async () => {
    try {
      setLoading(true);
      const data = await bookService.getBook(bookId);
      setBook(data);
    } catch (error) {
      console.error('Failed to load book:', error);
      router.push('/books');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!book) {
    return null;
  }

  return <BookForm initialData={book} />;
}

================
File: src/app/books/[id]/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { ArrowLeft, Edit, Trash2, Globe, Lock, BookOpen } from 'lucide-react';
import { Book } from '@/types/database';
import { bookService } from '@/lib/supabase/books';
import { Button, Card, Badge, Modal, Spinner } from '@/components/ui';

export default function BookDetailPage() {
  const router = useRouter();
  const params = useParams();
  const bookId = params.id as string;
  const [book, setBook] = useState<Book | null>(null);
  const [loading, setLoading] = useState(true);
  const [deleting, setDeleting] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);

  useEffect(() => {
    if (bookId) {
      loadBook();
    }
  }, [bookId]);

  const loadBook = async () => {
    setLoading(true);
    try {
      const data = await bookService.getBook(bookId);
      setBook(data);
    } catch (error) {
      console.error('Failed to load book:', error);
      router.push('/books');
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async () => {
    setDeleting(true);
    try {
      await bookService.deleteBook(bookId);
      router.push('/books');
      router.refresh();
    } catch (error) {
      console.error('Failed to delete book:', error);
    } finally {
      setDeleting(false);
      setShowDeleteModal(false);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!book) return null;

  return (
    <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="mb-8">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => router.push('/books')}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back to Books
        </Button>
        
        <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
          <div className="flex items-start gap-6">
            {book.cover_image_url ? (
              <img src={book.cover_image_url} alt={book.title} className="w-40 h-56 rounded-lg object-cover shadow-lg" />
            ) : (
              <div className="w-40 h-56 rounded-lg bg-gray-200 flex items-center justify-center">
                <BookOpen className="w-16 h-16 text-gray-400" />
              </div>
            )}
            <div className="flex-1">
              <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">{book.title}</h1>
              {book.author && <p className="text-lg text-gray-600 mt-1">by {book.author}</p>}
              <div className="flex items-center gap-3 mt-4">
                <Badge variant={book.is_public ? 'success' : 'secondary'}>
                  {book.is_public ? <Globe className="h-4 w-4 mr-1.5" /> : <Lock className="h-4 w-4 mr-1.5" />}
                  {book.is_public ? 'Public' : 'Private'}
                </Badge>
                {book.category && (
                  <Badge style={{ backgroundColor: `${book.category.color}20`, color: book.category.color }}>
                    {book.category.name}
                  </Badge>
                )}
              </div>
            </div>
          </div>
          
          <div className="flex items-center gap-2 flex-shrink-0">
            <Button
              variant="outline"
              onClick={() => router.push(`/books/${bookId}/edit`)}
              leftIcon={<Edit className="h-4 w-4" />}
            >
              Edit
            </Button>
            <Button
              variant="danger"
              onClick={() => setShowDeleteModal(true)}
              leftIcon={<Trash2 className="h-4 w-4" />}
              className="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
            >
              Delete
            </Button>
          </div>
        </div>
      </div>

      <div className="space-y-6">
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Description</h2></Card.Header>
          <Card.Content>
            <div className="prose prose-sm max-w-none dark:prose-invert">
              {book.description || <p className="text-gray-500 italic">No description provided.</p>}
            </div>
          </Card.Content>
        </Card>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <Card.Header><h2 className="text-lg font-semibold">Details</h2></Card.Header>
              <Card.Content>
                <dl className="space-y-3 text-sm">
                    {book.publisher && <div><dt className="font-medium text-gray-500">Publisher</dt><dd>{book.publisher}</dd></div>}
                    {book.publication_year && <div><dt className="font-medium text-gray-500">Year</dt><dd>{book.publication_year}</dd></div>}
                    {book.language && <div><dt className="font-medium text-gray-500">Language</dt><dd className="uppercase">{book.language}</dd></div>}
                    {book.content_type && <div><dt className="font-medium text-gray-500">Content Type</dt><dd className="capitalize">{book.content_type}</dd></div>}
                </dl>
              </Card.Content>
            </Card>
            {book.tags && book.tags.length > 0 && (
                 <Card>
                   <Card.Header><h2 className="text-lg font-semibold">Tags</h2></Card.Header>
                   <Card.Content>
                     <div className="flex flex-wrap gap-2">
                       {book.tags.map((tag) => <Badge key={tag}>{tag}</Badge>)}
                     </div>
                   </Card.Content>
                 </Card>
            )}
        </div>
      </div>
      
      <Modal
        isOpen={showDeleteModal}
        onClose={() => setShowDeleteModal(false)}
        title="Delete Book"
        className="max-w-md"
      >
        <p className="text-gray-600 dark:text-gray-400">
          Are you sure you want to delete "{book.title}"? This action cannot be undone.
        </p>
        <div className="flex justify-end gap-3 mt-6">
          <Button variant="outline" onClick={() => setShowDeleteModal(false)}>Cancel</Button>
          <Button variant="danger" onClick={handleDelete} loading={deleting}>Delete Book</Button>
        </div>
      </Modal>
    </div>
  );
}

================
File: src/app/books/layout.tsx
================
'use client';

import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { AuthGuard } from '@/components/auth/AuthGuard';

export default function BooksLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthGuard>
      <DashboardLayout>{children}</DashboardLayout>
    </AuthGuard>
  );
}

================
File: src/app/books/new/page.tsx
================
'use client';

import { BookForm } from '@/components/books/BookForm';

export default function NewBookPage() {
  return <BookForm />;
}

================
File: src/app/books/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { 
  Plus, Search, Filter, BookOpen, FileText, Video, 
  Headphones, Image as ImageIcon, Gamepad2, Grid, List 
} from 'lucide-react';
import { Book, ContentType } from '@/types/database';
import { bookService, BookFilters } from '@/lib/supabase/books';
import { categoryService } from '@/lib/supabase/categories';
import { 
  Button, Card, Badge, SearchBox, FilterPanel, Spinner, Select 
} from '@/components/ui';
import { cn } from '@/lib/utils';

const contentTypeIcons: Record<ContentType, React.ReactNode> = {
  text: <FileText className="h-4 w-4" />,
  pdf: <FileText className="h-4 w-4" />,
  video: <Video className="h-4 w-4" />,
  audio: <Headphones className="h-4 w-4" />,
  image: <ImageIcon className="h-4 w-4" />,
  interactive: <Gamepad2 className="h-4 w-4" />,
};

const contentTypeColors: Record<ContentType, string> = {
  text: 'default',
  pdf: 'danger',
  video: 'primary',
  audio: 'warning',
  image: 'success',
  interactive: 'info',
};

export default function BooksPage() {
  const router = useRouter();
  const [books, setBooks] = useState<Book[]>([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState<BookFilters>({});
  const [stats, setStats] = useState({
    total: 0,
    text: 0,
    video: 0,
    audio: 0,
    pdf: 0,
    other: 0,
  });
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [authors, setAuthors] = useState<string[]>([]);
  const [languages, setLanguages] = useState<string[]>([]);
  const [categories, setCategories] = useState<any[]>([]);
  
  // State to control the visibility of the filter panel
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    loadBooks();
  }, [filters]);

  const loadInitialData = async () => {
    try {
      const [authorsData, languagesData, categoriesData, statsData] = await Promise.all([
        bookService.getAuthors(),
        bookService.getLanguages(),
        categoryService.getCategories({ type: 'book' }),
        bookService.getBookStats(),
      ]);
      
      setAuthors(authorsData);
      setLanguages(languagesData);
      setCategories(categoriesData);
      setStats(statsData);
    } catch (error) {
      console.error('Failed to load initial data:', error);
    }
  };

  const loadBooks = async () => {
    try {
      setLoading(true);
      const data = await bookService.getBooks(filters);
      setBooks(data);
    } catch (error) {
      console.error('Failed to load books:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (search: string) => {
    setFilters({ ...filters, search });
  };

  const handleFilterChange = (filterId: string, value: any) => {
    setFilters({ ...filters, [filterId]: value });
  };

  const contentTypes = bookService.getContentTypes();

  const filterGroups = [
    {
      id: 'contentType',
      label: 'Content Type',
      type: 'checkbox' as const,
      options: contentTypes.map(type => ({
        value: type.value,
        label: type.label,
        icon: contentTypeIcons[type.value],
      })),
    },
    {
      id: 'author',
      label: 'Author',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Authors' },
        ...authors.map(author => ({ value: author, label: author })),
      ],
    },
    {
      id: 'language',
      label: 'Language',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Languages' },
        ...languages.map(lang => ({ value: lang, label: lang.toUpperCase() })),
      ],
    },
    {
      id: 'categoryId',
      label: 'Category',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Categories' },
        ...categories.map(cat => ({ value: cat.id, label: cat.name })),
      ],
    },
  ];

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Book Library</h1>
          <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Manage your books and learning materials
          </p>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
            <button
              onClick={() => setViewMode('grid')}
              className={cn(
                "p-2 rounded",
                viewMode === 'grid'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <Grid className="h-4 w-4" />
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={cn(
                "p-2 rounded",
                viewMode === 'list'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <List className="h-4 w-4" />
            </button>
          </div>
          <Button
            onClick={() => router.push('/books/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Add Book
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.total}
              </p>
            </div>
            <BookOpen className="h-8 w-8 text-gray-400" />
          </div>
        </Card>
        {Object.entries(contentTypeIcons).slice(0, 5).map(([type, icon]) => (
          <Card key={type} className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400 capitalize">
                  {type}
                </p>
                <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                  {stats[type as keyof typeof stats] || 0}
                </p>
              </div>
              <div className="text-gray-400">{icon}</div>
            </div>
          </Card>
        ))}
      </div>

      {/* Search and Filters */}
      <div className="space-y-4">
        <div className="flex flex-col sm:flex-row gap-4">
          <div className="flex-1">
            <SearchBox
              placeholder="Search by title, author, or description..."
              onSearch={handleSearch}
              fullWidth
            />
          </div>
          <Button
            variant="outline"
            onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
            leftIcon={<Filter className="h-4 w-4" />}
          >
            Filters
          </Button>
        </div>

        {isFilterPanelOpen && (
          <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
              <FilterPanel
                  filters={filterGroups}
                  values={filters}
                  onChange={handleFilterChange}
                  onReset={() => setFilters({})}
                  collapsible={false}
              />
          </div>
        )}
      </div>


      {/* Books Display */}
      {loading ? (
        <div className="flex justify-center py-12">
          <Spinner size="lg" />
        </div>
      ) : books.length === 0 ? (
        <Card className="p-12 text-center">
          <BookOpen className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">No books found</h3>
          <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
            Start building your library by adding your first book.
          </p>
          <Button
            className="mt-4"
            onClick={() => router.push('/books/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Add Book
          </Button>
        </Card>
      ) : viewMode === 'grid' ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {books.map((book) => (
            <Card
              key={book.id}
              className="hover:shadow-lg transition-shadow cursor-pointer overflow-hidden"
              onClick={() => router.push(`/books/${book.id}`)}
            >
              {book.cover_image_url ? (
                <div className="h-48 overflow-hidden bg-gray-100">
                  <img
                    src={book.cover_image_url}
                    alt={book.title}
                    className="w-full h-full object-cover"
                  />
                </div>
              ) : (
                <div className="h-48 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center">
                  <BookOpen className="h-16 w-16 text-gray-400" />
                </div>
              )}
              <Card.Content className="p-4">
                <div className="flex items-start justify-between mb-2">
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 line-clamp-2 flex-1">
                    {book.title}
                  </h3>
                  <Badge
                    variant={contentTypeColors[book.content_type] as any}
                    size="sm"
                    className="ml-2"
                  >
                    {contentTypeIcons[book.content_type]}
                  </Badge>
                </div>
                
                {book.author && (
                  <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                    by {book.author}
                  </p>
                )}
                
                <div className="flex items-center justify-between text-xs text-gray-500">
                  {book.publication_year && (
                    <span>{book.publication_year}</span>
                  )}
                  {book.language && (
                    <span className="uppercase">{book.language}</span>
                  )}
                </div>
                
                {book.category && (
                  <div className="mt-3">
                    <span
                      className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                      style={{
                        backgroundColor: book.category.color ? `${book.category.color}20` : undefined,
                        color: book.category.color || undefined,
                      }}
                    >
                      {book.category.name}
                    </span>
                  </div>
                )}
              </Card.Content>
            </Card>
          ))}
        </div>
      ) : (
        <div className="space-y-4">
          {books.map((book) => (
            <Card
              key={book.id}
              className="hover:shadow-md transition-shadow cursor-pointer"
              onClick={() => router.push(`/books/${book.id}`)}
            >
              <Card.Content className="p-4">
                <div className="flex items-start gap-4">
                  {book.cover_image_url ? (
                    <img
                      src={book.cover_image_url}
                      alt={book.title}
                      className="w-20 h-28 object-cover rounded"
                    />
                  ) : (
                    <div className="w-20 h-28 bg-gray-100 dark:bg-gray-800 rounded flex items-center justify-center">
                      <BookOpen className="h-8 w-8 text-gray-400" />
                    </div>
                  )}
                  <div className="flex-1">
                    <div className="flex items-start justify-between">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
                          {book.title}
                        </h3>
                        {book.author && (
                          <p className="text-sm text-gray-600 dark:text-gray-400">
                            by {book.author}
                          </p>
                        )}
                      </div>
                      <Badge
                        variant={contentTypeColors[book.content_type] as any}
                        size="sm"
                      >
                        {book.content_type}
                      </Badge>
                    </div>
                    
                    {book.description && (
                      <p className="mt-2 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                        {book.description}
                      </p>
                    )}
                    
                    <div className="mt-3 flex items-center gap-4 text-sm text-gray-500">
                      {book.publisher && <span>Publisher: {book.publisher}</span>}
                      {book.publication_year && <span>{book.publication_year}</span>}
                      {book.total_pages && <span>{book.total_pages} pages</span>}
                      {book.language && <span className="uppercase">{book.language}</span>}
                    </div>
                    
                    <div className="mt-3 flex items-center gap-2">
                      {book.category && (
                        <span
                          className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                          style={{
                            backgroundColor: book.category.color ? `${book.category.color}20` : undefined,
                            color: book.category.color || undefined,
                          }}
                        >
                          {book.category.name}
                        </span>
                      )}
                      {book.tags && book.tags.length > 0 && (
                        <>
                          {book.tags.slice(0, 3).map((tag) => (
                            <span
                              key={tag}
                              className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                            >
                              {tag}
                            </span>
                          ))}
                          {book.tags.length > 3 && (
                            <span className="text-xs text-gray-500">
                              +{book.tags.length - 3}
                            </span>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </Card.Content>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

================
File: src/app/courses/[id]/edit/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { CourseForm } from '@/components/courses/CourseForm';
import { courseService } from '@/lib/supabase/courses';
import { Spinner } from '@/components/ui';
import { Course } from '@/types/database';

export default function EditCoursePage() {
  const router = useRouter();
  const params = useParams();
  const courseId = params.id as string;
  
  const [course, setCourse] = useState<Course | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (courseId) {
      loadCourse();
    }
  }, [courseId]);

  const loadCourse = async () => {
    try {
      setLoading(true);
      const data = await courseService.getCourse(courseId);
      setCourse(data);
    } catch (error) {
      console.error('Failed to load course:', error);
      router.push('/courses');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!course) {
    return null;
  }

  return <CourseForm initialData={course} />;
}

================
File: src/app/courses/[id]/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { 
  ArrowLeft, Edit, Trash2, Archive, Globe, Lock, 
  Book, Bookmark, Calendar, Clock, Target, AlertCircle,
  MoreVertical, Share2, Copy, CheckCircle
} from 'lucide-react';
import { Course } from '@/types/database';
import { courseService } from '@/lib/supabase/courses';
import { Button, Card, Badge, Modal, Spinner, Tabs, TabsList, TabsTrigger } from '@/components/ui';
import { CourseBookManager, CourseVocabularyManager, CourseScheduleList } from '@/components/relationships';
import { cn } from '@/lib/utils';

const statusColors = {
  draft: 'default',
  published: 'success',
  archived: 'secondary',
} as const;

const difficultyColors = {
  beginner: 'info',
  intermediate: 'warning',
  advanced: 'danger',
  expert: 'primary',
} as const;

export default function CourseDetailPage() {
  const router = useRouter();
  const params = useParams();
  const courseId = params.id as string;
  
  const [course, setCourse] = useState<Course | null>(null);
  const [loading, setLoading] = useState(true);
  const [deleting, setDeleting] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    if (courseId) {
      loadCourse();
    }
  }, [courseId]);

  const loadCourse = async () => {
    try {
      setLoading(true);
      const data = await courseService.getCourse(courseId);
      setCourse(data);
    } catch (error) {
      console.error('Failed to load course:', error);
      router.push('/courses');
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async () => {
    try {
      setDeleting(true);
      await courseService.deleteCourse(courseId);
      router.push('/courses');
    } catch (error) {
      console.error('Failed to delete course:', error);
    } finally {
      setDeleting(false);
      setShowDeleteModal(false);
    }
  };

  const handleArchive = async () => {
    try {
      await courseService.archiveCourse(courseId);
      await loadCourse();
    } catch (error) {
      console.error('Failed to archive course:', error);
    }
  };

  const handlePublish = async () => {
    try {
      await courseService.publishCourse(courseId);
      await loadCourse();
    } catch (error) {
      console.error('Failed to publish course:', error);
    }
  };

  const handleCopyPublicLink = () => {
    if (course?.public_slug) {
      const publicUrl = `${window.location.origin}/public/courses/${course.public_slug}`;
      navigator.clipboard.writeText(publicUrl);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!course) {
    return null;
  }

  const tabs = [
    { id: 'overview', label: 'Overview', icon: <Book className="h-4 w-4" /> },
    { id: 'materials', label: 'Materials', icon: <Bookmark className="h-4 w-4" /> },
    { id: 'schedule', label: 'Schedule', icon: <Calendar className="h-4 w-4" /> },
  ];

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => router.push('/courses')}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back to Courses
        </Button>
        
        <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
          <div className="flex-1">
            <div className="flex items-start gap-4">
              {course.thumbnail_url && (
                <img
                  src={course.thumbnail_url}
                  alt={course.title}
                  className="w-24 h-24 rounded-lg object-cover"
                />
              )}
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">
                    {course.title}
                  </h1>
                  <Badge variant={statusColors[course.status]}>
                    {course.status}
                  </Badge>
                  {course.is_public ? (
                    <Globe className="h-5 w-5 text-green-500" />
                  ) : (
                    <Lock className="h-5 w-5 text-gray-400" />
                  )}
                </div>
                
                {course.short_description && (
                  <p className="text-lg text-gray-600 dark:text-gray-400 mb-4">
                    {course.short_description}
                  </p>
                )}
                
                <div className="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                  <Badge variant={difficultyColors[course.difficulty]} size="sm">
                    {course.difficulty}
                  </Badge>
                  
                  {course.duration_hours && (
                    <div className="flex items-center gap-1">
                      <Clock className="h-4 w-4" />
                      <span>{course.duration_hours} hours</span>
                    </div>
                  )}
                  
                  {course.category && (
                    <span
                      className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                      style={{
                        backgroundColor: course.category.color ? `${course.category.color}20` : undefined,
                        color: course.category.color || undefined,
                      }}
                    >
                      {course.category.name}
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
          
          {/* Actions */}
          <div className="flex items-center gap-2">
            {course.status === 'draft' && (
              <Button
                variant="primary"
                onClick={handlePublish}
                leftIcon={<CheckCircle className="h-4 w-4" />}
              >
                Publish
              </Button>
            )}
            
            {course.status === 'published' && course.public_slug && (
              <Button
                variant="outline"
                onClick={handleCopyPublicLink}
                leftIcon={copied ? <CheckCircle className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
              >
                {copied ? 'Copied!' : 'Copy Link'}
              </Button>
            )}
            
            <Button
              variant="outline"
              onClick={() => router.push(`/courses/${courseId}/edit`)}
              leftIcon={<Edit className="h-4 w-4" />}
            >
              Edit
            </Button>
            
            {course.status !== 'archived' && (
              <Button
                variant="outline"
                onClick={handleArchive}
                leftIcon={<Archive className="h-4 w-4" />}
              >
                Archive
              </Button>
            )}
            
            <Button
              variant="outline"
              onClick={() => setShowDeleteModal(true)}
              leftIcon={<Trash2 className="h-4 w-4" />}
              className="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
            >
              Delete
            </Button>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab} className="mb-6">
        <TabsList>
          {tabs.map((tab) => (
            <TabsTrigger key={tab.id} value={tab.id}>
              {tab.icon}
              <span className="ml-2">{tab.label}</span>
            </TabsTrigger>
          ))}
        </TabsList>
      </Tabs>

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 space-y-6">
            {/* Description */}
            <Card>
              <Card.Header>
                <h2 className="text-lg font-semibold">Description</h2>
              </Card.Header>
              <Card.Content>
                <div className="prose prose-sm max-w-none dark:prose-invert">
                  {course.description || (
                    <p className="text-gray-500 italic">No description provided</p>
                  )}
                </div>
              </Card.Content>
            </Card>

            {/* Learning Objectives */}
            {course.objectives && course.objectives.length > 0 && (
              <Card>
                <Card.Header>
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <Target className="h-5 w-5" />
                    Learning Objectives
                  </h2>
                </Card.Header>
                <Card.Content>
                  <ul className="space-y-2">
                    {course.objectives.map((objective, index) => (
                      <li key={index} className="flex items-start gap-2">
                        <CheckCircle className="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" />
                        <span className="text-sm">{objective}</span>
                      </li>
                    ))}
                  </ul>
                </Card.Content>
              </Card>
            )}

            {/* Prerequisites */}
            {course.prerequisites && course.prerequisites.length > 0 && (
              <Card>
                <Card.Header>
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <AlertCircle className="h-5 w-5" />
                    Prerequisites
                  </h2>
                </Card.Header>
                <Card.Content>
                  <ul className="space-y-2">
                    {course.prerequisites.map((prerequisite, index) => (
                      <li key={index} className="flex items-start gap-2">
                        <span className="text-gray-400">•</span>
                        <span className="text-sm">{prerequisite}</span>
                      </li>
                    ))}
                  </ul>
                </Card.Content>
              </Card>
            )}
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Tags */}
            {course.tags && course.tags.length > 0 && (
              <Card>
                <Card.Header>
                  <h3 className="text-sm font-semibold">Tags</h3>
                </Card.Header>
                <Card.Content>
                  <div className="flex flex-wrap gap-2">
                    {course.tags.map((tag) => (
                      <span
                        key={tag}
                        className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                </Card.Content>
              </Card>
            )}

            {/* Metadata */}
            <Card>
              <Card.Header>
                <h3 className="text-sm font-semibold">Course Information</h3>
              </Card.Header>
              <Card.Content>
                <dl className="space-y-3 text-sm">
                  <div>
                    <dt className="text-gray-500 dark:text-gray-400">Created</dt>
                    <dd className="font-medium">
                      {new Date(course.created_at).toLocaleDateString()}
                    </dd>
                  </div>
                  <div>
                    <dt className="text-gray-500 dark:text-gray-400">Last Updated</dt>
                    <dd className="font-medium">
                      {new Date(course.updated_at).toLocaleDateString()}
                    </dd>
                  </div>
                  {course.published_at && (
                    <div>
                      <dt className="text-gray-500 dark:text-gray-400">Published</dt>
                      <dd className="font-medium">
                        {new Date(course.published_at).toLocaleDateString()}
                      </dd>
                    </div>
                  )}
                  <div>
                    <dt className="text-gray-500 dark:text-gray-400">Course ID</dt>
                    <dd className="font-mono text-xs">{course.id}</dd>
                  </div>
                </dl>
              </Card.Content>
            </Card>
          </div>
        </div>
      )}

      {activeTab === 'materials' && (
        <div className="space-y-6">
          {/* Books */}
          <Card>
            <Card.Header>
              <h2 className="text-lg font-semibold">Course Materials</h2>
            </Card.Header>
            <Card.Content className="space-y-8">
              <CourseBookManager courseId={courseId} onUpdate={loadCourse} />
              <div className="border-t pt-8">
                <CourseVocabularyManager courseId={courseId} onUpdate={loadCourse} />
              </div>
            </Card.Content>
          </Card>
        </div>
      )}

      {activeTab === 'schedule' && (
        <Card>
          <Card.Content>
            <CourseScheduleList courseId={courseId} />
          </Card.Content>
        </Card>
      )}

      {/* Delete Confirmation Modal */}
      <Modal
        isOpen={showDeleteModal}
        onClose={() => setShowDeleteModal(false)}
        title="Delete Course"
        className="max-w-md"
      >
        <p className="text-gray-600 dark:text-gray-400">
          Are you sure you want to delete "{course.title}"? This action cannot be undone.
        </p>
        <div className="flex justify-end gap-3 mt-6">
          <Button
            variant="outline"
            onClick={() => setShowDeleteModal(false)}
          >
            Cancel
          </Button>
          <Button
            variant="danger"
            onClick={handleDelete}
            loading={deleting}
          >
            Delete Course
          </Button>
        </div>
      </Modal>
    </div>
  );
}

================
File: src/app/courses/layout.tsx
================
'use client';

import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { AuthGuard } from '@/components/auth/AuthGuard';

export default function CoursesLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthGuard>
      <DashboardLayout>{children}</DashboardLayout>
    </AuthGuard>
  );
}

================
File: src/app/courses/new/page.tsx
================
'use client';

import { CourseForm } from '@/components/courses/CourseForm';

export default function NewCoursePage() {
  return <CourseForm />;
}

================
File: src/app/courses/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Plus, Search, Filter, BookOpen, Clock, BarChart3 } from 'lucide-react';
import { Course, CourseStatus, DifficultyLevel } from '@/types/database';
import { courseService, CourseFilters } from '@/lib/supabase/courses';
import { Button, Card, Badge, SearchBox, FilterPanel, Spinner } from '@/components/ui';
import { cn } from '@/lib/utils';

const statusColors: Record<CourseStatus, string> = {
  draft: 'default',
  published: 'success',
  archived: 'secondary',
};

const difficultyColors: Record<DifficultyLevel, string> = {
  beginner: 'info',
  intermediate: 'warning',
  advanced: 'danger',
  expert: 'primary',
};

export default function CoursesPage() {
  const router = useRouter();
  const [courses, setCourses] = useState<Course[]>([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState<CourseFilters>({});
  const [stats, setStats] = useState({
    total: 0,
    draft: 0,
    published: 0,
    archived: 0,
  });
  // State to control the visibility of the filter panel
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);

  useEffect(() => {
    loadCourses();
    loadStats();
  }, [filters]);

  const loadCourses = async () => {
    try {
      setLoading(true);
      const data = await courseService.getCourses(filters);
      setCourses(data);
    } catch (error) {
      console.error('Failed to load courses:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadStats = async () => {
    try {
      const data = await courseService.getCourseStats();
      setStats(data);
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  };

  const handleSearch = (search: string) => {
    setFilters({ ...filters, search });
  };

  const handleFilterChange = (filterId: string, value: any) => {
    setFilters({ ...filters, [filterId]: value });
  };

  const filterGroups = [
    {
      id: 'status',
      label: 'Status',
      type: 'checkbox' as const,
      options: [
        { value: 'draft', label: 'Draft', count: stats.draft },
        { value: 'published', label: 'Published', count: stats.published },
        { value: 'archived', label: 'Archived', count: stats.archived },
      ],
    },
    {
      id: 'difficulty',
      label: 'Difficulty',
      type: 'radio' as const,
      options: [
        { value: 'beginner', label: 'Beginner' },
        { value: 'intermediate', label: 'Intermediate' },
        { value: 'advanced', label: 'Advanced' },
        { value: 'expert', label: 'Expert' },
      ],
    },
  ];

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Courses</h1>
          <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Manage your courses and learning materials
          </p>
        </div>
        <Button
          onClick={() => router.push('/courses/new')}
          leftIcon={<Plus className="h-4 w-4" />}
        >
          Create Course
        </Button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total Courses</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.total}
              </p>
            </div>
            <BookOpen className="h-8 w-8 text-gray-400" />
          </div>
        </Card>
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Draft</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.draft}
              </p>
            </div>
            <Clock className="h-8 w-8 text-gray-400" />
          </div>
        </Card>
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Published</p>
              <p className="mt-1 text-2xl font-semibold text-green-600 dark:text-green-400">
                {stats.published}
              </p>
            </div>
            <BarChart3 className="h-8 w-8 text-green-400" />
          </div>
        </Card>
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Archived</p>
              <p className="mt-1 text-2xl font-semibold text-gray-500 dark:text-gray-400">
                {stats.archived}
              </p>
            </div>
            <Filter className="h-8 w-8 text-gray-400" />
          </div>
        </Card>
      </div>

      {/* Search and Filters */}
      <div className="space-y-4">
        <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1">
                <SearchBox
                    placeholder="Search courses..."
                    onSearch={handleSearch}
                    fullWidth
                />
            </div>
            <Button
                variant="outline"
                onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
                leftIcon={<Filter className="h-4 w-4" />}
            >
                Filters
            </Button>
        </div>
        {isFilterPanelOpen && (
            <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                <FilterPanel
                    filters={filterGroups}
                    values={filters}
                    onChange={handleFilterChange}
                    onReset={() => setFilters({})}
                    collapsible={false}
                />
            </div>
        )}
      </div>


      {/* Course Grid */}
      {loading ? (
        <div className="flex justify-center py-12">
          <Spinner size="lg" />
        </div>
      ) : courses.length === 0 ? (
        <Card className="p-12 text-center">
          <BookOpen className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">No courses found</h3>
          <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
            Get started by creating your first course.
          </p>
          <Button
            className="mt-4"
            onClick={() => router.push('/courses/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Create Course
          </Button>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {courses.map((course) => (
            <Card
              key={course.id}
              className="hover:shadow-lg transition-shadow cursor-pointer"
              onClick={() => router.push(`/courses/${course.id}`)}
            >
              {course.thumbnail_url && (
                <div className="h-48 overflow-hidden rounded-t-lg">
                  <img
                    src={course.thumbnail_url}
                    alt={course.title}
                    className="w-full h-full object-cover"
                  />
                </div>
              )}
              <Card.Content className="p-6">
                <div className="flex items-start justify-between mb-2">
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 line-clamp-1">
                    {course.title}
                  </h3>
                  <Badge
                    variant={statusColors[course.status] as any}
                    size="sm"
                  >
                    {course.status}
                  </Badge>
                </div>
                
                {course.short_description && (
                  <p className="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-4">
                    {course.short_description}
                  </p>
                )}
                
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <Badge
                      variant={difficultyColors[course.difficulty] as any}
                      size="sm"
                    >
                      {course.difficulty}
                    </Badge>
                    {course.duration_hours && (
                      <span className="text-sm text-gray-500">
                        {course.duration_hours}h
                      </span>
                    )}
                  </div>
                  
                  {course.category && (
                    <span
                      className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                      style={{
                        backgroundColor: course.category.color ? `${course.category.color}20` : undefined,
                        color: course.category.color || undefined,
                      }}
                    >
                      {course.category.name}
                    </span>
                  )}
                </div>
                
                {course.tags && course.tags.length > 0 && (
                  <div className="mt-3 flex flex-wrap gap-1">
                    {course.tags.slice(0, 3).map((tag) => (
                      <span
                        key={tag}
                        className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                      >
                        {tag}
                      </span>
                    ))}
                    {course.tags.length > 3 && (
                      <span className="text-xs text-gray-500">
                        +{course.tags.length - 3}
                      </span>
                    )}
                  </div>
                )}
              </Card.Content>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

================
File: src/app/dashboard/components/page.tsx
================
'use client';

import React, { useState } from 'react';
import {
  Button,
  Card,
  Input,
  Textarea,
  Modal,
  Select,
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
  TableEmpty,
  SearchBox,
  FilterPanel,
  Badge,
  Spinner,
  Pagination,
  Tabs,
  TabsList,
  TabsTrigger,
  TabsContent,
} from '@/components/ui';
import { Home, Settings, Users, FileText } from 'lucide-react';

export default function ComponentsPage() {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [searchValue, setSearchValue] = useState('');
  const [selectValue, setSelectValue] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [activeTab, setActiveTab] = useState('overview');
  const [filterValues, setFilterValues] = useState<Record<string, any>>({});

  const selectOptions = [
    { value: 'option1', label: 'Option 1' },
    { value: 'option2', label: 'Option 2' },
    { value: 'option3', label: 'Option 3', disabled: true },
  ];

  const tableData = [
    { id: 1, name: 'John Doe', email: 'john@example.com', status: 'active' },
    { id: 2, name: 'Jane Smith', email: 'jane@example.com', status: 'inactive' },
    { id: 3, name: 'Bob Johnson', email: 'bob@example.com', status: 'active' },
  ];

  const filters = [
    {
      id: 'status',
      label: 'Status',
      type: 'checkbox' as const,
      options: [
        { value: 'active', label: 'Active', count: 12 },
        { value: 'inactive', label: 'Inactive', count: 5 },
        { value: 'pending', label: 'Pending', count: 3 },
      ],
    },
    {
      id: 'difficulty',
      label: 'Difficulty',
      type: 'radio' as const,
      options: [
        { value: 'beginner', label: 'Beginner' },
        { value: 'intermediate', label: 'Intermediate' },
        { value: 'advanced', label: 'Advanced' },
      ],
    },
    {
      id: 'price',
      label: 'Price Range',
      type: 'range' as const,
      min: 0,
      max: 1000,
      step: 10,
    },
  ];

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-2xl font-bold">UI Components</h1>
        <p className="text-gray-600 dark:text-gray-400 mt-1">
          A showcase of all available UI components
        </p>
      </div>

      {/* Tabs */}
      <Card>
        <Card.Header>
          <Card.Title>Tabs Component</Card.Title>
        </Card.Header>
        <Card.Content>
          <Tabs value={activeTab} onValueChange={setActiveTab}>
            <TabsList>
              <TabsTrigger value="overview">Overview</TabsTrigger>
              <TabsTrigger value="analytics">Analytics</TabsTrigger>
              <TabsTrigger value="reports">Reports</TabsTrigger>
              <TabsTrigger value="settings" disabled>Settings</TabsTrigger>
            </TabsList>
            <TabsContent value="overview">
              <p>This is the overview tab content.</p>
            </TabsContent>
            <TabsContent value="analytics">
              <p>This is the analytics tab content.</p>
            </TabsContent>
            <TabsContent value="reports">
              <p>This is the reports tab content.</p>
            </TabsContent>
          </Tabs>
        </Card.Content>
      </Card>

      {/* Buttons */}
      <Card>
        <Card.Header>
          <Card.Title>Buttons</Card.Title>
        </Card.Header>
        <Card.Content className="space-y-4">
          <div className="flex flex-wrap gap-2">
            <Button variant="primary">Primary</Button>
            <Button variant="secondary">Secondary</Button>
            <Button variant="danger">Danger</Button>
            <Button variant="ghost">Ghost</Button>
          </div>
          <div className="flex flex-wrap gap-2">
            <Button size="sm">Small</Button>
            <Button size="md">Medium</Button>
            <Button size="lg">Large</Button>
            <Button disabled>Disabled</Button>
            <Button loading>Loading</Button>
          </div>
          <div className="flex flex-wrap gap-2">
            <Button leftIcon={<Home className="h-4 w-4" />}>With Icon</Button>
            <Button rightIcon={<Settings className="h-4 w-4" />}>With Icon</Button>
            <Button fullWidth>Full Width</Button>
          </div>
        </Card.Content>
      </Card>

      {/* Form Elements */}
      <Card>
        <Card.Header>
          <Card.Title>Form Elements</Card.Title>
        </Card.Header>
        <Card.Content className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Input
              label="Text Input"
              placeholder="Enter text..."
              helperText="This is helper text"
            />
            <Input
              label="Email Input"
              type="email"
              placeholder="email@example.com"
              required
            />
            <Input
              label="Password Input"
              type="password"
              placeholder="Enter password..."
            />
            <Input
              label="With Error"
              error="This field is required"
              placeholder="Enter text..."
            />
          </div>

          <Select
            label="Select Input"
            options={selectOptions}
            value={selectValue}
            onChange={(e) => setSelectValue(e.target.value)}
            placeholder="Choose an option..."
          />

          <Textarea
            label="Textarea"
            placeholder="Enter long text..."
            rows={4}
            helperText="Max 500 characters"
          />

          <SearchBox
            placeholder="Search..."
            value={searchValue}
            onChange={(e) => setSearchValue(e.target.value)}
            onSearch={(value) => console.log('Search:', value)}
            fullWidth
          />
        </Card.Content>
      </Card>

      {/* Badges */}
      <Card>
        <Card.Header>
          <Card.Title>Badges</Card.Title>
        </Card.Header>
        <Card.Content className="space-y-4">
          <div className="flex flex-wrap gap-2">
            <Badge>Default</Badge>
            <Badge variant="primary">Primary</Badge>
            <Badge variant="secondary">Secondary</Badge>
            <Badge variant="success">Success</Badge>
            <Badge variant="warning">Warning</Badge>
            <Badge variant="danger">Danger</Badge>
            <Badge variant="info">Info</Badge>
          </div>
          <div className="flex flex-wrap gap-2">
            <Badge size="sm">Small</Badge>
            <Badge size="md">Medium</Badge>
            <Badge size="lg">Large</Badge>
            <Badge rounded>Rounded</Badge>
            <Badge dot>With Dot</Badge>
          </div>
        </Card.Content>
      </Card>

      {/* Table */}
      <Card>
        <Card.Header>
          <Card.Title>Table</Card.Title>
        </Card.Header>
        <Card.Content>
          <Table variant="striped">
            <TableHeader>
              <TableRow>
                <TableHead>ID</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Email</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {tableData.map((row) => (
                <TableRow key={row.id}>
                  <TableCell>{row.id}</TableCell>
                  <TableCell>{row.name}</TableCell>
                  <TableCell>{row.email}</TableCell>
                  <TableCell>
                    <Badge
                      variant={row.status === 'active' ? 'success' : 'default'}
                      size="sm"
                    >
                      {row.status}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    <Button variant="ghost" size="sm">
                      Edit
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </Card.Content>
      </Card>

      {/* Empty Table */}
      <Card>
        <Card.Header>
          <Card.Title>Empty Table</Card.Title>
        </Card.Header>
        <Card.Content>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>ID</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Email</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              <TableEmpty message="No data found" icon={<FileText className="h-8 w-8" />} />
            </TableBody>
          </Table>
        </Card.Content>
      </Card>

      {/* Modal */}
      <Card>
        <Card.Header>
          <Card.Title>Modal</Card.Title>
        </Card.Header>
        <Card.Content>
          <Button onClick={() => setIsModalOpen(true)}>Open Modal</Button>
          <Modal
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            title="Example Modal"
            size="md"
          >
            <p>This is the modal content. You can put any content here.</p>
            <div className="mt-4 flex justify-end space-x-2">
              <Button variant="ghost" onClick={() => setIsModalOpen(false)}>
                Cancel
              </Button>
              <Button onClick={() => setIsModalOpen(false)}>Confirm</Button>
            </div>
          </Modal>
        </Card.Content>
      </Card>

      {/* Filter Panel */}
      <Card>
        <Card.Header>
          <Card.Title>Filter Panel</Card.Title>
        </Card.Header>
        <Card.Content>
          <div className="max-w-xs">
            <FilterPanel
              filters={filters}
              values={filterValues}
              onChange={(filterId, value) => {
                setFilterValues({ ...filterValues, [filterId]: value });
              }}
              onReset={() => setFilterValues({})}
            />
          </div>
        </Card.Content>
      </Card>

      {/* Pagination */}
      <Card>
        <Card.Header>
          <Card.Title>Pagination</Card.Title>
        </Card.Header>
        <Card.Content>
          <Pagination
            currentPage={currentPage}
            totalPages={10}
            onPageChange={setCurrentPage}
          />
        </Card.Content>
      </Card>

      {/* Loading States */}
      <Card>
        <Card.Header>
          <Card.Title>Loading States</Card.Title>
        </Card.Header>
        <Card.Content>
          <div className="flex items-center space-x-4">
            <Spinner size="sm" />
            <Spinner size="md" />
            <Spinner size="lg" />
            <Spinner size="xl" />
            <Spinner variant="secondary" />
            <div className="bg-blue-600 p-4 rounded">
              <Spinner variant="white" />
            </div>
          </div>
        </Card.Content>
      </Card>
    </div>
  );
}

================
File: src/app/dashboard/page.tsx
================
import { AuthGuard } from '@/components/auth/AuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';

export default function DashboardPage() {
  return (
    <AuthGuard requireAuth={true}>
      <DashboardLayout>
        <div className="p-6">
          <div className="mb-8">
            <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p className="text-gray-600 mt-1">
              Welcome to Course Builder. Manage your courses, books, and educational content.
            </p>
          </div>

          {/* Quick Stats */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-8 h-8 bg-primary-100 rounded-md flex items-center justify-center">
                    <span className="text-primary-600 font-semibold">📚</span>
                  </div>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Total Courses</p>
                  <p className="text-2xl font-semibold text-gray-900">0</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                    <span className="text-green-600 font-semibold">📖</span>
                  </div>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Books</p>
                  <p className="text-2xl font-semibold text-gray-900">0</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                    <span className="text-blue-600 font-semibold">📝</span>
                  </div>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Vocabulary</p>
                  <p className="text-2xl font-semibold text-gray-900">0</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <div className="w-8 h-8 bg-purple-100 rounded-md flex items-center justify-center">
                    <span className="text-purple-600 font-semibold">📅</span>
                  </div>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-500">Schedules</p>
                  <p className="text-2xl font-semibold text-gray-900">0</p>
                </div>
              </div>
            </div>
          </div>

          {/* Recent Activity */}
          <div className="bg-white rounded-lg shadow">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="text-lg font-medium text-gray-900">Recent Activity</h2>
            </div>
            <div className="p-6">
              <div className="text-center py-12">
                <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <span className="text-gray-400 text-xl">📊</span>
                </div>
                <h3 className="text-sm font-medium text-gray-900 mb-1">No activity yet</h3>
                <p className="text-sm text-gray-500">
                  Start by creating your first course or importing educational materials.
                </p>
              </div>
            </div>
          </div>
        </div>
      </DashboardLayout>
    </AuthGuard>
  );
}

================
File: src/app/globals.css
================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    font-feature-settings: "rlig" 1, "calt" 1;
  }
  
  body {
    @apply bg-gray-50 text-gray-900;
  }
}

@layer components {
  .btn {
    @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed;
  }
  
  .btn-primary {
    @apply btn bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500;
  }
  
  .btn-secondary {
    @apply btn bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
  }
  
  .btn-outline {
    @apply btn border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-primary-500;
  }
  
  .card {
    @apply bg-white overflow-hidden shadow rounded-lg;
  }
  
  .form-input {
    @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm;
  }
  
  .form-label {
    @apply block text-sm font-medium text-gray-700 mb-1;
  }
}

@layer utilities {
  .scrollbar-thin {
    scrollbar-width: thin;
    scrollbar-color: rgb(156 163 175) transparent;
  }
  
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgb(156 163 175);
    border-radius: 3px;
  }
}

================
File: src/app/layout.tsx
================
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/contexts/AuthContext';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Course Builder - Modular Course Design Platform',
  description: 'A flexible, customizable online course construction tool for educators, trainers, and content creators.',
  keywords: 'course builder, education, training, course management, curriculum design',
  authors: [{ name: 'Course Builder Team' }],
  viewport: 'width=device-width, initial-scale=1',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className="h-full">
      <body className={`${inter.className} h-full antialiased`}>
        <AuthProvider>
          <div id="root" className="min-h-full">
            {children}
          </div>
        </AuthProvider>
      </body>
    </html>
  );
}

================
File: src/app/lessons/[id]/page.tsx
================
'use client'

import { useEffect, useState } from 'react'
import { useRouter, useParams } from 'next/navigation'
import { Button } from '@/components/ui/Button'
import { Card } from '@/components/ui/Card'
import { Badge } from '@/components/ui/Badge'
import { Spinner } from '@/components/ui/Spinner'
import { LessonContentManager } from '@/components/relationships'
import { lessonService } from '@/lib/supabase/lessons'
import { scheduleService } from '@/lib/supabase/schedules'
import { 
  ArrowLeft, 
  Calendar, 
  Clock, 
  Users, 
  MapPin,
  Edit,
  Trash2
} from 'lucide-react'

interface LessonWithSchedule {
  id: string
  schedule_id: string
  lesson_number: number
  date: string
  start_time: string
  end_time: string
  topic: string
  description?: string
  location?: string
  max_students?: number
  homework?: string
  notes?: string
  status: 'scheduled' | 'completed' | 'cancelled'
  created_at: string
  updated_at: string
  schedule?: {
    id: string
    course: {
      id: string
      title: string
    }
  }
}

export default function LessonDetailPage() {
  const router = useRouter()
  const params = useParams()
  const lessonId = params.id as string
  
  const [lesson, setLesson] = useState<LessonWithSchedule | null>(null)
  const [loading, setLoading] = useState(true)
  const [deleting, setDeleting] = useState(false)

  useEffect(() => {
    if (lessonId) {
      loadLesson()
    }
  }, [lessonId])

  const loadLesson = async () => {
    try {
      setLoading(true)
      const data = await lessonService.getLesson(lessonId)
      
      // Also load schedule details to get course info
      if (data.schedule_id) {
        const schedule = await scheduleService.getSchedule(data.schedule_id)
        setLesson({
          ...data,
          schedule: schedule
        } as LessonWithSchedule)
      } else {
        setLesson(data as LessonWithSchedule)
      }
    } catch (error) {
      console.error('Failed to load lesson:', error)
      router.push('/schedules')
    } finally {
      setLoading(false)
    }
  }

  const handleDelete = async () => {
    if (!confirm('Are you sure you want to delete this lesson?')) return

    try {
      setDeleting(true)
      await lessonService.deleteLesson(lessonId)
      router.push(lesson?.schedule_id ? `/schedules/${lesson.schedule_id}` : '/schedules')
    } catch (error) {
      console.error('Failed to delete lesson:', error)
    } finally {
      setDeleting(false)
    }
  }

  const formatTime = (time: string) => {
    try {
      return new Date(`2000-01-01T${time}`).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
      })
    } catch {
      return time
    }
  }

  const formatDate = (date: string) => {
    try {
      return new Date(date).toLocaleDateString([], {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    } catch {
      return date
    }
  }

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Spinner size="lg" />
      </div>
    )
  }

  if (!lesson) {
    return null
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => router.push(lesson.schedule_id ? `/schedules/${lesson.schedule_id}` : '/schedules')}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back to Schedule
        </Button>
        
        <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">
                Lesson {lesson.lesson_number}: {lesson.topic}
              </h1>
              <Badge variant={
                lesson.status === 'completed' ? 'success' :
                lesson.status === 'cancelled' ? 'danger' :
                'default'
              }>
                {lesson.status}
              </Badge>
            </div>
            
            {lesson.schedule?.course && (
              <p className="text-lg text-gray-600 dark:text-gray-400 mb-2">
                {lesson.schedule.course.title}
              </p>
            )}

            {lesson.description && (
              <p className="text-gray-600 dark:text-gray-400 mb-4">
                {lesson.description}
              </p>
            )}
            
            <div className="flex flex-wrap items-center gap-4 text-sm text-gray-500">
              <div className="flex items-center gap-1">
                <Calendar className="h-4 w-4" />
                <span>{formatDate(lesson.date)}</span>
              </div>
              
              <div className="flex items-center gap-1">
                <Clock className="h-4 w-4" />
                <span>{formatTime(lesson.start_time)} - {formatTime(lesson.end_time)}</span>
              </div>
              
              {lesson.location && (
                <div className="flex items-center gap-1">
                  <MapPin className="h-4 w-4" />
                  <span>{lesson.location}</span>
                </div>
              )}
              
              {lesson.max_students && (
                <div className="flex items-center gap-1">
                  <Users className="h-4 w-4" />
                  <span>Max {lesson.max_students} students</span>
                </div>
              )}
            </div>
          </div>
          
          {/* Actions */}
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              onClick={() => router.push(`/lessons/${lessonId}/edit`)}
              leftIcon={<Edit className="h-4 w-4" />}
            >
              Edit
            </Button>
            
            <Button
              variant="outline"
              onClick={handleDelete}
              loading={deleting}
              leftIcon={<Trash2 className="h-4 w-4" />}
              className="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
            >
              Delete
            </Button>
          </div>
        </div>
      </div>

      {/* Content Sections */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          {/* Lesson Content Manager */}
          <Card>
            <Card.Content>
              <LessonContentManager 
                lessonId={lessonId} 
                onUpdate={loadLesson}
              />
            </Card.Content>
          </Card>
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Homework */}
          {lesson.homework && (
            <Card>
              <Card.Header>
                <h3 className="text-sm font-semibold">Homework</h3>
              </Card.Header>
              <Card.Content>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  {lesson.homework}
                </p>
              </Card.Content>
            </Card>
          )}

          {/* Notes */}
          {lesson.notes && (
            <Card>
              <Card.Header>
                <h3 className="text-sm font-semibold">Notes</h3>
              </Card.Header>
              <Card.Content>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  {lesson.notes}
                </p>
              </Card.Content>
            </Card>
          )}

          {/* Metadata */}
          <Card>
            <Card.Header>
              <h3 className="text-sm font-semibold">Lesson Information</h3>
            </Card.Header>
            <Card.Content>
              <dl className="space-y-3 text-sm">
                <div>
                  <dt className="text-gray-500 dark:text-gray-400">Created</dt>
                  <dd className="font-medium">
                    {new Date(lesson.created_at).toLocaleDateString()}
                  </dd>
                </div>
                <div>
                  <dt className="text-gray-500 dark:text-gray-400">Last Updated</dt>
                  <dd className="font-medium">
                    {new Date(lesson.updated_at).toLocaleDateString()}
                  </dd>
                </div>
                <div>
                  <dt className="text-gray-500 dark:text-gray-400">Lesson ID</dt>
                  <dd className="font-mono text-xs">{lesson.id}</dd>
                </div>
              </dl>
            </Card.Content>
          </Card>
        </div>
      </div>
    </div>
  )
}

================
File: src/app/page.tsx
================
'use client';

import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import { Button } from '@/components/ui/Button';

export default function HomePage() {
  const { user, loading } = useAuth();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-primary-50 to-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <h1 className="text-2xl font-bold text-primary-600">
                  Course Builder
                </h1>
              </div>
            </div>
            <nav className="hidden md:flex space-x-8">
              {user ? (
                <>
                  <Link 
                    href="/dashboard" 
                    className="text-gray-600 hover:text-primary-600 px-3 py-2 text-sm font-medium"
                  >
                    Dashboard
                  </Link>
                  <Link 
                    href="/courses" 
                    className="text-gray-600 hover:text-primary-600 px-3 py-2 text-sm font-medium"
                  >
                    Courses
                  </Link>
                  <Link 
                    href="/books" 
                    className="text-gray-600 hover:text-primary-600 px-3 py-2 text-sm font-medium"
                  >
                    Books
                  </Link>
                </>
              ) : (
                <>
                  <Link 
                    href="/auth" 
                    className="text-gray-600 hover:text-primary-600 px-3 py-2 text-sm font-medium"
                  >
                    Sign In
                  </Link>
                </>
              )}
            </nav>
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div className="text-center">
          <h2 className="text-4xl font-extrabold text-gray-900 sm:text-5xl">
            Modular Course Design & Management Platform
          </h2>
          <p className="mt-6 text-xl text-gray-600 max-w-3xl mx-auto">
            A highly flexible, customizable online course construction tool. 
            Empower educators, trainers, and content creators to efficiently design, 
            combine, manage, and share structured, modular educational content.
          </p>
          
          <div className="mt-10 flex justify-center gap-4">
            {user ? (
              <>
                <Link href="/dashboard">
                  <Button variant="primary">Go to Dashboard</Button>
                </Link>
                <Link href="/courses">
                  <Button variant="outline">View Courses</Button>
                </Link>
              </>
            ) : (
              <>
                <Link href="/auth">
                  <Button variant="primary">Get Started</Button>
                </Link>
                <Link href="/auth">
                  <Button variant="outline">Sign In</Button>
                </Link>
              </>
            )}
          </div>
        </div>

        {/* Feature Grid */}
        <div className="mt-20 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {features.map((feature) => (
            <div key={feature.title} className="card p-6">
              <div className="flex items-center justify-center w-12 h-12 bg-primary-100 rounded-lg mb-4">
                <span className="text-2xl">{feature.icon}</span>
              </div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                {feature.title}
              </h3>
              <p className="text-gray-600">
                {feature.description}
              </p>
            </div>
          ))}
        </div>
      </main>

      {/* Footer */}
      <footer className="bg-white border-t border-gray-200 mt-24">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div className="text-center text-gray-600">
            <p>&copy; 2024 Course Builder. Built for educators and content creators.</p>
          </div>
        </div>
      </footer>
    </div>
  );
}

const features = [
  {
    icon: '📚',
    title: 'Course Management',
    description: 'Create and manage courses by combining books, schedules, objectives, and methods into complete educational experiences.',
  },
  {
    icon: '📖',
    title: 'Book Library',
    description: 'Centralized library of reusable educational materials and books that can be associated with multiple courses.',
  },
  {
    icon: '📝',
    title: 'Vocabulary System',
    description: 'Organize vocabulary into groups with CEFR levels, part of speech, and definitions for language learning.',
  },
  {
    icon: '📅',
    title: 'Schedule Design',
    description: 'Create flexible teaching schedules with calendar views, lesson planning, and attendance tracking.',
  },
  {
    icon: '🎯',
    title: 'Learning Objectives',
    description: 'Build a library of reusable teaching objectives to ensure consistency and continuity across courses.',
  },
  {
    icon: '🔧',
    title: 'Teaching Methods',
    description: 'Manage various teaching strategies including PBL, flipped classroom, and group discussions.',
  },
];

================
File: src/app/schedules/[id]/edit/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { ArrowLeft } from 'lucide-react';
import { Button, Card, Spinner } from '@/components/ui';
import { ScheduleForm } from '@/components/schedules/ScheduleForm';
import { scheduleService } from '@/lib/services/schedule-service';
import { Schedule } from '@/types/schedule';

export default function EditSchedulePage() {
  const router = useRouter();
  const params = useParams();
  const scheduleId = params.id as string;
  
  const [schedule, setSchedule] = useState<Schedule | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (scheduleId) {
      loadSchedule();
    }
  }, [scheduleId]);

  const loadSchedule = async () => {
    try {
      setLoading(true);
      const data = await scheduleService.getSchedule(scheduleId);
      setSchedule(data as Schedule);
    } catch (error) {
      console.error('Failed to load schedule:', error);
      router.push('/schedules');
    } finally {
      setLoading(false);
    }
  };

  const handleSuccess = () => {
    router.push(`/schedules/${scheduleId}`);
    router.refresh();
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-full p-8">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!schedule) {
    return <div className="p-8 text-center text-gray-500">Schedule not found.</div>;
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => router.push(`/schedules/${scheduleId}`)}
        className="mb-4"
      >
        <ArrowLeft className="h-4 w-4 mr-2" />
        Back to Schedule
      </Button>

      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Edit Schedule</h1>
        <p className="mt-1 text-sm text-gray-600">
          Update the schedule details for "{schedule.name}"
        </p>
      </div>

      <Card>
        <Card.Content className="p-6">
          <ScheduleForm schedule={schedule} onSuccess={handleSuccess} />
        </Card.Content>
      </Card>
    </div>
  );
}

================
File: src/app/schedules/[id]/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { ArrowLeft, Edit, Trash2, Calendar, Clock, Users } from 'lucide-react';
import { Schedule, Lesson } from '@/types/schedule';
import { scheduleService } from '@/lib/services/schedule-service';
import { Button, Card, Badge, Spinner, Modal } from '@/components/ui';
import { ScheduleCalendar } from '@/components/schedules/ScheduleCalendar';
import { LessonDetailModal } from '@/components/schedules/LessonDetailModal';
import { LessonForm } from '@/components/schedules/LessonForm'; // <-- Import LessonForm

export default function ScheduleDetailPage() {
  const router = useRouter();
  const params = useParams();
  const scheduleId = params.id as string;

  const [schedule, setSchedule] = useState<Schedule | null>(null);
  const [loading, setLoading] = useState(true);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deleting, setDeleting] = useState(false);
  const [selectedLesson, setSelectedLesson] = useState<Lesson | null>(null);
  const [editingLesson, setEditingLesson] = useState<Lesson | null>(null); // <-- State for editing modal

  useEffect(() => {
    if (scheduleId) {
      loadSchedule();
    }
  }, [scheduleId]);

  const loadSchedule = async () => {
    try {
      setLoading(true);
      const data = await scheduleService.getSchedule(scheduleId);
      setSchedule(data as Schedule);
    } catch (error) {
      console.error('Failed to load schedule:', error);
      router.push('/schedules');
    } finally {
      setLoading(false);
    }
  };
  
  const handleDelete = async () => {
    if (!schedule) return;
    setDeleting(true);
    try {
      await scheduleService.deleteSchedule(schedule.id);
      router.push('/schedules');
      router.refresh();
    } catch (error) {
      console.error('Failed to delete schedule:', error);
    } finally {
      setDeleting(false);
      setShowDeleteModal(false);
    }
  };

  const handleStartEditLesson = (lesson: Lesson) => {
    setSelectedLesson(null); // Close the detail modal
    setEditingLesson(lesson); // Open the edit modal
  };

  const handleFinishEdit = () => {
    setEditingLesson(null); // Close the edit modal
    loadSchedule(); // Refresh data to see changes
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-full p-8">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!schedule) {
    return <div className="p-8 text-center text-gray-500">Schedule not found.</div>;
  }

  return (
    <>
      <div className="p-6 space-y-6">
        {/* Header and Details Card... (code remains the same) */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <Button variant="ghost" size="sm" onClick={() => router.push('/schedules')} className="mb-4">
                    <ArrowLeft className="h-4 w-4 mr-2" />
                    Back to Schedules
                </Button>
                <h1 className="text-2xl font-bold text-gray-900">{schedule.name}</h1>
                <p className="mt-1 text-sm text-gray-600">
                    For course: <strong>{schedule.course?.title || 'N/A'}</strong>
                </p>
            </div>
            <div className="flex items-center gap-2">
                <Button variant="outline" onClick={() => router.push(`/schedules/${scheduleId}/edit`)} leftIcon={<Edit className="h-4 w-4" />}>
                    Edit Schedule
                </Button>
                <Button variant="danger" onClick={() => setShowDeleteModal(true)} leftIcon={<Trash2 className="h-4 w-4" />}>
                    Delete Schedule
                </Button>
            </div>
        </div>
        <Card>
            <Card.Header><h2 className="text-lg font-semibold">Schedule Details</h2></Card.Header>
            <Card.Content>
                <dl className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6 text-sm">
                    <div className="flex items-start gap-3"><Calendar className="h-5 w-5 text-gray-400 mt-0.5"/><div><dt className="font-medium text-gray-500">Duration</dt><dd>{new Date(schedule.start_date).toLocaleDateString()} - {schedule.end_date ? new Date(schedule.end_date).toLocaleDateString() : 'Ongoing'}</dd></div></div>
                    <div className="flex items-start gap-3"><Clock className="h-5 w-5 text-gray-400 mt-0.5"/><div><dt className="font-medium text-gray-500">Default Time</dt><dd>{schedule.default_start_time} ({schedule.default_duration_minutes} min)</dd></div></div>
                    <div className="flex items-start gap-3"><Users className="h-5 w-5 text-gray-400 mt-0.5"/><div><dt className="font-medium text-gray-500">Max Students</dt><dd>{schedule.max_students || 'Not set'}</dd></div></div>
                    <div className="col-span-full"><dt className="font-medium text-gray-500">Description</dt><dd className="mt-1 text-gray-700">{schedule.description || 'No description provided.'}</dd></div>
                </dl>
            </Card.Content>
        </Card>
      
        <Card>
          <Card.Header>
              <h2 className="text-lg font-semibold">Lesson Calendar</h2>
          </Card.Header>
          <Card.Content>
              <ScheduleCalendar schedule={schedule} onSelectLesson={(lesson) => setSelectedLesson(lesson as Lesson)} />
          </Card.Content>
        </Card>

        {/* Delete Schedule Modal */}
        <Modal isOpen={showDeleteModal} onClose={() => setShowDeleteModal(false)} title="Delete Schedule" className="max-w-md">
            <p className="text-gray-600">Are you sure you want to delete "{schedule.name}"? This will also delete all associated lessons and cannot be undone.</p>
            <div className="flex justify-end gap-3 mt-6">
                <Button variant="outline" onClick={() => setShowDeleteModal(false)}>Cancel</Button>
                <Button variant="danger" onClick={handleDelete} loading={deleting}>Delete Schedule</Button>
            </div>
        </Modal>
      </div>

      {/* Lesson View/Edit Modals */}
      <LessonDetailModal 
        isOpen={!!selectedLesson}
        onClose={() => setSelectedLesson(null)}
        lesson={selectedLesson}
        onEdit={handleStartEditLesson}
      />

      {editingLesson && (
        <Modal isOpen={!!editingLesson} onClose={() => setEditingLesson(null)} title={`Edit Lesson: ${editingLesson.title}`} size="xl">
            <LessonForm lesson={editingLesson} onSuccess={handleFinishEdit} />
        </Modal>
      )}
    </>
  );
}

================
File: src/app/schedules/layout.tsx
================
'use client';

import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { AuthGuard } from '@/components/auth/AuthGuard';

export default function SchedulesLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthGuard>
      <DashboardLayout>{children}</DashboardLayout>
    </AuthGuard>
  );
}

================
File: src/app/schedules/new/page.tsx
================
'use client';

import { ScheduleForm } from '@/components/schedules/ScheduleForm';

export default function NewSchedulePage() {
  return (
    <div className="max-w-4xl mx-auto py-8">
      <ScheduleForm />
    </div>
  );
}

================
File: src/app/schedules/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Plus, Search, Calendar } from 'lucide-react';
import { Schedule } from '@/types/schedule';
import { scheduleService } from '@/lib/services/schedule-service';
import { 
  Button, Card, Badge, SearchBox, Spinner 
} from '@/components/ui';

export default function SchedulesPage() {
  const router = useRouter();
  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadSchedules();
  }, []);

  const loadSchedules = async () => {
    try {
      setLoading(true);
      // Assuming getSchedules can be called with an empty filter object
      const data = await scheduleService.getSchedules({});
      setSchedules(data as Schedule[]);
    } catch (error) {
      console.error('Failed to load schedules:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (search: string) => {
    // For now, re-fetches all. Can be optimized with search filter later.
    loadSchedules(); 
  };

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Schedules</h1>
          <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Manage your course schedules and lesson plans.
          </p>
        </div>
        <Button
          onClick={() => router.push('/schedules/new')}
          leftIcon={<Plus className="h-4 w-4" />}
        >
          Create Schedule
        </Button>
      </div>

      {/* Search and Filters Placeholder */}
      <div className="flex-1">
        <SearchBox
          placeholder="Search schedules..."
          onSearch={handleSearch}
          fullWidth
        />
      </div>

      {/* Schedules Display */}
      {loading ? (
        <div className="flex justify-center py-12">
          <Spinner size="lg" />
        </div>
      ) : schedules.length === 0 ? (
        <Card className="p-12 text-center">
          <Calendar className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">No schedules found</h3>
          <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
            Get started by creating your first schedule.
          </p>
          <Button
            className="mt-4"
            onClick={() => router.push('/schedules/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Create Schedule
          </Button>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {schedules.map((schedule) => (
            <Card
              key={schedule.id}
              className="hover:shadow-lg transition-shadow cursor-pointer"
              onClick={() => router.push(`/schedules/${schedule.id}`)}
            >
              <Card.Content className="p-4">
                <h3 className="text-lg font-semibold text-gray-900 line-clamp-1">{schedule.name}</h3>
                {schedule.description && <p className="text-sm text-gray-600 line-clamp-2 mt-1">{schedule.description}</p>}
                <div className="mt-3 flex justify-between items-center text-sm text-gray-500">
                  {/* The course relation might not be populated, so we add a fallback */}
                  <span>{schedule.course?.title || 'No Course'}</span>
                  <Badge variant={schedule.is_active ? 'success' : 'secondary'}>
                    {schedule.is_active ? 'Active' : 'Inactive'}
                  </Badge>
                </div>
              </Card.Content>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

================
File: src/app/vocabulary/groups/new/page.tsx
================
import { VocabularyGroupForm } from '@/components/vocabulary';

export default function NewVocabularyGroupPage() {
  return <VocabularyGroupForm />;
}

================
File: src/app/vocabulary/groups/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import {
  Plus, Search, Users, BookOpen, Globe, Lock,
  Grid, List, Filter // Changed from Filter2 to Filter
} from 'lucide-react';
import { VocabularyGroup, DifficultyLevel } from '@/types/database';
import { vocabularyService, VocabularyGroupFilters } from '@/lib/supabase/vocabulary';
import { categoryService } from '@/lib/supabase/categories';
import {
  Button, Card, Badge, SearchBox, FilterPanel, Spinner, Select
} from '@/components/ui';
import { cn } from '@/lib/utils';

const difficultyColors: Record<DifficultyLevel, string> = {
  beginner: 'success',
  intermediate: 'warning',
  advanced: 'danger',
  expert: 'primary',
};

export default function VocabularyGroupsPage() {
  const router = useRouter();
  const [groups, setGroups] = useState<(VocabularyGroup & { vocabulary_count: number })[]>([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState<VocabularyGroupFilters>({});
  const [stats, setStats] = useState({
    vocabulary: { total: 0, beginner: 0, intermediate: 0, advanced: 0, expert: 0 },
    groups: { total: 0, beginner: 0, intermediate: 0, advanced: 0, expert: 0 }
  });
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [languages, setLanguages] = useState<string[]>([]);
  const [categories, setCategories] = useState<any[]>([]);
  // Add state to control the visibility of the filter panel
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false); // NEW STATE

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    loadGroups();
  }, [filters]);

  const loadInitialData = async () => {
    try {
      const [statsData, languagesData, categoriesData] = await Promise.all([
        vocabularyService.getVocabularyStats(),
        vocabularyService.getLanguages(),
        categoryService.getCategories({ type: 'vocabulary' }),
      ]);

      setStats(statsData);
      setLanguages(languagesData);
      setCategories(categoriesData);
    } catch (error) {
      console.error('Failed to load initial data:', error);
    }
  };

  const loadGroups = async () => {
    try {
      setLoading(true);
      const data = await vocabularyService.getVocabularyGroups(filters);
      setGroups(data);
    } catch (error) {
      console.error('Failed to load vocabulary groups:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (search: string) => {
    setFilters({ ...filters, search });
  };

  const handleFilterChange = (filterId: string, value: any) => {
    setFilters({ ...filters, [filterId]: value });
  };

  const difficultyLevels = vocabularyService.getDifficultyLevels();

  const filterGroups = [
    {
      id: 'difficulty',
      label: 'Difficulty',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Levels' },
        ...difficultyLevels.map(level => ({ value: level.value, label: level.label })),
      ],
    },
    {
      id: 'language',
      label: 'Language',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Languages' },
        ...languages.map(lang => ({ value: lang, label: lang.toUpperCase() })),
      ],
    },
    {
      id: 'categoryId',
      label: 'Category',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Categories' },
        ...categories.map(cat => ({ value: cat.id, label: cat.name })),
      ],
    },
  ];

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Vocabulary Groups</h1>
          <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Organize your vocabulary into themed groups
          </p>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
            <button
              onClick={() => setViewMode('grid')}
              className={cn(
                "p-2 rounded",
                viewMode === 'grid'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <Grid className="h-4 w-4" />
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={cn(
                "p-2 rounded",
                viewMode === 'list'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <List className="h-4 w-4" />
            </button>
          </div>
          <Button
            onClick={() => router.push('/vocabulary')}
            variant="outline"
            leftIcon={<BookOpen className="h-4 w-4" />}
          >
            Words
          </Button>
          <Button
            onClick={() => router.push('/vocabulary/groups/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            New Group
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Groups</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.groups.total}
              </p>
            </div>
            <Users className="h-8 w-8 text-gray-400" />
          </div>
        </Card>

        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Words</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.vocabulary.total}
              </p>
            </div>
            <BookOpen className="h-8 w-8 text-gray-400" />
          </div>
        </Card>

        {difficultyLevels.slice(0, 4).map((level) => (
          <Card key={level.value} className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400 capitalize">
                  {level.label}
                </p>
                <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                  {stats.groups[level.value] || 0}
                </p>
              </div>
              <div className={`w-3 h-3 rounded-full bg-${level.color}-500`}></div>
            </div>
          </Card>
        ))}
      </div>

      {/* Search and Filters - MODIFIED SECTION */}
      <div className="space-y-4">
        <div className="flex flex-col sm:flex-row gap-4">
          <div className="flex-1">
            <SearchBox
              placeholder="Search by group name or description..."
              onSearch={handleSearch}
              fullWidth
            />
          </div>
          <Button
            variant="outline"
            onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
            leftIcon={<Filter className="h-4 w-4" />}
          >
            Filters
          </Button>
        </div>

        {isFilterPanelOpen && (
          <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <FilterPanel
              filters={filterGroups}
              values={filters}
              onChange={handleFilterChange}
              onReset={() => setFilters({})}
              collapsible={false}
              // className="h-full" // Removed this className
            />
          </div>
        )}
      </div>

      {/* Groups Display */}
      {loading ? (
        <div className="flex justify-center py-12">
          <Spinner size="lg" />
        </div>
      ) : groups.length === 0 ? (
        <Card className="p-12 text-center">
          <Users className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">No groups found</h3>
          <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
            Start organizing your vocabulary by creating your first group.
          </p>
          <Button
            className="mt-4"
            onClick={() => router.push('/vocabulary/groups/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Create Group
          </Button>
        </Card>
      ) : viewMode === 'grid' ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {groups.map((group) => (
            <Card
              key={group.id}
              className="hover:shadow-lg transition-shadow cursor-pointer overflow-hidden"
              onClick={() => router.push(`/vocabulary/groups/${group.id}`)}
            >
              <Card.Content className="p-4">
                <div className="flex items-start justify-between mb-3">
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-1">
                      {group.name}
                    </h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                      {group.vocabulary_count} words
                    </p>
                  </div>
                  <div className="flex items-center gap-1 ml-2">
                    {group.is_public ? (
                      <Globe className="h-4 w-4 text-green-500" />
                    ) : (
                      <Lock className="h-4 w-4 text-gray-400" />
                    )}
                  </div>
                </div>

                {group.description && (
                  <p className="text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">
                    {group.description}
                  </p>
                )}

                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Badge
                      variant={difficultyColors[group.difficulty] as any}
                      size="sm"
                    >
                      {group.difficulty}
                    </Badge>
                    <Badge variant="warning" size="sm">
                      {group.language.toUpperCase()}
                    </Badge>
                  </div>
                </div>

                {group.target_language && (
                  <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                    Target: {group.target_language.toUpperCase()}
                  </p>
                )}

                {group.category && (
                  <div className="mb-3">
                    <span
                      className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                      style={{
                        backgroundColor: group.category.color ? `${group.category.color}20` : undefined,
                        color: group.category.color || undefined,
                      }}
                    >
                      {group.category.name}
                    </span>
                  </div>
                )}

                {group.tags && group.tags.length > 0 && (
                  <div className="flex flex-wrap gap-1">
                    {group.tags.slice(0, 2).map((tag) => (
                      <span
                        key={tag}
                        className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                      >
                        {tag}
                      </span>
                    ))}
                    {group.tags.length > 2 && (
                      <span className="text-xs text-gray-500">
                        +{group.tags.length - 2}
                      </span>
                    )}
                  </div>
                )}
              </Card.Content>
            </Card>
          ))}
        </div>
      ) : (
        <div className="space-y-4">
          {groups.map((group) => (
            <Card
              key={group.id}
              className="hover:shadow-md transition-shadow cursor-pointer"
              onClick={() => router.push(`/vocabulary/groups/${group.id}`)}
            >
              <Card.Content className="p-4">
                <div className="flex items-start gap-4">
                  <div className="w-16 h-16 bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-800 dark:to-blue-900 rounded-lg flex items-center justify-center">
                    <Users className="h-8 w-8 text-blue-600 dark:text-blue-400" />
                  </div>

                  <div className="flex-1">
                    <div className="flex items-start justify-between">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
                            {group.name}
                          </h3>
                          {group.is_public ? (
                            <Globe className="h-4 w-4 text-green-500" />
                          ) : (
                            <Lock className="h-4 w-4 text-gray-400" />
                          )}
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          {group.vocabulary_count} words
                        </p>
                      </div>

                      <div className="flex items-center gap-2">
                        <Badge
                          variant={difficultyColors[group.difficulty] as any}
                          size="sm"
                        >
                          {group.difficulty}
                        </Badge>
                        <Badge variant="warning" size="sm">
                          {group.language.toUpperCase()}
                        </Badge>
                        {group.target_language && (
                          <Badge variant="warning" size="sm">
                            → {group.target_language.toUpperCase()}
                          </Badge>
                        )}
                      </div>
                    </div>

                    {group.description && (
                      <p className="text-sm text-gray-700 dark:text-gray-300 mb-2 line-clamp-2">
                        {group.description}
                      </p>
                    )}

                    <div className="flex items-center gap-2">
                      {group.category && (
                        <span
                          className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                          style={{
                            backgroundColor: group.category.color ? `${group.category.color}20` : undefined,
                            color: group.category.color || undefined,
                          }}
                        >
                          {group.category.name}
                        </span>
                      )}
                      {group.tags && group.tags.length > 0 && (
                        <>
                          {group.tags.slice(0, 3).map((tag) => (
                            <span
                              key={tag}
                              className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                            >
                              {tag}
                            </span>
                          ))}
                          {group.tags.length > 3 && (
                            <span className="text-xs text-gray-500">
                              +{group.tags.length - 3}
                            </span>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </Card.Content>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

================
File: src/app/vocabulary/layout.tsx
================
import { AuthGuard } from '@/components/auth';
import { DashboardLayout } from '@/components/layout/DashboardLayout';

export default function VocabularyLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthGuard>
      {/* <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        {children}
      </div> */}
      <DashboardLayout>{children}</DashboardLayout>
    </AuthGuard>
  );
}

================
File: src/app/vocabulary/new/page.tsx
================
import { VocabularyForm } from '@/components/vocabulary';

export default function NewVocabularyPage() {
  return <VocabularyForm />;
}

================
File: src/app/vocabulary/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import {
  Plus, Search, BookOpen, Volume2, Image as ImageIcon,
  Grid, List, Users, Filter // Import Filter icon
} from 'lucide-react';
import { Vocabulary, DifficultyLevel } from '@/types/database';
import { vocabularyService, VocabularyFilters } from '@/lib/supabase/vocabulary';
import {
  Button, Card, Badge, SearchBox, FilterPanel, Spinner, Select
} from '@/components/ui';
import { cn } from '@/lib/utils';

const difficultyColors: Record<DifficultyLevel, string> = {
  beginner: 'success',
  intermediate: 'warning',
  advanced: 'danger',
  expert: 'primary',
};

export default function VocabularyPage() {
  const router = useRouter();
  const [vocabulary, setVocabulary] = useState<Vocabulary[]>([]);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState<VocabularyFilters>({});
  const [stats, setStats] = useState({
    vocabulary: { total: 0, beginner: 0, intermediate: 0, advanced: 0, expert: 0 },
    groups: { total: 0, beginner: 0, intermediate: 0, advanced: 0, expert: 0 }
  });
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [partsOfSpeech, setPartsOfSpeech] = useState<string[]>([]);
  // Add state to control the visibility of the filter panel
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false); // New state

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    loadVocabulary();
  }, [filters]);

  const loadInitialData = async () => {
    try {
      const [statsData, partsData] = await Promise.all([
        vocabularyService.getVocabularyStats(),
        vocabularyService.getPartsOfSpeech(),
      ]);

      setStats(statsData);
      setPartsOfSpeech(partsData);
    } catch (error) {
      console.error('Failed to load initial data:', error);
    }
  };

  const loadVocabulary = async () => {
    try {
      setLoading(true);
      const data = await vocabularyService.getVocabulary(filters);
      setVocabulary(data);
    } catch (error) {
      console.error('Failed to load vocabulary:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = (search: string) => {
    setFilters({ ...filters, search });
  };

  const handleFilterChange = (filterId: string, value: any) => {
    setFilters({ ...filters, [filterId]: value });
  };

  const difficultyLevels = vocabularyService.getDifficultyLevels();

  const filterGroups = [
    {
      id: 'difficulty',
      label: 'Difficulty',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Levels' },
        ...difficultyLevels.map(level => ({ value: level.value, label: level.label })),
      ],
    },
    {
      id: 'partOfSpeech',
      label: 'Part of Speech',
      type: 'select' as const,
      options: [
        { value: '', label: 'All Parts' },
        ...partsOfSpeech.map(pos => ({ value: pos, label: pos.charAt(0).toUpperCase() + pos.slice(1) })),
      ],
    },
  ];

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Vocabulary</h1>
          <p className="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Manage your vocabulary words and groups
          </p>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
            <button
              onClick={() => setViewMode('grid')}
              className={cn(
                "p-2 rounded",
                viewMode === 'grid'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <Grid className="h-4 w-4" />
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={cn(
                "p-2 rounded",
                viewMode === 'list'
                  ? "bg-white dark:bg-gray-700 shadow-sm"
                  : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              )}
            >
              <List className="h-4 w-4" />
            </button>
          </div>
          <Button
            onClick={() => router.push('/vocabulary/groups')}
            variant="outline"
            leftIcon={<Users className="h-4 w-4" />}
          >
            Groups
          </Button>
          <Button
            onClick={() => router.push('/vocabulary/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Add Word
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Words</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.vocabulary.total}
              </p>
            </div>
            <BookOpen className="h-8 w-8 text-gray-400" />
          </div>
        </Card>

        <Card className="p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Groups</p>
              <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                {stats.groups.total}
              </p>
            </div>
            <Users className="h-8 w-8 text-gray-400" />
          </div>
        </Card>

        {difficultyLevels.slice(0, 4).map((level) => (
          <Card key={level.value} className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400 capitalize">
                  {level.label}
                </p>
                <p className="mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100">
                  {stats.vocabulary[level.value] || 0}
                </p>
              </div>
              <div className={`w-3 h-3 rounded-full bg-${level.color}-500`}></div>
            </div>
          </Card>
        ))}
      </div>

      {/* Search and Filters - Modified section */}
      <div className="space-y-4"> {/* Changed from flex flex-col lg:flex-row gap-4 to space-y-4 */}
        <div className="flex flex-col sm:flex-row gap-4"> {/* Changed from flex-1 to flex-col sm:flex-row gap-4 */}
          <div className="flex-1">
            <SearchBox
              placeholder="Search by word, translation, or definition..."
              onSearch={handleSearch}
              fullWidth
            />
          </div>
          {/* Add a button to toggle the filter panel */}
          <Button
            variant="outline"
            onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
            leftIcon={<Filter className="h-4 w-4" />}
          >
            Filters
          </Button>
        </div>

        {/* Conditionally render the FilterPanel */}
        {isFilterPanelOpen && (
          <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <FilterPanel
              filters={filterGroups}
              values={filters}
              onChange={handleFilterChange}
              onReset={() => setFilters({})}
              collapsible={false}
              // className="h-full" // Removed this className as it might conflict with conditional rendering
            />
          </div>
        )}
      </div>


      {/* Vocabulary Display */}
      {loading ? (
        <div className="flex justify-center py-12">
          <Spinner size="lg" />
        </div>
      ) : vocabulary.length === 0 ? (
        <Card className="p-12 text-center">
          <BookOpen className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">No vocabulary found</h3>
          <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
            Start building your vocabulary by adding your first word.
          </p>
          <Button
            className="mt-4"
            onClick={() => router.push('/vocabulary/new')}
            leftIcon={<Plus className="h-4 w-4" />}
          >
            Add Word
          </Button>
        </Card>
      ) : viewMode === 'grid' ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {vocabulary.map((word) => (
            <Card
              key={word.id}
              className="hover:shadow-lg transition-shadow cursor-pointer overflow-hidden"
              onClick={() => router.push(`/vocabulary/${word.id}`)}
            >
              <Card.Content className="p-4">
                <div className="flex items-start justify-between mb-3">
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-1">
                      {word.word}
                    </h3>
                    {word.pronunciation && (
                      <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">
                        {word.pronunciation}
                      </p>
                    )}
                  </div>
                  <div className="flex items-center gap-1 ml-2">
                    {word.audio_url && <Volume2 className="h-4 w-4 text-gray-400" />}
                    {word.image_url && <ImageIcon className="h-4 w-4 text-gray-400" />}
                  </div>
                </div>

                {word.translation && (
                  <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                    {word.translation}
                  </p>
                )}

                {word.definition && (
                  <p className="text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">
                    {word.definition}
                  </p>
                )}

                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Badge
                      variant={difficultyColors[word.difficulty] as any}
                      size="sm"
                    >
                      {word.difficulty}
                    </Badge>
                    {word.part_of_speech && (
                      <Badge variant="warning" size="sm">
                        {word.part_of_speech}
                      </Badge>
                    )}
                  </div>
                </div>

                {word.tags && word.tags.length > 0 && (
                  <div className="mt-3 flex flex-wrap gap-1">
                    {word.tags.slice(0, 2).map((tag) => (
                      <span
                        key={tag}
                        className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                      >
                        {tag}
                      </span>
                    ))}
                    {word.tags.length > 2 && (
                      <span className="text-xs text-gray-500">
                        +{word.tags.length - 2}
                      </span>
                    )}
                  </div>
                )}
              </Card.Content>
            </Card>
          ))}
        </div>
      ) : (
        <div className="space-y-4">
          {vocabulary.map((word) => (
            <Card
              key={word.id}
              className="hover:shadow-md transition-shadow cursor-pointer"
              onClick={() => router.push(`/vocabulary/${word.id}`)}
            >
              <Card.Content className="p-4">
                <div className="flex items-start gap-4">
                  {word.image_url ? (
                    <img
                      src={word.image_url}
                      alt={word.word}
                      className="w-20 h-20 object-cover rounded"
                    />
                  ) : (
                    <div className="w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded flex items-center justify-center">
                      <BookOpen className="h-8 w-8 text-gray-400" />
                    </div>
                  )}

                  <div className="flex-1">
                    <div className="flex items-start justify-between">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
                            {word.word}
                          </h3>
                          {word.audio_url && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                const audio = new Audio(word.audio_url);
                                audio.play().catch(console.error);
                              }}
                              className="text-gray-400 hover:text-gray-600"
                            >
                              <Volume2 className="h-4 w-4" />
                            </button>
                          )}
                        </div>
                        {word.pronunciation && (
                          <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">
                            {word.pronunciation}
                          </p>
                        )}
                        {word.translation && (
                          <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            {word.translation}
                          </p>
                        )}
                      </div>

                      <div className="flex items-center gap-2">
                        <Badge
                          variant={difficultyColors[word.difficulty] as any}
                          size="sm"
                        >
                          {word.difficulty}
                        </Badge>
                        {word.part_of_speech && (
                          <Badge variant="warning" size="sm">
                            {word.part_of_speech}
                          </Badge>
                        )}
                      </div>
                    </div>

                    {word.definition && (
                      <p className="text-sm text-gray-700 dark:text-gray-300 mb-2 line-clamp-2">
                        {word.definition}
                      </p>
                    )}

                    {word.example_sentence && (
                      <div className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <span className="font-medium">Example:</span> {word.example_sentence}
                      </div>
                    )}

                    {word.tags && word.tags.length > 0 && (
                      <div className="flex items-center gap-2">
                        {word.tags.slice(0, 4).map((tag) => (
                          <span
                            key={tag}
                            className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                          >
                            {tag}
                          </span>
                        ))}
                        {word.tags.length > 4 && (
                          <span className="text-xs text-gray-500">
                            +{word.tags.length - 4}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </Card.Content>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

================
File: src/components/auth/AuthGuard.tsx
================
'use client';

import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

interface AuthGuardProps {
  children: React.ReactNode;
  requireAuth?: boolean;
  redirectTo?: string;
}

export function AuthGuard({ 
  children, 
  requireAuth = true, 
  redirectTo = '/auth' 
}: AuthGuardProps) {
  const { user, loading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading) {
      if (requireAuth && !user) {
        router.push(redirectTo);
      } else if (!requireAuth && user) {
        router.push('/dashboard');
      }
    }
  }, [user, loading, requireAuth, redirectTo, router]);

  // Show loading spinner while checking auth
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    );
  }

  // If we require auth but user is not logged in, show nothing (will redirect)
  if (requireAuth && !user) {
    return null;
  }

  // If we don't require auth but user is logged in, show nothing (will redirect)
  if (!requireAuth && user) {
    return null;
  }

  return <>{children}</>;
}

================
File: src/components/auth/index.ts
================
// Authentication components exports
export { AuthGuard } from './AuthGuard';
export { LoginForm } from './LoginForm';
export { UserProfile } from './UserProfile';

================
File: src/components/auth/LoginForm.tsx
================
'use client';

import { useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';

interface LoginFormProps {
  onToggleMode: () => void;
  isSignUp?: boolean;
}

export function LoginForm({ onToggleMode, isSignUp = false }: LoginFormProps) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const { signIn, signUp } = useAuth();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      if (isSignUp) {
        if (password !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }

        const { user, error } = await signUp(email, password, {
          data: {
            first_name: firstName,
            last_name: lastName,
            full_name: `${firstName} ${lastName}`.trim(),
          },
        });

        if (error) {
          setError(error.message);
        } else if (user) {
          // Success - user will be redirected by auth state change
        }
      } else {
        const { user, error } = await signIn(email, password);

        if (error) {
          setError(error.message);
        } else if (user) {
          // Success - user will be redirected by auth state change
        }
      }
    } catch (err) {
      setError('An unexpected error occurred');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
      <div className="text-center mb-6">
        <h2 className="text-2xl font-bold text-gray-900">
          {isSignUp ? 'Create Account' : 'Sign In'}
        </h2>
        <p className="text-gray-600 mt-2">
          {isSignUp 
            ? 'Join Course Builder to start creating amazing courses' 
            : 'Welcome back! Please sign in to your account'
          }
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        {isSignUp && (
          <div className="grid grid-cols-2 gap-4">
            <Input
              label="First Name"
              type="text"
              value={firstName}
              onChange={(e) => setFirstName(e.target.value)}
              required
              placeholder="John"
            />
            <Input
              label="Last Name"
              type="text"
              value={lastName}
              onChange={(e) => setLastName(e.target.value)}
              required
              placeholder="Doe"
            />
          </div>
        )}

        <Input
          label="Email"
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
          placeholder="john@example.com"
        />

        <Input
          label="Password"
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
          placeholder="••••••••"
        />

        {isSignUp && (
          <Input
            label="Confirm Password"
            type="password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            required
            placeholder="••••••••"
          />
        )}

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md text-sm">
            {error}
          </div>
        )}

        <Button
          type="submit"
          className="w-full"
          loading={loading}
          disabled={loading}
        >
          {isSignUp ? 'Create Account' : 'Sign In'}
        </Button>

        <div className="text-center">
          <button
            type="button"
            onClick={onToggleMode}
            className="text-primary-600 hover:text-primary-700 text-sm font-medium"
          >
            {isSignUp 
              ? 'Already have an account? Sign in' 
              : "Don't have an account? Sign up"
            }
          </button>
        </div>
      </form>
    </div>
  );
}

================
File: src/components/auth/UserProfile.tsx
================
'use client';

import { Fragment } from 'react';
import { Menu, Transition } from '@headlessui/react';
import { UserCircleIcon, ArrowRightOnRectangleIcon, Cog6ToothIcon } from '@heroicons/react/24/outline';
import { useAuth } from '@/contexts/AuthContext';
import { cn } from '@/lib/utils';

export function UserProfile() {
  const { user, signOut } = useAuth();

  if (!user) return null;

  const userDisplayName = user.user_metadata?.full_name || 
                          user.user_metadata?.first_name || 
                          user.email?.split('@')[0] || 
                          'User';

  const userInitials = userDisplayName
    .split(' ')
    .map((name: string) => name[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);

  return (
    <Menu as="div" className="relative">
      <Menu.Button className="flex items-center space-x-3 text-sm rounded-full p-2 hover:bg-gray-100 transition-colors">
        {user.user_metadata?.avatar_url ? (
          <img
            className="h-8 w-8 rounded-full"
            src={user.user_metadata.avatar_url}
            alt={userDisplayName}
          />
        ) : (
          <div className="h-8 w-8 rounded-full bg-primary-600 flex items-center justify-center text-white text-xs font-medium">
            {userInitials}
          </div>
        )}
        <span className="hidden md:block text-gray-700 font-medium">
          {userDisplayName}
        </span>
      </Menu.Button>

      <Transition
        as={Fragment}
        enter="transition ease-out duration-100"
        enterFrom="transform opacity-0 scale-95"
        enterTo="transform opacity-100 scale-100"
        leave="transition ease-in duration-75"
        leaveFrom="transform opacity-100 scale-100"
        leaveTo="transform opacity-0 scale-95"
      >
        <Menu.Items className="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
          <div className="px-4 py-3 border-b border-gray-100">
            <p className="text-sm font-medium text-gray-900">{userDisplayName}</p>
            <p className="text-sm text-gray-500 truncate">{user.email}</p>
          </div>

          <div className="py-1">
            <Menu.Item>
              {({ active }) => (
                <button
                  className={cn(
                    'flex w-full items-center px-4 py-2 text-sm text-gray-700',
                    active && 'bg-gray-100'
                  )}
                >
                  <UserCircleIcon className="h-5 w-5 mr-3 text-gray-400" />
                  Profile Settings
                </button>
              )}
            </Menu.Item>

            <Menu.Item>
              {({ active }) => (
                <button
                  className={cn(
                    'flex w-full items-center px-4 py-2 text-sm text-gray-700',
                    active && 'bg-gray-100'
                  )}
                >
                  <Cog6ToothIcon className="h-5 w-5 mr-3 text-gray-400" />
                  Account Settings
                </button>
              )}
            </Menu.Item>

            <Menu.Item>
              {({ active }) => (
                <button
                  onClick={signOut}
                  className={cn(
                    'flex w-full items-center px-4 py-2 text-sm text-gray-700',
                    active && 'bg-gray-100'
                  )}
                >
                  <ArrowRightOnRectangleIcon className="h-5 w-5 mr-3 text-gray-400" />
                  Sign Out
                </button>
              )}
            </Menu.Item>
          </div>
        </Menu.Items>
      </Transition>
    </Menu>
  );
}

================
File: src/components/books/BookForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Save, X, Plus } from 'lucide-react';
import { Book, Category, ContentType } from '@/types/database';
import { bookService, CreateBookData, UpdateBookData } from '@/lib/supabase/books';
import { categoryService } from '@/lib/supabase/categories';
import { 
  Button, Card, Input, Textarea, Select, Badge, Modal, Spinner 
} from '@/components/ui';

interface BookFormProps {
  initialData?: Book;
}

export function BookForm({ initialData }: BookFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;
  const [loading, setLoading] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);

  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryColor, setNewCategoryColor] = useState('#6b7280');

  const [formData, setFormData] = useState({
    title: initialData?.title || '',
    author: initialData?.author || '',
    description: initialData?.description || '',
    category_id: initialData?.category_id || '',
    content_type: initialData?.content_type || 'text' as ContentType,
    language: initialData?.language || 'en',
    tags: initialData?.tags || [],
    cover_image_url: initialData?.cover_image_url || '',
    publication_year: initialData?.publication_year || '',
    is_public: initialData?.is_public || false,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [newTag, setNewTag] = useState('');

  useEffect(() => {
    loadCategories();
  }, []);

  const loadCategories = async () => {
    try {
      const data = await categoryService.getCategories({ type: 'book' });
      setCategories(data);
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  };

  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    if (!formData.title.trim()) {
      newErrors.title = 'Title is required';
    }
    if (formData.publication_year && isNaN(Number(formData.publication_year))) {
      newErrors.publication_year = 'Publication year must be a number';
    }
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;
    
    setLoading(true);
    try {
      const bookData = {
        ...formData,
        publication_year: formData.publication_year ? Number(formData.publication_year) : undefined,
      };
      
      if (isEditing) {
        await bookService.updateBook({ id: initialData.id, ...bookData } as UpdateBookData);
      } else {
        await bookService.createBook(bookData as CreateBookData);
      }
      
      router.push('/books');
      router.refresh(); // To reflect changes on the book list page
    } catch (error: any) {
      console.error('Failed to save book:', error);
      setErrors({ submit: error.message || 'Failed to save book. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData({ ...formData, tags: [...formData.tags, newTag.trim()] });
      setNewTag('');
    }
  };

  const handleRemoveTag = (tag: string) => {
    setFormData({ ...formData, tags: formData.tags.filter(t => t !== tag) });
  };

  // Add this new handler function
  const handleCreateCategory = async () => {
    if (!newCategoryName.trim()) return;

    try {
      const newCategory = await categoryService.createCategory({
        name: newCategoryName,
        type: 'book', // This ensures it's a 'book' category
        color: newCategoryColor,
      });

      // Close the modal and reset its form fields
      setIsCategoryModalOpen(false);
      setNewCategoryName('');

      // Reload the category list and automatically select the new one
      await loadCategories();
      setFormData({ ...formData, category_id: newCategory.id });
      
    } catch (error) {
      console.error("Failed to create book category:", error);
      // You could set an error state here to show in the modal if you wish
    }
  };
  return (
    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="mb-8">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => router.back()}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back
        </Button>
        <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
          {isEditing ? 'Edit Book' : 'Create New Book'}
        </h1>
      </div>

      {errors.submit && (
        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {errors.submit}
        </div>
      )}

      <div className="space-y-6">
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Basic Information</h2></Card.Header>
          <Card.Content className="space-y-4">
            <Input
              label="Book Title"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              error={errors.title}
              placeholder="Enter book title"
              required
            />
            <Input
              label="Author"
              value={formData.author}
              onChange={(e) => setFormData({ ...formData, author: e.target.value })}
              placeholder="Enter author's name"
            />
            <Textarea
              label="Description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Detailed book description"
              rows={4}
            />
            <Input
              label="Cover Image URL"
              type="url"
              value={formData.cover_image_url}
              onChange={(e) => setFormData({ ...formData, cover_image_url: e.target.value })}
              placeholder="https://example.com/image.jpg"
            />
          </Card.Content>
        </Card>

        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Details & Categorization</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="md:col-span-1">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Category
              </label>
              <div className="flex items-center gap-2">
                <Select
                  className="flex-grow"
                  value={formData.category_id}
                  onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
                  options={[
                    { value: '', label: 'Select category' },
                    ...categories.map(cat => ({ value: cat.id, label: cat.name }))
                  ]}
                />
                <Button
                  type="button"
                  variant="outline"
                  size="md"
                  onClick={() => setIsCategoryModalOpen(true)}
                  className="flex-shrink-0 !h-10" // Using !h-10 to match the input height
                >
                  <Plus className="h-4 w-4" />
                </Button>
              </div>
            </div>
              <Input
                label="Publication Year"
                type="number"
                value={formData.publication_year}
                onChange={(e) => setFormData({ ...formData, publication_year: e.target.value })}
                error={errors.publication_year}
                placeholder="e.g., 2023"
              />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
               <Select
                label="Content Type"
                value={formData.content_type}
                onChange={(e) => setFormData({ ...formData, content_type: e.target.value as ContentType })}
                options={bookService.getContentTypes()}
              />
              <Input
                label="Language"
                value={formData.language}
                onChange={(e) => setFormData({ ...formData, language: e.target.value })}
                placeholder="e.g., en"
              />
            </div>
            <div className="flex items-center space-x-2 pt-2">
              <input
                type="checkbox"
                id="is_public"
                checked={formData.is_public}
                onChange={(e) => setFormData({ ...formData, is_public: e.target.checked })}
                className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
              />
              <label htmlFor="is_public" className="text-sm font-medium text-gray-700 dark:text-gray-300">
                Make this book publicly accessible
              </label>
            </div>
          </Card.Content>
        </Card>
        
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Tags</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="flex gap-2">
              <Input
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                placeholder="Add a tag"
                onKeyPress={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddTag(); }}}
              />
              <Button type="button" onClick={handleAddTag} leftIcon={<Plus className="h-4 w-4" />}>Add</Button>
            </div>
            {formData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {formData.tags.map((tag) => (
                  <Badge key={tag} variant="secondary" className="px-3 py-1">
                    {tag}
                    <button type="button" onClick={() => handleRemoveTag(tag)} className="ml-2 hover:text-red-500">
                      <X className="h-3 w-3" />
                    </button>
                  </Badge>
                ))}
              </div>
            )}
          </Card.Content>
        </Card>

        <div className="flex justify-end gap-3">
          <Button type="button" variant="outline" onClick={() => router.push('/books')}>Cancel</Button>
          <Button type="submit" loading={loading} leftIcon={<Save className="h-4 w-4" />}>
            {isEditing ? 'Update Book' : 'Create Book'}
          </Button>
        </div>
      </div>
      <Modal
        isOpen={isCategoryModalOpen}
        onClose={() => setIsCategoryModalOpen(false)}
        title="Create New Book Category"
        size="sm"
      >
        <div className="space-y-4">
          <Input
            label="Category Name"
            value={newCategoryName}
            onChange={(e) => setNewCategoryName(e.target.value)}
            placeholder="e.g., Fiction, Science, etc."
            required
          />
          <Input
            label="Category Color"
            type="color"
            value={newCategoryColor}
            onChange={(e) => setNewCategoryColor(e.target.value)}
            className="h-10"
          />
        </div>
        <div className="mt-6 flex justify-end gap-3">
          <Button variant="ghost" onClick={() => setIsCategoryModalOpen(false)}>
            Cancel
          </Button>
          <Button onClick={handleCreateCategory}>
            Create Category
          </Button>
        </div>
      </Modal>
    </form>
  );
}

================
File: src/components/books/index.ts
================
export { BookForm } from './BookForm';

================
File: src/components/courses/CourseForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Save, X, Plus, GripVertical } from 'lucide-react';
import { Course, CourseStatus, DifficultyLevel, Category } from '@/types/database';
import { courseService, CreateCourseData, UpdateCourseData } from '@/lib/supabase/courses';
import { categoryService } from '@/lib/supabase/categories';
import { 
  Button, Card, Input, Textarea, Select, Badge, Modal, Spinner 
} from '@/components/ui';
import { cn } from '@/lib/utils';

interface CourseFormProps {
  initialData?: Course;
}

export function CourseForm({ initialData }: CourseFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;

  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryColor, setNewCategoryColor] = useState('#6b7280');
  
  const [loading, setLoading] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);
  const [formData, setFormData] = useState({
    title: initialData?.title || '',
    short_description: initialData?.short_description || '',
    description: initialData?.description || '',
    category_id: initialData?.category_id || '',
    status: initialData?.status || 'draft' as CourseStatus,
    difficulty: initialData?.difficulty || 'beginner' as DifficultyLevel,
    duration_hours: initialData?.duration_hours || '',
    objectives: initialData?.objectives || [],
    prerequisites: initialData?.prerequisites || [],
    tags: initialData?.tags || [],
    thumbnail_url: initialData?.thumbnail_url || '',
    is_public: initialData?.is_public || false,
  });
  
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [newObjective, setNewObjective] = useState('');
  const [newPrerequisite, setNewPrerequisite] = useState('');
  const [newTag, setNewTag] = useState('');

  useEffect(() => {
    loadCategories();
  }, []);

  const loadCategories = async () => {
    try {
      const data = await categoryService.getCategories({ type: 'course' });
      setCategories(data);
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  };

  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    
    if (!formData.title.trim()) {
      newErrors.title = 'Title is required';
    }
    
    if (formData.title.length > 200) {
      newErrors.title = 'Title must be less than 200 characters';
    }
    
    if (formData.short_description && formData.short_description.length > 300) {
      newErrors.short_description = 'Short description must be less than 300 characters';
    }
    
    if (formData.duration_hours && isNaN(Number(formData.duration_hours))) {
      newErrors.duration_hours = 'Duration must be a number';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }
    
    try {
      setLoading(true);
      
      const courseData = {
        ...formData,
        duration_hours: formData.duration_hours ? Number(formData.duration_hours) : undefined,
      };
      
      if (isEditing) {
        await courseService.updateCourse({
          id: initialData.id,
          ...courseData,
        } as UpdateCourseData);
      } else {
        await courseService.createCourse(courseData as CreateCourseData);
      }
      
      router.push('/courses');
    } catch (error) {
      console.error('Failed to save course:', error);
      setErrors({ submit: 'Failed to save course. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  const handleAddObjective = () => {
    if (newObjective.trim()) {
      setFormData({
        ...formData,
        objectives: [...formData.objectives, newObjective.trim()],
      });
      setNewObjective('');
    }
  };

  const handleRemoveObjective = (index: number) => {
    setFormData({
      ...formData,
      objectives: formData.objectives.filter((_, i) => i !== index),
    });
  };

  const handleAddPrerequisite = () => {
    if (newPrerequisite.trim()) {
      setFormData({
        ...formData,
        prerequisites: [...formData.prerequisites, newPrerequisite.trim()],
      });
      setNewPrerequisite('');
    }
  };

  const handleRemovePrerequisite = (index: number) => {
    setFormData({
      ...formData,
      prerequisites: formData.prerequisites.filter((_, i) => i !== index),
    });
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData({
        ...formData,
        tags: [...formData.tags, newTag.trim()],
      });
      setNewTag('');
    }
  };

  const handleRemoveTag = (tag: string) => {
    setFormData({
      ...formData,
      tags: formData.tags.filter(t => t !== tag),
    });
  };

  const handleCreateCategory = async () => {
    if (!newCategoryName.trim()) return;
  
    try {
      const newCategory = await categoryService.createCategory({
        name: newCategoryName,
        type: 'course', // Hardcode the type for this context
        color: newCategoryColor,
      });
  
      // Close modal and reset form
      setIsCategoryModalOpen(false);
      setNewCategoryName('');
  
      // Refresh the category list and select the new one
      await loadCategories();
      setFormData({ ...formData, category_id: newCategory.id });
      
    } catch (error) {
      console.error("Failed to create category:", error);
      // You can add error handling for the user here
    }
  };

  const statusOptions = [
    { value: 'draft', label: 'Draft' },
    { value: 'published', label: 'Published' },
    { value: 'archived', label: 'Archived' },
  ];

  const difficultyOptions = [
    { value: 'beginner', label: 'Beginner' },
    { value: 'intermediate', label: 'Intermediate' },
    { value: 'advanced', label: 'Advanced' },
    { value: 'expert', label: 'Expert' },
  ];

  return (
    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => router.push('/courses')}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back to Courses
        </Button>
        
        <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
          {isEditing ? 'Edit Course' : 'Create New Course'}
        </h1>
      </div>

      {errors.submit && (
        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {errors.submit}
        </div>
      )}

      <div className="space-y-6">
        {/* Basic Information */}
        <Card>
          <Card.Header>
            <h2 className="text-lg font-semibold">Basic Information</h2>
          </Card.Header>
          <Card.Content>
            <div className="space-y-4">
              <Input
                label="Course Title"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                error={errors.title}
                placeholder="Enter course title"
                required
              />
              
              <Input
                label="Short Description"
                value={formData.short_description}
                onChange={(e) => setFormData({ ...formData, short_description: e.target.value })}
                error={errors.short_description}
                placeholder="Brief description (max 300 characters)"
                helperText={`${formData.short_description.length}/300 characters`}
              />
              
              <Textarea
                label="Full Description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Detailed course description"
                rows={6}
              />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Category
                  </label>
                  <div className="flex items-center gap-2">
                    <Select
                      className="flex-grow"
                      value={formData.category_id}
                      onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
                      options={[
                        { value: '', label: 'Select category' },
                        ...categories.map(cat => ({ value: cat.id, label: cat.name }))
                      ]}
                    />
                    <Button
                      type="button"
                      variant="outline"
                      size="md"
                      onClick={() => setIsCategoryModalOpen(true)}
                      className="flex-shrink-0"
                    >
                      <Plus className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
                
                <Input
                  label="Duration (hours)"
                  type="number"
                  value={formData.duration_hours}
                  onChange={(e) => setFormData({ ...formData, duration_hours: e.target.value })}
                  error={errors.duration_hours}
                  placeholder="e.g., 24"
                />
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Select
                  label="Status"
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value as CourseStatus })}
                  options={statusOptions}
                />
                
                <Select
                  label="Difficulty Level"
                  value={formData.difficulty}
                  onChange={(e) => setFormData({ ...formData, difficulty: e.target.value as DifficultyLevel })}
                  options={difficultyOptions}
                />
              </div>
              
              <Input
                label="Thumbnail URL"
                type="url"
                value={formData.thumbnail_url}
                onChange={(e) => setFormData({ ...formData, thumbnail_url: e.target.value })}
                placeholder="https://example.com/image.jpg"
              />
              
              <div className="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="is_public"
                  checked={formData.is_public}
                  onChange={(e) => setFormData({ ...formData, is_public: e.target.checked })}
                  className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                />
                <label htmlFor="is_public" className="text-sm font-medium text-gray-700 dark:text-gray-300">
                  Make this course publicly accessible
                </label>
              </div>
            </div>
          </Card.Content>
        </Card>

        {/* Learning Objectives */}
        <Card>
          <Card.Header>
            <h2 className="text-lg font-semibold">Learning Objectives</h2>
          </Card.Header>
          <Card.Content>
            <div className="space-y-4">
              <div className="flex gap-2">
                <Input
                  value={newObjective}
                  onChange={(e) => setNewObjective(e.target.value)}
                  placeholder="Add a learning objective"
                  onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddObjective())}
                />
                <Button
                  type="button"
                  onClick={handleAddObjective}
                  leftIcon={<Plus className="h-4 w-4" />}
                >
                  Add
                </Button>
              </div>
              
              {formData.objectives.length > 0 && (
                <div className="space-y-2">
                  {formData.objectives.map((objective, index) => (
                    <div key={index} className="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                      <GripVertical className="h-4 w-4 text-gray-400" />
                      <span className="flex-1 text-sm">{objective}</span>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => handleRemoveObjective(index)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </Card.Content>
        </Card>

        {/* Prerequisites */}
        <Card>
          <Card.Header>
            <h2 className="text-lg font-semibold">Prerequisites</h2>
          </Card.Header>
          <Card.Content>
            <div className="space-y-4">
              <div className="flex gap-2">
                <Input
                  value={newPrerequisite}
                  onChange={(e) => setNewPrerequisite(e.target.value)}
                  placeholder="Add a prerequisite"
                  onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddPrerequisite())}
                />
                <Button
                  type="button"
                  onClick={handleAddPrerequisite}
                  leftIcon={<Plus className="h-4 w-4" />}
                >
                  Add
                </Button>
              </div>
              
              {formData.prerequisites.length > 0 && (
                <div className="space-y-2">
                  {formData.prerequisites.map((prerequisite, index) => (
                    <div key={index} className="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                      <GripVertical className="h-4 w-4 text-gray-400" />
                      <span className="flex-1 text-sm">{prerequisite}</span>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => handleRemovePrerequisite(index)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </Card.Content>
        </Card>

        {/* Tags */}
        <Card>
          <Card.Header>
            <h2 className="text-lg font-semibold">Tags</h2>
          </Card.Header>
          <Card.Content>
            <div className="space-y-4">
              <div className="flex gap-2">
                <Input
                  value={newTag}
                  onChange={(e) => setNewTag(e.target.value)}
                  placeholder="Add a tag"
                  onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddTag())}
                />
                <Button
                  type="button"
                  onClick={handleAddTag}
                  leftIcon={<Plus className="h-4 w-4" />}
                >
                  Add
                </Button>
              </div>
              
              {formData.tags.length > 0 && (
                <div className="flex flex-wrap gap-2">
                  {formData.tags.map((tag) => (
                    <Badge
                      key={tag}
                      variant="secondary"
                      className="px-3 py-1"
                    >
                      {tag}
                      <button
                        type="button"
                        onClick={() => handleRemoveTag(tag)}
                        className="ml-2 hover:text-red-500"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    </Badge>
                  ))}
                </div>
              )}
            </div>
          </Card.Content>
        </Card>

        {/* Actions */}
        <div className="flex justify-end gap-3">
          <Button
            type="button"
            variant="outline"
            onClick={() => router.push('/courses')}
          >
            Cancel
          </Button>
          <Button
            type="submit"
            loading={loading}
            leftIcon={<Save className="h-4 w-4" />}
          >
            {isEditing ? 'Update Course' : 'Create Course'}
          </Button>
        </div>
      </div>

      <Modal
        isOpen={isCategoryModalOpen}
        onClose={() => setIsCategoryModalOpen(false)}
        title="Create New Category"
        size="sm"
      >
        <div className="space-y-4">
          <Input
            label="Category Name"
            value={newCategoryName}
            onChange={(e) => setNewCategoryName(e.target.value)}
            placeholder="e.g., Programming"
            required
          />
          <Input
            label="Category Color"
            type="color"
            value={newCategoryColor}
            onChange={(e) => setNewCategoryColor(e.target.value)}
            className="h-10"
          />
        </div>
        <div className="mt-6 flex justify-end gap-3">
          <Button variant="ghost" onClick={() => setIsCategoryModalOpen(false)}>
            Cancel
          </Button>
          <Button onClick={handleCreateCategory}>
            Create Category
          </Button>
        </div>
      </Modal>
    </form>
  );
}
export default CourseForm;

================
File: src/components/courses/index.ts
================
export { CourseForm } from './CourseForm';

================
File: src/components/ErrorBoundary.tsx
================
'use client';

import React from 'react';

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ComponentType<{ error: Error }>;
}

export class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return <this.props.fallback error={this.state.error!} />;
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="max-w-md w-full bg-white rounded-lg shadow-md p-6 text-center">
            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-red-600 text-xl">⚠️</span>
            </div>
            <h2 className="text-lg font-semibold text-gray-900 mb-2">
              Something went wrong
            </h2>
            <p className="text-gray-600 mb-4">
              An unexpected error occurred. Please try refreshing the page.
            </p>
            <button
              onClick={() => window.location.reload()}
              className="btn-primary"
            >
              Refresh Page
            </button>
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details className="mt-4 text-left">
                <summary className="cursor-pointer text-sm text-gray-500">
                  Error Details
                </summary>
                <pre className="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded overflow-auto">
                  {this.state.error.toString()}
                </pre>
              </details>
            )}
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

================
File: src/components/layout/DashboardLayout.tsx
================
'use client';

import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import {
  Bars3Icon,
  HomeIcon,
  BookOpenIcon,
  AcademicCapIcon,
  ClipboardDocumentListIcon,
  CalendarIcon,
  XMarkIcon,
} from '@heroicons/react/24/outline';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { UserProfile } from '@/components/auth/UserProfile';
import { cn } from '@/lib/utils';

const navigation = [
  { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
  { name: 'Courses', href: '/courses', icon: AcademicCapIcon },
  { name: 'Books', href: '/books', icon: BookOpenIcon },
  { name: 'Vocabulary', href: '/vocabulary', icon: ClipboardDocumentListIcon },
  { name: 'Schedules', href: '/schedules', icon: CalendarIcon },
  { name: 'Components', href: '/dashboard/components', icon: Bars3Icon },
];

interface DashboardLayoutProps {
  children: React.ReactNode;
}

export function DashboardLayout({ children }: DashboardLayoutProps) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const pathname = usePathname();

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Mobile sidebar */}
      <Transition.Root show={sidebarOpen} as={Fragment}>
        <Dialog as="div" className="relative z-50 lg:hidden" onClose={setSidebarOpen}>
          <Transition.Child
            as={Fragment}
            enter="transition-opacity ease-linear duration-300"
            enterFrom="opacity-0"
            enterTo="opacity-100"
            leave="transition-opacity ease-linear duration-300"
            leaveFrom="opacity-100"
            leaveTo="opacity-0"
          >
            <div className="fixed inset-0 bg-gray-900/80" />
          </Transition.Child>

          <div className="fixed inset-0 flex">
            <Transition.Child
              as={Fragment}
              enter="transition ease-in-out duration-300 transform"
              enterFrom="-translate-x-full"
              enterTo="translate-x-0"
              leave="transition ease-in-out duration-300 transform"
              leaveFrom="translate-x-0"
              leaveTo="-translate-x-full"
            >
              <Dialog.Panel className="relative mr-16 flex w-full max-w-xs flex-1">
                <Transition.Child
                  as={Fragment}
                  enter="ease-in-out duration-300"
                  enterFrom="opacity-0"
                  enterTo="opacity-100"
                  leave="ease-in-out duration-300"
                  leaveFrom="opacity-100"
                  leaveTo="opacity-0"
                >
                  <div className="absolute left-full top-0 flex w-16 justify-center pt-5">
                    <button
                      type="button"
                      className="-m-2.5 p-2.5"
                      onClick={() => setSidebarOpen(false)}
                    >
                      <span className="sr-only">Close sidebar</span>
                      <XMarkIcon className="h-6 w-6 text-white" aria-hidden="true" />
                    </button>
                  </div>
                </Transition.Child>

                <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-white px-6 pb-2">
                  <div className="flex h-16 shrink-0 items-center">
                    <h1 className="text-xl font-bold text-primary-600">Course Builder</h1>
                  </div>
                  <nav className="flex flex-1 flex-col">
                    <ul role="list" className="flex flex-1 flex-col gap-y-7">
                      <li>
                        <ul role="list" className="-mx-2 space-y-1">
                          {navigation.map((item) => (
                            <li key={item.name}>
                              <Link
                                href={item.href}
                                className={cn(
                                  pathname === item.href
                                    ? 'bg-gray-50 text-primary-600'
                                    : 'text-gray-700 hover:text-primary-600 hover:bg-gray-50',
                                  'group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold'
                                )}
                                onClick={() => setSidebarOpen(false)}
                              >
                                <item.icon
                                  className={cn(
                                    pathname === item.href
                                      ? 'text-primary-600'
                                      : 'text-gray-400 group-hover:text-primary-600',
                                    'h-6 w-6 shrink-0'
                                  )}
                                  aria-hidden="true"
                                />
                                {item.name}
                              </Link>
                            </li>
                          ))}
                        </ul>
                      </li>
                    </ul>
                  </nav>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </Dialog>
      </Transition.Root>

      {/* Static sidebar for desktop */}
      <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col">
        <div className="flex grow flex-col gap-y-5 overflow-y-auto border-r border-gray-200 bg-white px-6">
          <div className="flex h-16 shrink-0 items-center">
            <h1 className="text-xl font-bold text-primary-600">Course Builder</h1>
          </div>
          <nav className="flex flex-1 flex-col">
            <ul role="list" className="flex flex-1 flex-col gap-y-7">
              <li>
                <ul role="list" className="-mx-2 space-y-1">
                  {navigation.map((item) => (
                    <li key={item.name}>
                      <Link
                        href={item.href}
                        className={cn(
                          pathname === item.href
                            ? 'bg-gray-50 text-primary-600'
                            : 'text-gray-700 hover:text-primary-600 hover:bg-gray-50',
                          'group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold'
                        )}
                      >
                        <item.icon
                          className={cn(
                            pathname === item.href
                              ? 'text-primary-600'
                              : 'text-gray-400 group-hover:text-primary-600',
                            'h-6 w-6 shrink-0'
                          )}
                          aria-hidden="true"
                        />
                        {item.name}
                      </Link>
                    </li>
                  ))}
                </ul>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <div className="lg:pl-72">
        {/* Top navigation */}
        <div className="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
          <button
            type="button"
            className="-m-2.5 p-2.5 text-gray-700 lg:hidden"
            onClick={() => setSidebarOpen(true)}
          >
            <span className="sr-only">Open sidebar</span>
            <Bars3Icon className="h-6 w-6" aria-hidden="true" />
          </button>

          <div className="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
            <div className="flex flex-1"></div>
            <div className="flex items-center gap-x-4 lg:gap-x-6">
              <UserProfile />
            </div>
          </div>
        </div>

        <main>{children}</main>
      </div>
    </div>
  );
}

================
File: src/components/relationships/CourseBookManager.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/Button'
import { Modal } from '@/components/ui/Modal'
import { SearchBox } from '@/components/ui/SearchBox'
import { Table } from '@/components/ui/Table'
import { Badge } from '@/components/ui/Badge'
import { courseBookService } from '@/lib/services/relationships'
import { bookService } from '@/lib/supabase/books'
import { Book, Loader2 } from 'lucide-react'

interface CourseBookManagerProps {
  courseId: string
  onUpdate?: () => void
}

export function CourseBookManager({ courseId, onUpdate }: CourseBookManagerProps) {
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedBooks, setSelectedBooks] = useState<string[]>([])
  const [courseBooks, setCourseBooks] = useState<any[]>([])
  const [availableBooks, setAvailableBooks] = useState<any[]>([])
  const [loading, setLoading] = useState(false)
  const [loadingBooks, setLoadingBooks] = useState(false)

  // Load course books
  const loadCourseBooks = async () => {
    try {
      const books = await courseBookService.getCourseBooksWithDetails(courseId)
      setCourseBooks(books || [])
    } catch (error) {
      console.error('Failed to load course books:', error)
    }
  }

  // Load available books
  const loadAvailableBooks = async () => {
    setLoadingBooks(true)
    try {
      const books = await bookService.getBooks()
      // Filter out books already in the course
      const courseBooksIds = courseBooks.map(cb => cb.book_id)
      const available = books.filter(book => !courseBooksIds.includes(book.id))
      setAvailableBooks(available)
    } catch (error) {
      console.error('Failed to load available books:', error)
    } finally {
      setLoadingBooks(false)
    }
  }

  // Initial load
  useEffect(() => {
    loadCourseBooks()
  }, [courseId])

  // Open modal and load data
  const openModal = async () => {
    setIsModalOpen(true)
    setSelectedBooks([])
    setSearchQuery('')
    await loadAvailableBooks()
  }

  // Add selected books to course
  const handleAddBooks = async () => {
    if (selectedBooks.length === 0) return

    setLoading(true)
    try {
      await courseBookService.bulkAddBooksToCourse(courseId, selectedBooks)
      setSelectedBooks([])
      await loadCourseBooks()
      onUpdate?.()
      setIsModalOpen(false)
    } catch (error) {
      console.error('Failed to add books:', error)
    } finally {
      setLoading(false)
    }
  }

  // Remove book from course
  const handleRemoveBook = async (bookId: string) => {
    if (!confirm('Are you sure you want to remove this book from the course?')) return

    try {
      await courseBookService.removeBookFromCourse(courseId, bookId)
      await loadCourseBooks()
      onUpdate?.()
    } catch (error) {
      console.error('Failed to remove book:', error)
    }
  }

  // Toggle book required status
  const handleToggleRequired = async (bookId: string, currentRequired: boolean) => {
    try {
      await courseBookService.updateCourseBook(courseId, bookId, {
        isRequired: !currentRequired
      })
      await loadCourseBooks()
    } catch (error) {
      console.error('Failed to update book:', error)
    }
  }

  // Toggle book selection
  const toggleBookSelection = (bookId: string) => {
    if (selectedBooks.includes(bookId)) {
      setSelectedBooks(selectedBooks.filter(id => id !== bookId))
    } else {
      setSelectedBooks([...selectedBooks, bookId])
    }
  }

  // Filter available books based on search
  const filteredBooks = availableBooks.filter(book =>
    (book.title || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
    book.author?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    book.isbn?.toLowerCase().includes(searchQuery.toLowerCase())
  )
  
  return (
    <>
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-medium">Course Books</h3>
          <Button onClick={openModal} size="sm">
            <Book className="h-4 w-4 mr-2" />
            Manage Books
          </Button>
        </div>

        {courseBooks.length > 0 ? (
          <div className="grid gap-4">
            {courseBooks.map((courseBook) => (
              <div
                key={courseBook.id}
                className="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
              >
                <div className="flex items-center gap-4">
                  {courseBook.book?.cover_image_url && (
                    <img
                      src={courseBook.book.cover_image_url}
                      alt={courseBook.book.title}
                      className="w-16 h-20 object-cover rounded"
                    />
                  )}
                  <div>
                    <h4 className="font-medium">{courseBook.book?.title}</h4>
                    <p className="text-sm text-gray-600 dark:text-gray-400">{courseBook.book?.author}</p>
                    {courseBook.book?.isbn && (
                      <p className="text-xs text-gray-500 dark:text-gray-500">ISBN: {courseBook.book.isbn}</p>
                    )}
                    {courseBook.notes && (
                      <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{courseBook.notes}</p>
                    )}
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Badge
                    variant={courseBook.is_required ? 'default' : 'secondary'}
                    className="cursor-pointer"
                    onClick={() => handleToggleRequired(courseBook.book_id, courseBook.is_required)}
                  >
                    {courseBook.is_required ? 'Required' : 'Optional'}
                  </Badge>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveBook(courseBook.book_id)}
                    className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                  >
                    Remove
                  </Button>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-gray-500 dark:text-gray-400 text-center py-8">
            No books added to this course yet.
          </p>
        )}
      </div>

      <Modal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        title="Add Books to Course"
        size="lg"
      >
        <div className="space-y-4">
          <SearchBox
            value={searchQuery}
            onSearch={setSearchQuery}
            placeholder="Search books by title, author, or ISBN..."
          />

          {loadingBooks ? (
            <div className="flex justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
            </div>
          ) : filteredBooks.length > 0 ? (
            <div className="max-h-96 overflow-y-auto">
              <Table
                columns={[
                  {
                    key: 'select',
                    label: (
                      <input
                        type="checkbox"
                        checked={filteredBooks.length > 0 && filteredBooks.every(book => selectedBooks.includes(book.id))}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setSelectedBooks(filteredBooks.map(book => book.id))
                          } else {
                            setSelectedBooks([])
                          }
                        }}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      />
                    ),
                    render: (book) => (
                      <input
                        type="checkbox"
                        checked={selectedBooks.includes(book.id)}
                        onChange={() => toggleBookSelection(book.id)}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      />
                    )
                  },
                  { 
                    key: 'title', 
                    label: 'Title',
                    render: (book) => (
                      <div>
                        <p className="font-medium">{book.title}</p>
                        {book.isbn && (
                          <p className="text-xs text-gray-500">ISBN: {book.isbn}</p>
                        )}
                      </div>
                    )
                  },
                  { key: 'author', label: 'Author' },
                  {
                    key: 'category',
                    label: 'Category',
                    render: (book) => book.category?.name || '-'
                  },
                  {
                    key: 'type',
                    label: 'Type',
                    render: (book) => (
                      <Badge variant="warning">
                        {book.content_type || 'physical'}
                      </Badge>
                    )
                  }
                ]}
                data={filteredBooks}
              />
            </div>
          ) : (
            <p className="text-center py-8 text-gray-500 dark:text-gray-400">
              {searchQuery ? 'No books found matching your search.' : 'No available books to add.'}
            </p>
          )}

          <div className="flex justify-between items-center border-t pt-4">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              {selectedBooks.length} book{selectedBooks.length !== 1 ? 's' : ''} selected
            </p>
            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setIsModalOpen(false)}>
                Cancel
              </Button>
              <Button
                onClick={handleAddBooks}
                disabled={selectedBooks.length === 0 || loading}
                loading={loading}
              >
                Add Books
              </Button>
            </div>
          </div>
        </div>
      </Modal>
    </>
  )
}

================
File: src/components/relationships/CourseScheduleList.tsx
================
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { scheduleService } from '@/lib/supabase/schedules'
import { lessonService } from '@/lib/supabase/lessons'
import { Button } from '@/components/ui/Button'
import { Badge } from '@/components/ui/Badge'
import { Card } from '@/components/ui/Card'
import { 
  Calendar, 
  Clock, 
  MapPin, 
  Users,
  ChevronRight,
  Plus 
} from 'lucide-react'

interface CourseScheduleListProps {
  courseId: string
}

export function CourseScheduleList({ courseId }: CourseScheduleListProps) {
  const router = useRouter()
  const [schedules, setSchedules] = useState<any[]>([])
  const [lessons, setLessons] = useState<any[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadSchedulesAndLessons()
  }, [courseId])

  const loadSchedulesAndLessons = async () => {
    setLoading(true)
    try {
      // Get all schedules for this course
      const courseSchedules = await scheduleService.getSchedule(courseId)
      setSchedules(courseSchedules)

      // Get all lessons for these schedules
      if (courseSchedules.length > 0) {
        const allLessons = []
        for (const schedule of courseSchedules) {
          const scheduleLessons = await lessonService.getScheduleLessons(schedule.id)
          allLessons.push(...scheduleLessons.map(lesson => ({
            ...lesson,
            schedule
          })))
        }
        // Sort lessons by date and time
        allLessons.sort((a, b) => {
          const dateCompare = new Date(a.date).getTime() - new Date(b.date).getTime()
          if (dateCompare !== 0) return dateCompare
          return a.start_time.localeCompare(b.start_time)
        })
        setLessons(allLessons)
      }
    } catch (error) {
      console.error('Failed to load schedules and lessons:', error)
    } finally {
      setLoading(false)
    }
  }

  const formatTime = (time: string) => {
    try {
      return new Date(`2000-01-01T${time}`).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
      })
    } catch {
      return time
    }
  }

  const formatDate = (date: string) => {
    try {
      return new Date(date).toLocaleDateString([], {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      })
    } catch {
      return date
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'success'
      case 'cancelled': return 'danger'
      default: return 'default'
    }
  }

  if (loading) {
    return (
      <div className="text-center py-8">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-gray-100 mx-auto"></div>
      </div>
    )
  }

  if (schedules.length === 0) {
    return (
      <div className="text-center py-16">
        <Calendar className="h-12 w-12 text-gray-400 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">
          No schedules yet
        </h3>
        <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Create a teaching schedule for this course
        </p>
        <Button 
          className="mt-4" 
          size="sm"
          onClick={() => router.push(`/schedules/new?courseId=${courseId}`)}
        >
          <Plus className="h-4 w-4 mr-2" />
          Create Schedule
        </Button>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Schedule Summary */}
      <div className="flex justify-between items-center">
        <div>
          <h3 className="text-lg font-medium">Course Schedules</h3>
          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
            {schedules.length} schedule{schedules.length !== 1 ? 's' : ''}, {lessons.length} lesson{lessons.length !== 1 ? 's' : ''}
          </p>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={() => router.push(`/schedules/new?courseId=${courseId}`)}
        >
          <Plus className="h-4 w-4 mr-2" />
          New Schedule
        </Button>
      </div>

      {/* Lessons List */}
      <div className="space-y-3">
        {lessons.map((lesson) => (
          <Card
            key={lesson.id}
            className="hover:shadow-md transition-shadow cursor-pointer"
            onClick={() => router.push(`/lessons/${lesson.id}`)}
          >
            <Card.Content className="p-4">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-2">
                    <h4 className="font-medium text-lg">
                      Lesson {lesson.lesson_number}: {lesson.topic}
                    </h4>
                    <Badge variant={getStatusColor(lesson.status)} size="sm">
                      {lesson.status}
                    </Badge>
                  </div>
                  
                  {lesson.description && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                      {lesson.description}
                    </p>
                  )}
                  
                  <div className="flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                    <div className="flex items-center gap-1">
                      <Calendar className="h-3 w-3" />
                      <span>{formatDate(lesson.date)}</span>
                    </div>
                    
                    <div className="flex items-center gap-1">
                      <Clock className="h-3 w-3" />
                      <span>{formatTime(lesson.start_time)} - {formatTime(lesson.end_time)}</span>
                    </div>
                    
                    {lesson.location && (
                      <div className="flex items-center gap-1">
                        <MapPin className="h-3 w-3" />
                        <span>{lesson.location}</span>
                      </div>
                    )}
                    
                    {lesson.max_students && (
                      <div className="flex items-center gap-1">
                        <Users className="h-3 w-3" />
                        <span>Max {lesson.max_students}</span>
                      </div>
                    )}
                  </div>
                  
                  {lesson.schedule && (
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                      Schedule: {lesson.schedule.name}
                    </p>
                  )}
                </div>
                
                <ChevronRight className="h-5 w-5 text-gray-400 flex-shrink-0 ml-4" />
              </div>
            </Card.Content>
          </Card>
        ))}
      </div>
    </div>
  )
}

================
File: src/components/relationships/CourseVocabularyManager.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/Button'
import { Modal } from '@/components/ui/Modal'
import { SearchBox } from '@/components/ui/SearchBox'
import { Badge } from '@/components/ui/Badge'
import { courseVocabularyService } from '@/lib/services/relationships'
import { vocabularyService } from '@/lib/supabase/vocabulary'
import { BookOpen, Languages, Loader2, X } from 'lucide-react'

interface CourseVocabularyManagerProps {
  courseId: string
  onUpdate?: () => void
}

export function CourseVocabularyManager({ courseId, onUpdate }: CourseVocabularyManagerProps) {
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedGroups, setSelectedGroups] = useState<string[]>([])
  const [courseGroups, setCourseGroups] = useState<any[]>([])
  const [availableGroups, setAvailableGroups] = useState<any[]>([])
  const [loading, setLoading] = useState(false)
  const [loadingGroups, setLoadingGroups] = useState(false)
  const [stats, setStats] = useState<any>(null)

  // Load course vocabulary groups
  const loadCourseGroups = async () => {
    try {
      const groups = await courseVocabularyService.getCourseVocabularyGroups(courseId)
      setCourseGroups(groups || [])
      
      // Load stats
      const vocabStats = await courseVocabularyService.getCourseVocabularyStats(courseId)
      setStats(vocabStats)
    } catch (error) {
      console.error('Failed to load course vocabulary groups:', error)
    }
  }

  // Load available vocabulary groups
  const loadAvailableGroups = async () => {
    setLoadingGroups(true)
    try {
      const groups = await vocabularyService.getVocabularyGroups()
      // Filter out groups already in the course
      const courseGroupIds = courseGroups.map(cg => cg.vocabulary_group_id)
      const available = groups.filter(group => !courseGroupIds.includes(group.id))
      setAvailableGroups(available)
    } catch (error) {
      console.error('Failed to load available groups:', error)
    } finally {
      setLoadingGroups(false)
    }
  }

  useEffect(() => {
    loadCourseGroups()
  }, [courseId])

  // Open modal and load data
  const openModal = async () => {
    setIsModalOpen(true)
    setSelectedGroups([])
    setSearchQuery('')
    await loadAvailableGroups()
  }

  // Add selected groups to course
  const handleAddGroups = async () => {
    if (selectedGroups.length === 0) return

    setLoading(true)
    try {
      await courseVocabularyService.bulkAddVocabularyGroupsToCourse(courseId, selectedGroups)
      setSelectedGroups([])
      await loadCourseGroups()
      onUpdate?.()
      setIsModalOpen(false)
    } catch (error) {
      console.error('Failed to add vocabulary groups:', error)
    } finally {
      setLoading(false)
    }
  }

  // Remove group from course
  const handleRemoveGroup = async (groupId: string) => {
    if (!confirm('Are you sure you want to remove this vocabulary group from the course?')) return

    try {
      await courseVocabularyService.removeVocabularyGroupFromCourse(courseId, groupId)
      await loadCourseGroups()
      onUpdate?.()
    } catch (error) {
      console.error('Failed to remove vocabulary group:', error)
    }
  }

  // Toggle group selection
  const toggleGroupSelection = (groupId: string) => {
    if (selectedGroups.includes(groupId)) {
      setSelectedGroups(selectedGroups.filter(id => id !== groupId))
    } else {
      setSelectedGroups([...selectedGroups, groupId])
    }
  }

  // Filter available groups based on search
  const filteredGroups = availableGroups.filter(group =>
    group.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    group.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    group.language?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    group.target_language?.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'beginner': return 'success'
      case 'intermediate': return 'warning'
      case 'advanced': return 'danger'
      case 'expert': return 'secondary'
      default: return 'default'
    }
  }

  return (
    <>
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <div>
            <h3 className="text-lg font-medium">Vocabulary Groups</h3>
            {stats && stats.totalWords > 0 && (
              <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                Total words: {stats.totalWords}
              </p>
            )}
          </div>
          <Button onClick={openModal} size="sm">
            <Languages className="h-4 w-4 mr-2" />
            Manage Vocabulary
          </Button>
        </div>

        {courseGroups.length > 0 ? (
          <div className="grid gap-4">
            {courseGroups.map((courseGroup) => {
              const group = courseGroup.vocabulary_group
              const wordCount = group?.vocabulary_group_items?.length || 0
              
              return (
                <div
                  key={courseGroup.id}
                  className="p-4 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h4 className="font-medium">{group?.name}</h4>
                        <Badge variant={getDifficultyColor(group?.difficulty)}>
                          {group?.difficulty}
                        </Badge>
                        {group?.language && group?.target_language && (
                          <Badge variant="outline">
                            {group.language} → {group.target_language}
                          </Badge>
                        )}
                      </div>
                      {group?.description && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{group.description}</p>
                      )}
                      <div className="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                        <span>{wordCount} word{wordCount !== 1 ? 's' : ''}</span>
                        {group?.tags && group.tags.length > 0 && (
                          <div className="flex gap-1">
                            {group.tags.slice(0, 3).map((tag: string) => (
                              <span key={tag} className="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">
                                {tag}
                              </span>
                            ))}
                            {group.tags.length > 3 && (
                              <span className="text-xs">+{group.tags.length - 3}</span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleRemoveGroup(courseGroup.vocabulary_group_id)}
                      className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                    >
                      <X className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              )
            })}
          </div>
        ) : (
          <p className="text-gray-500 dark:text-gray-400 text-center py-8">
            No vocabulary groups added to this course yet.
          </p>
        )}

        {stats && stats.totalWords > 0 && (
          <div className="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <h4 className="font-medium mb-3">Vocabulary Statistics</h4>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-600 dark:text-gray-400 mb-2">By Difficulty:</p>
                <ul className="space-y-1">
                  {Object.entries(stats.byDifficulty).map(([level, count]) => (
                    <li key={level} className="flex justify-between">
                      <span className="capitalize text-gray-700 dark:text-gray-300">{level}:</span>
                      <span className="font-medium">{count as number}</span>
                    </li>
                  ))}
                </ul>
              </div>
              <div>
                <p className="text-gray-600 dark:text-gray-400 mb-2">By Part of Speech:</p>
                <ul className="space-y-1">
                  {Object.entries(stats.byPartOfSpeech).slice(0, 5).map(([pos, count]) => (
                    <li key={pos} className="flex justify-between">
                      <span className="capitalize text-gray-700 dark:text-gray-300">{pos}:</span>
                      <span className="font-medium">{count as number}</span>
                    </li>
                  ))}
                  {Object.keys(stats.byPartOfSpeech).length > 5 && (
                    <li className="text-gray-500 dark:text-gray-400 text-xs">
                      +{Object.keys(stats.byPartOfSpeech).length - 5} more
                    </li>
                  )}
                </ul>
              </div>
            </div>
          </div>
        )}
      </div>

      <Modal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        title="Add Vocabulary Groups"
        size="lg"
      >
        <div className="space-y-4">
          <SearchBox
            value={searchQuery}
            onSearch={setSearchQuery}
            placeholder="Search vocabulary groups by name, description, or language..."
          />

          {loadingGroups ? (
            <div className="flex justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
            </div>
          ) : filteredGroups.length > 0 ? (
            <div className="max-h-96 overflow-y-auto space-y-2">
              {filteredGroups.map((group) => (
                <div
                  key={group.id}
                  className={`p-3 border rounded-lg cursor-pointer transition-all ${
                    selectedGroups.includes(group.id)
                      ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                      : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                  }`}
                  onClick={() => toggleGroupSelection(group.id)}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex items-start gap-3 flex-1">
                      <input
                        type="checkbox"
                        checked={selectedGroups.includes(group.id)}
                        onChange={() => {}}
                        className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <h5 className="font-medium">{group.name}</h5>
                          <Badge variant={getDifficultyColor(group.difficulty)} size="sm">
                            {group.difficulty}
                          </Badge>
                          {group.language && group.target_language && (
                            <Badge variant="outline" size="sm">
                              {group.language} → {group.target_language}
                            </Badge>
                          )}
                        </div>
                        {group.description && (
                          <p className="text-sm text-gray-600 dark:text-gray-400">{group.description}</p>
                        )}
                        <div className="flex items-center gap-4 mt-1 text-xs text-gray-500 dark:text-gray-400">
                          <span>{group.vocabulary_group_items?.length || 0} words</span>
                          {group.tags && group.tags.length > 0 && (
                            <span>{group.tags.length} tags</span>
                          )}
                        </div>
                      </div>
                    </div>
                    <BookOpen className="h-4 w-4 text-gray-400 mt-1" />
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-center py-8 text-gray-500 dark:text-gray-400">
              {searchQuery ? 'No vocabulary groups found matching your search.' : 'No available vocabulary groups to add.'}
            </p>
          )}

          <div className="flex justify-between items-center border-t pt-4">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              {selectedGroups.length} group{selectedGroups.length !== 1 ? 's' : ''} selected
            </p>
            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setIsModalOpen(false)}>
                Cancel
              </Button>
              <Button
                onClick={handleAddGroups}
                disabled={selectedGroups.length === 0 || loading}
                loading={loading}
              >
                Add Groups
              </Button>
            </div>
          </div>
        </div>
      </Modal>
    </>
  )
}

================
File: src/components/relationships/index.ts
================
// Export all relationship components
export { CourseBookManager } from './CourseBookManager'
export { CourseVocabularyManager } from './CourseVocabularyManager'
export { LessonContentManager } from './LessonContentManager'
export { CourseScheduleList } from './CourseScheduleList'

================
File: src/components/relationships/LessonContentManager.tsx
================
'use client'

import { useState, useEffect } from 'react'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/Tabs'
import { Button } from '@/components/ui/Button'
import { Badge } from '@/components/ui/Badge'
import { Modal } from '@/components/ui/Modal'
import { SearchBox } from '@/components/ui/SearchBox'
import { lessonRelationshipService } from '@/lib/services/relationships'
import { objectiveService } from '@/lib/supabase/objectives'
import { methodService } from '@/lib/supabase/methods'
import { taskService } from '@/lib/supabase/tasks'
import { bookService } from '@/lib/supabase/books'
import { vocabularyService } from '@/lib/supabase/vocabulary'
import { 
  Target, 
  Lightbulb, 
  ClipboardList, 
  Book, 
  Languages,
  Plus,
  X,
  Clock,
  Users,
  Calendar,
  Loader2
} from 'lucide-react'

interface LessonContentManagerProps {
  lessonId: string
  onUpdate?: () => void
}

interface TabContent {
  objectives: any[]
  methods: any[]
  tasks: any[]
  books: any[]
  vocabulary: any[]
}

export function LessonContentManager({ lessonId, onUpdate }: LessonContentManagerProps) {
  const [activeTab, setActiveTab] = useState('objectives')
  const [content, setContent] = useState<TabContent>({
    objectives: [],
    methods: [],
    tasks: [],
    books: [],
    vocabulary: []
  })
  const [loading, setLoading] = useState(true)
  const [modalOpen, setModalOpen] = useState(false)
  const [modalType, setModalType] = useState<keyof TabContent>('objectives')
  const [searchQuery, setSearchQuery] = useState('')
  const [availableItems, setAvailableItems] = useState<any[]>([])
  const [selectedItems, setSelectedItems] = useState<string[]>([])
  const [loadingModal, setLoadingModal] = useState(false)
  const [savingItems, setSavingItems] = useState(false)

  // Load all lesson content
  const loadLessonContent = async () => {
    setLoading(true)
    try {
      const lessonContent = await lessonRelationshipService.getLessonContent(lessonId)
      setContent(lessonContent)
    } catch (error) {
      console.error('Failed to load lesson content:', error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadLessonContent()
  }, [lessonId])

  // Load available items based on type
  const loadAvailableItems = async (type: keyof TabContent) => {
    setLoadingModal(true)
    try {
      let items: any[] = []
      const currentIds = content[type].map(item => {
        switch (type) {
          case 'objectives': return item.objective_id
          case 'methods': return item.method_id
          case 'tasks': return item.task_id
          case 'books': return item.book_id
          case 'vocabulary': return item.vocabulary_id
          default: return null
        }
      }).filter(Boolean)

      switch (type) {
        case 'objectives':
          const objectives = await objectiveService.getObjectives()
          items = objectives.filter(obj => !currentIds.includes(obj.id))
          break
        case 'methods':
          const methods = await methodService.getMethods()
          items = methods.filter(method => !currentIds.includes(method.id))
          break
        case 'tasks':
          const tasks = await taskService.getTasks()
          items = tasks.filter(task => !currentIds.includes(task.id))
          break
        case 'books':
          const books = await bookService.getBooks()
          items = books.filter(book => !currentIds.includes(book.id))
          break
        case 'vocabulary':
          const vocabulary = await vocabularyService.getVocabulary()
          items = vocabulary.filter(vocab => !currentIds.includes(vocab.id))
          break
      }

      setAvailableItems(items)
    } catch (error) {
      console.error(`Failed to load available ${type}:`, error)
    } finally {
      setLoadingModal(false)
    }
  }

  // Handle opening add modal
  const openAddModal = async (type: keyof TabContent) => {
    setModalType(type)
    setModalOpen(true)
    setSearchQuery('')
    setSelectedItems([])
    await loadAvailableItems(type)
  }

  // Handle removing items
  const handleRemove = async (type: keyof TabContent, itemId: string) => {
    if (!confirm(`Are you sure you want to remove this ${type.slice(0, -1)}?`)) return

    try {
      switch (type) {
        case 'objectives':
          await lessonRelationshipService.removeObjectiveFromLesson(lessonId, itemId)
          break
        case 'methods':
          await lessonRelationshipService.removeMethodFromLesson(lessonId, itemId)
          break
        case 'tasks':
          await lessonRelationshipService.removeTaskFromLesson(lessonId, itemId)
          break
        case 'books':
          await lessonRelationshipService.removeBookFromLesson(lessonId, itemId)
          break
        case 'vocabulary':
          await lessonRelationshipService.removeVocabularyFromLesson(lessonId, itemId)
          break
      }
      await loadLessonContent()
      onUpdate?.()
    } catch (error) {
      console.error(`Failed to remove ${type}:`, error)
    }
  }

  // Handle adding selected items
  const handleAddItems = async () => {
    if (selectedItems.length === 0) return

    setSavingItems(true)
    try {
      switch (modalType) {
        case 'objectives':
          await lessonRelationshipService.bulkAddObjectivesToLesson(lessonId, selectedItems)
          break
        case 'methods':
          await lessonRelationshipService.bulkAddMethodsToLesson(
            lessonId,
            selectedItems.map(id => ({ methodId: id }))
          )
          break
        case 'tasks':
          await lessonRelationshipService.bulkAddTasksToLesson(
            lessonId,
            selectedItems.map(id => ({ taskId: id }))
          )
          break
        case 'books':
          for (const bookId of selectedItems) {
            await lessonRelationshipService.addBookToLesson(lessonId, bookId)
          }
          break
        case 'vocabulary':
          for (const vocabId of selectedItems) {
            await lessonRelationshipService.addVocabularyToLesson(lessonId, vocabId)
          }
          break
      }
      await loadLessonContent()
      onUpdate?.()
      setModalOpen(false)
    } catch (error) {
      console.error(`Failed to add ${modalType}:`, error)
    } finally {
      setSavingItems(false)
    }
  }

  // Toggle item selection
  const toggleItemSelection = (itemId: string) => {
    if (selectedItems.includes(itemId)) {
      setSelectedItems(selectedItems.filter(id => id !== itemId))
    } else {
      setSelectedItems([...selectedItems, itemId])
    }
  }

  // Filter items based on search
  const getFilteredItems = () => {
    if (!searchQuery) return availableItems

    return availableItems.filter(item => {
      const searchLower = searchQuery.toLowerCase()
      switch (modalType) {
        case 'objectives':
          return item.title?.toLowerCase().includes(searchLower) ||
                 item.description?.toLowerCase().includes(searchLower)
        case 'methods':
          return item.name?.toLowerCase().includes(searchLower) ||
                 item.description?.toLowerCase().includes(searchLower)
        case 'tasks':
          return item.title?.toLowerCase().includes(searchLower) ||
                 item.description?.toLowerCase().includes(searchLower)
        case 'books':
          return item.title?.toLowerCase().includes(searchLower) ||
                 item.author?.toLowerCase().includes(searchLower) ||
                 item.isbn?.toLowerCase().includes(searchLower)
        case 'vocabulary':
          return item.word?.toLowerCase().includes(searchLower) ||
                 item.translation?.toLowerCase().includes(searchLower)
        default:
          return true
      }
    })
  }

  const tabs = [
    {
      key: 'objectives',
      label: 'Objectives',
      icon: <Target className="h-4 w-4" />,
      count: content.objectives.length
    },
    {
      key: 'methods',
      label: 'Methods',
      icon: <Lightbulb className="h-4 w-4" />,
      count: content.methods.length
    },
    {
      key: 'tasks',
      label: 'Tasks',
      icon: <ClipboardList className="h-4 w-4" />,
      count: content.tasks.length
    },
    {
      key: 'books',
      label: 'Books',
      icon: <Book className="h-4 w-4" />,
      count: content.books.length
    },
    {
      key: 'vocabulary',
      label: 'Vocabulary',
      icon: <Languages className="h-4 w-4" />,
      count: content.vocabulary.length
    }
  ]

  const renderContent = () => {
    if (loading) {
      return (
        <div className="flex justify-center py-8">
          <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
        </div>
      )
    }

    const currentContent = content[activeTab as keyof TabContent]

    if (currentContent.length === 0) {
      return (
        <div className="text-center py-8">
          <p className="text-gray-500 dark:text-gray-400 mb-4">
            No {activeTab} added to this lesson yet.
          </p>
          <Button onClick={() => openAddModal(activeTab as keyof TabContent)}>
            <Plus className="h-4 w-4 mr-2" />
            Add {activeTab}
          </Button>
        </div>
      )
    }

    switch (activeTab) {
      case 'objectives':
        return (
          <div className="space-y-3">
            {content.objectives.map((item) => (
              <div key={item.id} className="flex items-start justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                <div className="flex-1">
                  <h4 className="font-medium">{item.objective?.title}</h4>
                  {item.objective?.description && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.objective.description}</p>
                  )}
                  <div className="flex items-center gap-2 mt-2">
                    {item.objective?.bloom_level && (
                      <Badge variant="outline" size="sm">
                        {item.objective.bloom_level}
                      </Badge>
                    )}
                    {item.objective?.category && (
                      <Badge variant="secondary" size="sm">
                        {item.objective.category}
                      </Badge>
                    )}
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemove('objectives', item.objective_id)}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        )

      case 'methods':
        return (
          <div className="space-y-3">
            {content.methods.map((item) => (
              <div key={item.id} className="flex items-start justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                <div className="flex-1">
                  <h4 className="font-medium">{item.method?.name}</h4>
                  {item.method?.description && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.method.description}</p>
                  )}
                  <div className="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                    <span className="flex items-center gap-1">
                      <Clock className="h-3 w-3" />
                      {item.duration_override || item.method?.duration_minutes} min
                    </span>
                    {item.method?.group_size_min && item.method?.group_size_max && (
                      <span className="flex items-center gap-1">
                        <Users className="h-3 w-3" />
                        {item.method.group_size_min}-{item.method.group_size_max}
                      </span>
                    )}
                    {item.method?.category && (
                      <Badge variant="outline" size="sm">
                        {item.method.category}
                      </Badge>
                    )}
                  </div>
                  {item.notes && (
                    <p className="text-sm text-blue-600 dark:text-blue-400 mt-2">Note: {item.notes}</p>
                  )}
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemove('methods', item.method_id)}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        )

      case 'tasks':
        return (
          <div className="space-y-3">
            {content.tasks.map((item) => (
              <div key={item.id} className="flex items-start justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <h4 className="font-medium">{item.task?.title}</h4>
                    {item.is_homework && (
                      <Badge variant="warning" size="sm">Homework</Badge>
                    )}
                  </div>
                  {item.task?.description && (
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.task.description}</p>
                  )}
                  <div className="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                    <span className="flex items-center gap-1">
                      <Clock className="h-3 w-3" />
                      {item.duration_override || item.task?.duration_minutes} min
                    </span>
                    {item.task?.difficulty && (
                      <Badge variant="outline" size="sm">{item.task.difficulty}</Badge>
                    )}
                    {item.due_date && (
                      <span className="flex items-center gap-1">
                        <Calendar className="h-3 w-3" />
                        Due: {new Date(item.due_date).toLocaleDateString()}
                      </span>
                    )}
                  </div>
                  {item.notes && (
                    <p className="text-sm text-blue-600 dark:text-blue-400 mt-2">Note: {item.notes}</p>
                  )}
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemove('tasks', item.task_id)}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        )

      case 'books':
        return (
          <div className="space-y-3">
            {content.books.map((item) => (
              <div key={item.id} className="flex items-start justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                <div className="flex items-center gap-3 flex-1">
                  {item.book?.cover_image_url && (
                    <img
                      src={item.book.cover_image_url}
                      alt={item.book.title}
                      className="w-12 h-16 object-cover rounded"
                    />
                  )}
                  <div className="flex-1">
                    <h4 className="font-medium">{item.book?.title}</h4>
                    <p className="text-sm text-gray-600 dark:text-gray-400">{item.book?.author}</p>
                    {(item.pages_from || item.pages_to) && (
                      <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Pages: {item.pages_from || '?'} - {item.pages_to || '?'}
                      </p>
                    )}
                    {item.notes && (
                      <p className="text-sm text-blue-600 dark:text-blue-400 mt-1">Note: {item.notes}</p>
                    )}
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemove('books', item.book_id)}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        )

      case 'vocabulary':
        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {content.vocabulary.map((item) => (
              <div key={item.id} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">
                <div className="flex-1">
                  <h4 className="font-medium">{item.vocabulary?.word}</h4>
                  {item.vocabulary?.translation && (
                    <p className="text-sm text-gray-600 dark:text-gray-400">{item.vocabulary.translation}</p>
                  )}
                  <div className="flex items-center gap-2 mt-1">
                    {item.vocabulary?.part_of_speech && (
                      <Badge variant="outline" size="sm">
                        {item.vocabulary.part_of_speech}
                      </Badge>
                    )}
                    {item.vocabulary?.difficulty && (
                      <Badge variant="secondary" size="sm">
                        {item.vocabulary.difficulty}
                      </Badge>
                    )}
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleRemove('vocabulary', item.vocabulary_id)}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        )

      default:
        return null
    }
  }

  // Render modal content based on type
  const renderModalContent = () => {
    const filteredItems = getFilteredItems()

    if (loadingModal) {
      return (
        <div className="flex justify-center py-8">
          <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
        </div>
      )
    }

    if (filteredItems.length === 0) {
      return (
        <p className="text-center py-8 text-gray-500 dark:text-gray-400">
          {searchQuery ? `No ${modalType} found matching your search.` : `No available ${modalType} to add.`}
        </p>
      )
    }

    switch (modalType) {
      case 'objectives':
        return (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredItems.map((item) => (
              <div
                key={item.id}
                className={`p-3 border rounded-lg cursor-pointer transition-all ${
                  selectedItems.includes(item.id)
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
                onClick={() => toggleItemSelection(item.id)}
              >
                <div className="flex items-start gap-3">
                  <input
                    type="checkbox"
                    checked={selectedItems.includes(item.id)}
                    onChange={() => {}}
                    className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    onClick={(e) => e.stopPropagation()}
                  />
                  <div className="flex-1">
                    <h5 className="font-medium">{item.title}</h5>
                    {item.description && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.description}</p>
                    )}
                    <div className="flex items-center gap-2 mt-2">
                      {item.bloom_level && (
                        <Badge variant="outline" size="sm">{item.bloom_level}</Badge>
                      )}
                      {item.category && (
                        <Badge variant="secondary" size="sm">{item.category}</Badge>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )

      case 'methods':
        return (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredItems.map((item) => (
              <div
                key={item.id}
                className={`p-3 border rounded-lg cursor-pointer transition-all ${
                  selectedItems.includes(item.id)
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
                onClick={() => toggleItemSelection(item.id)}
              >
                <div className="flex items-start gap-3">
                  <input
                    type="checkbox"
                    checked={selectedItems.includes(item.id)}
                    onChange={() => {}}
                    className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    onClick={(e) => e.stopPropagation()}
                  />
                  <div className="flex-1">
                    <h5 className="font-medium">{item.name}</h5>
                    {item.description && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.description}</p>
                    )}
                    <div className="flex items-center gap-3 mt-2 text-sm text-gray-500">
                      <span className="flex items-center gap-1">
                        <Clock className="h-3 w-3" />
                        {item.duration_minutes} min
                      </span>
                      {item.group_size_min && item.group_size_max && (
                        <span className="flex items-center gap-1">
                          <Users className="h-3 w-3" />
                          {item.group_size_min}-{item.group_size_max}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )

      case 'tasks':
        return (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredItems.map((item) => (
              <div
                key={item.id}
                className={`p-3 border rounded-lg cursor-pointer transition-all ${
                  selectedItems.includes(item.id)
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
                onClick={() => toggleItemSelection(item.id)}
              >
                <div className="flex items-start gap-3">
                  <input
                    type="checkbox"
                    checked={selectedItems.includes(item.id)}
                    onChange={() => {}}
                    className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    onClick={(e) => e.stopPropagation()}
                  />
                  <div className="flex-1">
                    <h5 className="font-medium">{item.title}</h5>
                    {item.description && (
                      <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.description}</p>
                    )}
                    <div className="flex items-center gap-3 mt-2">
                      <span className="text-sm text-gray-500">
                        <Clock className="h-3 w-3 inline mr-1" />
                        {item.duration_minutes} min
                      </span>
                      {item.difficulty && (
                        <Badge variant="outline" size="sm">{item.difficulty}</Badge>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )

      case 'books':
        return (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredItems.map((item) => (
              <div
                key={item.id}
                className={`p-3 border rounded-lg cursor-pointer transition-all ${
                  selectedItems.includes(item.id)
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
                onClick={() => toggleItemSelection(item.id)}
              >
                <div className="flex items-start gap-3">
                  <input
                    type="checkbox"
                    checked={selectedItems.includes(item.id)}
                    onChange={() => {}}
                    className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    onClick={(e) => e.stopPropagation()}
                  />
                  {item.cover_image_url && (
                    <img
                      src={item.cover_image_url}
                      alt={item.title}
                      className="w-12 h-16 object-cover rounded"
                    />
                  )}
                  <div className="flex-1">
                    <h5 className="font-medium">{item.title}</h5>
                    <p className="text-sm text-gray-600 dark:text-gray-400">{item.author}</p>
                    {item.isbn && (
                      <p className="text-xs text-gray-500 mt-1">ISBN: {item.isbn}</p>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )

      case 'vocabulary':
        return (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredItems.map((item) => (
              <div
                key={item.id}
                className={`p-3 border rounded-lg cursor-pointer transition-all ${
                  selectedItems.includes(item.id)
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
                onClick={() => toggleItemSelection(item.id)}
              >
                <div className="flex items-start gap-3">
                  <input
                    type="checkbox"
                    checked={selectedItems.includes(item.id)}
                    onChange={() => {}}
                    className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    onClick={(e) => e.stopPropagation()}
                  />
                  <div className="flex-1">
                    <h5 className="font-medium">{item.word}</h5>
                    {item.translation && (
                      <p className="text-sm text-gray-600 dark:text-gray-400">{item.translation}</p>
                    )}
                    <div className="flex items-center gap-2 mt-1">
                      {item.part_of_speech && (
                        <Badge variant="outline" size="sm">{item.part_of_speech}</Badge>
                      )}
                      {item.difficulty && (
                        <Badge variant="secondary" size="sm">{item.difficulty}</Badge>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )

      default:
        return null
    }
  }

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-medium">Lesson Content</h3>
        <Button 
          size="sm" 
          onClick={() => openAddModal(activeTab as keyof TabContent)}
          disabled={loading}
        >
          <Plus className="h-4 w-4 mr-2" />
          Add {activeTab.slice(0, -1)}
        </Button>
      </div>

      {/* <Tabs
        tabs={tabs.map(tab => ({
          ...tab,
          label: (
            <span className="flex items-center gap-2">
              {tab.icon}
              {tab.label}
              {tab.count > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {tab.count}
                </Badge>
              )}
            </span>
          )
        }))}
        activeTab={activeTab}
        onChange={setActiveTab}
      /> */}
      <Tabs value={activeTab} onValueChange={setActiveTab}> {/* */}
        <TabsList className="w-full justify-start overflow-x-auto"> {/* */}
          {tabs.map((tab) => (
            <TabsTrigger key={tab.key} value={tab.key}> {/* */}
              <span className="flex items-center gap-2"> {/* */}
                {tab.icon} {/* */}
                {tab.label} {/* */}
                {tab.count > 0 && ( /* */
                  <Badge variant="secondary" className="ml-1"> {/* */}
                    {tab.count} {/* */}
                  </Badge>
                )}
              </span>
            </TabsTrigger>
          ))}
        </TabsList>

        {tabs.map((tab) => (
          <TabsContent key={tab.key} value={tab.key}>
            {renderContent()}
          </TabsContent>
        ))}
      </Tabs>


      {/* Add Content Modal */}
      <Modal
        isOpen={modalOpen}
        onClose={() => setModalOpen(false)}
        title={`Add ${modalType.charAt(0).toUpperCase() + modalType.slice(1)} to Lesson`}
        size="lg"
      >
        <div className="space-y-4">
          <SearchBox
            value={searchQuery}
            onSearch={setSearchQuery}
            placeholder={`Search ${modalType}...`}
          />

          {renderModalContent()}

          <div className="flex justify-between items-center border-t pt-4">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              {selectedItems.length} {modalType.slice(0, -1)}{selectedItems.length !== 1 ? 's' : ''} selected
            </p>
            <div className="flex gap-2">
              <Button variant="outline" onClick={() => setModalOpen(false)}>
                Cancel
              </Button>
              <Button
                onClick={handleAddItems}
                disabled={selectedItems.length === 0 || savingItems}
                loading={savingItems}
              >
                Add {modalType}
              </Button>
            </div>
          </div>
        </div>
      </Modal>
    </div>
  )
}

================
File: src/components/schedules/LessonDetailModal.tsx
================
'use client';

import React from 'react';
import { Modal, Button, Badge } from '@/components/ui';
import { Lesson } from '@/types/schedule';
import { Clock, Info, Book, Edit } from 'lucide-react';

interface LessonDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  lesson: Lesson | null;
  onEdit: (lesson: Lesson) => void;
}

export function LessonDetailModal({ isOpen, onClose, lesson, onEdit }: LessonDetailModalProps) {
  if (!lesson) return null;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={lesson.title} size="lg">
      <div className="space-y-4">
        <div>
          <h3 className="font-medium text-gray-800">Lesson Details</h3>
          <p className="mt-2 text-sm text-gray-600">{lesson.description || 'No description provided.'}</p>
        </div>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div className="flex items-start gap-3">
                <Clock className="h-4 w-4 text-gray-400 mt-0.5"/>
                <div>
                    <p className="font-medium text-gray-500">Time</p>
                    <p>{new Date(lesson.date).toLocaleDateString()} at {lesson.start_time} - {lesson.end_time}</p>
                </div>
            </div>
            <div className="flex items-start gap-3">
                <Info className="h-4 w-4 text-gray-400 mt-0.5"/>
                <div>
                    <p className="font-medium text-gray-500">Status</p>
                    <Badge variant={lesson.status === 'completed' ? 'success' : 'default'} size="sm">{lesson.status}</Badge>
                </div>
            </div>
        </div>

        {lesson.notes && (
             <div className="pt-2">
                <h4 className="font-medium text-gray-800">Teaching Notes</h4>
                <p className="mt-1 text-sm text-gray-600 whitespace-pre-wrap">{lesson.notes}</p>
            </div>
        )}

        {lesson.homework && (
            <div className="pt-2">
                <h4 className="font-medium text-gray-800">Homework</h4>
                <p className="mt-1 text-sm text-gray-600 whitespace-pre-wrap">{lesson.homework}</p>
            </div>
        )}
      </div>
      <div className="mt-6 flex justify-end gap-3">
        <Button variant="outline" onClick={onClose}>Close</Button>
        <Button onClick={() => onEdit(lesson)} leftIcon={<Edit className="h-4 w-4"/>}>Edit Lesson</Button>
      </div>
    </Modal>
  );
}

================
File: src/components/schedules/LessonForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Textarea } from '@/components/ui/Textarea';
import { Select } from '@/components/ui/Select';
import { Badge } from '@/components/ui/Badge';
import { useAuth } from '@/contexts/AuthContext';
import { scheduleService } from '@/lib/services/schedule-service';
import type { Lesson, Schedule } from '@/types/schedule';
import type { LessonStatus } from '@/types/database';
import { Plus, X } from 'lucide-react';

interface LessonFormProps {
  scheduleId?: string;
  lesson?: Lesson | null;
  onSuccess?: () => void;
}

const LESSON_STATUS_OPTIONS: { value: LessonStatus; label: string }[] = [
  { value: 'draft', label: 'Draft' },
  { value: 'scheduled', label: 'Scheduled' },
  { value: 'completed', label: 'Completed' },
  { value: 'cancelled', label: 'Cancelled' },
];

const initialFormData = {
    schedule_id: '',
    title: '',
    description: '',
    date: new Date().toISOString().split('T')[0],
    start_time: '09:00',
    end_time: '10:00',
    duration_minutes: 60,
    location: '',
    status: 'scheduled' as LessonStatus,
    notes: '',
    homework: '',
    resources: [] as string[],
};

export function LessonForm({ scheduleId, lesson, onSuccess }: LessonFormProps) {
  const router = useRouter();
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [formData, setFormData] = useState(initialFormData);
  
  const [newResource, setNewResource] = useState('');

  const isEditing = !!(lesson && lesson.id);

  useEffect(() => {
    loadSchedules();
  }, []);

  // *** THIS IS THE CORE FIX ***
  // This useEffect now reliably populates the form when a lesson is passed for editing.
  useEffect(() => {
    if (lesson && isEditing) {
      setFormData({
        schedule_id: lesson.schedule_id,
        title: lesson.title || '',
        description: lesson.description || '',
        date: lesson.date,
        start_time: lesson.start_time,
        end_time: lesson.end_time,
        duration_minutes: lesson.duration_minutes,
        location: lesson.location || '',
        status: lesson.status,
        notes: lesson.notes || '',
        homework: lesson.homework || '',
        resources: lesson.resources || [],
      });
    } else {
      setFormData({ ...initialFormData, schedule_id: scheduleId || '' });
    }
  }, [lesson]);

  const loadSchedules = async () => {
    if (user) {
      try {
        const data = await scheduleService.getSchedules({ user_id: user.id });
        setSchedules(data || []);
      } catch (error) {
        console.error('Error loading schedules:', error);
      }
    }
  };

  const calculateEndTime = (startTime: string, duration: number) => {
    if(!startTime || !duration) return;
    const [hours, minutes] = startTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(hours, minutes, 0, 0);
    startDate.setMinutes(startDate.getMinutes() + duration);
    
    const endTime = startDate.toTimeString().slice(0, 5);
    setFormData(prev => ({ ...prev, end_time: endTime }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;
    setLoading(true);
    try {
      const lessonData = { ...formData, user_id: user.id };

      if (isEditing) {
        if (!lesson) throw new Error("Lesson to update is missing.");
        await scheduleService.updateLesson(lesson.id, lessonData);
      } else {
        await scheduleService.createLesson(lessonData);
      }

      if (onSuccess) {
        onSuccess();
      }
    } catch (error: any) {
      console.error('Error saving lesson:', error);
      alert('Error saving lesson. Please try again.');
    } finally {
      setLoading(false);
    }
  };
  
  // ... (Other handlers like handleStartTimeChange remain the same)
  const handleStartTimeChange = (value: string) => { setFormData(prev => ({ ...prev, start_time: value })); calculateEndTime(value, formData.duration_minutes); };
  const handleDurationChange = (value: number) => { setFormData(prev => ({ ...prev, duration_minutes: value })); calculateEndTime(formData.start_time, value); };
  const handleAddResource = () => { if (newResource.trim()) { setFormData(prev => ({ ...prev, resources: [...(prev.resources || []), newResource.trim()] })); setNewResource(''); } };
  const handleRemoveResource = (index: number) => { setFormData(prev => ({ ...prev, resources: (prev.resources || []).filter((_, i) => i !== index) })); };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="col-span-2">
            <Select
                label="Schedule"
                value={formData.schedule_id}
                onChange={(e) => setFormData({ ...formData, schedule_id: e.target.value })}
                required
                disabled={isEditing}
                options={schedules.map(s => ({ value: s.id, label: s.name }))}
            />
        </div>

        <div className="col-span-2"><Input label="Lesson Title" value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} required /></div>
        <div className="col-span-2"><Textarea label="Description" value={formData.description || ''} onChange={(e) => setFormData({ ...formData, description: e.target.value })} rows={3} /></div>
        <div><Input type="date" label="Date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} required /></div>
        <div><Select label="Status" value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value as any })} options={LESSON_STATUS_OPTIONS} /></div>
        <div><Input type="time" label="Start Time" value={formData.start_time} onChange={(e) => handleStartTimeChange(e.target.value)} required /></div>
        <div><Input type="number" label="Duration (minutes)" value={formData.duration_minutes} onChange={(e) => handleDurationChange(parseInt(e.target.value))} required /></div>
        <div><Input type="time" label="End Time" value={formData.end_time} readOnly disabled helperText="Auto-calculated" /></div>
        <div><Input label="Location" value={formData.location || ''} onChange={(e) => setFormData({ ...formData, location: e.target.value })} /></div>
        <div className="col-span-2"><Textarea label="Teaching Notes" value={formData.notes || ''} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} rows={3} /></div>
        <div className="col-span-2"><Textarea label="Homework Assignment" value={formData.homework || ''} onChange={(e) => setFormData({ ...formData, homework: e.target.value })} rows={3} /></div>
        <div className="col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">Resources & Links</label>
          <div className="space-y-2">
            <div className="flex gap-2"><Input value={newResource} onChange={(e) => setNewResource(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddResource())} /><Button type="button" onClick={handleAddResource} size="sm"><Plus className="h-4 w-4"/></Button></div>
            <div className="flex flex-wrap gap-2">
              {(formData.resources || []).map((resource, index) => (
                <Badge key={index} variant="secondary" className="flex items-center gap-1">
                  {resource}
                  <button type="button" onClick={() => handleRemoveResource(index)} className="ml-1 text-gray-500 hover:text-gray-700"><X className="h-3 w-3" /></button>
                </Badge>
              ))}
            </div>
          </div>
        </div>
      </div>
      <div className="flex justify-end space-x-4 mt-6">
        <Button type="button" variant="outline" onClick={onSuccess || (() => router.back())}>Cancel</Button>
        <Button type="submit" loading={loading}>{isEditing ? 'Update Lesson' : 'Create Lesson'}</Button>
      </div>
    </form>
  );
}

================
File: src/components/schedules/ScheduleCalendar.tsx
================
'use client';

import React from 'react';
import { Calendar, dateFnsLocalizer, Views, Event } from 'react-big-calendar';
import {format} from 'date-fns/format';
import {parse} from 'date-fns/parse';
import {startOfWeek} from 'date-fns/startOfWeek';
import {getDay} from 'date-fns/getDay';
import {enUS} from 'date-fns/locale/en-US';
import 'react-big-calendar/lib/css/react-big-calendar.css';
import { scheduleService } from '@/lib/services/schedule-service';
import { Schedule, Lesson } from '@/types/schedule';

const locales = {
  'en-US': enUS,
};

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales,
});

interface ScheduleCalendarProps {
  schedule: Schedule;
  // This new prop will handle the click event
  onSelectLesson: (lesson: Lesson) => void;
}

export function ScheduleCalendar({ schedule, onSelectLesson }: ScheduleCalendarProps) {
  const [currentDate, setCurrentDate] = React.useState(new Date());
  const [currentView, setCurrentView] = React.useState(Views.MONTH);

  if (!schedule.lessons) {
    return <div className="p-8 text-center text-gray-500">No lessons to display in calendar.</div>;
  }
  
  const events = scheduleService.transformToCalendarEvents(schedule.lessons);

  const handleEventSelect = (event: Event) => {
    // The lesson data is stored in the event's resource property
    if (event.resource) {
      onSelectLesson(event.resource.lesson as Lesson);
    }
  };

  const handleNavigate = (date: Date) => {
    setCurrentDate(date);
  };

  const handleViewChange = (view: any) => {
    setCurrentView(view);
  };

  return (
    <div className="h-[600px]">
      <Calendar
        localizer={localizer}
        events={events}
        startAccessor="start"
        endAccessor="end"
        style={{ height: '100%' }}
        views={[Views.MONTH, Views.WEEK, Views.DAY]}
        view={currentView}
        date={currentDate}
        onNavigate={handleNavigate}
        onView={handleViewChange}
        popup
        onSelectEvent={handleEventSelect}
        tooltipAccessor={(event: any) => event.resource?.description || event.title}
      />
    </div>
  );
}

================
File: src/components/schedules/ScheduleForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Textarea } from '@/components/ui/Textarea';
import { Select } from '@/components/ui/Select';
import { useAuth } from '@/contexts/AuthContext';
import { scheduleService } from '@/lib/services/schedule-service';
import { courseService } from '@/lib/supabase/courses';
import type { Schedule, RecurrenceType, DayOfWeek } from '@/types/schedule';
import type { Course } from '@/types/database';
import { Save } from 'lucide-react';

interface ScheduleFormProps {
  schedule?: Schedule;
  onSuccess?: () => void;
}

const RECURRENCE_TYPES: { value: RecurrenceType; label: string }[] = [
  { value: 'none', label: 'No Recurrence (One-time)' },
  { value: 'daily', label: 'Daily' },
  { value: 'weekly', label: 'Weekly' },
  { value: 'biweekly', label: 'Bi-weekly' },
  { value: 'monthly', label: 'Monthly' },
];

const DAYS_OF_WEEK: { value: DayOfWeek; label: string }[] = [
  { value: 'monday', label: 'Monday' },
  { value: 'tuesday', label: 'Tuesday' },
  { value: 'wednesday', label: 'Wednesday' },
  { value: 'thursday', label: 'Thursday' },
  { value: 'friday', label: 'Friday' },
  { value: 'saturday', label: 'Saturday' },
  { value: 'sunday', label: 'Sunday' },
];

const TIMEZONES = [
  { value: 'UTC', label: 'UTC' },
  { value: 'America/New_York', label: 'Eastern Time (US)' },
  { value: 'America/Chicago', label: 'Central Time (US)' },
  { value: 'America/Denver', label: 'Mountain Time (US)' },
  { value: 'America/Los_Angeles', label: 'Pacific Time (US)' },
  { value: 'Europe/London', label: 'London' },
  { value: 'Europe/Paris', label: 'Paris' },
  { value: 'Asia/Tokyo', label: 'Tokyo' },
  { value: 'Asia/Shanghai', label: 'Shanghai' },
  { value: 'Australia/Sydney', label: 'Sydney' },
];

export function ScheduleForm({ schedule, onSuccess }: ScheduleFormProps) {
  const router = useRouter();
  const { user } = useAuth();
  const isEditing = !!schedule;
  const [loading, setLoading] = useState(false);
  const [courses, setCourses] = useState<Course[]>([]);
  const [formData, setFormData] = useState({
    course_id: schedule?.course_id || '',
    name: schedule?.name || '',
    description: schedule?.description || '',
    start_date: schedule?.start_date || new Date().toISOString().split('T')[0],
    end_date: schedule?.end_date || '',
    recurrence_type: schedule?.recurrence_type || 'weekly' as RecurrenceType,
    recurrence_days: schedule?.recurrence_days || ['monday', 'wednesday', 'friday'] as DayOfWeek[],
    default_start_time: schedule?.default_start_time || '09:00',
    default_duration_minutes: schedule?.default_duration_minutes || 60,
    timezone: schedule?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
    location: schedule?.location || '',
    max_students: schedule?.max_students || 20,
    is_active: schedule?.is_active !== false,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  useEffect(() => {
    loadCourses();
  }, []);

  const loadCourses = async () => {
    try {
      const data = await courseService.getCourses({});
      setCourses(data);
    } catch (error) {
      console.error('Failed to load courses:', error);
    }
  };
  
  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    if (!formData.name.trim()) newErrors.name = 'Schedule name is required';
    if (!formData.course_id) newErrors.course_id = 'A course must be selected';
    if (!formData.start_date) newErrors.start_date = 'Start date is required';
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm() || !user) return;

    setLoading(true);
    try {
      const scheduleData = {
        ...formData,
        user_id: user.id,
        // Explicitly set max_students to number | undefined to match Partial<Schedule>
        max_students: formData.max_students === null ? undefined : formData.max_students,
        default_duration_minutes: formData.default_duration_minutes,
      };

      if (isEditing) {
        await scheduleService.updateSchedule(schedule!.id, scheduleData);
      } else {
        await scheduleService.createSchedule(scheduleData);
      }

      if (onSuccess) {
        onSuccess();
      } else {
        router.push('/schedules');
        router.refresh();
      }
    } catch (error: any) {
      console.error('Failed to save schedule:', error);
      setErrors({ submit: error.message || 'Failed to save schedule. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  const handleDayToggle = (day: DayOfWeek) => {
    setFormData(prev => ({
      ...prev,
      recurrence_days: prev.recurrence_days.includes(day)
        ? prev.recurrence_days.filter(d => d !== day)
        : [...prev.recurrence_days, day]
    }));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
       {errors.submit && (
        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {errors.submit}
        </div>
      )}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="col-span-2">
          <Select
            label="Course"
            value={formData.course_id}
            onChange={(e) => setFormData({ ...formData, course_id: e.target.value })}
            required
            error={errors.course_id}
            options={courses.map(c => ({ value: c.id, label: c.title }))}
            placeholder="Select a course..."
          />
        </div>
        <div className="col-span-2">
          <Input
            label="Schedule Name"
            value={formData.name}
            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
            placeholder="e.g., Morning Classes, Evening Sessions"
            required
            error={errors.name}
          />
        </div>
        <div className="col-span-2">
          <Textarea
            label="Description"
            value={formData.description || ''}
            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
            placeholder="Describe this schedule..."
            rows={3}
          />
        </div>
        <div>
          <Input
            type="date"
            label="Start Date"
            value={formData.start_date}
            onChange={(e) => setFormData({ ...formData, start_date: e.target.value })}
            required
            error={errors.start_date}
          />
        </div>
        <div>
          <Input
            type="date"
            label="End Date (Optional)"
            value={formData.end_date}
            onChange={(e) => setFormData({ ...formData, end_date: e.target.value })}
            helperText="Leave empty for ongoing schedule"
          />
        </div>
        <div>
          <Select
            label="Recurrence"
            value={formData.recurrence_type}
            onChange={(e) => setFormData({ ...formData, recurrence_type: e.target.value as RecurrenceType })}
            options={RECURRENCE_TYPES}
          />
        </div>
        {formData.recurrence_type !== 'none' && (
          <div className="col-span-2">
            <label className="block text-sm font-medium text-gray-700 mb-2">Class Days</label>
            <div className="flex flex-wrap gap-2">
              {DAYS_OF_WEEK.map((day) => (
                <button
                  key={day.value}
                  type="button"
                  onClick={() => handleDayToggle(day.value)}
                  className={`px-4 py-2 rounded-md transition-colors ${
                    formData.recurrence_days?.includes(day.value)
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  {day.label}
                </button>
              ))}
            </div>
          </div>
        )}
        <div>
          <Input
            type="time"
            label="Default Start Time"
            value={formData.default_start_time}
            onChange={(e) => setFormData({ ...formData, default_start_time: e.target.value })}
            required
          />
        </div>
        <div>
          <Input
            type="number"
            label="Duration (minutes)"
            value={formData.default_duration_minutes}
            onChange={(e) => setFormData({ ...formData, default_duration_minutes: parseInt(e.target.value) })}
            min="15"
            max="480"
            required
          />
        </div>
        <div>
          <Select
            label="Timezone"
            value={formData.timezone}
            onChange={(e) => setFormData({ ...formData, timezone: e.target.value })}
            options={TIMEZONES}
          />
        </div>
        <div>
          <Input
            label="Location"
            value={formData.location}
            onChange={(e) => setFormData({ ...formData, location: e.target.value })}
            placeholder="e.g., Room 101, Online, etc."
          />
        </div>
        <div>
          <Input
            type="number"
            label="Maximum Students"
            value={formData.max_students}
            onChange={(e) => setFormData({ ...formData, max_students: parseInt(e.target.value) })}
            min="1"
            max="1000"
          />
        </div>
        <div className="flex items-center">
          <label className="flex items-center cursor-pointer">
            <input
              type="checkbox"
              checked={formData.is_active}
              onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}
              className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            />
            <span className="text-sm font-medium text-gray-700">Active Schedule</span>
          </label>
        </div>
      </div>
      <div className="flex justify-end space-x-4 mt-6">
        <Button type="button" variant="outline" onClick={() => router.push('/schedules')}>Cancel</Button>
        <Button type="submit" loading={loading} leftIcon={<Save className="h-4 w-4" />}>
          {isEditing ? 'Update Schedule' : 'Create Schedule'}
        </Button>
      </div>
    </form>
  );
}

================
File: src/components/ui/Badge.tsx
================
'use client';

import React from 'react';
import { cn } from '@/lib/utils';

export interface BadgeProps extends React.HTMLAttributes<HTMLSpanElement> {
  variant?: 'default' | 'primary' | 'secondary' | 'success' | 'warning' | 'danger' | 'info' | 'outline';
  size?: 'sm' | 'md' | 'lg';
  rounded?: boolean;
  dot?: boolean;
}

const variantClasses = {
  default: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
  primary: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
  secondary: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300',
  success: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
  warning: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
  danger: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
  info: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-300',
  outline: 'bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800',
};

const sizeClasses = {
  sm: 'px-2 py-0.5 text-xs',
  md: 'px-2.5 py-0.5 text-sm',
  lg: 'px-3 py-1 text-base',
};

const dotSizeClasses = {
  sm: 'h-1.5 w-1.5',
  md: 'h-2 w-2',
  lg: 'h-2.5 w-2.5',
};

export const Badge: React.FC<BadgeProps> = ({
  variant = 'default',
  size = 'md',
  rounded = false,
  dot = false,
  className,
  children,
  ...props
}) => {
  return (
    <span
      className={cn(
        'inline-flex items-center font-medium',
        rounded ? 'rounded-full' : 'rounded',
        variantClasses[variant],
        sizeClasses[size],
        className
      )}
      {...props}
    >
      {dot && (
        <span
          className={cn(
            'rounded-full bg-current opacity-75 mr-1.5',
            dotSizeClasses[size]
          )}
        />
      )}
      {children}
    </span>
  );
};

Badge.displayName = 'Badge';

================
File: src/components/ui/Button.tsx
================
import { cn } from '@/lib/utils';
import { ButtonProps } from '@/types';
import { cva, type VariantProps } from 'class-variance-authority';
import { forwardRef } from 'react';

const buttonVariants = cva(
  'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background',
  {
    variants: {
      variant: {
        primary: 'bg-primary-600 text-white hover:bg-primary-700',
        secondary: 'bg-gray-600 text-white hover:bg-gray-700',
        outline: 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50',
        ghost: 'text-gray-700 hover:bg-gray-100',
        danger: 'bg-red-600 text-white hover:bg-red-700',
      },
      size: {
        sm: 'h-8 px-3 text-xs',
        md: 'h-10 px-4 py-2',
        lg: 'h-12 px-6 text-lg',
      },
    },
    defaultVariants: {
      variant: 'primary',
      size: 'md',
    },
  }
);

export interface ButtonComponentProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  loading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  fullWidth?: boolean;
}

const Button = forwardRef<HTMLButtonElement, ButtonComponentProps>(
  ({ className, variant, size, loading, children, disabled, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        disabled={disabled || loading}
        {...props}
      >
        {loading && (
          <svg
            className="animate-spin -ml-1 mr-2 h-4 w-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            ></circle>
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        )}
        {children}
      </button>
    );
  }
);

Button.displayName = 'Button';

export { Button, buttonVariants };

================
File: src/components/ui/Card.tsx
================
// File: src/components/ui/Card.tsx

import { cn } from '@/lib/utils'; 
import { forwardRef } from 'react'; 

interface CardProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode; 
}

// 1. Define the main Card component as before
const CardComponent = forwardRef<HTMLDivElement, CardProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          'bg-white overflow-hidden shadow rounded-lg border border-gray-200',
          className
        )}
        {...props}
      >
        {children}
      </div>
    );
  }
);
CardComponent.displayName = 'Card'; 

// 2. Define sub-components as before
const Header = forwardRef<HTMLDivElement, CardProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn('px-6 py-4 border-b border-gray-200', className)}
        {...props}
      >
        {children}
      </div>
    );
  }
);
Header.displayName = 'Header'; 

const Title = forwardRef<HTMLHeadingElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, children, ...props }, ref) => {
    return (
      <h3
        ref={ref}
        className={cn('text-lg font-medium text-gray-900', className)}
        {...props}
      >
        {children}
      </h3>
    );
  }
);
Title.displayName = 'Title'; 

const Content = forwardRef<HTMLDivElement, CardProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <div ref={ref} className={cn('px-6 py-4', className)} {...props}>
        {children}
      </div>
    );
  }
);
Content.displayName = 'Content'; 

const Footer = forwardRef<HTMLDivElement, CardProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn('px-6 py-4 bg-gray-50 border-t border-gray-200', className)}
        {...props}
      >
        {children}
      </div>
    );
  }
);
Footer.displayName = 'Footer'; 

// 3. Combine them into a single object for export
export const Card = Object.assign(CardComponent, {
  Header,
  Title,
  Content,
  Footer,
});

================
File: src/components/ui/FilterPanel.tsx
================
'use client';

import React, { useState } from 'react';
import { ChevronDown, ChevronUp, Filter, X } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from './Button';

export interface FilterOption {
  value: string;
  label: string;
  count?: number;
}

export interface FilterGroup {
  id: string;
  label: string;
  type: 'checkbox' | 'radio' | 'range' | 'select';
  options?: FilterOption[];
  min?: number;
  max?: number;
  step?: number;
  value?: string | string[] | [number, number];
}

export interface FilterPanelProps {
  filters: FilterGroup[];
  values: Record<string, any>;
  onChange: (filterId: string, value: any) => void;
  onReset?: () => void;
  onApply?: () => void;
  className?: string;
  collapsible?: boolean;
  defaultCollapsed?: boolean;
  showApplyButton?: boolean;
  showResetButton?: boolean;
  title?: string;
}

export const FilterPanel: React.FC<FilterPanelProps> = ({
  filters,
  values,
  onChange,
  onReset,
  onApply,
  className,
  collapsible = true,
  defaultCollapsed = false,
  showApplyButton = false,
  showResetButton = true,
  title = 'Filters',
}) => {
  const [collapsed, setCollapsed] = useState(defaultCollapsed);
  const [expandedGroups, setExpandedGroups] = useState<Record<string, boolean>>({});

  const toggleGroup = (groupId: string) => {
    setExpandedGroups((prev) => ({
      ...prev,
      [groupId]: !prev[groupId],
    }));
  };

  const handleCheckboxChange = (filterId: string, option: string, checked: boolean) => {
    const currentValues = (values[filterId] as string[]) || [];
    const newValues = checked
      ? [...currentValues, option]
      : currentValues.filter((v) => v !== option);
    onChange(filterId, newValues);
  };

  const handleRadioChange = (filterId: string, value: string) => {
    onChange(filterId, value);
  };

  const handleRangeChange = (filterId: string, index: number, value: number) => {
    const currentValues = (values[filterId] as [number, number]) || [0, 100];
    const newValues: [number, number] = [...currentValues] as [number, number];
    newValues[index] = value;
    onChange(filterId, newValues);
  };

  const hasActiveFilters = Object.values(values).some((value) => {
    if (Array.isArray(value)) return value.length > 0;
    if (typeof value === 'string') return value !== '';
    return false;
  });

  const renderFilterGroup = (filter: FilterGroup) => {
    const isExpanded = expandedGroups[filter.id] !== false;

    return (
      <div key={filter.id} className="border-b border-gray-200 dark:border-gray-700">
        <button
          type="button"
          onClick={() => toggleGroup(filter.id)}
          className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
        >
          <span className="text-sm font-medium text-gray-900 dark:text-gray-100">
            {filter.label}
          </span>
          {isExpanded ? (
            <ChevronUp className="h-4 w-4 text-gray-500" />
          ) : (
            <ChevronDown className="h-4 w-4 text-gray-500" />
          )}
        </button>

        {isExpanded && (
          <div className="px-4 pb-3">
            {filter.type === 'checkbox' && filter.options && (
              <div className="space-y-2">
                {filter.options.map((option) => (
                  <label
                    key={option.value}
                    className="flex items-center text-sm cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      checked={(values[filter.id] as string[] || []).includes(option.value)}
                      onChange={(e) =>
                        handleCheckboxChange(filter.id, option.value, e.target.checked)
                      }
                      className="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <span className="ml-2 text-gray-700 dark:text-gray-300">
                      {option.label}
                      {option.count !== undefined && (
                        <span className="ml-1 text-gray-500">({option.count})</span>
                      )}
                    </span>
                  </label>
                ))}
              </div>
            )}

            {filter.type === 'radio' && filter.options && (
              <div className="space-y-2">
                {filter.options.map((option) => (
                  <label
                    key={option.value}
                    className="flex items-center text-sm cursor-pointer"
                  >
                    <input
                      type="radio"
                      name={filter.id}
                      value={option.value}
                      checked={values[filter.id] === option.value}
                      onChange={() => handleRadioChange(filter.id, option.value)}
                      className="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                    />
                    <span className="ml-2 text-gray-700 dark:text-gray-300">
                      {option.label}
                    </span>
                  </label>
                ))}
              </div>
            )}

            {filter.type === 'range' && filter.min !== undefined && filter.max !== undefined && (
              <div className="space-y-2">
                <div className="flex items-center space-x-2">
                  <input
                    type="number"
                    min={filter.min}
                    max={filter.max}
                    step={filter.step}
                    value={(values[filter.id] as [number, number])?.[0] || filter.min}
                    onChange={(e) =>
                      handleRangeChange(filter.id, 0, Number(e.target.value))
                    }
                    className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
                  />
                  <span className="text-gray-500">to</span>
                  <input
                    type="number"
                    min={filter.min}
                    max={filter.max}
                    step={filter.step}
                    value={(values[filter.id] as [number, number])?.[1] || filter.max}
                    onChange={(e) =>
                      handleRangeChange(filter.id, 1, Number(e.target.value))
                    }
                    className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>
            )}

            {filter.type === 'select' && filter.options && (
              <select
                value={values[filter.id] || ''}
                onChange={(e) => onChange(filter.id, e.target.value)}
                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">All</option>
                {filter.options.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            )}
          </div>
        )}
      </div>
    );
  };

  const content = (
    <>
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center space-x-2">
          <Filter className="h-5 w-5 text-gray-500" />
          <h3 className="text-base font-medium text-gray-900 dark:text-gray-100">{title}</h3>
          {hasActiveFilters && (
            <span className="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
              Active
            </span>
          )}
        </div>
        {collapsible && (
          <button
            type="button"
            onClick={() => setCollapsed(!collapsed)}
            className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
          >
            {collapsed ? (
              <ChevronDown className="h-4 w-4 text-gray-500" />
            ) : (
              <ChevronUp className="h-4 w-4 text-gray-500" />
            )}
          </button>
        )}
      </div>

      {!collapsed && (
        <>
          <div className="max-h-96 overflow-y-auto">
            {filters.map(renderFilterGroup)}
          </div>

          {(showResetButton || showApplyButton) && (
            <div className="px-4 py-3 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
              {showResetButton && (
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={onReset}
                  disabled={!hasActiveFilters}
                >
                  <X className="h-4 w-4 mr-1" />
                  Reset
                </Button>
              )}
              {showApplyButton && (
                <Button
                  type="button"
                  size="sm"
                  onClick={onApply}
                  className="ml-auto"
                >
                  Apply Filters
                </Button>
              )}
            </div>
          )}
        </>
      )}
    </>
  );

  return (
    <div
      className={cn(
        'bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700',
        className
      )}
    >
      {content}
    </div>
  );
};

FilterPanel.displayName = 'FilterPanel';

================
File: src/components/ui/index.ts
================
// UI Components
export * from './Button';
export * from './Card';
export * from './Input';
export * from './Textarea';
export * from './Modal';
export * from './Select';
export * from './Table';
export * from './SearchBox';
export * from './FilterPanel';
export * from './Badge';
export * from './Spinner';
export * from './Pagination';
export * from './Tabs';

================
File: src/components/ui/Input.tsx
================
import { cn } from '@/lib/utils';
import { forwardRef } from 'react';

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, label, error, helperText, id, ...props }, ref) => {
    const inputId = id || `input-${Math.random().toString(36).substr(2, 9)}`;

    return (
      <div className="space-y-1">
        {label && (
          <label 
            htmlFor={inputId} 
            className="block text-sm font-medium text-gray-700"
          >
            {label}
            {props.required && <span className="text-red-500 ml-1">*</span>}
          </label>
        )}
        <input
          type={type}
          id={inputId}
          className={cn(
            'block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm',
            error && 'border-red-300 focus:border-red-500 focus:ring-red-500',
            props.disabled && 'bg-gray-50 text-gray-500 cursor-not-allowed',
            className
          )}
          ref={ref}
          {...props}
        />
        {error && (
          <p className="text-sm text-red-600" id={`${inputId}-error`}>
            {error}
          </p>
        )}
        {helperText && !error && (
          <p className="text-sm text-gray-500" id={`${inputId}-helper`}>
            {helperText}
          </p>
        )}
      </div>
    );
  }
);

Input.displayName = 'Input';

export { Input };

================
File: src/components/ui/Modal.tsx
================
'use client';

import React, { useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils';

export interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
  closeOnOverlayClick?: boolean;
  closeOnEsc?: boolean;
  showCloseButton?: boolean;
  className?: string;
  overlayClassName?: string;
}

const sizeClasses = {
  sm: 'max-w-md',
  md: 'max-w-lg',
  lg: 'max-w-2xl',
  xl: 'max-w-4xl',
  full: 'max-w-full mx-4',
};

export const Modal: React.FC<ModalProps> = ({
  isOpen,
  onClose,
  title,
  children,
  size = 'md',
  closeOnOverlayClick = true,
  closeOnEsc = true,
  showCloseButton = true,
  className,
  overlayClassName,
}) => {
  const modalRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (closeOnEsc && e.key === 'Escape') {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEsc);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEsc);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose, closeOnEsc]);

  useEffect(() => {
    if (isOpen && modalRef.current) {
      modalRef.current.focus();
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const modalContent = (
    <div
      className={cn(
        'fixed inset-0 z-50 flex items-center justify-center',
        overlayClassName
      )}
    >
      {/* Overlay */}
      <div
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={closeOnOverlayClick ? onClose : undefined}
        aria-hidden="true"
      />

      {/* Modal */}
      <div
        ref={modalRef}
        role="dialog"
        aria-modal="true"
        aria-labelledby={title ? 'modal-title' : undefined}
        tabIndex={-1}
        className={cn(
          'relative bg-white dark:bg-gray-800 rounded-lg shadow-xl',
          'w-full p-6',
          'max-h-[90vh] overflow-auto',
          'focus:outline-none',
          sizeClasses[size],
          className
        )}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        {(title || showCloseButton) && (
          <div className="flex items-center justify-between mb-4">
            {title && (
              <h2
                id="modal-title"
                className="text-lg font-semibold text-gray-900 dark:text-gray-100"
              >
                {title}
              </h2>
            )}
            {showCloseButton && (
              <button
                type="button"
                onClick={onClose}
                className="ml-auto p-1.5 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Close modal"
              >
                <X className="h-5 w-5" />
              </button>
            )}
          </div>
        )}

        {/* Content */}
        <div className="text-gray-700 dark:text-gray-300">{children}</div>
      </div>
    </div>
  );

  // Use portal to render modal at document root
  if (typeof window !== 'undefined') {
    return createPortal(modalContent, document.body);
  }

  return null;
};

Modal.displayName = 'Modal';

================
File: src/components/ui/Pagination.tsx
================
'use client';

import React from 'react';
import { ChevronLeft, ChevronRight, MoreHorizontal } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from './Button';

export interface PaginationProps {
  currentPage: number;
  totalPages: number;
  onPageChange: (page: number) => void;
  showFirstLast?: boolean;
  maxVisible?: number;
  className?: string;
}

export const Pagination: React.FC<PaginationProps> = ({
  currentPage,
  totalPages,
  onPageChange,
  showFirstLast = true,
  maxVisible = 7,
  className,
}) => {
  const generatePageNumbers = () => {
    const pages: (number | string)[] = [];
    
    if (totalPages <= maxVisible) {
      // Show all pages if total pages is less than max visible
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      // Always show first page
      pages.push(1);
      
      if (currentPage <= 3) {
        // Near the beginning
        for (let i = 2; i <= Math.min(maxVisible - 2, totalPages - 1); i++) {
          pages.push(i);
        }
        pages.push('...');
        pages.push(totalPages);
      } else if (currentPage >= totalPages - 2) {
        // Near the end
        pages.push('...');
        for (let i = Math.max(totalPages - maxVisible + 3, 2); i <= totalPages; i++) {
          pages.push(i);
        }
      } else {
        // In the middle
        pages.push('...');
        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
          pages.push(i);
        }
        pages.push('...');
        pages.push(totalPages);
      }
    }
    
    return pages;
  };

  const pageNumbers = generatePageNumbers();

  return (
    <nav
      className={cn('flex items-center justify-center space-x-1', className)}
      aria-label="Pagination"
    >
      {showFirstLast && (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onPageChange(1)}
          disabled={currentPage === 1}
          aria-label="Go to first page"
        >
          First
        </Button>
      )}
      
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onPageChange(currentPage - 1)}
        disabled={currentPage === 1}
        aria-label="Go to previous page"
      >
        <ChevronLeft className="h-4 w-4" />
      </Button>
      
      <div className="flex items-center space-x-1">
        {pageNumbers.map((page, index) => {
          if (page === '...') {
            return (
              <span
                key={`ellipsis-${index}`}
                className="px-3 py-1 text-gray-400"
              >
                <MoreHorizontal className="h-4 w-4" />
              </span>
            );
          }
          
          const pageNumber = page as number;
          const isActive = pageNumber === currentPage;
          
          return (
            <Button
              key={pageNumber}
              variant={isActive ? 'primary' : 'ghost'}
              size="sm"
              onClick={() => onPageChange(pageNumber)}
              aria-label={`Go to page ${pageNumber}`}
              aria-current={isActive ? 'page' : undefined}
              className={cn(
                'min-w-[2rem]',
                isActive && 'pointer-events-none'
              )}
            >
              {pageNumber}
            </Button>
          );
        })}
      </div>
      
      <Button
        variant="ghost"
        size="sm"
        onClick={() => onPageChange(currentPage + 1)}
        disabled={currentPage === totalPages}
        aria-label="Go to next page"
      >
        <ChevronRight className="h-4 w-4" />
      </Button>
      
      {showFirstLast && (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onPageChange(totalPages)}
          disabled={currentPage === totalPages}
          aria-label="Go to last page"
        >
          Last
        </Button>
      )}
    </nav>
  );
};

Pagination.displayName = 'Pagination';

================
File: src/components/ui/SearchBox.tsx
================
'use client';

import React, { forwardRef, InputHTMLAttributes, useState } from 'react';
import { Search, X } from 'lucide-react';
import { cn } from '@/lib/utils';

export interface SearchBoxProps extends Omit<InputHTMLAttributes<HTMLInputElement>, 'size'> {
  onSearch?: (value: string) => void;
  onClear?: () => void;
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'filled' | 'ghost';
  fullWidth?: boolean;
  showClearButton?: boolean;
  debounceDelay?: number;
}

const sizeClasses = {
  sm: 'h-8 text-sm pl-8 pr-3',
  md: 'h-10 text-base pl-10 pr-4',
  lg: 'h-12 text-lg pl-12 pr-5',
};

const iconSizeClasses = {
  sm: 'h-4 w-4',
  md: 'h-5 w-5',
  lg: 'h-6 w-6',
};

const iconPositionClasses = {
  sm: 'left-2',
  md: 'left-3',
  lg: 'left-4',
};

const variantClasses = {
  default: 'border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800',
  filled: 'border border-transparent bg-gray-100 dark:bg-gray-700',
  ghost: 'border border-transparent hover:bg-gray-100 dark:hover:bg-gray-700',
};

export const SearchBox = forwardRef<HTMLInputElement, SearchBoxProps>(
  (
    {
      onSearch,
      onClear,
      size = 'md',
      variant = 'default',
      fullWidth = false,
      showClearButton = true,
      debounceDelay = 300,
      className,
      value: controlledValue,
      onChange,
      ...props
    },
    ref
  ) => {
    const [internalValue, setInternalValue] = useState('');
    const value = controlledValue !== undefined ? controlledValue : internalValue;
    const [debounceTimer, setDebounceTimer] = useState<NodeJS.Timeout | null>(null);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const newValue = e.target.value;
      
      if (controlledValue === undefined) {
        setInternalValue(newValue);
      }
      
      onChange?.(e);

      // Debounced search
      if (onSearch) {
        if (debounceTimer) {
          clearTimeout(debounceTimer);
        }
        const timer = setTimeout(() => {
          onSearch(newValue);
        }, debounceDelay);
        setDebounceTimer(timer);
      }
    };

    const handleClear = () => {
      if (controlledValue === undefined) {
        setInternalValue('');
      }
      
      // Create synthetic event for onChange
      const syntheticEvent = {
        target: { value: '' },
        currentTarget: { value: '' },
      } as React.ChangeEvent<HTMLInputElement>;
      
      onChange?.(syntheticEvent);
      onClear?.();
      onSearch?.('');
    };

    const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
      if (e.key === 'Enter' && onSearch) {
        if (debounceTimer) {
          clearTimeout(debounceTimer);
        }
        onSearch(value as string);
      }
    };

    return (
      <div className={cn('relative', fullWidth && 'w-full')}>
        <div className="absolute inset-y-0 left-0 flex items-center pointer-events-none">
          <Search
            className={cn(
              'text-gray-400',
              iconSizeClasses[size],
              iconPositionClasses[size]
            )}
          />
        </div>
        
        <input
          ref={ref}
          type="search"
          value={value}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
          className={cn(
            'rounded-md transition-colors duration-200',
            'focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent',
            'placeholder-gray-400 dark:placeholder-gray-500',
            'text-gray-900 dark:text-gray-100',
            sizeClasses[size],
            variantClasses[variant],
            showClearButton && value && 'pr-10',
            fullWidth && 'w-full',
            className
          )}
          {...props}
        />
        
        {showClearButton && value && (
          <button
            type="button"
            onClick={handleClear}
            className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <X className={iconSizeClasses[size]} />
          </button>
        )}
      </div>
    );
  }
);

SearchBox.displayName = 'SearchBox';

================
File: src/components/ui/Select.tsx
================
'use client';

import React, { forwardRef, SelectHTMLAttributes } from 'react';
import { ChevronDown } from 'lucide-react';
import { cn } from '@/lib/utils';

export interface SelectOption {
  value: string;
  label: string;
  disabled?: boolean;
}

export interface SelectProps extends Omit<SelectHTMLAttributes<HTMLSelectElement>, 'size'> {
  label?: string;
  error?: string;
  options: SelectOption[];
  placeholder?: string;
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'filled' | 'ghost';
  fullWidth?: boolean;
}

const sizeClasses = {
  sm: 'h-8 text-sm px-3 pr-8',
  md: 'h-10 text-base px-4 pr-10',
  lg: 'h-12 text-lg px-5 pr-12',
};

const iconSizeClasses = {
  sm: 'h-4 w-4',
  md: 'h-5 w-5',
  lg: 'h-6 w-6',
};

const variantClasses = {
  default: 'border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800',
  filled: 'border border-transparent bg-gray-100 dark:bg-gray-700',
  ghost: 'border border-transparent hover:bg-gray-100 dark:hover:bg-gray-700',
};

export const Select = forwardRef<HTMLSelectElement, SelectProps>(
  (
    {
      label,
      error,
      options,
      placeholder,
      size = 'md',
      variant = 'default',
      fullWidth = false,
      className,
      disabled,
      ...props
    },
    ref
  ) => {
    const selectId = props.id || props.name;

    return (
      <div className={cn('space-y-1', fullWidth && 'w-full')}>
        {label && (
          <label
            htmlFor={selectId}
            className="block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            {label}
            {props.required && <span className="text-red-500 ml-1">*</span>}
          </label>
        )}
        <div className="relative">
          <select
            ref={ref}
            id={selectId}
            className={cn(
              'appearance-none rounded-md transition-colors duration-200',
              'focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent',
              'disabled:opacity-50 disabled:cursor-not-allowed',
              'text-gray-900 dark:text-gray-100',
              sizeClasses[size],
              variantClasses[variant],
              error && 'border-red-500 dark:border-red-400',
              fullWidth && 'w-full',
              className
            )}
            disabled={disabled}
            {...props}
          >
            {placeholder && (
              <option value="" disabled>
                {placeholder}
              </option>
            )}
            {options.map((option) => (
              <option
                key={option.value}
                value={option.value}
                disabled={option.disabled}
              >
                {option.label}
              </option>
            ))}
          </select>
          <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
            <ChevronDown
              className={cn(
                'text-gray-400',
                iconSizeClasses[size]
              )}
            />
          </div>
        </div>
        {error && (
          <p className="text-sm text-red-600 dark:text-red-400">{error}</p>
        )}
      </div>
    );
  }
);

Select.displayName = 'Select';

================
File: src/components/ui/Spinner.tsx
================
'use client';

import React from 'react';
import { cn } from '@/lib/utils';

export interface SpinnerProps extends React.HTMLAttributes<HTMLDivElement> {
  size?: 'sm' | 'md' | 'lg' | 'xl';
  variant?: 'primary' | 'secondary' | 'white';
}

const sizeClasses = {
  sm: 'h-4 w-4 border-2',
  md: 'h-6 w-6 border-2',
  lg: 'h-8 w-8 border-3',
  xl: 'h-12 w-12 border-4',
};

const variantClasses = {
  primary: 'border-blue-600 border-t-transparent',
  secondary: 'border-gray-600 border-t-transparent',
  white: 'border-white border-t-transparent',
};

export const Spinner: React.FC<SpinnerProps> = ({
  size = 'md',
  variant = 'primary',
  className,
  ...props
}) => {
  return (
    <div
      className={cn(
        'animate-spin rounded-full',
        sizeClasses[size],
        variantClasses[variant],
        className
      )}
      role="status"
      aria-label="Loading"
      {...props}
    >
      <span className="sr-only">Loading...</span>
    </div>
  );
};

Spinner.displayName = 'Spinner';

================
File: src/components/ui/Table copy.tsx
================
'use client';

import React from 'react';
import { cn } from '@/lib/utils';

// Table Root Component
export interface TableProps extends React.HTMLAttributes<HTMLTableElement> {
  variant?: 'default' | 'striped' | 'bordered';
  size?: 'sm' | 'md' | 'lg';
  responsive?: boolean;
}

const variantClasses = {
  default: '',
  striped: '[&_tbody_tr:nth-child(even)]:bg-gray-50 dark:[&_tbody_tr:nth-child(even)]:bg-gray-800',
  bordered: 'border border-gray-200 dark:border-gray-700',
};

const sizeClasses = {
  sm: '[&_th]:py-2 [&_th]:px-3 [&_td]:py-2 [&_td]:px-3 text-sm',
  md: '[&_th]:py-3 [&_th]:px-4 [&_td]:py-3 [&_td]:px-4',
  lg: '[&_th]:py-4 [&_th]:px-6 [&_td]:py-4 [&_td]:px-6 text-lg',
};

export const Table: React.FC<TableProps> = ({
  variant = 'default',
  size = 'md',
  responsive = true,
  className,
  children,
  ...props
}) => {
  const table = (
    <table
      className={cn(
        'min-w-full divide-y divide-gray-200 dark:divide-gray-700',
        variantClasses[variant],
        sizeClasses[size],
        className
      )}
      {...props}
    >
      {children}
    </table>
  );

  if (responsive) {
    return (
      <div className="overflow-x-auto -mx-4 sm:-mx-6 lg:-mx-8">
        <div className="inline-block min-w-full py-2 align-middle px-4 sm:px-6 lg:px-8">
          {table}
        </div>
      </div>
    );
  }

  return table;
};

// Table Header Component
export const TableHeader: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <thead
    className={cn('bg-gray-50 dark:bg-gray-800', className)}
    {...props}
  />
);

// Table Body Component
export const TableBody: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <tbody
    className={cn(
      'bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700',
      className
    )}
    {...props}
  />
);

// Table Row Component
export const TableRow: React.FC<React.HTMLAttributes<HTMLTableRowElement>> = ({
  className,
  ...props
}) => (
  <tr
    className={cn(
      'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors',
      className
    )}
    {...props}
  />
);

// Table Head Cell Component
export interface TableHeadProps extends React.ThHTMLAttributes<HTMLTableCellElement> {
  sortable?: boolean;
  sorted?: 'asc' | 'desc' | false;
  onSort?: () => void;
}

export const TableHead: React.FC<TableHeadProps> = ({
  sortable = false,
  sorted = false,
  onSort,
  className,
  children,
  ...props
}) => (
  <th
    className={cn(
      'text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider',
      sortable && 'cursor-pointer select-none hover:text-gray-700 dark:hover:text-gray-200',
      className
    )}
    onClick={sortable ? onSort : undefined}
    {...props}
  >
    <div className="flex items-center space-x-1">
      <span>{children}</span>
      {sortable && (
        <span className="inline-flex flex-col">
          <svg
            className={cn(
              'w-3 h-3 -mb-1',
              sorted === 'asc' ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400'
            )}
            fill="currentColor"
            viewBox="0 0 320 512"
          >
            <path d="M41 288h238c21.4 0 32.1 25.9 17 41L177 448c-9.4 9.4-24.6 9.4-33.9 0L24 329c-15.1-15.1-4.4-41 17-41z" />
          </svg>
          <svg
            className={cn(
              'w-3 h-3 -mt-1',
              sorted === 'desc' ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400'
            )}
            fill="currentColor"
            viewBox="0 0 320 512"
          >
            <path d="M279 224H41c-21.4 0-32.1-25.9-17-41L143 64c9.4-9.4 24.6-9.4 33.9 0l119 119c15.2 15.1 4.5 41-16.9 41z" />
          </svg>
        </span>
      )}
    </div>
  </th>
);

// Table Cell Component
export const TableCell: React.FC<React.TdHTMLAttributes<HTMLTableCellElement>> = ({
  className,
  ...props
}) => (
  <td
    className={cn(
      'text-gray-900 dark:text-gray-100 whitespace-nowrap',
      className
    )}
    {...props}
  />
);

// Table Footer Component
export const TableFooter: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <tfoot
    className={cn(
      'bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700',
      className
    )}
    {...props}
  />
);

// Empty State Component
export interface TableEmptyProps {
  message?: string;
  icon?: React.ReactNode;
}

export const TableEmpty: React.FC<TableEmptyProps> = ({
  message = 'No data available',
  icon,
}) => (
  <TableRow>
    <TableCell
      colSpan={100}
      className="text-center py-8 text-gray-500 dark:text-gray-400"
    >
      <div className="flex flex-col items-center space-y-2">
        {icon && <div className="text-gray-400">{icon}</div>}
        <p>{message}</p>
      </div>
    </TableCell>
  </TableRow>
);

================
File: src/components/ui/Table.tsx
================
// src/components/ui/Table.tsx

'use client'; // Client component directive

import React from 'react';
import { cn } from '@/lib/utils'; // Utility for conditional class names

// Table Root Component Props interface
export interface TableProps extends React.HTMLAttributes<HTMLTableElement> {
  variant?: 'default' | 'striped' | 'bordered'; // Visual style of the table
  size?: 'sm' | 'md' | 'lg'; // Size variant for padding and font
  responsive?: boolean; // Controls whether the table is wrapped in an overflow container
  // Columns definition for the table
  columns: {
    key: string; // Unique key to access data from each row object
    label: string | React.ReactNode; // Label to display in the table header
    render?: (item: any) => React.ReactNode; // Optional render function for custom cell content
  }[];
  data: any[]; // Array of data objects to display in the table rows
}

// CSS classes for different table variants
const variantClasses = {
  default: '',
  striped: '[&_tbody_tr:nth-child(even)]:bg-gray-50 dark:[&_tbody_tr:nth-child(even)]:bg-gray-800',
  bordered: 'border border-gray-200 dark:border-gray-700',
};

// CSS classes for different table sizes
const sizeClasses = {
  sm: '[&_th]:py-2 [&_th]:px-3 [&_td]:py-2 [&_td]:px-3 text-sm',
  md: '[&_th]:py-3 [&_th]:px-4 [&_td]:py-3 [&_td]:px-4',
  lg: '[&_th]:py-4 [&_th]:px-6 [&_td]:py-4 [&_td]:px-6 text-lg',
};

// Main Table component
export const Table: React.FC<TableProps> = ({
  variant = 'default',
  size = 'md',
  responsive = true,
  className,
  columns, // Destructure columns prop
  data, // Destructure data prop
  // Note: 'children' prop is no longer used for rendering table content directly,
  // as columns and data are used for automatic rendering.
  ...props
}) => {
  // Inner table element
  const table = (
    <table
      className={cn(
        'min-w-full divide-y divide-gray-200 dark:divide-gray-700',
        variantClasses[variant],
        sizeClasses[size],
        className
      )}
      {...props}
    >
      {/* Table Header (<thead>) - automatically rendered from columns prop */}
      <TableHeader>
        <TableRow>
          {columns.map((col) => (
            <TableHead key={col.key}>{col.label}</TableHead>
          ))}
        </TableRow>
      </TableHeader>
      {/* Table Body (<tbody>) - automatically rendered from data and columns props */}
      <TableBody>
        {data.length > 0 ? (
          data.map((row, rowIndex) => (
            // Use row.id as key if available, fallback to rowIndex
            <TableRow key={row.id || rowIndex}>
              {columns.map((col) => (
                <TableCell key={col.key}>
                  {/* Render cell content using custom render function or direct key access */}
                  {col.render ? col.render(row) : (row[col.key] || '-')}
                </TableCell>
              ))}
            </TableRow>
          ))
        ) : (
          // Display empty state if no data
          <TableEmpty colSpan={columns.length} message="No data available" />
        )}
      </TableBody>
    </table>
  );

  // Wrap table in responsive container if responsive prop is true
  if (responsive) {
    return (
      <div className="overflow-x-auto -mx-4 sm:-mx-6 lg:-mx-8">
        <div className="inline-block min-w-full py-2 align-middle px-4 sm:px-6 lg:px-8">
          {table}
        </div>
      </div>
    );
  }

  return table;
};

// Table Header Component (<thead>)
export const TableHeader: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <thead
    className={cn('bg-gray-50 dark:bg-gray-800', className)}
    {...props}
  />
);

// Table Body Component (<tbody>)
export const TableBody: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <tbody
    className={cn(
      'bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700',
      className
    )}
    {...props}
  />
);

// Table Row Component (<tr>)
export const TableRow: React.FC<React.HTMLAttributes<HTMLTableRowElement>> = ({
  className,
  ...props
}) => (
  <tr
    className={cn(
      'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors',
      className
    )}
    {...props}
  />
);

// Table Head Cell Component (<th>) Props interface
export interface TableHeadProps extends React.ThHTMLAttributes<HTMLTableCellElement> {
  sortable?: boolean; // Indicates if the column is sortable
  sorted?: 'asc' | 'desc' | false; // Current sort direction
  onSort?: () => void; // Callback for sorting
}

// Table Head Cell Component (<th>)
export const TableHead: React.FC<TableHeadProps> = ({
  sortable = false,
  sorted = false,
  onSort,
  className,
  children,
  ...props
}) => (
  <th
    className={cn(
      'text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider',
      sortable && 'cursor-pointer select-none hover:text-gray-700 dark:hover:text-gray-200',
      className
    )}
    onClick={sortable ? onSort : undefined}
    {...props}
  >
    <div className="flex items-center space-x-1">
      <span>{children}</span>
      {sortable && (
        <span className="inline-flex flex-col">
          {/* Up arrow for ascending sort */}
          <svg
            className={cn(
              'w-3 h-3 -mb-1',
              sorted === 'asc' ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400'
            )}
            fill="currentColor"
            viewBox="0 0 320 512"
          >
            <path d="M41 288h238c21.4 0 32.1 25.9 17 41L177 448c-9.4 9.4-24.6 9.4-33.9 0L24 329c-15.1-15.1-4.4-41 17-41z" />
          </svg>
          {/* Down arrow for descending sort */}
          <svg
            className={cn(
              'w-3 h-3 -mt-1',
              sorted === 'desc' ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400'
            )}
            fill="currentColor"
            viewBox="0 0 320 512"
          >
            <path d="M279 224H41c-21.4 0-32.1-25.9-17-41L143 64c9.4-9.4 24.6-9.4 33.9 0l119 119c15.2 15.1 4.5 41-16.9 41z" />
          </svg>
        </span>
      )}
    </div>
  </th>
);

// Table Cell Component (<td>)
export const TableCell: React.FC<React.TdHTMLAttributes<HTMLTableCellElement>> = ({
  className,
  ...props
}) => (
  <td
    className={cn(
      'text-gray-900 dark:text-gray-100 whitespace-nowrap',
      className
    )}
    {...props}
  />
);

// Table Footer Component (<tfoot>)
export const TableFooter: React.FC<React.HTMLAttributes<HTMLTableSectionElement>> = ({
  className,
  ...props
}) => (
  <tfoot
    className={cn(
      'bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700',
      className
    )}
    {...props}
  />
);

// Empty State Component Props interface
export interface TableEmptyProps {
  message?: string; // Message to display when no data is available
  icon?: React.ReactNode; // Optional icon to display
  colSpan?: number; // Number of columns the empty cell should span
}

// Empty State Component (used inside TableBody when data is empty)
export const TableEmpty: React.FC<TableEmptyProps> = ({
  message = 'No data available',
  icon,
  colSpan = 1, // Default colSpan to 1
}) => (
  <TableRow>
    <TableCell
      colSpan={colSpan} // Apply colSpan to the TableCell
      className="text-center py-8 text-gray-500 dark:text-gray-400"
    >
      <div className="flex flex-col items-center space-y-2">
        {icon && <div className="text-gray-400">{icon}</div>}
        <p>{message}</p>
      </div>
    </TableCell>
  </TableRow>
);

================
File: src/components/ui/Tabs.tsx
================
'use client';

import React, { createContext, useContext, useState } from 'react';
import { cn } from '@/lib/utils';

interface TabsContextValue {
  activeTab: string;
  setActiveTab: (value: string) => void;
}

const TabsContext = createContext<TabsContextValue | undefined>(undefined);

export interface TabsProps {
  defaultValue?: string;
  value?: string;
  onValueChange?: (value: string) => void;
  className?: string;
  children: React.ReactNode;
}

export const Tabs: React.FC<TabsProps> = ({
  defaultValue,
  value,
  onValueChange,
  className,
  children,
}) => {
  const [internalValue, setInternalValue] = useState(defaultValue || '');
  const activeTab = value !== undefined ? value : internalValue;

  const setActiveTab = (newValue: string) => {
    if (value === undefined) {
      setInternalValue(newValue);
    }
    onValueChange?.(newValue);
  };

  return (
    <TabsContext.Provider value={{ activeTab, setActiveTab }}>
      <div className={cn('w-full', className)}>{children}</div>
    </TabsContext.Provider>
  );
};

export interface TabsListProps {
  className?: string;
  children: React.ReactNode;
}

export const TabsList: React.FC<TabsListProps> = ({ className, children }) => {
  return (
    <div
      className={cn(
        'inline-flex h-10 items-center justify-start rounded-lg bg-gray-100 dark:bg-gray-800 p-1',
        className
      )}
      role="tablist"
    >
      {children}
    </div>
  );
};

export interface TabsTriggerProps {
  value: string;
  disabled?: boolean;
  className?: string;
  children: React.ReactNode;
}

export const TabsTrigger: React.FC<TabsTriggerProps> = ({
  value,
  disabled = false,
  className,
  children,
}) => {
  const context = useContext(TabsContext);
  if (!context) throw new Error('TabsTrigger must be used within Tabs');

  const { activeTab, setActiveTab } = context;
  const isActive = activeTab === value;

  return (
    <button
      type="button"
      role="tab"
      aria-selected={isActive}
      aria-controls={`panel-${value}`}
      data-state={isActive ? 'active' : 'inactive'}
      disabled={disabled}
      onClick={() => setActiveTab(value)}
      className={cn(
        'inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5',
        'text-sm font-medium ring-offset-background transition-all',
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
        'disabled:pointer-events-none disabled:opacity-50',
        isActive
          ? 'bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm'
          : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100',
        className
      )}
    >
      {children}
    </button>
  );
};

export interface TabsContentProps {
  value: string;
  className?: string;
  children: React.ReactNode;
}

export const TabsContent: React.FC<TabsContentProps> = ({
  value,
  className,
  children,
}) => {
  const context = useContext(TabsContext);
  if (!context) throw new Error('TabsContent must be used within Tabs');

  const { activeTab } = context;
  const isActive = activeTab === value;

  if (!isActive) return null;

  return (
    <div
      role="tabpanel"
      id={`panel-${value}`}
      aria-labelledby={`trigger-${value}`}
      tabIndex={0}
      className={cn(
        'mt-2 ring-offset-background',
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
        className
      )}
    >
      {children}
    </div>
  );
};

================
File: src/components/ui/Textarea.tsx
================
import { cn } from '@/lib/utils';
import { forwardRef } from 'react';

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

const Textarea = forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, label, error, helperText, id, ...props }, ref) => {
    const textareaId = id || `textarea-${Math.random().toString(36).substr(2, 9)}`;

    return (
      <div className="space-y-1">
        {label && (
          <label 
            htmlFor={textareaId} 
            className="block text-sm font-medium text-gray-700"
          >
            {label}
            {props.required && <span className="text-red-500 ml-1">*</span>}
          </label>
        )}
        <textarea
          id={textareaId}
          className={cn(
            'block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm',
            error && 'border-red-300 focus:border-red-500 focus:ring-red-500',
            props.disabled && 'bg-gray-50 text-gray-500 cursor-not-allowed',
            className
          )}
          ref={ref}
          {...props}
        />
        {error && (
          <p className="text-sm text-red-600" id={`${textareaId}-error`}>
            {error}
          </p>
        )}
        {helperText && !error && (
          <p className="text-sm text-gray-500" id={`${textareaId}-helper`}>
            {helperText}
          </p>
        )}
      </div>
    );
  }
);

Textarea.displayName = 'Textarea';

export { Textarea };

================
File: src/components/vocabulary/index.ts
================
export { VocabularyForm } from './VocabularyForm';
export { VocabularyGroupForm } from './VocabularyGroupForm';

================
File: src/components/vocabulary/VocabularyForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Save, X, Plus, Volume2 } from 'lucide-react';
import { Vocabulary, DifficultyLevel } from '@/types/database';
import { vocabularyService, CreateVocabularyData, UpdateVocabularyData } from '@/lib/supabase/vocabulary';
import { 
  Button, Card, Input, Textarea, Select, Badge, Spinner 
} from '@/components/ui';

interface VocabularyFormProps {
  initialData?: Vocabulary;
}

export function VocabularyForm({ initialData }: VocabularyFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;
  const [loading, setLoading] = useState(false);

  const [formData, setFormData] = useState({
    word: initialData?.word || '',
    translation: initialData?.translation || '',
    pronunciation: initialData?.pronunciation || '',
    part_of_speech: initialData?.part_of_speech || '',
    definition: initialData?.definition || '',
    example_sentence: initialData?.example_sentence || '',
    example_translation: initialData?.example_translation || '',
    notes: initialData?.notes || '',
    difficulty: initialData?.difficulty || 'beginner' as DifficultyLevel,
    audio_url: initialData?.audio_url || '',
    image_url: initialData?.image_url || '',
    tags: initialData?.tags || [],
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [newTag, setNewTag] = useState('');

  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    if (!formData.word.trim()) {
      newErrors.word = 'Word is required';
    }
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;
    
    setLoading(true);
    try {
      if (isEditing) {
        await vocabularyService.updateVocabulary({ id: initialData.id, ...formData } as UpdateVocabularyData);
      } else {
        await vocabularyService.createVocabulary(formData as CreateVocabularyData);
      }
      
      router.push('/vocabulary');
      router.refresh();
    } catch (error: any) {
      console.error('Failed to save vocabulary:', error);
      setErrors({ submit: error.message || 'Failed to save vocabulary. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData({ ...formData, tags: [...formData.tags, newTag.trim()] });
      setNewTag('');
    }
  };

  const handleRemoveTag = (tag: string) => {
    setFormData({ ...formData, tags: formData.tags.filter(t => t !== tag) });
  };

  const difficultyLevels = vocabularyService.getDifficultyLevels();
  const partsOfSpeech = vocabularyService.getPartsOfSpeechOptions();

  return (
    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="mb-8">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => router.back()}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back
        </Button>
        <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
          {isEditing ? 'Edit Vocabulary' : 'Add New Vocabulary'}
        </h1>
      </div>

      {errors.submit && (
        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {errors.submit}
        </div>
      )}

      <div className="space-y-6">
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Basic Information</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="Word"
                value={formData.word}
                onChange={(e) => setFormData({ ...formData, word: e.target.value })}
                error={errors.word}
                placeholder="Enter the word"
                required
              />
              <Input
                label="Translation"
                value={formData.translation}
                onChange={(e) => setFormData({ ...formData, translation: e.target.value })}
                placeholder="Enter translation"
              />
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="Pronunciation"
                value={formData.pronunciation}
                onChange={(e) => setFormData({ ...formData, pronunciation: e.target.value })}
                placeholder="e.g., /həˈloʊ/"
              />
              <Select
                label="Part of Speech"
                value={formData.part_of_speech}
                onChange={(e) => setFormData({ ...formData, part_of_speech: e.target.value })}
                options={[
                  { value: '', label: 'Select part of speech' },
                  ...partsOfSpeech
                ]}
              />
            </div>

            <Textarea
              label="Definition"
              value={formData.definition}
              onChange={(e) => setFormData({ ...formData, definition: e.target.value })}
              placeholder="Enter the definition of the word"
              rows={3}
            />
          </Card.Content>
        </Card>

        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Examples & Usage</h2></Card.Header>
          <Card.Content className="space-y-4">
            <Textarea
              label="Example Sentence"
              value={formData.example_sentence}
              onChange={(e) => setFormData({ ...formData, example_sentence: e.target.value })}
              placeholder="Enter an example sentence using this word"
              rows={2}
            />
            
            <Textarea
              label="Example Translation"
              value={formData.example_translation}
              onChange={(e) => setFormData({ ...formData, example_translation: e.target.value })}
              placeholder="Enter the translation of the example sentence"
              rows={2}
            />

            <Textarea
              label="Notes"
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              placeholder="Additional notes, usage tips, or context"
              rows={3}
            />
          </Card.Content>
        </Card>

        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Media & Classification</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Input
                  label="Audio URL"
                  type="url"
                  value={formData.audio_url}
                  onChange={(e) => setFormData({ ...formData, audio_url: e.target.value })}
                  placeholder="https://example.com/audio.mp3"
                />
                {formData.audio_url && (
                  <div className="mt-2 flex items-center gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      leftIcon={<Volume2 className="h-4 w-4" />}
                      onClick={() => {
                        const audio = new Audio(formData.audio_url);
                        audio.play().catch(console.error);
                      }}
                    >
                      Test Audio
                    </Button>
                  </div>
                )}
              </div>
              
              <Input
                label="Image URL"
                type="url"
                value={formData.image_url}
                onChange={(e) => setFormData({ ...formData, image_url: e.target.value })}
                placeholder="https://example.com/image.jpg"
              />
            </div>

            <Select
              label="Difficulty Level"
              value={formData.difficulty}
              onChange={(e) => setFormData({ ...formData, difficulty: e.target.value as DifficultyLevel })}
              options={difficultyLevels.map(level => ({
                value: level.value,
                label: level.label
              }))}
            />

            {formData.image_url && (
              <div className="mt-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Image Preview
                </label>
                <div className="w-32 h-32 border rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800">
                  <img
                    src={formData.image_url}
                    alt={formData.word}
                    className="w-full h-full object-cover"
                    onError={(e) => {
                      const target = e.target as HTMLImageElement;
                      target.style.display = 'none';
                    }}
                  />
                </div>
              </div>
            )}
          </Card.Content>
        </Card>
        
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Tags</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="flex gap-2">
              <Input
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                placeholder="Add a tag"
                onKeyPress={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddTag(); }}}
              />
              <Button type="button" onClick={handleAddTag} leftIcon={<Plus className="h-4 w-4" />}>Add</Button>
            </div>
            {formData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {formData.tags.map((tag) => (
                  <Badge key={tag} variant="secondary" className="px-3 py-1">
                    {tag}
                    <button type="button" onClick={() => handleRemoveTag(tag)} className="ml-2 hover:text-red-500">
                      <X className="h-3 w-3" />
                    </button>
                  </Badge>
                ))}
              </div>
            )}
          </Card.Content>
        </Card>

        <div className="flex justify-end gap-3">
          <Button type="button" variant="outline" onClick={() => router.push('/vocabulary')}>Cancel</Button>
          <Button type="submit" loading={loading} leftIcon={<Save className="h-4 w-4" />}>
            {isEditing ? 'Update Vocabulary' : 'Create Vocabulary'}
          </Button>
        </div>
      </div>
    </form>
  );
}

================
File: src/components/vocabulary/VocabularyGroupForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Save, X, Plus } from 'lucide-react';
import { VocabularyGroup, Category, DifficultyLevel } from '@/types/database';
import { vocabularyService, CreateVocabularyGroupData, UpdateVocabularyGroupData } from '@/lib/supabase/vocabulary';
import { categoryService } from '@/lib/supabase/categories';
import { 
  Button, Card, Input, Textarea, Select, Badge, Modal, Spinner 
} from '@/components/ui';

interface VocabularyGroupFormProps {
  initialData?: VocabularyGroup;
}

export function VocabularyGroupForm({ initialData }: VocabularyGroupFormProps) {
  const router = useRouter();
  const isEditing = !!initialData;
  const [loading, setLoading] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);

  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryColor, setNewCategoryColor] = useState('#6b7280');

  const [formData, setFormData] = useState({
    name: initialData?.name || '',
    description: initialData?.description || '',
    category_id: initialData?.category_id || '',
    language: initialData?.language || 'en',
    target_language: initialData?.target_language || '',
    difficulty: initialData?.difficulty || 'beginner' as DifficultyLevel,
    tags: initialData?.tags || [],
    is_public: initialData?.is_public || false,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [newTag, setNewTag] = useState('');

  useEffect(() => {
    loadCategories();
  }, []);

  const loadCategories = async () => {
    try {
      const data = await categoryService.getCategories({ type: 'vocabulary' });
      setCategories(data);
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  };

  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    if (!formData.name.trim()) {
      newErrors.name = 'Group name is required';
    }
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;
    
    setLoading(true);
    try {
      if (isEditing) {
        await vocabularyService.updateVocabularyGroup({ id: initialData.id, ...formData } as UpdateVocabularyGroupData);
      } else {
        await vocabularyService.createVocabularyGroup(formData as CreateVocabularyGroupData);
      }
      
      router.push('/vocabulary/groups');
      router.refresh();
    } catch (error: any) {
      console.error('Failed to save vocabulary group:', error);
      setErrors({ submit: error.message || 'Failed to save vocabulary group. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData({ ...formData, tags: [...formData.tags, newTag.trim()] });
      setNewTag('');
    }
  };

  const handleRemoveTag = (tag: string) => {
    setFormData({ ...formData, tags: formData.tags.filter(t => t !== tag) });
  };

  const handleCreateCategory = async () => {
    if (!newCategoryName.trim()) return;

    try {
      const newCategory = await categoryService.createCategory({
        name: newCategoryName,
        type: 'vocabulary',
        color: newCategoryColor,
      });

      setIsCategoryModalOpen(false);
      setNewCategoryName('');
      await loadCategories();
      setFormData({ ...formData, category_id: newCategory.id });
      
    } catch (error) {
      console.error("Failed to create vocabulary category:", error);
    }
  };

  const difficultyLevels = vocabularyService.getDifficultyLevels();

  const commonLanguages = [
    { value: 'en', label: 'English' },
    { value: 'es', label: 'Spanish' },
    { value: 'fr', label: 'French' },
    { value: 'de', label: 'German' },
    { value: 'it', label: 'Italian' },
    { value: 'pt', label: 'Portuguese' },
    { value: 'ru', label: 'Russian' },
    { value: 'ja', label: 'Japanese' },
    { value: 'ko', label: 'Korean' },
    { value: 'zh', label: 'Chinese' },
    { value: 'ar', label: 'Arabic' },
    { value: 'hi', label: 'Hindi' },
  ];

  return (
    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="mb-8">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => router.back()}
          leftIcon={<ArrowLeft className="h-4 w-4" />}
          className="mb-4"
        >
          Back
        </Button>
        <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
          {isEditing ? 'Edit Vocabulary Group' : 'Create New Vocabulary Group'}
        </h1>
      </div>

      {errors.submit && (
        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg">
          {errors.submit}
        </div>
      )}

      <div className="space-y-6">
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Basic Information</h2></Card.Header>
          <Card.Content className="space-y-4">
            <Input
              label="Group Name"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              error={errors.name}
              placeholder="Enter group name"
              required
            />
            
            <Textarea
              label="Description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Describe this vocabulary group"
              rows={3}
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Category
                </label>
                <div className="flex items-center gap-2">
                  <Select
                    className="flex-grow"
                    value={formData.category_id}
                    onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
                    options={[
                      { value: '', label: 'Select category' },
                      ...categories.map(cat => ({ value: cat.id, label: cat.name }))
                    ]}
                  />
                  <Button
                    type="button"
                    variant="outline"
                    size="md"
                    onClick={() => setIsCategoryModalOpen(true)}
                    className="flex-shrink-0 !h-10"
                  >
                    <Plus className="h-4 w-4" />
                  </Button>
                </div>
              </div>

              <Select
                label="Difficulty Level"
                value={formData.difficulty}
                onChange={(e) => setFormData({ ...formData, difficulty: e.target.value as DifficultyLevel })}
                options={difficultyLevels.map(level => ({
                  value: level.value,
                  label: level.label
                }))}
              />
            </div>
          </Card.Content>
        </Card>

        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Language Settings</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select
                label="Source Language"
                value={formData.language}
                onChange={(e) => setFormData({ ...formData, language: e.target.value })}
                options={commonLanguages}
              />
              
              <Select
                label="Target Language"
                value={formData.target_language}
                onChange={(e) => setFormData({ ...formData, target_language: e.target.value })}
                options={[
                  { value: '', label: 'Select target language' },
                  ...commonLanguages
                ]}
              />
            </div>

            <div className="flex items-center space-x-2 pt-2">
              <input
                type="checkbox"
                id="is_public"
                checked={formData.is_public}
                onChange={(e) => setFormData({ ...formData, is_public: e.target.checked })}
                className="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
              />
              <label htmlFor="is_public" className="text-sm font-medium text-gray-700 dark:text-gray-300">
                Make this group publicly accessible
              </label>
            </div>
          </Card.Content>
        </Card>
        
        <Card>
          <Card.Header><h2 className="text-lg font-semibold">Tags</h2></Card.Header>
          <Card.Content className="space-y-4">
            <div className="flex gap-2">
              <Input
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                placeholder="Add a tag"
                onKeyPress={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddTag(); }}}
              />
              <Button type="button" onClick={handleAddTag} leftIcon={<Plus className="h-4 w-4" />}>Add</Button>
            </div>
            {formData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {formData.tags.map((tag) => (
                  <Badge key={tag} variant="secondary" className="px-3 py-1">
                    {tag}
                    <button type="button" onClick={() => handleRemoveTag(tag)} className="ml-2 hover:text-red-500">
                      <X className="h-3 w-3" />
                    </button>
                  </Badge>
                ))}
              </div>
            )}
          </Card.Content>
        </Card>

        <div className="flex justify-end gap-3">
          <Button type="button" variant="outline" onClick={() => router.push('/vocabulary/groups')}>Cancel</Button>
          <Button type="submit" loading={loading} leftIcon={<Save className="h-4 w-4" />}>
            {isEditing ? 'Update Group' : 'Create Group'}
          </Button>
        </div>
      </div>

      <Modal
        isOpen={isCategoryModalOpen}
        onClose={() => setIsCategoryModalOpen(false)}
        title="Create New Vocabulary Category"
        size="sm"
      >
        <div className="space-y-4">
          <Input
            label="Category Name"
            value={newCategoryName}
            onChange={(e) => setNewCategoryName(e.target.value)}
            placeholder="e.g., Business, Academic, etc."
            required
          />
          <Input
            label="Category Color"
            type="color"
            value={newCategoryColor}
            onChange={(e) => setNewCategoryColor(e.target.value)}
            className="h-10"
          />
        </div>
        <div className="mt-6 flex justify-end gap-3">
          <Button variant="ghost" onClick={() => setIsCategoryModalOpen(false)}>
            Cancel
          </Button>
          <Button onClick={handleCreateCategory}>
            Create Category
          </Button>
        </div>
      </Modal>
    </form>
  );
}

================
File: src/contexts/AuthContext.tsx
================
'use client';

import { createContext, useContext, useEffect, useState } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { createSupabaseClient } from '@/lib/supabase';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  loading: boolean;
  signUp: (email: string, password: string, options?: { data?: { [key: string]: any } }) => Promise<{ user: User | null; error: any }>;
  signIn: (email: string, password: string) => Promise<{ user: User | null; error: any }>;
  signOut: () => Promise<void>;
  resetPassword: (email: string) => Promise<{ error: any }>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);
  
  const supabase = createSupabaseClient();

  useEffect(() => {
    // Get initial session
    const getInitialSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    };

    getInitialSession();

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        setSession(session);
        setUser(session?.user ?? null);
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, [supabase.auth]);

  const signUp = async (email: string, password: string, options?: { data?: { [key: string]: any } }) => {
    setLoading(true);
    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options,
      });
      return { user: data.user, error };
    } finally {
      setLoading(false);
    }
  };

  const signIn = async (email: string, password: string) => {
    setLoading(true);
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      return { user: data.user, error };
    } finally {
      setLoading(false);
    }
  };

  const signOut = async () => {
    setLoading(true);
    try {
      await supabase.auth.signOut();
    } finally {
      setLoading(false);
    }
  };

  const resetPassword = async (email: string) => {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/auth/reset-password`,
    });
    return { error };
  };

  const value = {
    user,
    session,
    loading,
    signUp,
    signIn,
    signOut,
    resetPassword,
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

================
File: src/lib/services/relationships/course-book-service.ts
================
import { createSupabaseClient } from '@/lib/supabase'
import type { Database } from '@/types/database'

type CourseBook = Database['public']['Tables']['course_books']['Insert']
type CourseBookRow = Database['public']['Tables']['course_books']['Row']

export class CourseBookService {
  private supabase = createSupabaseClient()

  // Add a book to a course
  async addBookToCourse(courseId: string, bookId: string, options?: {
    isRequired?: boolean
    notes?: string
    position?: number
  }) {
    const { data, error } = await this.supabase
      .from('course_books')
      .insert({
        course_id: courseId,
        book_id: bookId,
        is_required: options?.isRequired ?? false,
        notes: options?.notes,
        position: options?.position ?? 0
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  // Remove a book from a course
  async removeBookFromCourse(courseId: string, bookId: string) {
    const { error } = await this.supabase
      .from('course_books')
      .delete()
      .match({ course_id: courseId, book_id: bookId })

    if (error) throw error
  }

  // Get all books for a course
  async getCourseBooksWithDetails(courseId: string) {
    const { data, error } = await this.supabase
      .from('course_books')
      .select(`
        *,
        book:books (
          id,
          title,
          author,
          isbn,
          publisher,
          publication_year,
          cover_image_url,
          content_type,
          file_url
        )
      `)
      .eq('course_id', courseId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // Get all courses using a specific book
  async getCoursesUsingBook(bookId: string) {
    const { data, error } = await this.supabase
      .from('course_books')
      .select(`
        *,
        course:courses (
          id,
          title,
          description,
          status,
          difficulty
        )
      `)
      .eq('book_id', bookId)

    if (error) throw error
    return data
  }

  // Update book association details
  async updateCourseBook(courseId: string, bookId: string, updates: {
    isRequired?: boolean
    notes?: string
    position?: number
  }) {
    const { data, error } = await this.supabase
      .from('course_books')
      .update({
        is_required: updates.isRequired,
        notes: updates.notes,
        position: updates.position
      })
      .match({ course_id: courseId, book_id: bookId })
      .select()
      .single()

    if (error) throw error
    return data
  }

  // Reorder books in a course
  async reorderCourseBooks(courseId: string, bookOrders: { bookId: string; position: number }[]) {
    const updates = bookOrders.map(({ bookId, position }) => 
      this.supabase
        .from('course_books')
        .update({ position })
        .match({ course_id: courseId, book_id: bookId })
    )

    const results = await Promise.all(updates)
    const errors = results.filter(r => r.error)
    
    if (errors.length > 0) {
      throw new Error(`Failed to reorder books: ${errors.map(e => e.error?.message).join(', ')}`)
    }
  }

  // Bulk add books to course
  async bulkAddBooksToCourse(courseId: string, bookIds: string[], isRequired = false) {
    const inserts: CourseBook[] = bookIds.map((bookId, index) => ({
      course_id: courseId,
      book_id: bookId,
      is_required: isRequired,
      position: index
    }))

    const { data, error } = await this.supabase
      .from('course_books')
      .insert(inserts)
      .select()

    if (error) throw error
    return data
  }

  // Check if a book is associated with a course
  async isBookInCourse(courseId: string, bookId: string): Promise<boolean> {
    const { data, error } = await this.supabase
      .from('course_books')
      .select('id')
      .match({ course_id: courseId, book_id: bookId })
      .single()

    if (error && error.code !== 'PGRST116') throw error
    return !!data
  }
}

export const courseBookService = new CourseBookService()

================
File: src/lib/services/relationships/course-schedule-service.ts
================
import { createSupabaseClient } from '@/lib/supabase'
import type { Database } from '@/types/database'

export class CourseScheduleService {
  private supabase = createSupabaseClient()

  // Link a schedule to a course
  async linkScheduleToCourse(scheduleId: string, courseId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .update({ course_id: courseId })
      .eq('id', scheduleId)
      .select()
      .single()

    if (error) throw error
    return data
  }

  // Unlink a schedule from a course
  async unlinkScheduleFromCourse(scheduleId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .update({ course_id: null })
      .eq('id', scheduleId)
      .select()
      .single()

    if (error) throw error
    return data
  }

  // Get all schedules for a course
  async getCourseSchedules(courseId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        *,
        lessons (
          id,
          title,
          date,
          start_time,
          end_time,
          status
        )
      `)
      .eq('course_id', courseId)
      .order('start_date', { ascending: true })

    if (error) throw error
    return data
  }

  // Get active schedules for a course
  async getActiveCourseSchedules(courseId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        *,
        lessons (
          id,
          title,
          date,
          start_time,
          end_time,
          status
        )
      `)
      .eq('course_id', courseId)
      .eq('is_active', true)
      .gte('end_date', new Date().toISOString().split('T')[0])
      .order('start_date', { ascending: true })

    if (error) throw error
    return data
  }

  // Get course for a schedule
  async getScheduleCourse(scheduleId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        course:courses (
          id,
          title,
          description,
          status,
          difficulty
        )
      `)
      .eq('id', scheduleId)
      .single()

    if (error) throw error
    return data?.course
  }

  // Get all lessons for a course across all schedules
  async getCourseLessons(courseId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        lessons (
          *,
          schedule:schedules (
            id,
            name
          )
        )
      `)
      .eq('course_id', courseId)

    if (error) throw error

    // Flatten lessons from all schedules
    const lessons = data?.flatMap(schedule => 
      schedule.lessons?.map(lesson => ({
        ...lesson,
        schedule: schedule
      })) ?? []
    )

    return lessons
  }

  // Get upcoming lessons for a course
  async getUpcomingCourseLessons(courseId: string, limit = 10) {
    const today = new Date().toISOString().split('T')[0]
    
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        lessons (
          *,
          schedule:schedules (
            id,
            name
          )
        )
      `)
      .eq('course_id', courseId)
      .eq('is_active', true)

    if (error) throw error

    // Flatten and filter upcoming lessons
    const upcomingLessons = data?.flatMap(schedule => 
      schedule.lessons?.filter(lesson => lesson.date >= today) ?? []
    )
    .sort((a, b) => {
      const dateCompare = a.date.localeCompare(b.date)
      if (dateCompare !== 0) return dateCompare
      return a.start_time.localeCompare(b.start_time)
    })
    .slice(0, limit)

    return upcomingLessons
  }

  // Check if a course has any schedules
  async courseHasSchedules(courseId: string): Promise<boolean> {
    const { count, error } = await this.supabase
      .from('schedules')
      .select('*', { count: 'exact', head: true })
      .eq('course_id', courseId)

    if (error) throw error
    return (count ?? 0) > 0
  }

  // Get course progress based on completed lessons
  async getCourseProgress(courseId: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        lessons (
          status
        )
      `)
      .eq('course_id', courseId)

    if (error) throw error

    const allLessons = data?.flatMap(schedule => schedule.lessons ?? []) ?? []
    const completedLessons = allLessons.filter(lesson => lesson.status === 'completed')

    return {
      totalLessons: allLessons.length,
      completedLessons: completedLessons.length,
      progressPercentage: allLessons.length > 0 
        ? Math.round((completedLessons.length / allLessons.length) * 100)
        : 0
    }
  }

  // Create a schedule for a course
  async createCourseSchedule(courseId: string, scheduleData: {
    name: string
    description?: string
    start_date: string
    end_date: string
    timezone?: string
    recurrence_rule?: string
    tags?: string[]
    default_start_time?: string
    default_duration_minutes?: number
    location?: string
    max_students?: number
    is_active?: boolean
  }) {
    const { data: userData, error: userError } = await this.supabase.auth.getUser()
    if (userError) throw userError

    const { data, error } = await this.supabase
      .from('schedules')
      .insert({
        ...scheduleData,
        course_id: courseId,
        user_id: userData.user.id
      })
      .select()
      .single()

    if (error) throw error
    return data
  }
}

export const courseScheduleService = new CourseScheduleService()

================
File: src/lib/services/relationships/course-vocabulary-service.ts
================
import { createSupabaseClient } from '@/lib/supabase'
import type { Database } from '@/types/database'

type CourseVocabularyGroup = Database['public']['Tables']['course_vocabulary_groups']['Insert']

export class CourseVocabularyService {
  private supabase = createSupabaseClient()

  // Add a vocabulary group to a course
  async addVocabularyGroupToCourse(courseId: string, vocabularyGroupId: string, position?: number) {
    const { data, error } = await this.supabase
      .from('course_vocabulary_groups')
      .insert({
        course_id: courseId,
        vocabulary_group_id: vocabularyGroupId,
        position: position ?? 0
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  // Remove a vocabulary group from a course
  async removeVocabularyGroupFromCourse(courseId: string, vocabularyGroupId: string) {
    const { error } = await this.supabase
      .from('course_vocabulary_groups')
      .delete()
      .match({ course_id: courseId, vocabulary_group_id: vocabularyGroupId })

    if (error) throw error
  }

  // Get all vocabulary groups for a course
  async getCourseVocabularyGroups(courseId: string) {
    const { data, error } = await this.supabase
      .from('course_vocabulary_groups')
      .select(`
        *,
        vocabulary_group:vocabulary_groups (
          id,
          name,
          description,
          language,
          target_language,
          difficulty,
          tags,
          vocabulary_group_items (
            vocabulary:vocabulary (
              id,
              word,
              translation,
              part_of_speech,
              difficulty
            )
          )
        )
      `)
      .eq('course_id', courseId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // Get all vocabulary items for a course (flattened)
  async getCourseVocabularyItems(courseId: string) {
    const { data, error } = await this.supabase
      .from('course_vocabulary_groups')
      .select(`
        vocabulary_group:vocabulary_groups (
          vocabulary_group_items (
            vocabulary:vocabulary (*)
          )
        )
      `)
      .eq('course_id', courseId)

    if (error) throw error

    // Flatten the vocabulary items
    const vocabularyItems = data?.flatMap(group => 
      group.vocabulary_group?.vocabulary_group_items?.map(item => item.vocabulary) ?? []
    ).filter(Boolean)

    return vocabularyItems
  }

  // Get courses using a vocabulary group
  async getCoursesUsingVocabularyGroup(vocabularyGroupId: string) {
    const { data, error } = await this.supabase
      .from('course_vocabulary_groups')
      .select(`
        *,
        course:courses (
          id,
          title,
          description,
          status,
          difficulty
        )
      `)
      .eq('vocabulary_group_id', vocabularyGroupId)

    if (error) throw error
    return data
  }

  // Reorder vocabulary groups in a course
  async reorderCourseVocabularyGroups(courseId: string, groupOrders: { groupId: string; position: number }[]) {
    const updates = groupOrders.map(({ groupId, position }) => 
      this.supabase
        .from('course_vocabulary_groups')
        .update({ position })
        .match({ course_id: courseId, vocabulary_group_id: groupId })
    )

    const results = await Promise.all(updates)
    const errors = results.filter(r => r.error)
    
    if (errors.length > 0) {
      throw new Error(`Failed to reorder vocabulary groups: ${errors.map(e => e.error?.message).join(', ')}`)
    }
  }

  // Bulk add vocabulary groups to course
  async bulkAddVocabularyGroupsToCourse(courseId: string, groupIds: string[]) {
    const inserts: CourseVocabularyGroup[] = groupIds.map((groupId, index) => ({
      course_id: courseId,
      vocabulary_group_id: groupId,
      position: index
    }))

    const { data, error } = await this.supabase
      .from('course_vocabulary_groups')
      .insert(inserts)
      .select()

    if (error) throw error
    return data
  }

  // Get vocabulary statistics for a course
  async getCourseVocabularyStats(courseId: string) {
    const vocabularyItems = await this.getCourseVocabularyItems(courseId)
    
    const stats = {
      totalWords: vocabularyItems.length,
      byDifficulty: {} as Record<string, number>,
      byPartOfSpeech: {} as Record<string, number>,
      languages: new Set<string>()
    }

    vocabularyItems.forEach(item => {
      if (item) {
        // Count by difficulty
        const difficulty = item.difficulty || 'unknown'
        stats.byDifficulty[difficulty] = (stats.byDifficulty[difficulty] || 0) + 1
        
        // Count by part of speech
        const partOfSpeech = item.part_of_speech || 'unknown'
        stats.byPartOfSpeech[partOfSpeech] = (stats.byPartOfSpeech[partOfSpeech] || 0) + 1
      }
    })

    return stats
  }
}

export const courseVocabularyService = new CourseVocabularyService()

================
File: src/lib/services/relationships/index.ts
================
// Export all relationship services
export { courseBookService } from './course-book-service'
export { courseVocabularyService } from './course-vocabulary-service'
export { courseScheduleService } from './course-schedule-service'
export { lessonRelationshipService } from './lesson-relationship-service'

// Export types
export type { CourseBookService } from './course-book-service'
export type { CourseVocabularyService } from './course-vocabulary-service'
export type { CourseScheduleService } from './course-schedule-service'
export type { LessonRelationshipService } from './lesson-relationship-service'

================
File: src/lib/services/relationships/lesson-relationship-service.ts
================
import { createSupabaseClient } from '@/lib/supabase'
import type { Database } from '@/types/database'

type LessonObjective = Database['public']['Tables']['lesson_objectives']['Insert']
type LessonMethod = Database['public']['Tables']['lesson_methods']['Insert']
type LessonTask = Database['public']['Tables']['lesson_tasks']['Insert']
type LessonBook = Database['public']['Tables']['lesson_books']['Insert']
type LessonVocabulary = Database['public']['Tables']['lesson_vocabulary']['Insert']

export class LessonRelationshipService {
  private supabase = createSupabaseClient()

  // === OBJECTIVES ===
  async addObjectiveToLesson(lessonId: string, objectiveId: string, position?: number) {
    const { data, error } = await this.supabase
      .from('lesson_objectives')
      .insert({
        lesson_id: lessonId,
        objective_id: objectiveId,
        position: position ?? 0
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  async removeObjectiveFromLesson(lessonId: string, objectiveId: string) {
    const { error } = await this.supabase
      .from('lesson_objectives')
      .delete()
      .match({ lesson_id: lessonId, objective_id: objectiveId })

    if (error) throw error
  }

  async getLessonObjectives(lessonId: string) {
    const { data, error } = await this.supabase
      .from('lesson_objectives')
      .select(`
        *,
        objective:objectives (*)
      `)
      .eq('lesson_id', lessonId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // === METHODS ===
  async addMethodToLesson(lessonId: string, methodId: string, options?: {
    durationOverride?: number
    position?: number
    notes?: string
  }) {
    const { data, error } = await this.supabase
      .from('lesson_methods')
      .insert({
        lesson_id: lessonId,
        method_id: methodId,
        duration_override: options?.durationOverride,
        position: options?.position ?? 0,
        notes: options?.notes
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  async removeMethodFromLesson(lessonId: string, methodId: string) {
    const { error } = await this.supabase
      .from('lesson_methods')
      .delete()
      .match({ lesson_id: lessonId, method_id: methodId })

    if (error) throw error
  }

  async getLessonMethods(lessonId: string) {
    const { data, error } = await this.supabase
      .from('lesson_methods')
      .select(`
        *,
        method:methods (*)
      `)
      .eq('lesson_id', lessonId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // === TASKS ===
  async addTaskToLesson(lessonId: string, taskId: string, options?: {
    durationOverride?: number
    position?: number
    notes?: string
    isHomework?: boolean
    dueDate?: string
  }) {
    const { data, error } = await this.supabase
      .from('lesson_tasks')
      .insert({
        lesson_id: lessonId,
        task_id: taskId,
        duration_override: options?.durationOverride,
        position: options?.position ?? 0,
        notes: options?.notes,
        is_homework: options?.isHomework ?? false,
        due_date: options?.dueDate
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  async removeTaskFromLesson(lessonId: string, taskId: string) {
    const { error } = await this.supabase
      .from('lesson_tasks')
      .delete()
      .match({ lesson_id: lessonId, task_id: taskId })

    if (error) throw error
  }

  async getLessonTasks(lessonId: string) {
    const { data, error } = await this.supabase
      .from('lesson_tasks')
      .select(`
        *,
        task:tasks (*)
      `)
      .eq('lesson_id', lessonId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // === BOOKS ===
  async addBookToLesson(lessonId: string, bookId: string, options?: {
    pagesFrom?: number
    pagesTo?: number
    notes?: string
  }) {
    const { data, error } = await this.supabase
      .from('lesson_books')
      .insert({
        lesson_id: lessonId,
        book_id: bookId,
        pages_from: options?.pagesFrom,
        pages_to: options?.pagesTo,
        notes: options?.notes
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  async removeBookFromLesson(lessonId: string, bookId: string) {
    const { error } = await this.supabase
      .from('lesson_books')
      .delete()
      .match({ lesson_id: lessonId, book_id: bookId })

    if (error) throw error
  }

  async getLessonBooks(lessonId: string) {
    const { data, error } = await this.supabase
      .from('lesson_books')
      .select(`
        *,
        book:books (
          id,
          title,
          author,
          cover_image_url
        )
      `)
      .eq('lesson_id', lessonId)

    if (error) throw error
    return data
  }

  // === VOCABULARY ===
  async addVocabularyToLesson(lessonId: string, vocabularyId: string, position?: number) {
    const { data, error } = await this.supabase
      .from('lesson_vocabulary')
      .insert({
        lesson_id: lessonId,
        vocabulary_id: vocabularyId,
        position: position ?? 0
      })
      .select()
      .single()

    if (error) throw error
    return data
  }

  async removeVocabularyFromLesson(lessonId: string, vocabularyId: string) {
    const { error } = await this.supabase
      .from('lesson_vocabulary')
      .delete()
      .match({ lesson_id: lessonId, vocabulary_id: vocabularyId })

    if (error) throw error
  }

  async getLessonVocabulary(lessonId: string) {
    const { data, error } = await this.supabase
      .from('lesson_vocabulary')
      .select(`
        *,
        vocabulary:vocabulary (*)
      `)
      .eq('lesson_id', lessonId)
      .order('position', { ascending: true })

    if (error) throw error
    return data
  }

  // === BULK OPERATIONS ===
  async bulkAddObjectivesToLesson(lessonId: string, objectiveIds: string[]) {
    const inserts: LessonObjective[] = objectiveIds.map((id, index) => ({
      lesson_id: lessonId,
      objective_id: id,
      position: index
    }))

    const { data, error } = await this.supabase
      .from('lesson_objectives')
      .insert(inserts)
      .select()

    if (error) throw error
    return data
  }

  async bulkAddMethodsToLesson(lessonId: string, methods: Array<{
    methodId: string
    durationOverride?: number
    notes?: string
  }>) {
    const inserts: LessonMethod[] = methods.map((method, index) => ({
      lesson_id: lessonId,
      method_id: method.methodId,
      duration_override: method.durationOverride,
      notes: method.notes,
      position: index
    }))

    const { data, error } = await this.supabase
      .from('lesson_methods')
      .insert(inserts)
      .select()

    if (error) throw error
    return data
  }

  async bulkAddTasksToLesson(lessonId: string, tasks: Array<{
    taskId: string
    durationOverride?: number
    notes?: string
    isHomework?: boolean
    dueDate?: string
  }>) {
    const inserts: LessonTask[] = tasks.map((task, index) => ({
      lesson_id: lessonId,
      task_id: task.taskId,
      duration_override: task.durationOverride,
      notes: task.notes,
      is_homework: task.isHomework ?? false,
      due_date: task.dueDate,
      position: index
    }))

    const { data, error } = await this.supabase
      .from('lesson_tasks')
      .insert(inserts)
      .select()

    if (error) throw error
    return data
  }

  // === GET ALL LESSON CONTENT ===
  async getLessonContent(lessonId: string) {
    const [objectives, methods, tasks, books, vocabulary] = await Promise.all([
      this.getLessonObjectives(lessonId),
      this.getLessonMethods(lessonId),
      this.getLessonTasks(lessonId),
      this.getLessonBooks(lessonId),
      this.getLessonVocabulary(lessonId)
    ])

    return {
      objectives,
      methods,
      tasks,
      books,
      vocabulary
    }
  }

  // === COPY LESSON CONTENT ===
  async copyLessonContent(sourceLessonId: string, targetLessonId: string) {
    const content = await this.getLessonContent(sourceLessonId)

    // Copy objectives
    if (content.objectives.length > 0) {
      await this.bulkAddObjectivesToLesson(
        targetLessonId,
        content.objectives.map(o => o.objective_id)
      )
    }

    // Copy methods
    if (content.methods.length > 0) {
      await this.bulkAddMethodsToLesson(
        targetLessonId,
        content.methods.map(m => ({
          methodId: m.method_id,
          durationOverride: m.duration_override || undefined,
          notes: m.notes || undefined
        }))
      )
    }

    // Copy tasks
    if (content.tasks.length > 0) {
      await this.bulkAddTasksToLesson(
        targetLessonId,
        content.tasks.map(t => ({
          taskId: t.task_id,
          durationOverride: t.duration_override || undefined,
          notes: t.notes || undefined,
          isHomework: t.is_homework,
          dueDate: t.due_date || undefined
        }))
      )
    }

    // Copy books
    for (const book of content.books) {
      await this.addBookToLesson(targetLessonId, book.book_id, {
        pagesFrom: book.pages_from || undefined,
        pagesTo: book.pages_to || undefined,
        notes: book.notes || undefined
      })
    }

    // Copy vocabulary
    if (content.vocabulary.length > 0) {
      const vocabularyInserts: LessonVocabulary[] = content.vocabulary.map((v, index) => ({
        lesson_id: targetLessonId,
        vocabulary_id: v.vocabulary_id,
        position: index
      }))

      await this.supabase
        .from('lesson_vocabulary')
        .insert(vocabularyInserts)
    }
  }
}

export const lessonRelationshipService = new LessonRelationshipService()

================
File: src/lib/services/schedule-service.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import type { 
  Schedule, 
  Lesson, 
  Attendance, 
  LessonObjective, 
  LessonMethod, 
  LessonTask,
  RecurrenceType,
  DayOfWeek
} from '@/types/schedule';

export class ScheduleService {
  private supabase = createClientComponentClient();

  // Schedule CRUD operations
  async getSchedules(filters?: { 
    course_id?: string; 
    is_active?: boolean;
    user_id?: string;
  }) {
    let query = this.supabase
      .from('schedules')
      .select(`
        *,
        course:courses(id, title, description),
        lessons(count)
      `)
      .order('created_at', { ascending: false });

    if (filters?.course_id) {
      query = query.eq('course_id', filters.course_id);
    }
    if (filters?.is_active !== undefined) {
      query = query.eq('is_active', filters.is_active);
    }
    if (filters?.user_id) {
      query = query.eq('user_id', filters.user_id);
    }

    const { data, error } = await query;
    if (error) throw error;
    return data;
  }

  async getSchedule(id: string) {
    const { data, error } = await this.supabase
      .from('schedules')
      .select(`
        *,
        course:courses(*),
        lessons(
          *,
          objectives:lesson_objectives(
            *,
            objective:objectives(*)
          ),
          methods:lesson_methods(
            *,
            method:methods(*)
          ),
          tasks:lesson_tasks(
            *,
            task:tasks(*)
          )
        )
      `)
      .eq('id', id)
      .single();

    if (error) throw error;
    return data;
  }

  async createSchedule(schedule: Omit<Schedule, 'id' | 'created_at' | 'updated_at'>) {
    const { data, error } = await this.supabase
      .from('schedules')
      .insert(schedule)
      .select()
      .single();

    if (error) throw error;

    // Generate lessons based on recurrence
    if (schedule.recurrence_type !== 'none' && data) {
      await this.generateRecurringLessons(data.id, schedule);
    }

    return data;
  }

  async updateSchedule(id: string, schedule: Partial<Schedule>) {
    const { data, error } = await this.supabase
      .from('schedules')
      .update(schedule)
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  async deleteSchedule(id: string) {
    const { error } = await this.supabase
      .from('schedules')
      .delete()
      .eq('id', id);

    if (error) throw error;
  }

  // Lesson CRUD operations
  async getLessons(filters?: {
    schedule_id?: string;
    status?: string;
    date_from?: string;
    date_to?: string;
    user_id?: string;
  }) {
    let query = this.supabase
      .from('lessons')
      .select(`
        *,
        schedule:schedules(
          *,
          course:courses(id, title)
        ),
        attendance(count)
      `)
      .order('date', { ascending: true })
      .order('start_time', { ascending: true });

    if (filters?.schedule_id) {
      query = query.eq('schedule_id', filters.schedule_id);
    }
    if (filters?.status) {
      query = query.eq('status', filters.status);
    }
    if (filters?.date_from) {
      query = query.gte('date', filters.date_from);
    }
    if (filters?.date_to) {
      query = query.lte('date', filters.date_to);
    }
    if (filters?.user_id) {
      query = query.eq('user_id', filters.user_id);
    }

    const { data, error } = await query;
    if (error) throw error;
    return data;
  }

  async getLesson(id: string) {
    const { data, error } = await this.supabase
      .from('lessons')
      .select(`
        *,
        schedule:schedules(
          *,
          course:courses(*)
        ),
        attendance(*),
        objectives:lesson_objectives(
          *,
          objective:objectives(*)
        ),
        methods:lesson_methods(
          *,
          method:methods(*)
        ),
        tasks:lesson_tasks(
          *,
          task:tasks(*)
        )
      `)
      .eq('id', id)
      .single();

    if (error) throw error;
    return data;
  }

  async createLesson(lesson: Omit<Lesson, 'id' | 'created_at' | 'updated_at'>) {
    const { data, error } = await this.supabase
      .from('lessons')
      .insert(lesson)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  async updateLesson(id: string, lesson: Partial<Lesson>) {
    const { data, error } = await this.supabase
      .from('lessons')
      .update({
        ...lesson,
        updated_at: new Date().toISOString()
      })
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  async deleteLesson(id: string) {
    const { error } = await this.supabase
      .from('lessons')
      .delete()
      .eq('id', id);

    if (error) throw error;
  }

  // Attendance operations
  async getAttendance(lesson_id: string) {
    const { data, error } = await this.supabase
      .from('attendance')
      .select('*')
      .eq('lesson_id', lesson_id)
      .order('student_name');

    if (error) throw error;
    return data;
  }

  async markAttendance(attendance: Omit<Attendance, 'id' | 'marked_at'>) {
    const { data, error } = await this.supabase
      .from('attendance')
      .upsert({
        ...attendance,
        marked_at: new Date().toISOString()
      })
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  async bulkMarkAttendance(lesson_id: string, attendances: Omit<Attendance, 'id' | 'lesson_id' | 'marked_at'>[]) {
    const records = attendances.map(a => ({
      ...a,
      lesson_id,
      marked_at: new Date().toISOString()
    }));

    const { data, error } = await this.supabase
      .from('attendance')
      .upsert(records)
      .select();

    if (error) throw error;
    return data;
  }

  // Helper methods
  async generateRecurringLessons(
    schedule_id: string, 
    schedule: Omit<Schedule, 'id' | 'created_at' | 'updated_at'>
  ) {
    const lessons: Omit<Lesson, 'id' | 'created_at' | 'updated_at'>[] = [];
    const startDate = new Date(schedule.start_date);
    const endDate = schedule.end_date ? new Date(schedule.end_date) : new Date(startDate);
    endDate.setMonth(endDate.getMonth() + 3); // Default to 3 months if no end date

    let currentDate = new Date(startDate);
    let lessonNumber = 1;

    while (currentDate <= endDate) {
      if (this.shouldCreateLesson(currentDate, schedule)) {
        const [hours, minutes] = schedule.default_start_time.split(':').map(Number);
        const startTime = new Date(currentDate);
        startTime.setHours(hours, minutes, 0, 0);
        
        const endTime = new Date(startTime);
        endTime.setMinutes(endTime.getMinutes() + schedule.default_duration_minutes);

        lessons.push({
          schedule_id,
          title: `${schedule.name} - Lesson ${lessonNumber}`,
          date: currentDate.toISOString().split('T')[0],
          start_time: startTime.toTimeString().slice(0, 5),
          end_time: endTime.toTimeString().slice(0, 5),
          duration_minutes: schedule.default_duration_minutes,
          location: schedule.location,
          status: 'scheduled',
          user_id: schedule.user_id
        });

        lessonNumber++;
      }

      // Increment date based on recurrence type
      currentDate = this.getNextLessonDate(currentDate, schedule);
    }

    if (lessons.length > 0) {
      const { error } = await this.supabase
        .from('lessons')
        .insert(lessons);

      if (error) throw error;
    }
  }

  private shouldCreateLesson(date: Date, schedule: any): boolean {
    if (schedule.recurrence_type === 'none') return true;
    
    // const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'lowercase' });
    const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    
    if (schedule.recurrence_days && schedule.recurrence_days.length > 0) {
      return schedule.recurrence_days.includes(dayOfWeek);
    }
    
    return true;
  }

  private getNextLessonDate(currentDate: Date, schedule: any): Date {
    const nextDate = new Date(currentDate);
    
    nextDate.setDate(nextDate.getDate() + 1);
    
    return nextDate;
  }

  // Calendar data transformation
  transformToCalendarEvents(lessons: Lesson[]): any[] {
    // console.log('Transforming lessons to calendar events:', lessons);
    return lessons.map(lesson => {
      const startDateTime = new Date(`${lesson.date}T${lesson.start_time}`);
      const endDateTime = new Date(`${lesson.date}T${lesson.end_time}`);
      
      return {
        id: lesson.id,
        title: lesson.title,
        start: startDateTime,
        end: endDateTime,
        resource: {
          lesson,
          schedule: lesson.schedule
        },
        className: this.getLessonClassName(lesson.status)
      };
    });
  }

  private getLessonClassName(status: string): string {
    switch (status) {
      case 'completed':
        return 'bg-green-100 border-green-300 text-green-800';
      case 'cancelled':
        return 'bg-red-100 border-red-300 text-red-800';
      case 'draft':
        return 'bg-gray-100 border-gray-300 text-gray-800';
      default:
        return 'bg-blue-100 border-blue-300 text-blue-800';
    }
  }

  // Statistics
  async getScheduleStats(schedule_id: string) {
    const { data: lessons, error } = await this.supabase
      .from('lessons')
      .select('status, attendance(status)')
      .eq('schedule_id', schedule_id);

    if (error) throw error;

    const stats = {
      total_lessons: lessons?.length || 0,
      completed_lessons: lessons?.filter(l => l.status === 'completed').length || 0,
      cancelled_lessons: lessons?.filter(l => l.status === 'cancelled').length || 0,
      scheduled_lessons: lessons?.filter(l => l.status === 'scheduled').length || 0,
      attendance_rate: 0
    };

    // Calculate attendance rate
    const allAttendance = lessons?.flatMap(l => l.attendance || []) || [];
    const presentCount = allAttendance.filter(a => a.status === 'present').length;
    if (allAttendance.length > 0) {
      stats.attendance_rate = Math.round((presentCount / allAttendance.length) * 100);
    }

    return stats;
  }
}

export const scheduleService = new ScheduleService();

================
File: src/lib/supabase.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

// This is the client-side Supabase client.
// It's used in client components (hooks, etc.)
export const createSupabaseClient = () => {
  return createClientComponentClient();
};

// We export the type for convenience.
// The server-side client will be created directly in server-side functions.
export type SupabaseClient = ReturnType<typeof createSupabaseClient>;

================
File: src/lib/supabase/books.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Book, ContentType } from '@/types/database';

const supabase = createClientComponentClient();

export interface BookFilters {
  search?: string;
  author?: string;
  categoryId?: string;
  contentType?: ContentType;
  language?: string;
  publicationYear?: number;
  tags?: string[];
  isPublic?: boolean;
}

export interface CreateBookData {
  title: string;
  author?: string;
  isbn?: string;
  publisher?: string;
  publication_year?: number;
  description?: string;
  category_id?: string;
  content_type: ContentType;
  file_url?: string;
  cover_image_url?: string;
  total_pages?: number;
  language: string;
  tags?: string[];
  is_public?: boolean;
}

export interface UpdateBookData extends Partial<CreateBookData> {
  id: string;
}

export const bookService = {
  // Get all books with optional filters
  async getBooks(filters: BookFilters = {}) {
    let query = supabase
      .from('books')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.search) {
      query = query.or(`title.ilike.%${filters.search}%,author.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);
    }
    
    if (filters.author) {
      query = query.ilike('author', `%${filters.author}%`);
    }
    
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.contentType) {
      query = query.eq('content_type', filters.contentType);
    }
    
    if (filters.language) {
      query = query.eq('language', filters.language);
    }
    
    if (filters.publicationYear) {
      query = query.eq('publication_year', filters.publicationYear);
    }
    
    if (filters.isPublic !== undefined) {
      query = query.eq('is_public', filters.isPublic);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Book[];
  },

  // Get single book by ID
  async getBook(id: string) {
    const { data, error } = await supabase
      .from('books')
      .select(`
        *,
        category:categories(id, name, color, icon),
        course_books(
          id,
          course_id,
          is_required,
          notes,
          position,
          course:courses(id, title, status)
        )
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Book;
  },

  // Create new book
  async createBook(bookData: CreateBookData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    // Set default language if not provided
    const dataWithDefaults = {
      ...bookData,
      language: bookData.language || 'en',
      is_public: bookData.is_public || false,
      user_id: user.user.id,
    };

    const { data, error } = await supabase
      .from('books')
      .insert(dataWithDefaults)
      .select()
      .single();
    
    if (error) throw error;
    return data as Book;
  },

  // Update book
  async updateBook({ id, ...bookData }: UpdateBookData) {
    const { data, error } = await supabase
      .from('books')
      .update({
        ...bookData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Book;
  },

  // Delete book
  async deleteBook(id: string) {
    const { error } = await supabase
      .from('books')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Get book statistics
  async getBookStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('books')
      .select('content_type', { count: 'exact' })
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    const stats = {
      total: data?.length || 0,
      text: data?.filter(b => b.content_type === 'text').length || 0,
      video: data?.filter(b => b.content_type === 'video').length || 0,
      audio: data?.filter(b => b.content_type === 'audio').length || 0,
      pdf: data?.filter(b => b.content_type === 'pdf').length || 0,
      other: data?.filter(b => ['image', 'interactive'].includes(b.content_type)).length || 0,
    };

    return stats;
  },

  // Get unique authors
  async getAuthors() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('books')
      .select('author')
      .eq('user_id', user.user.id)
      .not('author', 'is', null);
    
    if (error) throw error;

    // Extract unique authors
    const authors = [...new Set(data?.map(book => book.author).filter(Boolean))].sort();
    return authors;
  },

  // Get unique languages
  async getLanguages() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('books')
      .select('language')
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    // Extract unique languages
    const languages = [...new Set(data?.map(book => book.language).filter(Boolean))].sort();
    return languages;
  },

  // Get content type options
  getContentTypes(): { value: ContentType; label: string; icon?: string }[] {
    return [
      { value: 'text', label: 'Text', icon: '📄' },
      { value: 'pdf', label: 'PDF', icon: '📑' },
      { value: 'video', label: 'Video', icon: '🎥' },
      { value: 'audio', label: 'Audio', icon: '🎧' },
      { value: 'image', label: 'Image', icon: '🖼️' },
      { value: 'interactive', label: 'Interactive', icon: '🎮' },
    ];
  },
};

================
File: src/lib/supabase/categories.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Category } from '@/types/database';

const supabase = createClientComponentClient();

export interface CategoryFilters {
  type?: string;
  parentId?: string | null;
  search?: string;
}

export interface CreateCategoryData {
  name: string;
  description?: string;
  type: string;
  parent_id?: string;
  color?: string;
  icon?: string;
}

export interface UpdateCategoryData extends Partial<CreateCategoryData> {
  id: string;
}

export const categoryService = {
  // Get all categories with optional filters
  async getCategories(filters: CategoryFilters = {}) {
    let query = supabase
      .from('categories')
      .select('*')
      .order('name', { ascending: true });

    // Apply filters
    if (filters.type) {
      query = query.eq('type', filters.type);
    }
    
    if (filters.parentId !== undefined) {
      query = query.eq('parent_id', filters.parentId);
    }
    
    if (filters.search) {
      query = query.ilike('name', `%${filters.search}%`);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Category[];
  },

  // Get single category by ID
  async getCategory(id: string) {
    const { data, error } = await supabase
      .from('categories')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Category;
  },

  // Create new category
  async createCategory(categoryData: CreateCategoryData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('categories')
      .insert({
        ...categoryData,
        user_id: user.user.id,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as Category;
  },

  // Update category
  async updateCategory({ id, ...categoryData }: UpdateCategoryData) {
    const { data, error } = await supabase
      .from('categories')
      .update({
        ...categoryData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Category;
  },

  // Delete category
  async deleteCategory(id: string) {
    const { error } = await supabase
      .from('categories')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Get category types
  getCategoryTypes() {
    return [
      { value: 'course', label: 'Course' },
      { value: 'book', label: 'Book' },
      { value: 'vocabulary', label: 'Vocabulary' },
      { value: 'objective', label: 'Objective' },
      { value: 'method', label: 'Method' },
      { value: 'task', label: 'Task' },
    ];
  },
};

================
File: src/lib/supabase/courses.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Course, CourseStatus, DifficultyLevel } from '@/types/database';

const supabase = createClientComponentClient();

export interface CourseFilters {
  status?: CourseStatus;
  difficulty?: DifficultyLevel;
  categoryId?: string;
  search?: string;
  isPublic?: boolean;
  tags?: string[];
}

export interface CreateCourseData {
  title: string;
  description?: string;
  short_description?: string;
  category_id?: string;
  status?: CourseStatus;
  difficulty?: DifficultyLevel;
  duration_hours?: number;
  objectives?: string[];
  prerequisites?: string[];
  tags?: string[];
  thumbnail_url?: string;
  is_public?: boolean;
}

export interface UpdateCourseData extends Partial<CreateCourseData> {
  id: string;
}

export const courseService = {
  // Get all courses with optional filters
  async getCourses(filters: CourseFilters = {}) {
    let query = supabase
      .from('courses')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.status) {
      query = query.eq('status', filters.status);
    }
    
    if (filters.difficulty) {
      query = query.eq('difficulty', filters.difficulty);
    }
    
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.isPublic !== undefined) {
      query = query.eq('is_public', filters.isPublic);
    }
    
    if (filters.search) {
      query = query.or(`title.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Course[];
  },

  // Get single course by ID
  async getCourse(id: string) {
    const { data, error } = await supabase
      .from('courses')
      .select(`
        *,
        category:categories(id, name, color, icon),
        course_books(
          id,
          book_id,
          is_required,
          notes,
          position,
          book:books(id, title, author, cover_image_url)
        ),
        course_vocabulary_groups(
          id,
          vocabulary_group_id,
          position,
          vocabulary_group:vocabulary_groups(id, name, language, difficulty)
        )
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Course;
  },

  // Create new course
  async createCourse(courseData: CreateCourseData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('courses')
      .insert({
        ...courseData,
        user_id: user.user.id,
        status: courseData.status || 'draft',
        difficulty: courseData.difficulty || 'beginner',
        is_public: courseData.is_public || false,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as Course;
  },

  // Update course
  async updateCourse({ id, ...courseData }: UpdateCourseData) {
    const { data, error } = await supabase
      .from('courses')
      .update({
        ...courseData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Course;
  },

  // Delete course
  async deleteCourse(id: string) {
    const { error } = await supabase
      .from('courses')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Publish course
  async publishCourse(id: string) {
    const { data, error } = await supabase
      .from('courses')
      .update({
        status: 'published' as CourseStatus,
        published_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Course;
  },

  // Archive course
  async archiveCourse(id: string) {
    const { data, error } = await supabase
      .from('courses')
      .update({
        status: 'archived' as CourseStatus,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Course;
  },

  // Get course statistics
  async getCourseStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('courses')
      .select('status', { count: 'exact' })
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    const stats = {
      total: data?.length || 0,
      draft: data?.filter(c => c.status === 'draft').length || 0,
      published: data?.filter(c => c.status === 'published').length || 0,
      archived: data?.filter(c => c.status === 'archived').length || 0,
    };

    return stats;
  },
};

================
File: src/lib/supabase/lessons.ts
================
// src/lib/supabase/lessons.ts

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import type {
  Lesson,
  Attendance,
  AttendanceStatus
} from '@/types/schedule';
import type { LessonStatus } from '@/types/database';

const supabase = createClientComponentClient();

export interface LessonFilters {
  schedule_id?: string;
  status?: LessonStatus;
  date_from?: string;
  date_to?: string;
  user_id?: string;
}

export interface CreateLessonData
  extends Omit<Lesson, 'id' | 'created_at' | 'updated_at'> {}

export interface UpdateLessonData extends Partial<CreateLessonData> {
  id: string;
}

export interface CreateAttendanceData
  extends Omit<Attendance, 'id' | 'marked_at'> {}

export const lessonService = {
  /**
   * Get all lessons with optional filters.
   */
  async getLessons(filters: LessonFilters = {}) {
    let query = supabase
      .from('lessons')
      .select(
        `
        *,
        schedule:schedules(id, name, course:courses(id, title))
      `
      )
      .order('date', { ascending: true })
      .order('start_time', { ascending: true });

    if (filters.schedule_id) {
      query = query.eq('schedule_id', filters.schedule_id);
    }
    if (filters.status) {
      query = query.eq('status', filters.status);
    }
    if (filters.date_from) {
      query = query.gte('date', filters.date_from);
    }
    if (filters.date_to) {
      query = query.lte('date', filters.date_to);
    }
    if (filters.user_id) {
      query = query.eq('user_id', filters.user_id);
    }

    const { data, error } = await query;
    if (error) throw error;
    return data as Lesson[];
  },

  /**
   * Get all lessons for a specific schedule.
   */
  async getScheduleLessons(scheduleId: string) {
    const { data, error } = await supabase
      .from('lessons')
      .select('*')
      .eq('schedule_id', scheduleId)
      .order('date', { ascending: true })
      .order('start_time', { ascending: true });

    if (error) throw error;
    return data as Lesson[];
  },

  /**
   * Get a single lesson by its ID, including all related content.
   */
  async getLesson(id: string) {
    const { data, error } = await supabase
      .from('lessons')
      .select(
        `
        *,
        schedule:schedules(*, course:courses(*)),
        objectives:lesson_objectives(*, objective:objectives(*)),
        methods:lesson_methods(*, method:methods(*)),
        tasks:lesson_tasks(*, task:tasks(*)),
        books:lesson_books(*, book:books(*)),
        vocabulary:lesson_vocabulary(*, vocabulary:vocabulary(*)),
        attendance(*)
      `
      )
      .eq('id', id)
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Create a new lesson.
   */
  async createLesson(lessonData: CreateLessonData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('lessons')
      .insert({ ...lessonData, user_id: user.user.id })
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Update an existing lesson.
   */
  async updateLesson(id: string, lessonData: Partial<UpdateLessonData>) {
    const { data, error } = await supabase
      .from('lessons')
      .update({ ...lessonData, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Delete a lesson.
   */
  async deleteLesson(id: string) {
    const { error } = await supabase.from('lessons').delete().eq('id', id);
    if (error) throw error;
  },

  // ==================== ATTENDANCE ====================

  /**
   * Get all attendance records for a specific lesson.
   */
  async getAttendance(lesson_id: string) {
    const { data, error } = await supabase
      .from('attendance')
      .select('*')
      .eq('lesson_id', lesson_id)
      .order('student_name');

    if (error) throw error;
    return data;
  },

  /**
   * Mark (create or update) a single attendance record.
   */
  async markAttendance(attendanceData: CreateAttendanceData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('attendance')
      .upsert({
        ...attendanceData,
        marked_at: new Date().toISOString(),
        marked_by: user.user.id,
      })
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Mark attendance for multiple students at once.
   */
  async bulkMarkAttendance(
    lesson_id: string,
    attendances: Omit<Attendance, 'id' | 'lesson_id' | 'marked_at' | 'marked_by'>[]
  ) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const records = attendances.map((a) => ({
      ...a,
      lesson_id,
      marked_at: new Date().toISOString(),
      marked_by: user.user.id,
    }));

    const { data, error } = await supabase.from('attendance').upsert(records).select();

    if (error) throw error;
    return data;
  },
};

================
File: src/lib/supabase/methods.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Method } from '@/types/database';

const supabase = createClientComponentClient();

export interface MethodFilters {
  categoryId?: string;
  durationMin?: number;
  durationMax?: number;
  groupSizeMin?: number;
  groupSizeMax?: number;
  isTemplate?: boolean;
  search?: string;
  tags?: string[];
}

export interface CreateMethodData {
  name: string;
  description?: string;
  category_id?: string;
  instructions?: string;
  duration_minutes?: number;
  group_size_min?: number;
  group_size_max?: number;
  materials_needed?: string[];
  tags?: string[];
  is_template?: boolean;
}

export interface UpdateMethodData extends Partial<CreateMethodData> {
  id: string;
}

export const methodService = {
  // Get all methods with optional filters
  async getMethods(filters: MethodFilters = {}) {
    let query = supabase
      .from('methods')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.durationMin !== undefined) {
      query = query.gte('duration_minutes', filters.durationMin);
    }
    
    if (filters.durationMax !== undefined) {
      query = query.lte('duration_minutes', filters.durationMax);
    }
    
    if (filters.groupSizeMin !== undefined) {
      query = query.gte('group_size_min', filters.groupSizeMin);
    }
    
    if (filters.groupSizeMax !== undefined) {
      query = query.lte('group_size_max', filters.groupSizeMax);
    }
    
    if (filters.isTemplate !== undefined) {
      query = query.eq('is_template', filters.isTemplate);
    }
    
    if (filters.search) {
      query = query.or(`name.ilike.%${filters.search}%,description.ilike.%${filters.search}%,instructions.ilike.%${filters.search}%`);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Method[];
  },

  // Get single method by ID
  async getMethod(id: string) {
    const { data, error } = await supabase
      .from('methods')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Method;
  },

  // Create new method
  async createMethod(methodData: CreateMethodData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('methods')
      .insert({
        ...methodData,
        user_id: user.user.id,
        group_size_min: methodData.group_size_min ?? 1,
        is_template: methodData.is_template ?? false,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as Method;
  },

  // Update method
  async updateMethod({ id, ...methodData }: UpdateMethodData) {
    const { data, error } = await supabase
      .from('methods')
      .update({
        ...methodData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Method;
  },

  // Delete method
  async deleteMethod(id: string) {
    const { error } = await supabase
      .from('methods')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Get methods by category
  async getMethodsByCategory(categoryId: string) {
    const { data, error } = await supabase
      .from('methods')
      .select('*')
      .eq('category_id', categoryId)
      .order('name', { ascending: true });
    
    if (error) throw error;
    return data as Method[];
  },

  // Get template methods
  async getTemplateMethods() {
    const { data, error } = await supabase
      .from('methods')
      .select('*')
      .eq('is_template', true)
      .order('name', { ascending: true });
    
    if (error) throw error;
    return data as Method[];
  },

  // Get methods by duration range
  async getMethodsByDuration(minMinutes: number, maxMinutes: number) {
    const { data, error } = await supabase
      .from('methods')
      .select('*')
      .gte('duration_minutes', minMinutes)
      .lte('duration_minutes', maxMinutes)
      .order('duration_minutes', { ascending: true });
    
    if (error) throw error;
    return data as Method[];
  },

  // Get methods by group size
  async getMethodsByGroupSize(groupSize: number) {
    const { data, error } = await supabase
      .from('methods')
      .select('*')
      .lte('group_size_min', groupSize)
      .or(`group_size_max.gte.${groupSize},group_size_max.is.null`)
      .order('name', { ascending: true });
    
    if (error) throw error;
    return data as Method[];
  },

  // Clone method as template
  async cloneAsTemplate(id: string, newName?: string) {
    const original = await this.getMethod(id);
    
    return this.createMethod({
      name: newName || `${original.name} (Template)`,
      description: original.description,
      category_id: original.category_id,
      instructions: original.instructions,
      duration_minutes: original.duration_minutes,
      group_size_min: original.group_size_min,
      group_size_max: original.group_size_max,
      materials_needed: original.materials_needed,
      tags: original.tags,
      is_template: true,
    });
  },

  // Get method statistics
  async getMethodStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('methods')
      .select('duration_minutes, group_size_min, group_size_max, is_template', { count: 'exact' })
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    const stats = {
      total: data?.length || 0,
      templates: data?.filter(m => m.is_template).length || 0,
      averageDuration: data?.length ? 
        Math.round(data.reduce((sum, m) => sum + (m.duration_minutes || 0), 0) / data.length) : 0,
      byDurationRange: {
        short: data?.filter(m => (m.duration_minutes || 0) <= 15).length || 0, // 0-15 mins
        medium: data?.filter(m => (m.duration_minutes || 0) > 15 && (m.duration_minutes || 0) <= 45).length || 0, // 16-45 mins
        long: data?.filter(m => (m.duration_minutes || 0) > 45).length || 0, // 45+ mins
      },
      byGroupSize: {
        individual: data?.filter(m => (m.group_size_min || 1) === 1 && (m.group_size_max || 1) === 1).length || 0,
        small: data?.filter(m => (m.group_size_min || 1) <= 5 && (m.group_size_max || 100) > 1).length || 0,
        large: data?.filter(m => (m.group_size_min || 1) > 5).length || 0,
      },
    };

    return stats;
  },

  // Get popular materials
  async getPopularMaterials(limit: number = 10) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('methods')
      .select('materials_needed')
      .eq('user_id', user.user.id)
      .not('materials_needed', 'is', null);
    
    if (error) throw error;

    // Flatten and count materials
    const materialCounts: Record<string, number> = {};
    data?.forEach(method => {
      method.materials_needed?.forEach(material => {
        materialCounts[material] = (materialCounts[material] || 0) + 1;
      });
    });

    // Sort by count and return top items
    return Object.entries(materialCounts)
      .sort(([,a], [,b]) => b - a)
      .slice(0, limit)
      .map(([material, count]) => ({ material, count }));
  },
};

================
File: src/lib/supabase/objectives.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Objective } from '@/types/database';

const supabase = createClientComponentClient();

export interface ObjectiveFilters {
  categoryId?: string;
  bloomLevel?: string;
  measurable?: boolean;
  isTemplate?: boolean;
  search?: string;
  tags?: string[];
}

export interface CreateObjectiveData {
  title: string;
  description?: string;
  category_id?: string;
  bloom_level?: string;
  measurable?: boolean;
  tags?: string[];
  is_template?: boolean;
}

export interface UpdateObjectiveData extends Partial<CreateObjectiveData> {
  id: string;
}

export const objectiveService = {
  // Get all objectives with optional filters
  async getObjectives(filters: ObjectiveFilters = {}) {
    let query = supabase
      .from('objectives')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.bloomLevel) {
      query = query.eq('bloom_level', filters.bloomLevel);
    }
    
    if (filters.measurable !== undefined) {
      query = query.eq('measurable', filters.measurable);
    }
    
    if (filters.isTemplate !== undefined) {
      query = query.eq('is_template', filters.isTemplate);
    }
    
    if (filters.search) {
      query = query.or(`title.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Objective[];
  },

  // Get single objective by ID
  async getObjective(id: string) {
    const { data, error } = await supabase
      .from('objectives')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Objective;
  },

  // Create new objective
  async createObjective(objectiveData: CreateObjectiveData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('objectives')
      .insert({
        ...objectiveData,
        user_id: user.user.id,
        measurable: objectiveData.measurable ?? true,
        is_template: objectiveData.is_template ?? false,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as Objective;
  },

  // Update objective
  async updateObjective({ id, ...objectiveData }: UpdateObjectiveData) {
    const { data, error } = await supabase
      .from('objectives')
      .update({
        ...objectiveData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Objective;
  },

  // Delete objective
  async deleteObjective(id: string) {
    const { error } = await supabase
      .from('objectives')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Get Bloom's taxonomy levels
  getBloomLevels() {
    return [
      { value: 'remember', label: 'Remember' },
      { value: 'understand', label: 'Understand' },
      { value: 'apply', label: 'Apply' },
      { value: 'analyze', label: 'Analyze' },
      { value: 'evaluate', label: 'Evaluate' },
      { value: 'create', label: 'Create' },
    ];
  },

  // Get objectives by category
  async getObjectivesByCategory(categoryId: string) {
    const { data, error } = await supabase
      .from('objectives')
      .select('*')
      .eq('category_id', categoryId)
      .order('title', { ascending: true });
    
    if (error) throw error;
    return data as Objective[];
  },

  // Get template objectives
  async getTemplateObjectives() {
    const { data, error } = await supabase
      .from('objectives')
      .select('*')
      .eq('is_template', true)
      .order('title', { ascending: true });
    
    if (error) throw error;
    return data as Objective[];
  },

  // Clone objective as template
  async cloneAsTemplate(id: string, newTitle?: string) {
    const original = await this.getObjective(id);
    
    return this.createObjective({
      title: newTitle || `${original.title} (Template)`,
      description: original.description,
      category_id: original.category_id,
      bloom_level: original.bloom_level,
      measurable: original.measurable,
      tags: original.tags,
      is_template: true,
    });
  },

  // Get objective statistics
  async getObjectiveStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('objectives')
      .select('bloom_level, is_template', { count: 'exact' })
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    const stats = {
      total: data?.length || 0,
      templates: data?.filter(o => o.is_template).length || 0,
      byBloomLevel: {
        remember: data?.filter(o => o.bloom_level === 'remember').length || 0,
        understand: data?.filter(o => o.bloom_level === 'understand').length || 0,
        apply: data?.filter(o => o.bloom_level === 'apply').length || 0,
        analyze: data?.filter(o => o.bloom_level === 'analyze').length || 0,
        evaluate: data?.filter(o => o.bloom_level === 'evaluate').length || 0,
        create: data?.filter(o => o.bloom_level === 'create').length || 0,
      },
    };

    return stats;
  },
};

================
File: src/lib/supabase/schedules.ts
================
// src/lib/supabase/schedules.ts

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import {
  Schedule,
  Lesson,
  RecurrenceType,
  DayOfWeek,
} from '@/types/schedule';
import { Course } from '@/types/database';

const supabase = createClientComponentClient();

export interface ScheduleFilters {
  course_id?: string;
  is_active?: boolean;
  user_id?: string;
}

export interface CreateScheduleData
  extends Omit<Schedule, 'id' | 'created_at' | 'updated_at' | 'course'> {}

export interface UpdateScheduleData extends Partial<CreateScheduleData> {
  id: string;
}

/**
 * Generates lessons for a recurring schedule.
 * @param schedule_id - The ID of the schedule.
 * @param schedule - The schedule data.
 */
async function generateRecurringLessons(
  schedule_id: string,
  schedule: Omit<Schedule, 'id' | 'created_at' | 'updated_at'>
) {
  const lessons: Omit<Lesson, 'id' | 'created_at' | 'updated_at'>[] = [];
  const startDate = new Date(`${schedule.start_date}T00:00:00Z`);
  const endDate = schedule.end_date
    ? new Date(`${schedule.end_date}T00:00:00Z`)
    : new Date(startDate.getFullYear() + 1, startDate.getMonth(), startDate.getDate());

  let currentDate = new Date(startDate);
  let lessonNumber = 1;
  const dayMap: DayOfWeek[] = [
    'sunday',
    'monday',
    'tuesday',
    'wednesday',
    'thursday',
    'friday',
    'saturday',
  ];

  while (currentDate <= endDate) {
    const dayOfWeek = dayMap[currentDate.getUTCDay()];
    if (schedule.recurrence_days?.includes(dayOfWeek)) {
      const [hours, minutes] = schedule.default_start_time.split(':').map(Number);
      const lessonStartTime = new Date(currentDate);
      lessonStartTime.setUTCHours(hours, minutes, 0, 0);

      const lessonEndTime = new Date(lessonStartTime);
      lessonEndTime.setUTCMinutes(
        lessonStartTime.getUTCMinutes() + schedule.default_duration_minutes
      );

      lessons.push({
        schedule_id,
        user_id: schedule.user_id,
        title: `${schedule.name} - Lesson ${lessonNumber}`,
        date: currentDate.toISOString().split('T')[0],
        start_time: lessonStartTime.toUTCString().slice(17, 22),
        end_time: lessonEndTime.toUTCString().slice(17, 22),
        duration_minutes: schedule.default_duration_minutes,
        location: schedule.location,
        status: 'scheduled',
      });
      lessonNumber++;
    }

    // Move to the next day
    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
  }

  if (lessons.length > 0) {
    const { error } = await supabase.from('lessons').insert(lessons);
    if (error) throw error;
  }
}

export const scheduleService = {
  /**
   * Get all schedules with optional filters.
   */
  async getSchedules(filters: ScheduleFilters = {}) {
    let query = supabase
      .from('schedules')
      .select(
        `
        *,
        course:courses(id, title),
        lessons(count)
      `
      )
      .order('created_at', { ascending: false });

    if (filters.course_id) {
      query = query.eq('course_id', filters.course_id);
    }
    if (filters.is_active !== undefined) {
      query = query.eq('is_active', filters.is_active);
    }
    if (filters.user_id) {
      query = query.eq('user_id', filters.user_id);
    }

    const { data, error } = await query;
    if (error) throw error;
    return data;
  },

  /**
   * Get a single schedule by its ID.
   */
  async getSchedule(id: string) {
    const { data, error } = await supabase
      .from('schedules')
      .select(
        `
        *,
        course:courses(*),
        lessons(*)
      `
      )
      .eq('id', id)
      .single();
    if (error) throw error;
    return data;
  },

  /**
   * Create a new schedule and generate recurring lessons if applicable.
   */
  async createSchedule(scheduleData: CreateScheduleData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('schedules')
      .insert({ ...scheduleData, user_id: user.user.id })
      .select()
      .single();

    if (error) throw error;

    if (data && scheduleData.recurrence_type !== 'none') {
      await generateRecurringLessons(data.id, { ...scheduleData, user_id: user.user.id });
    }

    return data;
  },

  /**
   * Update an existing schedule.
   */
  async updateSchedule(id: string, scheduleData: Partial<UpdateScheduleData>) {
    const { data, error } = await supabase
      .from('schedules')
      .update({ ...scheduleData, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select()
      .single();
    if (error) throw error;
    return data;
  },

  /**
   * Delete a schedule and its associated lessons.
   */
  async deleteSchedule(id: string) {
    const { error } = await supabase.from('schedules').delete().eq('id', id);
    if (error) throw error;
  },
};

================
File: src/lib/supabase/tasks.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Task, DifficultyLevel } from '@/types/database';

const supabase = createClientComponentClient();

export interface TaskFilters {
  categoryId?: string;
  difficulty?: DifficultyLevel;
  durationMin?: number;
  durationMax?: number;
  isTemplate?: boolean;
  search?: string;
  tags?: string[];
}

export interface CreateTaskData {
  title: string;
  description?: string;
  category_id?: string;
  instructions?: string;
  duration_minutes?: number;
  difficulty?: DifficultyLevel;
  materials_needed?: string[];
  assessment_criteria?: string;
  tags?: string[];
  is_template?: boolean;
}

export interface UpdateTaskData extends Partial<CreateTaskData> {
  id: string;
}

export const taskService = {
  // Get all tasks with optional filters
  async getTasks(filters: TaskFilters = {}) {
    let query = supabase
      .from('tasks')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.difficulty) {
      query = query.eq('difficulty', filters.difficulty);
    }
    
    if (filters.durationMin !== undefined) {
      query = query.gte('duration_minutes', filters.durationMin);
    }
    
    if (filters.durationMax !== undefined) {
      query = query.lte('duration_minutes', filters.durationMax);
    }
    
    if (filters.isTemplate !== undefined) {
      query = query.eq('is_template', filters.isTemplate);
    }
    
    if (filters.search) {
      query = query.or(`title.ilike.%${filters.search}%,description.ilike.%${filters.search}%,instructions.ilike.%${filters.search}%`);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Task[];
  },

  // Get single task by ID
  async getTask(id: string) {
    const { data, error } = await supabase
      .from('tasks')
      .select(`
        *,
        category:categories(id, name, color, icon)
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Task;
  },

  // Create new task
  async createTask(taskData: CreateTaskData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('tasks')
      .insert({
        ...taskData,
        user_id: user.user.id,
        difficulty: taskData.difficulty ?? 'beginner',
        is_template: taskData.is_template ?? false,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as Task;
  },

  // Update task
  async updateTask({ id, ...taskData }: UpdateTaskData) {
    const { data, error } = await supabase
      .from('tasks')
      .update({
        ...taskData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Task;
  },

  // Delete task
  async deleteTask(id: string) {
    const { error } = await supabase
      .from('tasks')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // Get tasks by category
  async getTasksByCategory(categoryId: string) {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('category_id', categoryId)
      .order('title', { ascending: true });
    
    if (error) throw error;
    return data as Task[];
  },

  // Get template tasks
  async getTemplateTasks() {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('is_template', true)
      .order('title', { ascending: true });
    
    if (error) throw error;
    return data as Task[];
  },

  // Get tasks by difficulty
  async getTasksByDifficulty(difficulty: DifficultyLevel) {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('difficulty', difficulty)
      .order('title', { ascending: true });
    
    if (error) throw error;
    return data as Task[];
  },

  // Get tasks by duration range
  async getTasksByDuration(minMinutes: number, maxMinutes: number) {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .gte('duration_minutes', minMinutes)
      .lte('duration_minutes', maxMinutes)
      .order('duration_minutes', { ascending: true });
    
    if (error) throw error;
    return data as Task[];
  },

  // Clone task as template
  async cloneAsTemplate(id: string, newTitle?: string) {
    const original = await this.getTask(id);
    
    return this.createTask({
      title: newTitle || `${original.title} (Template)`,
      description: original.description,
      category_id: original.category_id,
      instructions: original.instructions,
      duration_minutes: original.duration_minutes,
      difficulty: original.difficulty,
      materials_needed: original.materials_needed,
      assessment_criteria: original.assessment_criteria,
      tags: original.tags,
      is_template: true,
    });
  },

  // Get task statistics
  async getTaskStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('tasks')
      .select('difficulty, duration_minutes, is_template', { count: 'exact' })
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    const stats = {
      total: data?.length || 0,
      templates: data?.filter(t => t.is_template).length || 0,
      averageDuration: data?.length ? 
        Math.round(data.reduce((sum, t) => sum + (t.duration_minutes || 0), 0) / data.length) : 0,
      byDifficulty: {
        beginner: data?.filter(t => t.difficulty === 'beginner').length || 0,
        intermediate: data?.filter(t => t.difficulty === 'intermediate').length || 0,
        advanced: data?.filter(t => t.difficulty === 'advanced').length || 0,
        expert: data?.filter(t => t.difficulty === 'expert').length || 0,
      },
      byDurationRange: {
        short: data?.filter(t => (t.duration_minutes || 0) <= 15).length || 0, // 0-15 mins
        medium: data?.filter(t => (t.duration_minutes || 0) > 15 && (t.duration_minutes || 0) <= 45).length || 0, // 16-45 mins
        long: data?.filter(t => (t.duration_minutes || 0) > 45).length || 0, // 45+ mins
      },
    };

    return stats;
  },

  // Get popular materials for tasks
  async getPopularMaterials(limit: number = 10) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('tasks')
      .select('materials_needed')
      .eq('user_id', user.user.id)
      .not('materials_needed', 'is', null);
    
    if (error) throw error;

    // Flatten and count materials
    const materialCounts: Record<string, number> = {};
    data?.forEach(task => {
      task.materials_needed?.forEach(material => {
        materialCounts[material] = (materialCounts[material] || 0) + 1;
      });
    });

    // Sort by count and return top items
    return Object.entries(materialCounts)
      .sort(([,a], [,b]) => b - a)
      .slice(0, limit)
      .map(([material, count]) => ({ material, count }));
  },

  // Get tasks suitable for specific lesson duration
  async getTasksForLessonDuration(lessonDurationMinutes: number, bufferMinutes: number = 5) {
    const maxTaskDuration = lessonDurationMinutes - bufferMinutes;
    
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .lte('duration_minutes', maxTaskDuration)
      .order('duration_minutes', { ascending: false });
    
    if (error) throw error;
    return data as Task[];
  },

  // Get assessment rubric suggestions
  getAssessmentCriteriaSuggestions() {
    return [
      'Accuracy of completion',
      'Time management',
      'Following instructions',
      'Creativity and innovation',
      'Collaboration and teamwork',
      'Communication skills',
      'Problem-solving approach',
      'Quality of final product',
      'Use of resources',
      'Reflection and self-assessment',
    ];
  },

  // Get difficulty level descriptions
  getDifficultyDescriptions() {
    return {
      beginner: 'Basic concepts, minimal prior knowledge required',
      intermediate: 'Some familiarity with topic, moderate complexity',
      advanced: 'Strong foundation required, complex problem-solving',
      expert: 'Mastery level, highly complex and nuanced tasks',
    };
  },
};

================
File: src/lib/supabase/vocabulary.ts
================
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Vocabulary, VocabularyGroup, VocabularyGroupItem, DifficultyLevel } from '@/types/database';

const supabase = createClientComponentClient();

export interface VocabularyFilters {
  search?: string;
  difficulty?: DifficultyLevel;
  partOfSpeech?: string;
  tags?: string[];
  groupId?: string;
}

export interface VocabularyGroupFilters {
  search?: string;
  difficulty?: DifficultyLevel;
  language?: string;
  targetLanguage?: string;
  categoryId?: string;
  tags?: string[];
  isPublic?: boolean;
}

export interface CreateVocabularyData {
  word: string;
  translation?: string;
  pronunciation?: string;
  part_of_speech?: string;
  definition?: string;
  example_sentence?: string;
  example_translation?: string;
  notes?: string;
  difficulty: DifficultyLevel;
  audio_url?: string;
  image_url?: string;
  tags?: string[];
}

export interface UpdateVocabularyData extends Partial<CreateVocabularyData> {
  id: string;
}

export interface CreateVocabularyGroupData {
  name: string;
  description?: string;
  category_id?: string;
  language: string;
  target_language?: string;
  difficulty: DifficultyLevel;
  tags?: string[];
  is_public?: boolean;
}

export interface UpdateVocabularyGroupData extends Partial<CreateVocabularyGroupData> {
  id: string;
}

export const vocabularyService = {
  // ==================== VOCABULARY ITEMS ====================
  
  // Get all vocabulary items with optional filters
  async getVocabulary(filters: VocabularyFilters = {}) {
    let query = supabase
      .from('vocabulary')
      .select('*')
      .order('word', { ascending: true });

    // Apply filters
    if (filters.search) {
      query = query.or(`word.ilike.%${filters.search}%,translation.ilike.%${filters.search}%,definition.ilike.%${filters.search}%`);
    }
    
    if (filters.difficulty) {
      query = query.eq('difficulty', filters.difficulty);
    }
    
    if (filters.partOfSpeech) {
      query = query.eq('part_of_speech', filters.partOfSpeech);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    return data as Vocabulary[];
  },

  // Get vocabulary items in a specific group
  async getVocabularyInGroup(groupId: string) {
    const { data, error } = await supabase
      .from('vocabulary_group_items')
      .select(`
        *,
        vocabulary(*)
      `)
      .eq('vocabulary_group_id', groupId)
      .order('position', { ascending: true });
    
    if (error) throw error;
    return data as (VocabularyGroupItem & { vocabulary: Vocabulary })[];
  },

  // Get single vocabulary item by ID
  async getVocabularyItem(id: string) {
    const { data, error } = await supabase
      .from('vocabulary')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as Vocabulary;
  },

  // Create new vocabulary item
  async createVocabulary(vocabularyData: CreateVocabularyData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const dataWithDefaults = {
      ...vocabularyData,
      difficulty: vocabularyData.difficulty || 'beginner' as DifficultyLevel,
      user_id: user.user.id,
    };

    const { data, error } = await supabase
      .from('vocabulary')
      .insert(dataWithDefaults)
      .select()
      .single();
    
    if (error) throw error;
    return data as Vocabulary;
  },

  // Update vocabulary item
  async updateVocabulary({ id, ...vocabularyData }: UpdateVocabularyData) {
    const { data, error } = await supabase
      .from('vocabulary')
      .update({
        ...vocabularyData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as Vocabulary;
  },

  // Delete vocabulary item
  async deleteVocabulary(id: string) {
    const { error } = await supabase
      .from('vocabulary')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // ==================== VOCABULARY GROUPS ====================
  
  // Get all vocabulary groups with optional filters
  async getVocabularyGroups(filters: VocabularyGroupFilters = {}) {
    let query = supabase
      .from('vocabulary_groups')
      .select(`
        *,
        category:categories(id, name, color, icon),
        vocabulary_group_items(count)
      `)
      .order('created_at', { ascending: false });

    // Apply filters
    if (filters.search) {
      query = query.or(`name.ilike.%${filters.search}%,description.ilike.%${filters.search}%`);
    }
    
    if (filters.difficulty) {
      query = query.eq('difficulty', filters.difficulty);
    }
    
    if (filters.language) {
      query = query.eq('language', filters.language);
    }
    
    if (filters.targetLanguage) {
      query = query.eq('target_language', filters.targetLanguage);
    }
    
    if (filters.categoryId) {
      query = query.eq('category_id', filters.categoryId);
    }
    
    if (filters.isPublic !== undefined) {
      query = query.eq('is_public', filters.isPublic);
    }
    
    if (filters.tags && filters.tags.length > 0) {
      query = query.contains('tags', filters.tags);
    }

    const { data, error } = await query;
    
    if (error) throw error;
    
    // Add vocabulary count to each group
    const groupsWithCount = data?.map(group => ({
      ...group,
      vocabulary_count: group.vocabulary_group_items?.[0]?.count || 0
    })) || [];
    
    return groupsWithCount as (VocabularyGroup & { vocabulary_count: number })[];
  },

  // Get single vocabulary group by ID
  async getVocabularyGroup(id: string) {
    const { data, error } = await supabase
      .from('vocabulary_groups')
      .select(`
        *,
        category:categories(id, name, color, icon),
        vocabulary_group_items(
          *,
          vocabulary(*)
        )
      `)
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data as VocabularyGroup & { vocabulary_group_items: (VocabularyGroupItem & { vocabulary: Vocabulary })[] };
  },

  // Create new vocabulary group
  async createVocabularyGroup(groupData: CreateVocabularyGroupData) {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const dataWithDefaults = {
      ...groupData,
      language: groupData.language || 'en',
      difficulty: groupData.difficulty || 'beginner' as DifficultyLevel,
      is_public: groupData.is_public || false,
      user_id: user.user.id,
    };

    const { data, error } = await supabase
      .from('vocabulary_groups')
      .insert(dataWithDefaults)
      .select()
      .single();
    
    if (error) throw error;
    return data as VocabularyGroup;
  },

  // Update vocabulary group
  async updateVocabularyGroup({ id, ...groupData }: UpdateVocabularyGroupData) {
    const { data, error } = await supabase
      .from('vocabulary_groups')
      .update({
        ...groupData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data as VocabularyGroup;
  },

  // Delete vocabulary group
  async deleteVocabularyGroup(id: string) {
    const { error } = await supabase
      .from('vocabulary_groups')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  },

  // ==================== GROUP MEMBERSHIP ====================
  
  // Add vocabulary item to group
  async addVocabularyToGroup(vocabularyId: string, groupId: string, position?: number) {
    // Get current max position if not provided
    if (position === undefined) {
      const { data: items } = await supabase
        .from('vocabulary_group_items')
        .select('position')
        .eq('vocabulary_group_id', groupId)
        .order('position', { ascending: false })
        .limit(1);
      
      position = items && items.length > 0 ? items[0].position + 1 : 0;
    }

    const { data, error } = await supabase
      .from('vocabulary_group_items')
      .insert({
        vocabulary_group_id: groupId,
        vocabulary_id: vocabularyId,
        position: position,
      })
      .select()
      .single();
    
    if (error) throw error;
    return data as VocabularyGroupItem;
  },

  // Remove vocabulary item from group
  async removeVocabularyFromGroup(vocabularyId: string, groupId: string) {
    const { error } = await supabase
      .from('vocabulary_group_items')
      .delete()
      .eq('vocabulary_group_id', groupId)
      .eq('vocabulary_id', vocabularyId);
    
    if (error) throw error;
  },

  // Update vocabulary position in group
  async updateVocabularyPosition(vocabularyId: string, groupId: string, newPosition: number) {
    const { data, error } = await supabase
      .from('vocabulary_group_items')
      .update({ position: newPosition })
      .eq('vocabulary_group_id', groupId)
      .eq('vocabulary_id', vocabularyId)
      .select()
      .single();
    
    if (error) throw error;
    return data as VocabularyGroupItem;
  },

  // ==================== STATISTICS ====================
  
  // Get vocabulary statistics
  async getVocabularyStats() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const [vocabularyData, groupsData] = await Promise.all([
      supabase
        .from('vocabulary')
        .select('difficulty', { count: 'exact' })
        .eq('user_id', user.user.id),
      supabase
        .from('vocabulary_groups')
        .select('difficulty', { count: 'exact' })
        .eq('user_id', user.user.id),
    ]);
    
    if (vocabularyData.error) throw vocabularyData.error;
    if (groupsData.error) throw groupsData.error;

    const vocabularyStats = {
      total: vocabularyData.data?.length || 0,
      beginner: vocabularyData.data?.filter(v => v.difficulty === 'beginner').length || 0,
      intermediate: vocabularyData.data?.filter(v => v.difficulty === 'intermediate').length || 0,
      advanced: vocabularyData.data?.filter(v => v.difficulty === 'advanced').length || 0,
      expert: vocabularyData.data?.filter(v => v.difficulty === 'expert').length || 0,
    };

    const groupStats = {
      total: groupsData.data?.length || 0,
      beginner: groupsData.data?.filter(g => g.difficulty === 'beginner').length || 0,
      intermediate: groupsData.data?.filter(g => g.difficulty === 'intermediate').length || 0,
      advanced: groupsData.data?.filter(g => g.difficulty === 'advanced').length || 0,
      expert: groupsData.data?.filter(g => g.difficulty === 'expert').length || 0,
    };

    return { vocabulary: vocabularyStats, groups: groupStats };
  },

  // Get unique part of speech values
  async getPartsOfSpeech() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('vocabulary')
      .select('part_of_speech')
      .eq('user_id', user.user.id)
      .not('part_of_speech', 'is', null);
    
    if (error) throw error;

    // Extract unique parts of speech
    const partsOfSpeech = [...new Set(data?.map(vocab => vocab.part_of_speech).filter(Boolean))].sort();
    return partsOfSpeech;
  },

  // Get unique languages used in vocabulary groups
  async getLanguages() {
    const { data: user } = await supabase.auth.getUser();
    if (!user.user) throw new Error('User not authenticated');

    const { data, error } = await supabase
      .from('vocabulary_groups')
      .select('language, target_language')
      .eq('user_id', user.user.id);
    
    if (error) throw error;

    // Extract unique languages
    const languages = new Set<string>();
    data?.forEach(group => {
      if (group.language) languages.add(group.language);
      if (group.target_language) languages.add(group.target_language);
    });

    return Array.from(languages).sort();
  },

  // Get difficulty level options
  getDifficultyLevels(): { value: DifficultyLevel; label: string; color: string }[] {
    return [
      { value: 'beginner', label: 'Beginner', color: 'green' },
      { value: 'intermediate', label: 'Intermediate', color: 'yellow' },
      { value: 'advanced', label: 'Advanced', color: 'orange' },
      { value: 'expert', label: 'Expert', color: 'red' },
    ];
  },

  // Get common parts of speech options
  getPartsOfSpeechOptions(): { value: string; label: string }[] {
    return [
      { value: 'noun', label: 'Noun' },
      { value: 'verb', label: 'Verb' },
      { value: 'adjective', label: 'Adjective' },
      { value: 'adverb', label: 'Adverb' },
      { value: 'pronoun', label: 'Pronoun' },
      { value: 'preposition', label: 'Preposition' },
      { value: 'conjunction', label: 'Conjunction' },
      { value: 'interjection', label: 'Interjection' },
      { value: 'article', label: 'Article' },
    ];
  },
};

================
File: src/lib/utils.ts
================
import { type ClassValue, clsx } from 'clsx';

/**
 * Utility function to merge class names with Tailwind CSS
 * Combines clsx and class-variance-authority for better DX
 */
export function cn(...inputs: ClassValue[]) {
  return clsx(inputs);
}

/**
 * Format date to locale string
 */
export function formatDate(date: Date | string | null | undefined): string {
  if (!date) return '';
  
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  
  return dateObj.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

/**
 * Format date to relative time (e.g., "2 days ago")
 */
export function formatRelativeTime(date: Date | string): string {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  const now = new Date();
  const diffInMs = now.getTime() - dateObj.getTime();
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

  if (diffInDays === 0) return 'Today';
  if (diffInDays === 1) return 'Yesterday';
  if (diffInDays < 7) return `${diffInDays} days ago`;
  if (diffInDays < 30) return `${Math.floor(diffInDays / 7)} weeks ago`;
  if (diffInDays < 365) return `${Math.floor(diffInDays / 30)} months ago`;
  
  return `${Math.floor(diffInDays / 365)} years ago`;
}

/**
 * Capitalize first letter of a string
 */
export function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

/**
 * Truncate text to specified length
 */
export function truncate(text: string, length: number): string {
  if (text.length <= length) return text;
  return text.substring(0, length) + '...';
}

/**
 * Generate a slug from a string
 */
export function slugify(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '') // Remove special characters
    .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
}

/**
 * Check if a string is a valid email
 */
export function isValidEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Generate a random ID
 */
export function generateId(): string {
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
}

/**
 * Debounce function
 */
export function debounce<T extends (...args: any[]) => void>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout;
  
  return function executedFunction(...args: Parameters<T>) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

================
File: src/types/database.ts
================
// Database types
export type CourseStatus = 'draft' | 'published' | 'archived';
export type DifficultyLevel = 'beginner' | 'intermediate' | 'advanced' | 'expert';
export type LessonStatus = 'draft' | 'scheduled' | 'completed' | 'cancelled';
export type ContentType = 'text' | 'video' | 'audio' | 'pdf' | 'image' | 'interactive';

// Category type
export interface Category {
  id: string;
  name: string;
  description?: string;
  type: string;
  parent_id?: string;
  color?: string;
  icon?: string;
  user_id: string;
  created_at: string;
  updated_at: string;
}

// Course type
export interface Course {
  id: string;
  title: string;
  description?: string;
  short_description?: string;
  category_id?: string;
  status: CourseStatus;
  difficulty: DifficultyLevel;
  duration_hours?: number;
  objectives?: string[];
  prerequisites?: string[];
  tags?: string[];
  thumbnail_url?: string;
  is_public: boolean;
  public_slug?: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  published_at?: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
  book_count?: number;
  vocabulary_group_count?: number;
  schedule_count?: number;
  // Add these two lines for the relations
  course_books?: CourseBook[];
  course_vocabulary_groups?: CourseVocabularyGroup[];
}

// Book type
export interface Book {
  id: string;
  title: string;
  author?: string;
  isbn?: string;
  publisher?: string;
  publication_year?: number;
  description?: string;
  category_id?: string;
  content_type: ContentType;
  file_url?: string;
  cover_image_url?: string;
  total_pages?: number;
  language: string;
  tags?: string[];
  is_public: boolean;
  public_slug?: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
}

// VocabularyGroup type
export interface VocabularyGroup {
  id: string;
  name: string;
  description?: string;
  category_id?: string;
  language: string;
  target_language?: string;
  difficulty: DifficultyLevel;
  tags?: string[];
  is_public: boolean;
  public_slug?: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
  vocabulary_items?: VocabularyGroupItem[];
  vocabulary_count?: number;
}

// Vocabulary type
export interface Vocabulary {
  id: string;
  word: string;
  translation?: string;
  pronunciation?: string;
  part_of_speech?: string;
  definition?: string;
  example_sentence?: string;
  example_translation?: string;
  notes?: string;
  difficulty: DifficultyLevel;
  audio_url?: string;
  image_url?: string;
  tags?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
}

// VocabularyGroupItem relation type
export interface VocabularyGroupItem {
  id: string;
  vocabulary_group_id: string;
  vocabulary_id: string;
  position: number;
  added_at: string;
  
  // Relations
  vocabulary_group?: VocabularyGroup;
  vocabulary?: Vocabulary;
}

// CourseBook relation type
export interface CourseBook {
  id: string;
  course_id: string;
  book_id: string;
  is_required: boolean;
  notes?: string;
  position: number;
  
  // Relations
  course?: Course;
  book?: Book;
}

// CourseVocabularyGroup relation type
export interface CourseVocabularyGroup {
  id: string;
  course_id: string;
  vocabulary_group_id: string;
  position: number;
  
  // Relations
  course?: Course;
  vocabulary_group?: VocabularyGroup;
}

// Objective type
export interface Objective {
  id: string;
  title: string;
  description?: string;
  category_id?: string;
  bloom_level?: string;
  measurable: boolean;
  tags?: string[];
  is_template: boolean;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
}

// Method type
export interface Method {
  id: string;
  name: string;
  description?: string;
  category_id?: string;
  instructions?: string;
  duration_minutes?: number;
  group_size_min: number;
  group_size_max?: number;
  materials_needed?: string[];
  tags?: string[];
  is_template: boolean;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
}

// Task type
export interface Task {
  id: string;
  title: string;
  description?: string;
  category_id?: string;
  instructions?: string;
  duration_minutes?: number;
  difficulty: DifficultyLevel;
  materials_needed?: string[];
  assessment_criteria?: string;
  tags?: string[];
  is_template: boolean;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  category?: Category;
}

================
File: src/types/index.ts
================
// Common types used throughout the application

export interface BaseEntity {
  id: string;
  created_at: string;
  updated_at: string;
  created_by?: string;
}

export interface Category extends BaseEntity {
  name: string;
  description?: string;
  type: 'course' | 'book' | 'vocabulary' | 'method' | 'objective' | 'task';
  parent_id?: string;
  color?: string;
}

export interface Course extends BaseEntity {
  name: string;
  description?: string;
  category_id?: string;
  cover_image?: string;
  target_audience?: string;
  prerequisites?: string;
  status: 'draft' | 'published' | 'archived';
  is_public?: boolean;
  
  // Relations
  category?: Category;
  books?: Book[];
  schedules?: Schedule[];
}

export interface Book extends BaseEntity {
  title: string;
  author?: string;
  description?: string;
  category_id?: string;
  cover_image?: string;
  isbn?: string;
  publisher?: string;
  publication_year?: number;
  tags?: string[];
  
  // Relations
  category?: Category;
  vocabulary_groups?: VocabularyGroup[];
}

export interface Vocabulary extends BaseEntity {
  word: string;
  part_of_speech: 'noun' | 'verb' | 'adjective' | 'adverb' | 'preposition' | 'conjunction' | 'interjection' | 'other';
  definition: string;
  pronunciation?: string;
  example_sentence?: string;
  cefr_level: 'A1' | 'A2' | 'B1' | 'B2' | 'C1' | 'C2';
  difficulty_level?: number; // 1-10
  tags?: string[];
}

export interface VocabularyGroup extends BaseEntity {
  name: string;
  description?: string;
  book_id?: string;
  category_id?: string;
  
  // Relations
  book?: Book;
  category?: Category;
  vocabulary?: Vocabulary[];
}

export interface Schedule extends BaseEntity {
  name: string;
  description?: string;
  total_weeks: number;
  sessions_per_week: number;
  session_duration: number; // in minutes
  start_date?: string;
  end_date?: string;
  template_type?: string;
  
  // Relations
  lessons?: Lesson[];
}

export interface Lesson extends BaseEntity {
  schedule_id: string;
  title: string;
  description?: string;
  week_number: number;
  session_number: number;
  date?: string;
  duration?: number; // in minutes
  notes?: string;
  attendance_notes?: string;
  
  // Relations
  schedule?: Schedule;
  objectives?: Objective[];
  methods?: Method[];
  tasks?: Task[];
  vocabulary_groups?: VocabularyGroup[];
}

export interface Objective extends BaseEntity {
  name: string;
  description: string;
  category_id?: string;
  status: 'planning' | 'active' | 'completed' | 'archived';
  difficulty_level?: number; // 1-10
  
  // Relations
  category?: Category;
}

export interface Method extends BaseEntity {
  name: string;
  description: string;
  category_id?: string;
  methodology_type: 'PBL' | 'flipped_classroom' | 'group_discussion' | 'lecture' | 'workshop' | 'seminar' | 'other';
  estimated_duration?: number; // in minutes
  required_materials?: string;
  
  // Relations
  category?: Category;
}

export interface Task extends BaseEntity {
  name: string;
  description: string;
  category_id?: string;
  type: 'quiz' | 'assignment' | 'reading' | 'writing' | 'discussion' | 'presentation' | 'project' | 'other';
  estimated_duration?: number; // in minutes
  difficulty_level?: number; // 1-10
  instructions?: string;
  materials_needed?: string;
  
  // Relations
  category?: Category;
}

// API Response types
export interface ApiResponse<T = any> {
  data?: T;
  error?: {
    message: string;
    code?: string;
  };
  meta?: {
    total?: number;
    page?: number;
    limit?: number;
  };
}

export interface PaginatedResponse<T = any> {
  data: T[];
  meta: {
    total: number;
    page: number;
    limit: number;
    totalPages: number;
  };
}

// Form and UI types
export interface SelectOption {
  value: string;
  label: string;
  disabled?: boolean;
}

export interface FilterOptions {
  search?: string;
  category?: string;
  status?: string;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
  page?: number;
  limit?: number;
}

// Component prop types
export interface CardProps {
  children: React.ReactNode;
  className?: string;
  onClick?: () => void;
}

export interface ButtonProps {
  children: React.ReactNode;
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  loading?: boolean;
  onClick?: () => void;
  type?: 'button' | 'submit' | 'reset';
  className?: string;
}

export interface InputProps {
  label?: string;
  error?: string;
  placeholder?: string;
  required?: boolean;
  disabled?: boolean;
  className?: string;
}

export interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl';
}

// Navigation and routing types
export interface NavItem {
  name: string;
  href: string;
  icon?: React.ComponentType<{ className?: string }>;
  current?: boolean;
  children?: NavItem[];
}

// Search and pagination
export interface SearchFilters {
  query?: string;
  categories?: string[];
  dateFrom?: string;
  dateTo?: string;
  status?: string[];
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

export interface PaginationInfo {
  currentPage: number;
  totalPages: number;
  totalItems: number;
  itemsPerPage: number;
  hasNextPage: boolean;
  hasPreviousPage: boolean;
}

// Export/Import types
export interface ImportResult {
  success: boolean;
  imported: number;
  failed: number;
  errors: Array<{
    row: number;
    message: string;
  }>;
}

export interface ExportOptions {
  format: 'csv' | 'excel' | 'json';
  fields: string[];
  filters?: FilterOptions;
}

// Bulk operations
export interface BulkOperation {
  action: 'delete' | 'update' | 'export';
  selectedIds: string[];
  updateData?: Partial<any>;
}

export interface BulkOperationResult {
  success: boolean;
  affected: number;
  errors: Array<{
    id: string;
    message: string;
  }>;
}

================
File: src/types/schedule.ts
================
// Schedule and Lesson types
export type RecurrenceType = 'none' | 'daily' | 'weekly' | 'biweekly' | 'monthly';
export type DayOfWeek = 'monday' | 'tuesday' | 'wednesday' | 'thursday' | 'friday' | 'saturday' | 'sunday';
export type AttendanceStatus = 'present' | 'absent' | 'late' | 'excused';

// Schedule type
export interface Schedule {
  id: string;
  course_id: string;
  name: string;
  description?: string;
  start_date: string;
  end_date?: string;
  recurrence_type: RecurrenceType;
  recurrence_days?: DayOfWeek[];
  recurrence_interval?: number;
  default_start_time: string;
  default_duration_minutes: number;
  timezone: string;
  location?: string;
  max_students?: number;
  is_active: boolean;
  user_id: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, any>;
  
  // Relations
  course?: any; // Will be Course type from database.ts
  lessons?: Lesson[];
  student_count?: number;
}

// Lesson type
export interface Lesson {
  id: string;
  schedule_id: string;
  title: string;
  description?: string;
  date: string;
  start_time: string;
  end_time: string;
  duration_minutes: number;
  location?: string;
  status: 'draft' | 'scheduled' | 'completed' | 'cancelled';
  notes?: string;
  homework?: string;
  resources?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
  completed_at?: string;
  cancelled_at?: string;
  metadata?: Record<string, any>;
  
  // Relations
  schedule?: Schedule;
  objectives?: LessonObjective[];
  methods?: LessonMethod[];
  tasks?: LessonTask[];
  attendance?: Attendance[];
}

// Attendance type
export interface Attendance {
  id: string;
  lesson_id: string;
  student_id: string;
  student_name: string;
  status: AttendanceStatus;
  arrival_time?: string;
  notes?: string;
  marked_at: string;
  marked_by: string;
  
  // Relations
  lesson?: Lesson;
}

// Objective type (simplified for now)
export interface Objective {
  id: string;
  title: string;
  description?: string;
  category_id?: string;
  tags?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
}

// Method type (simplified for now)
export interface Method {
  id: string;
  name: string;
  description?: string;
  category_id?: string;
  estimated_minutes?: number;
  materials_needed?: string[];
  tags?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
}

// Task type (simplified for now)
export interface Task {
  id: string;
  title: string;
  description?: string;
  type: 'quiz' | 'assignment' | 'reading' | 'writing' | 'speaking' | 'listening' | 'other';
  category_id?: string;
  estimated_minutes?: number;
  instructions?: string;
  tags?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
}

// Lesson-Objective relation
export interface LessonObjective {
  id: string;
  lesson_id: string;
  objective_id: string;
  position: number;
  
  // Relations
  lesson?: Lesson;
  objective?: Objective;
}

// Lesson-Method relation
export interface LessonMethod {
  id: string;
  lesson_id: string;
  method_id: string;
  position: number;
  duration_minutes?: number;
  notes?: string;
  
  // Relations
  lesson?: Lesson;
  method?: Method;
}

// Lesson-Task relation
export interface LessonTask {
  id: string;
  lesson_id: string;
  task_id: string;
  position: number;
  is_homework: boolean;
  due_date?: string;
  notes?: string;
  
  // Relations
  lesson?: Lesson;
  task?: Task;
}

// Calendar event type for UI
export interface CalendarEvent {
  id: string;
  title: string;
  start: Date;
  end: Date;
  resource?: {
    lesson: Lesson;
    schedule: Schedule;
  };
  className?: string;
}

// Schedule template type
export interface ScheduleTemplate {
  id: string;
  name: string;
  description?: string;
  default_duration_minutes: number;
  recurrence_type: RecurrenceType;
  recurrence_days?: DayOfWeek[];
  default_objectives?: string[];
  default_methods?: string[];
  default_tasks?: string[];
  user_id: string;
  created_at: string;
  updated_at: string;
}

================
File: tailwind.config.js
================
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
          950: '#172554',
        },
        gray: {
          50: '#f9fafb',
          100: '#f3f4f6',
          200: '#e5e7eb',
          300: '#d1d5db',
          400: '#9ca3af',
          500: '#6b7280',
          600: '#4b5563',
          700: '#374151',
          800: '#1f2937',
          900: '#111827',
          950: '#030712',
        },
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
      },
      maxWidth: {
        '8xl': '88rem',
        '9xl': '96rem',
      },
      spacing: {
        '18': '4.5rem',
        '88': '22rem',
      },
    },
  },
  plugins: [
    require('@tailwindcss/forms'),
  ],
}

================
File: tsconfig.json
================
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/types/*": ["./src/types/*"],
      "@/utils/*": ["./src/utils/*"],
      "@/hooks/*": ["./src/hooks/*"],
      "@/stores/*": ["./src/stores/*"],
      "@/styles/*": ["./src/styles/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
